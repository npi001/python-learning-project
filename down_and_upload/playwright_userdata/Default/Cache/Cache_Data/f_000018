/*! For license information please see player-2.d8fb81c8.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).xss={})}(this,function(e){"use strict";var t=function(){return(t=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function i(e,t,i){if(i||2==arguments.length)for(var r,n=0,a=t.length;n<a;n++)!r&&n in t||(r||(r=Array.prototype.slice.call(t,0,n)),r[n]=t[n]);return e.concat(r||Array.prototype.slice.call(t))}var r=/[^a-zA-Z0-9\\_:.-]/gim,n=/</g,a=/>/g,o=/&#([a-zA-Z0-9]*);?/gim,s=/&quot;/g,l=/&colon;?/gim,d=/&newline;?/gim,u=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a):/gi,c=/u\s*r\s*l\s*\(.*/gi,f=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,h=/"/g,p=function(e){return e.replace(n,"&lt;").replace(a,"&gt;")},g={indexOf:function(e,t){var i,r;for(i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return -1},forEach:function(e,t,i){var r,n;for(r=0,n=e.length;r<n;r++)t.call(i,e[r],r,e)},some:function(e,t,i){var r,n;for(r=0,n=e.length;r<n;r++)if(t.call(i,e[r],r,e))return!0;return!1},trim:function(e){return e.replace(/(^\s*)|(\s*$)/g,"")},includes:function(e,t){if("string"==typeof e)return -1!==e.indexOf(t);for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1},spaceIndex:function(e){var t=/\s|\n|\t/.exec(e);return t?t.index:-1},uniq:function(e){for(var t={},i=[],r=0;r<e.length;r++)t[e[r]]||(i.push(e[r]),t[e[r]]=!0);return i},from:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t},keys:function(e){var t=[];for(var i in e)t.push(i);return t}};function m(e){return null==e}function v(e){var t;return'"'===(t=e)[0]&&'"'===t[t.length-1]||"'"===t[0]&&"'"===t[t.length-1]?e.substr(1,e.length-2):e}function _(e){var t,i,r,n,a,o,s,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d="",u=0;for(e=function(e){e=e.replace(/rn/g,"n");for(var t="",i=0;i<e.length;i++){var r=e.charCodeAt(i);r<128?t+=String.fromCharCode(r):r>127&&r<2048?t+=String.fromCharCode(r>>6|192)+String.fromCharCode(63&r|128):t+=String.fromCharCode(r>>12|224)+String.fromCharCode(r>>6&63|128)+String.fromCharCode(63&r|128)}return t}(e);u<e.length;)n=(t=e.charCodeAt(u++))>>2,a=(3&t)<<4|(i=e.charCodeAt(u++))>>4,o=(15&i)<<2|(r=e.charCodeAt(u++))>>6,s=63&r,isNaN(i)?o=s=64:isNaN(r)&&(s=64),d=d+l.charAt(n)+l.charAt(a)+l.charAt(o)+l.charAt(s);return d}function y(e){var t,i,r,n,a,o,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l="",d=0;for(e=e.replace(/[^A-Za-z0-9+/=]/g,"");d<e.length;)t=s.indexOf(e.charAt(d++))<<2|(n=s.indexOf(e.charAt(d++)))>>4,i=(15&n)<<4|(a=s.indexOf(e.charAt(d++)))>>2,r=(3&a)<<6|(o=s.indexOf(e.charAt(d++))),l+=String.fromCharCode(t),64!==a&&(l+=String.fromCharCode(i)),64!==o&&(l+=String.fromCharCode(r));return function(e){for(var t="",i=0,r=0,n=0,a=0;i<e.length;)(r=e.charCodeAt(i))<128?(t+=String.fromCharCode(r),i++):r>191&&r<224?(t+=String.fromCharCode((31&r)<<6|63&(a=e.charCodeAt(i+1))),i+=2):(a=e.charCodeAt(i+1),t+=String.fromCharCode((15&r)<<12|(63&a)<<6|63&(n=e.charCodeAt(i+2))),i+=3);return t}(l)}function T(e,t,i){var r="",n=0,a=!1,o=!1,s=0,l=e.length,d="",u="";e:for(s=0;s<l;s++){var c=e.charAt(s);if(!1===a){if("<"===c){a=s;continue}}else if(!1===o){if("<"===c){r+=i(e.slice(n,s)),a=s,n=s;continue}if(">"===c||s===l-1){r+=i(e.slice(n,a)),d=function(e){var t,i=g.spaceIndex(e);return t=-1===i?e.slice(1,-1):e.slice(1,i+1),"/"===(t=g.trim(t).toLowerCase()).slice(0,1)&&(t=t.slice(1)),"/"===t.slice(-1)&&(t=t.slice(0,-1)),t}(u=e.slice(a,s+1)),r+=t(a,r.length,d,u,"</"===u.slice(0,2)),n=s+1,a=!1;continue}if('"'===c||"'"===c)for(var f=1,h=e.charAt(s-f);""===h.trim()||"="===h;){if("="===h){o=c;continue e}h=e.charAt(s-++f)}}else if(c===o){o=!1;continue}}return n<l&&(r+=i(e.substr(n))),r}function k(e,t){var i=0,n=0,a=[],o=!1,s=e.length;function l(e,i){if(!((e=(e=g.trim(e)).replace(r,"").toLowerCase()).length<1)){var n=t(e,i||"");n&&a.push(n)}}for(var d=0;d<s;d++){var u=e.charAt(d),c=void 0;if(!1!==o||"="!==u){if(!1===o||d!==n){if(/\s|\n|\t/.test(u)){if(e=e.replace(/\s|\n|\t/g," "),!1===o){if(-1===(c=function(e,t){for(;t<e.length;t++){var i=e[t];if(" "!==i)return"="===i?t:-1}return -1}(e,d))){l(g.trim(e.slice(i,d))),o=!1,i=d+1;continue}d=c-1;continue}if(-1===(c=function(e,t){for(;t>0;t--){var i=e[t];if(" "!==i)return"="===i?t:-1}return -1}(e,d-1))){l(o,v(g.trim(e.slice(i,d)))),o=!1,i=d+1;continue}}}else{if(-1===(c=e.indexOf(u,d+1)))break;l(o,g.trim(e.slice(n+1,c))),o=!1,i=(d=c)+1}}else o=e.slice(i,d),i=d+1,n='"'===e.charAt(i)||"'"===e.charAt(i)?i:function(e,t){for(;t<e.length;t++){var i=e[t];if(" "!==i)return"'"===i||'"'===i?t:-1}return -1}(e,d+1)}return i<e.length&&(!1===o?l(e.slice(i)):l(o,v(g.trim(e.slice(i))))),g.trim(a.join(" "))}function E(e,t,i){if(i=function(e){return e=function(e){for(var t="",i=0,r=e.length;i<r;i++)t+=32>e.charCodeAt(i)?" ":e.charAt(i);return g.trim(t)}(e=(e=(e=e.replace(s,'"')).replace(o,function(e,t){return"x"===t[0]||"X"===t[0]?String.fromCharCode(parseInt(t.substr(1),16)):String.fromCharCode(parseInt(t,10))})).replace(l,":").replace(d," "))}(i),"href"===t||"src"===t){if("#"===(i=g.trim(i)))return"#";if("http://"!==i.substr(0,7)&&"https://"!==i.substr(0,8)&&"mailto:"!==i.substr(0,7)&&"tel:"!==i.substr(0,4)&&"data:image/"!==i.substr(0,11)&&"ftp://"!==i.substr(0,6)&&"./"!==i.substr(0,2)&&"../"!==i.substr(0,3)&&"#"!==i[0]&&"/"!==i[0])return""}else if("background"===t){if(u.lastIndex=0,u.test(i))return""}else if("style"===t&&(f.lastIndex=0,f.test(i)||(c.lastIndex=0,c.test(i)&&(u.lastIndex=0,u.test(i)))))return"";return i=function(e){return e=p(e=e.replace(h,"&quot;"))}(i)}var S=function(e){return"string"==typeof e?e.replace(/'/g,'"').replace('=""',"").replace(/\s+/g,"").toLowerCase():""},C=function(){function e(e){var t=function(e){var t={};for(var i in e)t[i]=e[i];return t}(e||{});t.stripIgnoreTag&&(t.onIgnoreTag,t.onIgnoreTag=function(){return""}),t.whiteList={},t.onTag=function(){},t.onTagAttr=function(){},t.onIgnoreTag=function(){},t.onIgnoreTagAttr=function(){},t.safeAttrValue=E,t.escapeHtml=p,this.options=Object.assign(t,e)}return e.prototype.process=function(e){if(!(e=(e=e||"").toString()))return"";var t,i,r,n,a,o,s=this.options,l=s.whiteList,d=s.onTag,u=s.onIgnoreTag,c=s.onTagAttr,f=s.onIgnoreTagAttr,h=s.safeAttrValue,p=s.escapeHtml;s.stripBlankChar&&(e=(t=(t=e.split("")).filter(function(e){var t=e.charCodeAt(0);return!(127===t||t<=31&&10!==t&&13!==t)})).join("")),s.allowCommentTag||(e=function(e){for(var t="",i=0;i<e.length;){var r=e.indexOf("\x3c!--",i);if(-1===r){t+=e.slice(i);break}t+=e.slice(i,r);var n=e.indexOf("--\x3e",r);if(-1===n)break;i=n+3}return t}(e));var m=!1;s.stripIgnoreTagBody&&(i=s.stripIgnoreTagBody,"function"!=typeof(r=u)&&(r=function(){}),n=!Array.isArray(i),a=[],o=!1,u=(m={onIgnoreTag:function(e,t,s){var l;if(l=e,n||-1!==g.indexOf(i,l)){if(s.isClosing){var d="[/removed]",u=s.position+d.length;return a.push([!1!==o?o:s.position,u]),o=!1,d}return o||(o=s.position),"[removed]"}return r(e,t,s)},remove:function(e){var t="",i=0;return g.forEach(a,function(r){t+=e.slice(i,r[0]),i=r[1]}),t+=e.slice(i)}}).onIgnoreTag);var v=T(e,function(e,t,i,r,n){var a={sourcePosition:e,position:t,isClosing:n,isWhite:Object.prototype.hasOwnProperty.call(l,i)},o=d(i,r,a);if(null!=o)return o;if(a.isWhite){if(a.isClosing)return"</".concat(i,">");var s=function(e){var t=g.spaceIndex(e);if(-1===t)return{html:"",closing:"/"===e[e.length-2]};var i="/"===(e=g.trim(e.slice(t+1,-1)))[e.length-1];return i&&(e=g.trim(e.slice(0,-1))),{html:e,closing:i}}(r),m=l[i],v=k(s.html,function(e,t){var r=-1!==g.indexOf(m,e),n=c(i,e,t,r);return null==n?r?(t=h(i,e,t,null))?"".concat(e,'="').concat(t,'"'):e:null==(n=f(i,e,t,r))?void 0:n:n});return r="<".concat(i),v&&(r+=" ".concat(v)),s.closing&&(r+=" /"),r+=">"}return null==(o=u(i,r,a))?p(r):o},p);return m&&(v=m.remove(v)),v},e}(),b=Function("\nvar _checkXSS = function (it) {\n  return it && it.Math == Math && it;\n};\nreturn _checkXSS(typeof globalThis === 'object' && globalThis) ||\n_checkXSS(typeof window === 'object' && window) ||\n_checkXSS(typeof self === 'object' && self) ||\n_checkXSS(typeof global === 'object' && global) ||\nFunction('return this')();\n")(),D=new(function(){function e(){var e=this;this.batchData=[],this.uniqKeys=new Set,this.timeout=2e3,this.lock=!1,this.getSlardarBid=function(){var t,i,r="douyin_web";if(!g.includes(r,"bid"))return r;if(e.config&&e.config.bid)return e.config.bid;if(b&&b._xssBid)return b._xssBid;if(b&&b.slardar&&"function"==typeof b.slardar.config){var n=(b.slardar.config()||{}).bid;if(n)return n}if(b&&b.Slardar&&"function"==typeof b.Slardar.config){var a=(b.Slardar.config()||{}).bid;if(a)return a}return(null===(i=null===(t=null==b?void 0:b.Slardar)||void 0===t?void 0:t._baseParams)||void 0===i?void 0:i.bid)||"argus"},this.getConfigRegion=function(){var t;return g.includes("cn","region")?e.config&&e.config.region?e.config.region:((null===(t=null==b?void 0:b.gfdatav1)||void 0===t?void 0:t.region)||"cn").toLowerCase():"cn"},this.gerReportUrl=function(){var t={cn:y("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boe:y("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),ttp:y("aHR0cHM6Ly9tb24udXMudGlrdG9rdi5jb20vbW9uaXRvcl9icm93c2VyL2NvbGxlY3QvYmF0Y2gvc2VjdXJpdHkvP2JpZD0="),va:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),maliva:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),sg:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boei18n:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9")}[e.getConfigRegion()];if(t)return t+e.getSlardarBid()}}return e.prototype.setConfig=function(e){this.config=e},e.prototype.upload=function(){var e=this,t=this.gerReportUrl();!this.lock&&t&&0!==this.batchData.length&&(this.lock=!0,setTimeout(function(){var i=e.batchData.slice(0,100);e.batchData=e.batchData.slice(100),b.fetch(t,{method:"post",body:JSON.stringify(i),headers:{"Content-Type":"application/json"}}).catch(function(e){}),e.lock=!1,e.upload()},this.timeout))},e.prototype.generateKey=function(e){return e.collectKey?[e.collectMode,e.collectKey].join("___"):""},e.prototype.push=function(e){this.batchData.push(e),this.upload()},e.prototype.report=function(e){var t=this.generateKey(e);if(b.fetch&&e.collectKey){var i="object"==typeof window?window.location.href:"SSR";e.documentUrl=i;var r={age:Math.floor(Date.now()),type:"xss",url:i,body:e,"user-agent":""};"enforce"===e.disposition&&"SSR"!==i||(r.url=t),"SSR"===i&&(r.url="SSR___".concat(r.url),r.body.ssr=!0),this.push(r)}},e}()),L=function(e){for(var t=0,i=function(i){Array.isArray(e[i])?0===e[i].length?delete e[i]:(e[i]=g.from(g.uniq(e[i])),t+=e[i].length):0===g.keys(e[i]).length?delete e[i]:g.keys(e[i]).forEach(function(r){e[i][r]=g.from(g.uniq(e[i][r])),t+=e[i][r].length})},r=0,n=g.keys(e);r<n.length;r++)i(n[r]);return{count:t,ret:e}};function R(e,t){return D.setConfig(t),new C(t).process(e)}function P(e){var t,i=(t=/\s|\n|\t/.exec(e))?t.index:-1;if(-1===i)return{html:"",closing:"/"===e[e.length-2]};var r="/"===(e=e.slice(i+1,-1).trim())[e.length-1];return r&&(e=e.slice(0,-1).trim()),{html:e,closing:r}}var x=function(e){return -1===(e=(e=(e=(e=e.replace(/&colon;/gi,":")).replace(/&tab;/gi,"")).replace(/&newline;/gi,"")).replace(/(\t|\n|\r)/g,"")).indexOf("&#")?e.trim().toLowerCase():e.trim().replace(/&#(?:(x)([0-9a-f]+)|([0-9]+));?/gi,function(e,t,i,r){return String.fromCharCode(t?parseInt(i,16):parseInt(r))}).replace(/(\t|\n|\r)/g,"").toLowerCase()};function I(e,t){if(void 0===e&&(e=""),"string"!=typeof e)return!0;if(e=x(e),g.includes(e,"base64")&&!function(e){if(""===e||""===e.trim())return!0;try{return!g.includes(e,"data:text/html;base64")}catch(e){return!0}}(e))return t&&t("data:text/html;base64"),!1;var i=["expression(","behavior:","view-source:"];if(g.some(i,function(t){return -1!==e.indexOf(t)}))return g.forEach(i,function(i){-1!==e.indexOf(i)&&t&&t(i)}),!1;var r=["data:application","data:javascript","data:text/html","data:texthtml"];if(g.some(r,function(t){return -1!==e.indexOf(t)}))return g.forEach(r,function(i){-1!==e.indexOf(i)&&t&&t(i)}),!1;if(e.indexOf("javascript:")>0)return t&&t("javascript:"),!1;if(/^javascript:/i.test(e)){var n=e.slice(11).replace(/\s/g,"").trim();return!!g.some(["void","void(0)","void0","false","undefined",";"],function(e){return e===n})||(t&&t("javascript:"),!1)}return!0}var O=function(e,t){var i,r,n="<%= isSaveValidUrl =>";if("string"!=typeof e||(r=Number("<%= urlLimit =>"),void 0!==i&&(r=i),"NaN"!==e.toString()&&-1!==r&&e.length>=r)||I(e,t))return e;try{if(!0===(n=JSON.parse(n))||"true"===n){var a=new URL(e);return a.origin+a.pathname}}catch(e){}return"#"};function w(e,t,r){if(void 0===e&&(e=""),void 0===t&&(t=[]),"string"!=typeof e)return!0;if(!I(e=x(e)))return!1;var n,a={url:(n=e.match(/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/)||[])[0],scheme:n[1],slash:n[2],host:n[3],port:n[4],path:n[5],query:n[6],hash:n[7]},o=a.scheme,s=a.host;return r?!!r(e):!(!o||!s)&&(!g.includes(["http","https","file"],o)||("object"==typeof window&&window&&(t=i(i([],t,!0),[location.host],!1)),g.some(t,function(e){return!!(e instanceof RegExp&&e.test(s))||e===s})))}var M={a:["target","title","spellcheck","rel"],canvas:[],abbr:["title"],address:[],area:["shape","coords","alt"],article:[],aside:[],audio:["autoplay","controls","loop","preload"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:["dir"],dl:[],dt:[],em:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["alt","title","width","height","decoding"],ins:["datetime"],li:[],mark:[],nav:[],ol:["start"],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],sup:[],delete:[],form:[],strong:[],mask:["maskunits","x","y","width","height","fill"],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],wbr:[],video:["autoplay","controls","loop","preload","height","width"],svg:["viewBox","version","xmlns","fill","width","height","stroke","stroke-width","style"],path:["d","fill","opacity","stroke","p-id","fill-rule","clip-rule","stroke-width","stroke-linecap","stroke-linejoin","fill-opacity","mask"],rect:["x","y","width","height","fill","stroke","rx"],g:[]},A={collect:null,initCollect:function(){this.collect={whiteList:{},filterProtocol:[]}},removeCollect:function(){var e=L(this.collect),t=e.count,i=e.ret;return this.collect=null,{collectKey:0===t?null:JSON.stringify(i),collectMode:"white"}},onIgnoreTagAttr:function(e,t,r){return e&&g.indexOf(["href","src"],t)>-1?A.domainWhiteList&&Array.isArray(A.domainWhiteList)&&A.domainWhiteList.length>0&&!w(r,i([],A.domainWhiteList,!0))?"":"".concat(t,'="').concat(O(r,function(e){var t;null===(t=A.collect)||void 0===t||t.filterProtocol.push(e)}),'"'):e&&(g.indexOf(["style","class","id"],t)>-1||t.indexOf("data-")>-1)?"".concat(t,'="').concat(r,'"'):(A.collect.whiteList[e]=A.collect.whiteList[e]||[],void A.collect.whiteList[e].push(t))},onIgnoreTag:function(e,t){if("style"===e)return t;T(t,function(e,t,i,r){k(P(r).html.replace("/",""),function(e){A.collect.whiteList[i]=A.collect.whiteList[i]||[],A.collect.whiteList[i].push(e)})},p)},whiteList:M,mergeWhiteList:function(e){for(var t,i={},r=0,n=g.keys(M);r<n.length;r++)i[t=n[r]]=g.from(M[t]);for(var a=0,o=g.keys(e);a<o.length;a++)i[t=o[a]]=t in M?M[t].concat(e[t]):g.from(e[t]);return i},setWhiteList:function(e){for(var t=0,i=g.keys(e);t<i.length;t++){var r=i[t];this.whiteList[r]=r in M?M[r].concat(e[r]):g.from(e[r])}}};try{var N={},B="merge";g.includes(B,"override")&&(A.whiteList=N.whiteList),g.includes(B,"merge")&&A.setWhiteList(N.whiteList)}catch(e){}var U=function(e,t){for(var i={},r=0,n=g.keys(e);r<n.length;r++){var a=n[r];Array.isArray(e[a])?i[a]=g.from(e[a]):i[a]=U({},e[a])}for(var o=0,s=g.keys(t);o<s.length;o++)(a=s[o])in e?Array.isArray(e[a])?i[a]=e[a].concat(t[a]):i[a]=U(e[a],t[a]):Array.isArray(t[a])?i[a]=g.from(t[a]):i[a]=U({},t[a]);return i},H={blackList:{a:["folder"],meta:["content"],iframe:["srcdoc"],input:["pattern"],vmlframe:["xmlns"]},blackTags:["script","xml","embed","isindex","object","base","set","handler","animate","payload","import"],blackAttrs:["charset","ns","namespace","formaction","xlink:href","xmlns:xlink","handler","repeat","repeat-start","repeat-end"],blackAttrRegExps:[/^on/],filterList:{param:["value"],video:["poster"],form:["action"]},filterAttrs:["href","src","background","style","dynsrc","lowsrc","content"]};try{var G={};G.blackAttrRegExps&&(G.blackAttrRegExps=G.blackAttrRegExps.map(function(e){return new RegExp(e.toString().slice(1,e.toString().length-1))}));var V="merge";g.includes(V,"override")&&(H=G),g.includes(V,"merge")&&(H=U(H,G))}catch(e){}var F={mode:"black",whiteList:{},blackConfig:H,collect:null,initCollect:function(){F.collect={blackList:{},blackTags:[],blackAttrs:[],blackAttrRegExps:[],filterAttrs:[],filterList:{},filterProtocol:[]}},removeCollect:function(){var e=L(F.collect),t=e.count,i=e.ret;return F.collect=null,{collectKey:0===t?null:JSON.stringify(i),collectMode:"black"}},onIgnoreTag:function(e,t){var i;if(!g.includes(H.blackTags,e))return T(t,function(e,t,i,r,n){if(-1!==i.indexOf("/"))return p(r);if(n)return"</".concat(i,">");var a=P(r),o=k(a.html,function(e,t){var r,n=0;if(H.blackList[i]&&g.includes(H.blackList[i],e)&&(F.collect.blackList[i]=F.collect.blackList[i]||[],F.collect.blackList[i].push(e),n++),H.blackAttrRegExps.length&&H.blackAttrRegExps.some(function(t){return t.test(e)})&&g.forEach(H.blackAttrRegExps,function(t){t.test(e)&&(F.collect.blackAttrRegExps.push("".concat(t.toString(),"->").concat(e)),n++)}),H.blackAttrs.length&&g.includes(H.blackAttrs,e)&&(H.blackAttrs.push(e),n++),!n){if(H.filterList&&H.filterList[i]&&g.includes(H.filterList[i],e)){var a=O(t,function(e){var t;null===(t=F.collect)||void 0===t||t.filterProtocol.push(e)});return a!==t&&(F.collect.filterList[i]=F.collect.filterList[i]||[],F.collect.filterList[i].push(e)),t?"".concat(e,"='").concat(a,"'"):e}return H.filterAttrs&&g.includes(H.filterAttrs,e)?((a=O(t,function(e){var t;null===(t=F.collect)||void 0===t||t.filterProtocol.push(e)}))!==t&&(null===(r=F.collect)||void 0===r||r.filterAttrs.push(e)),t?"".concat(e,"='").concat(a,"'"):e):t?"".concat(e,"='").concat(t,"'"):e}});return r="<".concat(i),o&&(r+=" ".concat(o)),a.closing&&(r+=" /"),r+=">"},p);null===(i=F.collect)||void 0===i||i.blackTags.push(e)}},j=function(e){var t=e.reportOnly,i=void 0===t||t,r=e.block;return i&&"all"===i?"report":("string"==typeof i&&("true"===i&&(i=!0),"false"===i&&(i=!1)),r?"enforce":i?"report":"enforce")},q=function(e){return function(i,r,n){if(!i||"string"!=typeof i)return i;var a=r;e===R&&(a=A).initCollect();var o=e(i,a);if(S(o)===S(i))return i;if(!n)return o;var s=n.logType,l=j(n),d=a.removeCollect();return D.report(t(t({type:s,disposition:l},d),{sourceText:_(i),filterText:_(o)})),"enforce"===l?o:i}},K=q(function(e,t){return void 0===t&&(t={}),t&&t.whiteList||(t.whiteList={a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}),new C(t).process(e)}),Z=q(R),W=function(e,t,i){var r=[],n=O(e,function(e){r.push(e)});if(n===e)return e;r=g.from(g.uniq(r));var a=t||i||{};if(!a)return n;var o=a.logType,s=j(i);return D.report({type:o,disposition:s,collectKey:r.join("___"),collectData:JSON.stringify(r),collectMode:"black",sourceText:_(e),filterText:_(n)}),"enforce"===s?n:e},Y=b._xssProject||{},J=b.xssNamespace||{},z="3.0.26",X={FilterXSS:C,version:z,webpackPluginVersion:"<%= webpackPluginVersion =>",reportOnly:"<%= reportOnly =>",filterXSS:K,_filterXSS:Z,filterUrl:W,Config:A,BlackConfig:F,project:Y,setProjectName:function(e){Y[e]=this,b._xssProjectName=e}};J.douyin_web=X,b.xssNamespace=J,b.Math&&!b.Math.xssNamespace&&(b.Math.xssNamespace=J),Y[z]=X,b.globalThis=b,b.getFilterXss=function(){return void 0!==this._xssProjectName?this._xssProject[this._xssProjectName]:X},b.xss=X,b.isSafeUrl=w,b.isSafeDomain=w,b.isSafeProtocol=I,b._xssProject=Y,b._xssProjectName&&(Y[b._xssProjectName]=X);var Q=X.setProjectName.bind(X);e.BlackConfig=F,e.Config=A,e.FilterXSS=C,e._filterXSS=Z,e.filterUrl=W,e.filterXSS=K,e.isSafeDomain=w,e.isSafeProtocol=I,e.isSafeUrl=w,e.project=Y,e.setProjectName=Q,e.setXssNamespace=function(e){var t=e.appId,i=e.bid,r=e.region;J[t]=X;A.bid=i,A.region=r,A.enabled=!0},e.xssNamespace=J,Object.defineProperty(e,"__esModule",{value:!0})});"use strict";(self.webpackChunkdouyin_web=self.webpackChunkdouyin_web||[]).push([["13815"],{579806:function(e,t,i){i.d(t,{Z:function(){return B}});var r=i(452006);i(836654),i(691842),i(465132),i(499045),i(910795),i(511141),i(743465),i(464135),i(891555),i(981168),i(499953),i(47513),i(721911),i(429532),i(98601),i(110617),i(675373),i(819117),i(826893),i(927234),i(250440),i(914613),i(742611),i(874386);var n=i(943495),a=i(546041),o=i(896167),s=i(264001),l=i(638858),d=i(383640),u=i(734123),c=i(336397),f=i(132477),h=i(841921),p=i(295542),g=i(122174),m=i(298028),v=i(908767),_=i(13457),y=i(235879),T=i(94701),k=i(603384),E=i(19815),S=i(446215),C=i(231986),b=i(855381),D=i(51814),L=i(956333),R="DESTROYED",P="xglog_cache",x="degrade",I={UPDATE_URL:"UPDATE_URL"},O=null,w=null,M=null,A=null,N=0,B=function(e){var t,i,d,B,U,H,G,V;function F(e){var t,i,o,s;return(0,r.PA)(this,F),i=(0,r.$w)(this,F,[e]),(0,r._x)(i,"_onChangeConfig",function(e){if(e){var t=e.nextBufferLength===i.config.minBufferLength;if(i.setConfig(e),e.nextBufferLength&&!t)try{i._onTimeUpdate()}catch(e){}}}),(0,r._x)(i,"fpsStuckHandle",function(e){var t=i.player,r=i.config,n=i.mse;if(!i.fpsStuckTime&&(i.fpsStuckTime=e.currentTime,i.log(c._.LOG,"fpsStuckHandle, currentTime,",e.currentTime)),n&&i.fpsStuckTime>0){var a=t.bufferedPoint;n.clearOpQueues(f.d1.VIDEO,!!r.enableMsePatches),i.log(c._.LOG,"fpsStuckHandle, remove: ".concat(a.start,"-").concat(a.end,","),"stuckTime: ".concat(i.fpsStuckTime)),n.remove(f.d1.VIDEO,a.start,a.end).then(function(){t.currentTime=i.fpsStuckTime,i.fpsStuckTime=null}),!i._firstMetFPSStuck&&(i._firstMetFPSStuck=!0,i.log(c._.LOG,"firstMetFPSStuck"),i.emit(P))}}),(0,r._x)(i,"_replayHook",function(e){}),(0,r._x)(i,"_retryHook",function(){var e=i.player,t=i.playerConfig,r=e.paused;i.softDecode?e.vtype=a.l0.MP4_MSE_SOFT:e.vtype=a.l0.MP4_MSE,i._defInited=!1,i._MSEError=!1,e.video.removeEventListener("loadedmetadata",i.__onmetadataHandle);var n=e.currentTime||0;i.log(c._.LOG,"retryHook ",t.vid,i.codecType,n);var o=function(){i.__onmetadataHandle=function(){n&&(e.currentTime=n,i.log(c._.LOG,"retryHook update currentTime",t.vid,i.codecType,n)),r?e.pause():e.play(),e.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},e.video.addEventListener("loadedmetadata",i.__onmetadataHandle)};return!i.config.enableMsePatches&&o(),i._destroyMSE(),i._reset(),i.states=[],i.playerStartInit(t.url),i.config.enableMsePatches&&o(),!1}),(0,r._x)(i,"_playHook",function(e){i._usePaused=!1,i._cancelLoading=!1,i.log(c._.LOG,"playHook"),i._startProgress()}),(0,r._x)(i,"_pauseHook",function(e){var t;i._usePaused=!0;for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];i.log(c._.LOG,"pauseHook",n[0],null===(t=i.player)||void 0===t?void 0:t.currentTime),0>n.indexOf(null===m.Im||void 0===m.Im?void 0:m.Im.BUFFER_CONTROLS)&&(clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=null,i.log(c._.LOG,"pause hook clear buffer_control state")),i._loadStuckCheck()}),(0,r._x)(i,"abrSwitchURL",(o=(0,r.x)((0,r.l5)().mark(function e(t){var n,a,o,s;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=i.playerConfig.definition.list,a=0,o=0;case 4:if(!(o<n.length)){e.next=11;break}if(t.definition!==n[o].definition){e.next=8;break}return a=o,e.abrupt("break",11);case 8:o++,e.next=4;break;case 11:s=i.player.curDefinition,i.changeDefinition(n[a],s,!0);case 13:case"end":return e.stop()}},e)})),function(e){return o.apply(this,arguments)})),(0,r._x)(i,"timerHandle",function(){i._requestTimer&&i._onTimeUpdate()}),(0,r._x)(i,"changeDefineCanPlay",function(e,t,r,n){var a,o=i.player,s=i._changeDefState?i._changeDefState.currentTime:e;if(i.needStarLoadFirstSegment=!0,o.changeDefinitionSeekState=1,i.log(c._.LOG,"changeDefineCanPlay seek changeBitrate point ".concat(s,", pause: ").concat(null===(a=i._changeDefState)||void 0===a?void 0:a.paused)),o.ended){o.currentTime=0;return}o.currentTime=s,i._changeDefState&&i._changeDefState.paused?o.pause():o.play(),i._changeDefState=null,o.emit(u.Events.AFTER_DEFINITION_CHANGE,{from:r,to:n})}),(0,r._x)(i,"changeDefinition",function(e,t,a){var o,s=i.player,l=i.playerConfig,d=i.mp4,h=i.config;if(!t&&(t=s.curDefinition),i._MSEError=!1,i.useVideoLoad){"__auto__"===e.url&&(e.url=s.config.definition.list[0].url),M.call(i.player,e,t);return}var p=s.definitionList.filter(function(t){return t.definition===e.definition});if(p.length>0&&(e=p[0]),i._handlerUrl(e.url),e._mainURL=h._mainURL,e._backupURL=h._backupURL,i._switchBitRateWay&&!a){i.oldChangeDefinition(e,t);return}var g="自动"===e.definition||"auto"===e.definition;if(a)i.log(c._.LOG,"[switchBitrate:ABR], ready to switch bitRate, ",e.bitrate,e.definition);else{var m=!1;if(g)null===(y=i._abrService)||void 0===y||y.updateCurrentHDRStatus(null===(T=t)||void 0===T?void 0:T.isHDR),null===(k=i._abrService)||void 0===k||k.enable(),m=!0;else{i._abrService&&i._abrService.disable();var v,y,T,k,E,C=null===(E=l.definition)||void 0===E?void 0:E.list;if(C&&(!e.bitrate||!e.uri||!e.size||!e.duration)){for(var b=0;b<C.length;b++)if(e.definition===C[b].definition){e.bitrate=C[b].bitrate,e.uri=C[b].uri||t.uri,e.size=C[b].size||S.Z.getFileSize(e.bitrate,l.duration),e.duration=C[b].duration||i.playerConfig.duration;break}}}null===(v=i.adaptRange)||void 0===v||v.updateBitrate(e.bitrate),s.oldBit=e.bitrate,s.emit(u.Events.DEFINITION_CHANGE,{from:t,to:e}),setTimeout(function(){i._abrService&&i._abrService.updateAutoDefiDesc(s.curDefinition.definition,!g)}),m&&(e=s.curDefinition),i.log(c._.LOG,"[switchBitrate:CBS],switch bitRate, ",e.bitrate,e.definition,s.currentTime)}if(s.curDefinition=e,i.mp4.clearPCDNNodeList(),i.checkPCDN(),!!d){["keyValue","kid","secretKey","drm","getLicenseUrl","drmKeyToken","sessionId"].forEach(function(t){h[t]=e[t]});var D=i.config,L=D.kid,R=D.drmKeyToken,P=D.secretKey,x=D.keyValue,I=D.drm,O=D.reuseSecretKey,w=null;if(L||R||P||x||I)i._secretkey?!O&&i._secretkey.updateConfig(i.config):(i._secretkey=new n.XGSecretKey(i.config),i._secretkey.on(n.EVENT_EME.ERROR,i._errorHandler)),(w=i._secretkey.getLicenseSecret()).then(function(){if(!!i.player&&!!i._secretkey){var e=i.player.video||i.player.media;i._secretkey.setOptions(),i._secretkey.setupEME(e)}});else{var A=Promise.withResolvers(),N=A.promise,B=A.resolve;w=N,B()}w.then((o=(0,r.x)((0,r.l5)().mark(function n(a){var o,u,p,g,m,v,_,y,T,k,E,S,C,b;return(0,r.l5)().wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(null!=a&&a.secretKey&&(h.keyValue||(h.secretKey=a.secretKey),h.decryptKey=a.decryptKey),l.url=e.url,u=0,p=!1,g=s.getBufferedRange(),i._abrService&&i._abrService.isCurrentInAbr()?(m=Math.max(g[1],s.currentTime),u=i.getCurGopEndTime(m)):(u=i.getCurGopEndTime(),p=!0),!(u>=d.timeRange[d.timeRange.length-1].startTime)){r.next=9;break}return i.log(c._.LOG,"switch bitrate last segment, so return"),r.abrupt("return");case 9:if(v=null===(o=i._abrService)||void 0===o?void 0:o.isCurrentInAbr(),null==d||d.updateChangeBitRateTime(u),_=d.getFragmentIdx(u),!(g[1]<u)){r.next=16;break}d.fillGopData&&d.fillGopData(s.currentTime),r.next=20;break;case 16:return i.canDownload=!1,r.next=19,d.cancelLoading();case 19:d.metaLoading=!1;case 20:(y=i.getAdaptTimeRangeIdx(_))<0&&(y=i._curLoadSegmentIdx),i.log(c._.LOG,"switchBitrate point: ".concat(y),"currentTime: ".concat(s.currentTime,", timeStart: ").concat(u,", \n          buffer: ").concat(g[0]," - ").concat(g[1])),p&&s.emit("definitionSwitchTime",d.adaptTimeRange[y].startTime+1),i._definitionChangePointInfo={changeStartTime:u,changeInfo:{from:t,to:e}},i._removeBuffEndTime=u,(T=s.getBufferedRange(s.buffered))[1]>0&&T[1]>u&&(!i._abrService||!v)&&(i.removeBuffer(f.d1.VIDEO,u,T[1]),i.log(c._.LOG,"switchBitrate: ready to remove buffer, ".concat(u," - ").concat(T[1]))),(k=d.getFragmentIdx(s.currentTime))>0&&(E=s.buffered.start(0),S=d.timeRange[k].startTime-1,i.removeBuffer(f.d1.VIDEO,E,S,function(){i.log(c._.LOG,"switchBitrate: remove old bitrate buffer end",JSON.stringify(s.getBufferedRange(s.buffered)))}),i.log(c._.LOG,"switchBitrate: ready to remove pre buffer, ".concat(E," - ").concat(S))),C=d.getAdaptIdxBySrcIdx(k)+1,i.log(c._.LOG,"switchBitrate: resetFragmentLoadState, ".concat(C,",        changeBitRateIdx: ").concat(y)),d.resetFragmentLoadState(C),i._curLoadSegmentIdx=C,i.mp4.readyToChangeBitrate(e),i._setCurrentDefinition(e),i._emitDefinitionChangeDetailEvent(u),i.canDownload=!0,i._onTimeUpdate(),b={width:e.width||e.vwidth,height:e.height||e.vheight},s.emit("RESOLUTION_UPDATE",b);case 41:case"end":return r.stop()}},n)})),function(e){return o.apply(this,arguments)})).catch(function(t){i.log(c._.ERROR,"switchBitrate: GET_LICENSE_ERROR, ".concat(null==t?void 0:t.message));var r=new u.Errors(i.player,{errorType:_.iR.DRM,errorCode:_.O1.custom_drm,errorMessage:(null==t?void 0:t.message)||"GET_LICENSE_ERROR",vid:l.vid});t.errorType="GET_LICENSE_ERROR",i.emit("GET_LICENSE_ERROR",r),i.changeState("LICENSE_ERROR",{d:e.definition})})}}),(0,r._x)(i,"_onVideoError",function(e){var t,r,n=i.player;i.changeState("video_error",{code:e.code||(null==n||null===(t=n.video)||void 0===t||null===(t=t.error)||void 0===t?void 0:t.code),message:e.message||(null==n||null===(r=n.video)||void 0===r||null===(r=r.error)||void 0===r?void 0:r.message),videoType:i.useVideoLoad})}),(0,r._x)(i,"removeBuffer",function(e,t,r,n){var a,o=i.getBufferDur();null===(a=i.mse)||void 0===a||a.remove(e,t,r).then(function(){var e=i.player,t=o-i.getBufferDur();if(t>0){i.emit("removeBuffer",{removeDur:t});for(var r=[],a=0;a<e.buffered.length;a++)r.push([e.buffered.start(a),e.buffered.end(a)]);i.log(c._.LOG,"removeDur end,curBuffer:".concat(JSON.stringify(r),",\n        currentTime:").concat(i.player.currentTime))}n&&n()})}),(0,r._x)(i,"_onPlaying",function(){i._waitAdjustTimeCnt>0&&i._waitInBufferTimer&&(i._waitAdjustTimeCnt-=1,i.log(c._.WARN,"[waitInBuffer resume play], waitAdjustTimeCnt,",i._waitAdjustTimeCnt)),clearTimeout(i._waitInBufferTimer),i._waitInBufferTimer=null;var e=i.mp4,t=i.player,r=i.config.resumePlayWaterLevel;if(!e){i.checkResumePlayTimer>0&&(clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=null,t.isBufferControlPaused&&(t.isBufferControlPaused=!1),t.paused&&t.play());return}if(e&&e.meta&&e.meta.duration-t.currentTime<=r)return;if(i.waitLevelStartTime<0&&(i.waitLevelStartTime=t.currentTime),!i.playFlag&&(i.playFlag=!0),void 0!==t.isBufferControlPaused&&!(r<=0)){if(r>0&&t.currentTime-i.waitLevelStartTime>=m.Ef){var n=t.getBufferedRange(t.buffered2);n[1]>0&&n[1]-t.currentTime<r?(!t.paused&&(i.emit(m.of,{type:m.a1.WAITING}),t.pause(null===m.Im||void 0===m.Im?void 0:m.Im.BUFFER_CONTROLS),i.log(c._.LOG,"[!!!!!buffer not rich, pause],currentTime, ",t.currentTime,", bufferEnd,",n[1])),clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=setTimeout(i._onPlaying,r/2*1e3)):t.isBufferControlPaused&&t.paused&&(i.log(c._.LOG,"[!!!!!buffer rich, play],, currentTime, ",t.currentTime,", bufferEnd,",n[1]),clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=null,t.isBufferControlPaused=!1,i.emit(m.of,{type:m.a1.PLAYING}),t.play())}}}),(0,r._x)(i,"_lowDecoder",function(){var e="function"==typeof i.player.video.getStats?i.player.video.getStats():null;i.log(c._.WARN,"H265 lowdecode: ".concat(i.playerConfig.vid," "),e,", h265Degrade, ",i.config.h265Degrade),i.config.h265Degrade&&i._onDegrade()}),(0,r._x)(i,"_onError",function(e){i._onDegrade(e)}),(0,r._x)(i,"_onDegrade",function(e){var t,r,n=i.player,o=i.playerConfig,s=i.config;n.video.removeEventListener("lowdecode",i._onDegrade),n.video.removeEventListener("error",i._onError),null===(t=i.mp4)||void 0===t||t.destroy();var l=n.currentTime;if(i.log(c._.WARN,"[h265 degrade], vid,",o.vid,",currtime,",l),i.emit(x,{errc:null==e?void 0:e.errorCode,err_msg:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),CodecTypes:i.codecType,media_type:o.mediaType}),null!=s&&s.H264Config){var d=s.H264Config;["drm","getLicenseUrl","kid","keyValue","secretKey","isEncrypt","useEME"].forEach(function(e){s[e]=d[e]||null})}var u={mp4encryptplayer:s,mediaType:"video",codecType:a.u7.H264};if((null==o||null===(r=o.H264DefinitionList)||void 0===r?void 0:r.length)>0){var f=i._processArrayUrl(o.H264DefinitionList);o.H264DefinitionList=f,n.config.definition.list=f,n.config.url=f[0].url,n.config.defaultBitrate=o.H264DefinitionList[0].bitrate,n.config.defaultDefinition=o.H264DefinitionList[0].definition,i.isH265DegradeH264=!0,n.playNext(u),i.__onmetadataHandle=function(){n.currentTime=l,i.isH265DegradeH264=!1,i.log(c._.LOG,"H265DegradeH264 update currentTime",l),n.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},n.video.addEventListener("loadedmetadata",i.__onmetadataHandle)}else n.pause(),i._reset(),i.states=[],i.checkReUseMSE(!1,s.enableMsePatches),i.log(c._.ERROR,"H265 error,degrade h264 but no h264 url"),i.emit("error",e)}),(0,r._x)(i,"_onMp4MetaReady",function(e,t){if(!t||t.hasDestroyed){i.log(c._.LOG,"Mp4MetaReady but return, ".concat(!!t,", ").concat(null==t?void 0:t.hasDestroyed));return}var r=i._checkMetaInfo(e);if(r){i._errorHandler(r);return}var n=e.videoCodec,a=e.audioCodec;i._mediaCodec.videoCodec=n,i._mediaCodec.audioCodec=a;try{i._initEME(e),i.softDecode?(i.log(c._.LOG,"initMseProxy"),i._initMseProxy()):i.player.video instanceof HTMLVideoElement&&(i.log(c._.LOG,"initMse"),i._initMse(e)),i._initPromise&&i._initPromise.resolve()}catch(e){i._errorHandler(new u.Errors(i.player,{errorType:_.iR.MEDIA,errorCode:_.O1.eme_hijack,errorMessage:(null==e?void 0:e.message)||"eme or mse catch err",vid:i.playerConfig.vid}));return}if(null!=t&&t.timeRange){var o=[];t.timeRange.every(function(e){return o.push({startTime:e.startTime,endTime:e.endTime}),!0}),i.emit("KEYFRAMETIME",o)}t===i.mp4&&i._loadData()}),(0,r._x)(i,"_onMp4Error",(s=(0,r.x)((0,r.l5)().mark(function e(t){return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i._errorHandler(t);case 1:case"end":return e.stop()}},e)})),function(e){return s.apply(this,arguments)})),(0,r._x)(i,"_onMp4Progress",function(e){i.emit("progress_event",e)}),(0,r._x)(i,"_onMp4DataCallBack",function(){i._isMseInit&&i._onTimeUpdate()}),(0,r._x)(i,"_updateDrmConfig",function(e){var t=i.config;i.mp4.updateSecretKey(t.useEME,t.secretKey,t.decryptKey,t.keyValue),i._secretkey&&e.kid&&i._secretkey.updateKid(e.kid)}),(0,r._x)(i,"_updateMSE",function(e){i.player.video instanceof HTMLVideoElement&&(i.log(c._.LOG,"updateMse",e.videoCodec),i._initMse(e))}),(0,r._x)(i,"_onVideoTimeUpdate",function(){var e,t,r,n=i.mse,a=i.player;i.waitLevelStartTime<0&&(i.waitLevelStartTime=a.currentTime),i.checkReStartTimer(),i._isEnded(),a.isSeeking&&(a.isSeeking=!1),!i.useVideoLoad&&n&&i._removeBuffEndTime>0&&a.currentTime>i._removeBuffEndTime+1&&(i.log(c._.LOG,"remove old bitrate buffer,0 - ".concat(i._removeBuffEndTime)),i.removeBuffer(f.d1.VIDEO,0,i._removeBuffEndTime-1),i._removeBuffEndTime=0),a.currentTime>=(null===(e=i._definitionChangePointInfo)||void 0===e?void 0:e.changeStartTime)&&(i.needStarLoadFirstSegment=!0,(0,C.u8)()&&(i.log(c._.LOG,"definitionChangePointInfo update\n        changeDefinitionSeekState = 2\n        ".concat(a.currentTime)),a.changeDefinitionSeekState=2)),i._definitionChangePointInfo&&a.currentTime>i._definitionChangePointInfo.changeStartTime&&(a.emit(u.Events.AFTER_DEFINITION_CHANGE,i._definitionChangePointInfo.changeInfo),i.log(c._.LOG,u.Events.AFTER_DEFINITION_CHANGE,", currentTime,",a.currentTime,",from ",null===(t=i._definitionChangePointInfo)||void 0===t||null===(t=t.changeInfo)||void 0===t||null===(t=t.from)||void 0===t?void 0:t.definition," to ",null===(r=i._definitionChangePointInfo)||void 0===r||null===(r=r.changeInfo)||void 0===r||null===(r=r.to)||void 0===r?void 0:r.definition),i._definitionChangePointInfo=null),!i.useVideoLoad&&null===i._requestTimer&&(i._offineLine||i._cancelLoading||i._startProgress()),i._lastBufferPoint=a.bufferedPoint}),(0,r._x)(i,"_onBufferedReset",function(){i.mp4&&i.mp4.videoTrak&&i.mp4.resetFragmentLoadState(0)}),(0,r._x)(i,"_onOnlineHandler",function(){i._offineLine=!1;var e=i.playerConfig,t=i.player,r=t.currentTime,n=t.paused;i.log(c._.LOG,"online useVideoLoad:",i.useVideoLoad,i._hasStartProgressBack),i.useVideoLoad?(i.__onmetadataHandle=function(){r&&(t.currentTime=r),i.log(c._.LOG,"onOnlineHandler update currentTime",e.vid,i.codecType,i._currentTime),n?t.pause():t.play(),t.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},t.video.addEventListener("loadedmetadata",i.__onmetadataHandle),i._setPlayerSrc(e.url)):(i._hasStartProgressBack&&i._startProgress(),i._hasStartProgressBack=!1)}),(0,r._x)(i,"_onOfflineHandler",function(){i._offineLine=!0,i.log(c._.LOG,"offline, ",i._hasStartProgress),i._hasStartProgress&&(i._stopProgress(),i._hasStartProgressBack=!0)}),(0,r._x)(i,"_loadDataSuccess",function(e){if(!i.isDestroy&&(!!i.mse||!!i.mseProxy)){try{e.initSeg&&(i._appendInitSeg(e.initSeg),(!e.buffer||e.buffer.byteLength<1)&&i._onTimeUpdate());var t=e.buffer,r=e.state,n=e.context,a=e.videoTrack,o=e.audioTrack;if(i.debugInfo.loadIndx=n?n.fragIndex:-1,i.mse){if(r&&(!t||(null==t?void 0:t.byteLength)<=0)&&null!==(h=i.mp4)&&void 0!==h&&h.checkIsLoadEnd(null===(p=n.range)||void 0===p?void 0:p[1])){var s=i.player.buffered;i._loadedEnd=!0;var l=0;s&&(null==s?void 0:s.length)>0&&(l=s.end(s.length-1)),i._isEnded(),i.log(c._.LOG,"loaded ended !!!==>>>","range: ".concat(JSON.stringify(n.range)),"fragIndex: ".concat(n.fragIndex),"bufferEndTime: ".concat(l),"meta_duration: ".concat(i.mp4.meta.duration))}if(t&&(null==t?void 0:t.byteLength)>0){i._appendBuffer(f.d1.VIDEO,t,n,r);var d=i.getDataBitRate(n.fragIndex);i.player.emit("addVideoBufferEnd",{start:Math.floor(n.startPts),end:n.endPts,bandwidth:d.bitrate})}}else if(i.mseProxy&&(a&&a.samples.length>0||o&&o.samples.length>0)){if(a.editListApplied){var h,p,g,m=a.editList,v=a.samples,y=0;(null==m||null===(g=m.entries)||void 0===g?void 0:g.length)>0&&(y=m.entries[0].media_time),v.forEach(function(e){e.dts+=y,e.pts+=y,e.originDts+=y,e.originPts+=y}),a.baseMediaDecodeTime+=y}i.log(c._.LOG,"[xgvideo] append","index: ".concat(n.fragIndex),"range: ".concat(JSON.stringify(e.context.range)),"timeRange: ".concat(n.timeRange)),i.mseProxy.appendBuffer(a,o)}}catch(e){i.changeState("APPEND_DATA_ERROR",{errMsg:null==e?void 0:e.message});var T=new u.Errors(i.player,{errorType:_.iR.MEDIA,errorCode:_.O1.mseAppend,vid:i.playerConfig.vid,errorMessage:e.message,mediaError:{code:_.O1.mseAppend,message:e.message}});i._errorHandler(T)}null!=e&&e.state&&i._onTimeUpdate()}}),(0,r._x)(i,"_onResumePlaying",function(){i._resumePlay=!0}),(0,r._x)(i,"_seekOnce",function(e){var t=i.player;if(!!t)t.currentTime=e+.1*Math.pow(2,i._currentSeekTimes||0),i._currentSeekTimes++,i.log(c._.LOG,"当前第".concat(i._currentSeekTimes,"次Seek，currentTime=").concat(null==t?void 0:t.currentTime))}),(0,r._x)(i,"_onWaiting",function(){i.checkReStartTimer(),i._isEnded();var e,t=JSON.stringify(i.getAllBufferRange());i.changeState("waiting",{curtime:i.player.currentTime,buffer:t});var r=i.player,n=i.config,a=i.playerConfig,o=i.mp4;clearTimeout(i._waitInBufferTimer),i._waitInBufferTimer=null;var s=r.currentTime;i.log(c._.LOG,",[onWaiting],curTime, ",s,",buffer,",t,",dur,",null==o||null===(e=o.meta)||void 0===e?void 0:e.duration);var l=r.bufferedPoint;l.end>0&&(l.end-s>=2||i._loadedEnd)?i._waitAdjustTimeCnt<n.waitJampBufferMaxCnt?i._waitInBufferTimer=setTimeout(function(){i._waitAdjustTimeCnt++,i.changeState("waitInBuffer_seek",{waitAdjustTimeCnt:i._waitAdjustTimeCnt,curTime:s}),r.currentTime=r.currentTime+.5},n.waitingInBufferTimeOut):i._errorHandler(new u.Errors(i.player,{errorType:_.iR.RUNTIME,errorCode:_.O1.waitTimeout,errorMessage:"onWaitTimeout_in_buffer",vid:a.vid})):i._loadStuckCheck()}),(0,r._x)(i,"_onEnded",function(){i.log(c._.LOG,"[player.onEnded], stopProgress"),i._stopProgress()}),(0,r._x)(i,"_errorHandler",function(e){i._setPlayerError(e);var t=i.player,n=i.playerConfig,o=i.preLoadData;if(!!t&&!i.useVideoLoad){if(e.errorCode===_.O1["403"]&&i._emitExpireEvent(e)&&i.config.urlExpireDisableErrorEvent){i.log(c._.LOG,"_errorHandler urlExpireDisableErrorEvent",i.config.urlExpireDisableErrorEvent,",errorCode,",e.errorCode),i._stopProgress(),i.emit(P);return}if("object"!==(0,r.Ac)(e)){var s={};s.err=e,e=s}!e.ext&&(e.ext={});var l=t.paused;if(e.ext.vid=n.vid,e.ext.preloadHit=i.hitpreload?1:0,e.ext.preloadCached=o?o.duration:0,e.ext.timerStep=Math.max.apply(Math,(0,r.u)(i.timerStepList)),e.ext.codectype=i.codecType,e.message&&(e.errorMessage=e.message),e=new u.Errors(t,e),i.log(c._.ERROR,"_errorHandle","preState is ".concat(l),null===(d=e)||void 0===d?void 0:d.errorCode,e.errorMessage),e.url||(e.url=t.src),i.player.emit("playCatch",i.player.vtype,e),e.errd&&"object"===(0,r.Ac)(e.errd)&&i.mp4&&(e.errd.url=i.mp4.url,e.url=i.mp4.url),i.emit("DATA_REPORT",e),i.mp4&&i.mp4.cancelLoading(),i._abrService&&i._abrService.disable(),i.canDownload=!1,i.checkIsDegraded(e))i.player.vtype=a.l0.MP4_2,i._initPromise&&i.removeAndRejectInitPromise(e),i._startDegradedPlayback(e,l);else{i.log(c._.ERROR,"final error !!!!, ",n.vid,null===(f=e)||void 0===f?void 0:f.errorCode,null===(h=e)||void 0===h?void 0:h.errorMessage),i.player.pause(),i._reset(),i.states=[];var d,f,h,p,g,m=t.currentTime;i._destroyMSE(),t.currentTime=m,i.emit("error",e),i._setStartTimelines(a.l1.PLAY_ERROR,{message:null===(p=e)||void 0===p?void 0:p.message,httpCode:null===(g=e)||void 0===g?void 0:g.errorCode})}i.emit(P)}}),(0,r._x)(i,"_onSourceError",function(e){if(!i._hasFirstFramed){if(!(null!==(t=e.message)&&void 0!==t&&t.includes("PCDN"))){var t,r,n,o,s="".concat(i.player.vtype,"-host:").concat(null==e?void 0:e.host,"-").concat(null==e?void 0:e.errorCode,"-").concat(null!==(r=null==e||null===(n=e.mediaError)||void 0===n?void 0:n.message)&&void 0!==r?r:null==e?void 0:e.message);i._setStartTimelines(a.l1.HTTP_ERROR,{message:s,httpCode:null==e?void 0:e.errorCode}),null===(o=i._startTimelines)||void 0===o||null===(o=o.httpError)||void 0===o||o.push({message:s,httpCode:null==e?void 0:e.errorCode})}}}),(0,r._x)(i,"_onSeeking",(0,r.x)((0,r.l5)().mark(function e(){var t,n,a,o,s,l,d,u,h,p,g,m,v,_,y;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.useVideoLoad){e.next=2;break}return e.abrupt("return");case 2:if(a=(n=i).player,o=n.mp4,s=n.mse,l=n.config,3!==a.changeDefinitionSeekState){e.next=7;break}return a.changeDefinitionSeekState=void 0,i.log(c._.LOG,"[seeking] changeDefinitionSeekState clear"),e.abrupt("return");case 7:if(d=a.currentTime,u=a.bufferedPoint,i.waitLevelStartTime=d,i.changeState("seeking",{curTime:d,buffered:u,lastBuffered:i._lastBufferPoint}),i.log(c._.LOG,"[seeking], curTime: ".concat(d,", duration: ").concat(null==o||null===(t=o.meta)||void 0===t?void 0:t.duration),"buffer: ".concat(JSON.stringify(i.getAllBufferRange()))),!(!o||!o.meta)){e.next=15;break}return l.enableMsePatches&&o&&!o.meta&&d>=0&&(o.seekTimeAfterMetaReady=d),e.abrupt("return");case 15:if(i._startProgress(),o.bufferUsedPos=0,o.metaLoading=!1,i._loadedEnd=!1,i._definitionChangePointInfo&&(i._definitionChangePointInfo.changeStartTime=d,i.log(c._.LOG,"[seeking update definitionChangePointInfo]",d)),o.changeBitRateTime>0&&(o.updateChangeBitRateTime(d),i.log(c._.LOG,"[seeking update changeBitRateTime]",d)),h=0,!(u.end>0)){e.next=30;break}if(!(i.isSeekingInSameBuffer(d,u)&&(!l.enableMsePatches||o.checkInAdaptTimeRange(u)))){e.next=26;break}return i.log(c._.LOG,"[seeking in buffered], linear buffer, curTime: ".concat(d,", buffered: ").concat(u.start,"-").concat(u.end)),e.abrupt("return");case 26:o.seekTime=u.end,i.log(c._.LOG,"[seeking in buffered], but is not continuous: ".concat(u.start,"-").concat(u.end)),e.next=32;break;case 30:o.seekTime=d,i.log(c._.LOG,"[seeking out buffered], seekTime: ".concat(d));case 32:return p=o.getFragmentIdx(o.seekTime),h=(g=i.getAdaptTimeRangeIdx(p))<0?i._curLoadSegmentIdx:g,o.seekTime===d&&null!=s&&s.isFull()&&(v=(m=i.getAllBufferRange())[m.length-1],i._checkRemovePlayedBuffer([v.start,v.end],d,!0,!0)),i.log(c._.LOG,"[seekTime resetFragmentLoadState], adaptIdx: ".concat(h)),o.resetFragmentLoadState(h),null==s||s.clearOpQueues(f.d1.VIDEO,!!l.enableMsePatches),1===a.changeDefinitionSeekState?null==s||s.remove(f.d1.VIDEO,0,1/0).then(function(){a.changeDefinitionSeekState=2,i.log(c._.LOG,"[seeking], changeDefinitionSeek remove buffer end, changeDefinitionSeekState = 2")}):l.removeBufferAtSeek&&(_=o.seekTime,y=1/0,i.log(c._.LOG,"[seeking mse remove], ".concat(_,"-").concat(y)),null==s||s.remove(f.d1.VIDEO,_,y)),i.canDownload=!1,e.next=43,o.cancelLoading();case 43:i.canDownload=!0,o.fillFirstSegment=!1,i._curLoadSegmentIdx=h,i._onTimeUpdate(),i._isEnded();case 48:case"end":return e.stop()}},e)}))),i.initLog(null===(t=i.player.playerId)||void 0===t||null===(t=t.toString())||void 0===t?void 0:t.slice(-4)),i.log(c._.LOG,"plugin version: ".concat(L.i),"playerId: ".concat(i.playerId),"vid: ".concat(i.playerConfig.vid)),i._pendingPromises=[],i._allInitPromise=new D.Z,i._isInit=!1,i._isEventInit=!1,i.preloader=null,i._useVideoLoad=!1,i.mse=null,i.mp4=null,i.eme=null,i._isMseInit=!1,i._corePromise=null,i._initPromise=null,i._hasStartProgress=!1,i._hasStartProgressBack=!1,i._curLoadSegmentIdx=0,i._abrService=null,i._checkRemoveBufferLastTime=S.Z.nowTime(),i.playFlag=!1,i.config.resumePlayWaterLevel=Math.min(i.config.minBufferLength,i.config.resumePlayWaterLevel),i.checkResumePlayTimer=null,i._MSEError=!1,i._waitAdjustTimeCnt=0,i._waitInBufferTimer=null,i.isActive=!0,i.debugInfo={},i.seekTimeAfterMetaReady=void 0,i._suspendLoading=!1,i.states=[],i.removeVideoList=[],i._lastCheckTime=S.Z.nowTime(),i._lastCheckLagTime=S.Z.nowTime(),i._changeDefState=null,i._defInited=!1,i._removeBuffEndTime=0,i._lastTimeupdateTime2=0,i.waitLevelStartTime=-1,i.preLoadData=null,i.forPreloadTimeCache=null,i._usePaused=!1,i.hitpreload=!1,i.isH265DegradeH264=!1,i.loadstartTimer=null,i.loadedmetadataTimer=null,i.loadeddataTimer=null,i.canplayTimer=null,i.adaptRangeRes=[],i._definitionChangePointInfo=null,i._lastTimeupdateTime2=0,i.waitLevelStartTime=-1,i.timerStepList=[],i._isH265SoftDecoder=!1,i._beforeLoadStartCostTime=0,i._requestTimer=null,i.firstFrameCostTime={},i._mediaCodec={videoCodec:"",audioCodec:""},i._setTimelineData(),i._updatePropsByConfig(),i.player._customExpiryCheck=i.config.enableCusExpiryCheck,i._bindSrcTiming=m.Iv.META_READY,i}return(0,r.XW)(F,e),(0,r.qH)(F,[{key:"_setTimelineData",value:function(){this._startTimelines={startstage:-1,startmessage:"",httpCode:-1,httpError:[],reqtime:-1,downgradetime:-1,fcost:-1,ffcost:-1,startbufferlength:-1,playerError:"",startdelta:-1,loadstarttime:-1,loadeddatatime:-1,loadstarttype:-1,loadeddatatype:-1,playtime:-1,playerstate:-1},this._hasFirstFramed=!1}},{key:"setConfig",value:function(e){this.config=Object.assign(this.config,e),this._updatePropsByConfig()}},{key:"_updatePropsByConfig",value:function(){this._maxBufferLength=this.config.maxBufferLength,this._minBufferLength=this.config.minBufferLength,this._nextBufferLength=this.config.nextBufferLength,this._switchBitRateWay=this.config.switchBitRateWay,this._tickInSeconds=this.config.tickInSeconds||m._X}},{key:"initLog",value:function(e){var t=this.config.logCacheConfig,i=t.logCacheLevel,r=t.logMaxSize;this.logger=new c.Y(F.pluginName+e,{logCacheLevel:i,logMaxSize:r}),b.i5&&c.Y.enable()}},{key:"playerlogger",value:function(e){e?c.Y.enable():c.Y.disable()}},{key:"_setStartTimelines",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this._hasFirstFramed&&this._startTimelines){this._startTimelines.startstage=e,this._startTimelines.startmessage="".concat(a.sm[e]||"","-").concat((null==t?void 0:t.message)||"");var i=this._startTimelines.httpCode;this._startTimelines.httpCode=-1!==i?i:(null==t?void 0:t.httpCode)||-1,e===a.l1.PLAYER_ERROR&&(this._startTimelines.playerError=(null==t?void 0:t.message)||"")}}},{key:"afterCreate",value:function(){var e=this,t=this.playerConfig,i=this.config,n=this.player;if(i.width=t.width||0,i.height=t.height||0,t.vid=t.vid||i.vid,"object"!==(0,r.Ac)(i.reqParams)&&(i.reqParams={}),!f.d1.isSupported('video/mp4; codecs="avc1.64001E, mp4a.40.5"')){this._setStartTimelines(a.l1.NOT_SUPPORTED);return}void 0===i.supportHevc&&null!==u.Sniffer&&void 0!==u.Sniffer&&u.Sniffer.isHevcSupported&&u.Sniffer.isHevcSupported()&&this.player.video instanceof HTMLVideoElement&&(i.supportHevc=!0),void 0===i.supportVvcc&&(i.supportVvcc=(0,C.E0)()),this.softDecode?n.vtype=a.l0.MP4_MSE_SOFT:n.vtype=a.l0.MP4_MSE,(!(0,C.KI)()||this.softDecode)&&(i.useEME=!1),i.useEME=!1!==i.useEME,this.checkConfig(),i.onlyInit&&(t.autoplay=!1,t.videoInit=!1,this._hasStartProgress=!1,this._hasStartProgressBack=!1),t.useWaterLevel&&(t.userGestureEventMiddleware||(t.userGestureEventMiddleware=E.Ru),t.videoEventMiddleware||n.setEventsMiddleware(E.f4)),this._proxyPlayer(),n.useHooks("replay",this._replayHook),n.useHooks("play",this._playHook),n.useHooks("pause",this._pauseHook),n.useHooks("retry",this._retryHook),this.on("source_error",this._onSourceError),this.on("error",this._onSourceError),n.video.addEventListener(m.fD.BUFFERED_RESET,this._onBufferedReset),this._bindNetworkStateChange(),this.on(u.Events.TIME_UPDATE,this._onVideoTimeUpdate),this.on(u.Events.LOADED_DATA,function(){var t;-1===e._startTimelines.loadeddatatime&&(e._startTimelines.loadeddatatime=S.Z.nowTime(),e._startTimelines.loadeddatatype=n.vtype===a.l0.MP4_MSE?1:2),e.loadedDataEventRev=!0,e.changeState("LOADED_DATA"),e.deleteVideo(),e.mp4&&e.mp4.updateLoadedDataDone(),e._onTimeUpdate(),null!==(t=e.config)&&void 0!==t&&t.enableFPSStuckHandle&&e.on(u.Events.FPS_STUCK,e.fpsStuckHandle)}),this.on(u.Events.LOAD_START,function(){e.changeState("LOAD_START"),e._bindSrcTiming===m.Iv.META_READY?e._beforeLoadStartCostTime=new Date().getTime()-e._tm:e._beforeLoadStartCostTime=0,e.log(c._.LOG,"mp4plugin loadstart",e._beforeLoadStartCostTime),-1===e._startTimelines.loadstarttime&&(e._startTimelines.loadstarttime=S.Z.nowTime(),e._startTimelines.loadstarttype=n.vtype===a.l0.MP4_MSE?1:2),e.codecType===a.u7.H265&&!e.config.supportHevc&&(e._isMseInit=!0,e._onTimeUpdate())}),this.on(u.Events.ENDED,function(){e.log(c._.LOG,"mp4plugin receive player video ended event"),e._onEnded()}),this.on(u.Events.PAUSE,function(){e._usePaused=!0}),this.on(u.Events.PLAY,function(){e._usePaused=!1}),this.on(u.Events.AUTOPLAY_STARTED,function(){e._startTimelines&&(e._startTimelines.playtime=S.Z.nowTime())}),this.on("xglog",function(t){if("firstFrame"===t.eventType){var i,r=e.preLoadData&&e.preLoadData.definition?e.preLoadData.definition:-1,n=e.player;e._startTimelines.fcost=S.Z.nowTime()-e._startTimelines.reqtime,e._startTimelines.ffcost=t.fvt,e._hasFirstFramed=!0,e.log(c._.DEBUG,"[xgplayer-encrypt-mp4]>>>>firstFrame ".concat(e.playerConfig.vid,", ").concat(t.fvt,", codecType: ").concat(e.codecType),"hitPreload: ".concat(e.hitpreload,", video: ").concat(e._useVideoLoad,", preloadBitrate: ").concat(r),"curDefinition: ".concat(null===(i=n.curDefinition)||void 0===i?void 0:i.definition))}}),n.mp4MseFlag=!0}},{key:"_startBufferCheck",value:function(){var e=this.player;if(!e.video)return;var t=[];if(!!e.video.buffered){for(var i=0,r=e.video.buffered.length;i<r;i++)t.push([e.video.buffered.start(i),e.video.buffered.end(i)]);t.toString()!==this.lastBuffer&&(this.lastBuffer=t.toString(),this._onBufferReachThreshold())}}},{key:"_onBufferReachThreshold",value:function(){var e=this.player,t=this.config;if(e.video){for(var i=e.video.buffered,r=0,n=0,a=0;a<i.length&&(r=i.start(a),n=i.end(a),!(r<=e.video.currentTime)||!(e.video.currentTime<=n));a++);n-e.video.currentTime>=t.bufferThreshold&&!this._hasTriggerBufferThreshold&&(this._hasTriggerBufferThreshold=!0,e.emit("BUFFER_THRESHOLD",n-e.video.currentTime))}}},{key:"_startUrlExpiredCheck",value:function(){var e,t,i,r=this.player;if(null!==(e=this.expiryCheckPlugin)&&void 0!==e&&null!==(e=e.config)&&void 0!==e&&e.useCdnExpiryTime){null===(t=(i=this.expiryCheckPlugin).handleUrlExpiryCheckByCdnPath)||void 0===t||t.call(i);return}var n=r.config;n.definition&&n.definition.list&&n.definition.list.length>0&&(this.urlExpireTimestamp=n.definition.list[0].url_expire||0,this._handleUrlExpire())}},{key:"cancelLoading",value:(t=(0,r.x)((0,r.l5)().mark(function e(){var t,i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.mp4){e.next=2;break}return e.abrupt("return");case 2:return this._cancelLoading=!0,this.log(c._.LOG,"player cancelLoading",this.playerConfig.vid),this._stopProgress(),null===(t=this.preloader)||void 0===t||null===(i=t.cancelLoading)||void 0===i||i.call(t),e.next=8,this.mp4.cancelLoading();case 8:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"suspendLoading",value:function(){var e,t=this.mp4;if(!!t&&!this._suspendLoading)this._suspendLoading=!0,this.log(c._.LOG,"player suspendLoading",this.playerConfig.vid),this._stopProgress(),null!=t&&null!==(e=t.adaptTimeRange[this._curLoadSegmentIdx])&&void 0!==e&&e.isLoading&&(t.resetFragmentLoadState(this._curLoadSegmentIdx,!0),this.cancelLoading())}},{key:"resumeLoading",value:function(){if(!!this.mp4&&!!this._suspendLoading)this._suspendLoading=!1,this.log(c._.LOG,"player resumeLoading",this.playerConfig.vid),this._startProgress()}},{key:"checkConfig",value:function(){var e=this.playerConfig,t=this.config,i=e.defaultDefinition,r=e.defaultBitrate;if(!i){var n=this.playerConfig.definition;i=n&&n.defaultDefinition?n.defaultDefinition:t.definition}!r&&t.bitrate&&(r=t.bitrate),e.defaultDefinition=i,e.defaultBitrate=r}},{key:"beforePlayerInit",value:function(){var e=this,t=this.player,i=this;!this._isInit&&(u.BasePlugin.defineGetterOrSetter(t,{__url:{get:function(){return i.mse?i.mse.url:t.config.url},configurable:!0},downloadSpeed:{get:function(){return N/8},configurable:!0},playerVersion:{get:function(){return L.i},configurable:!0},menuCodeType:{get:function(){return i.mp4&&i.mp4.meta?i.mp4.meta.videoCodec:i.codecType===a.u7.H264?"avc":"hevc"},configurable:!0},playerType:{get:function(){return"MP4"},configurable:!0},supportMenus:{get:function(){return{speed:null==t?void 0:t.mp4MseFlag,cdn:null==t?void 0:t.mp4MseFlag,resolution:null==t?void 0:t.mp4MseFlag}},configurable:!0},preloadActive:{get:function(){return e.isActive},set:function(t){e.isActive=t,e.isActive&&e._startProgress()},configurable:!0},performance:{get:function(){var t={};return e.states.forEach(function(e){t[e.state.toLowerCase()]=e.t2}),t},configurable:!0},domain:{get:function(){return i.domain},configurable:!0},loadURL:{get:function(){return i.loadURL},configurable:!0},abrInstance:{get:function(){return i.abrInstance},configurable:!0},pcdnReq:{get:function(){var e=o.e.pcdnReqCnt,t=y.Yx.pcdnDownLoadReqCnt;return{pcdn_tracker_request_cnt:e.pcdn_tracker_request_cnt,pcdn_tracker_failed_cnt:e.pcdn_tracker_failed_cnt,pcdn_download_request_cnt:t.pcdn_download_request_cnt,pcdn_download_failed_cnt:t.pcdn_download_failed_cnt}},configurable:!0},retryInfo:{get:function(){return y.Tw},configurable:!0},softDecoder:{get:function(){return e._isH265SoftDecoder},configurable:!0},logCache:{get:function(){if(!!i.logger){var t,r,n,a="";try{a=JSON.stringify(e.config)}catch(e){a="config stringify error"}return i.log(c._.LOG,"timerStepList, ".concat(JSON.stringify(e.timerStepList),",\n            currentTime: ").concat(null===(t=i.player)||void 0===t?void 0:t.currentTime,"\n            buffer, ").concat(JSON.stringify(i.getAllBufferRange()),",\n            state: ").concat(JSON.stringify(i.states),",\n            isActive:").concat(i.isActive,",\n            preRangeType: ").concat(null===(r=i.player)||void 0===r||null===(r=r.preloader)||void 0===r||null===(r=r._config)||void 0===r?void 0:r.loadRangeType,",\n            loadRangeType: ").concat(null===(n=i.config)||void 0===n?void 0:n.loadRangeType,",\n            Mp4EncryptPlayer version, ").concat(L.i,",\n            Mp4EncryptPlayer config, ").concat(a)),i.logger.getLogCache()}},configurable:!0},pcdnVVStat:{get:function(){var e,t=i.mp4,n=i.pcdn;return t?(0,r.Zj)((0,r.Zj)({},t.pcdnVVStat),{},{trace_id:null===(e=t.pcdnTraceInfo)||void 0===e?void 0:e.trace_id,cancelCnt:(null==t?void 0:t.pSCCancelCnt)||0,is_try_open:n?1:0}):null},configurable:!0},beforeLoadStartCostTime:{get:function(){return e.useVideoLoad?0:e._beforeLoadStartCostTime},configurable:!0},mediaCodec:{get:function(){return e._mediaCodec},configurable:!0},bandwidth:{get:function(){var e,t,n=i.mp4,a=n?n.loadInfo:null;return{vid:null===(e=i.playerConfig)||void 0===e?void 0:e.vid,cdn:{speed:null==a||null===(t=a[y._R.CDN])||void 0===t?void 0:t.loadSpeed,size:a&&a[y._R.CDN]?a[y._R.CDN].loadLen:0},pcdn:(0,r.Zj)({size:a&&a[y._R.PCDN]?a[y._R.PCDN].loadLen:0},null==n?void 0:n.pcdnTraceInfo)}},configurable:!0},ext:{get:function(){var e,t,r,n,a,o,s,l,d=[];if((null===(e=i.player)||void 0===e||null===(e=e.video)||void 0===e||null===(e=e.buffered)||void 0===e?void 0:e.length)>0){for(var u=i.player.video.buffered,c=0,f=(null==u?void 0:u.length)||0;c<f;c++)d.push([u.start(c),u.end(c)])}return{type:"MP4",version:L.i,usevideo:i.useVideoLoad?1:0,curTime:null===(t=i.player)||void 0===t?void 0:t.currentTime,duration:(null===(r=i.mp4)||void 0===r||null===(r=r.meta)||void 0===r?void 0:r.duration)||(null===(n=i.player)||void 0===n?void 0:n.duration),loadIdx:i._curLoadSegmentIdx,curload:null!==(a=i.mp4)&&void 0!==a&&a.adaptTimeRange?i.mp4.adaptTimeRange[i._curLoadSegmentIdx]:{},buffer:d,speed:null===(o=i.debugInfo)||void 0===o?void 0:o.speed,states:null==i?void 0:i.states,loadRangeType:null===(s=i.config)||void 0===s?void 0:s.loadRangeType,preRangeType:null===(l=i.player)||void 0===l||null===(l=l.preloader)||void 0===l||null===(l=l._config)||void 0===l?void 0:l.loadRangeType}},configurable:!0},currentDefinitionFromPlayer:{get:function(){return i.abrInstance&&i.abrInstance.isCurrentInAbr?t._currentDefinitionFromPlayer:t.curDefinition},configurable:!0},currentDefitionFromPlayer:{get:function(){return t.currentDefinitionFromPlayer},configurable:!0},startTimelines:{get:function(){if(e._startTimelines){var i=S.Z.nowTime();e._startTimelines.startuploadtime=i;var r=t.vtype!==a.l0.MP4_MSE?e._startTimelines.downgradetime:e._startTimelines.reqtime;if(e._startTimelines.startdelta=i-r,e._startTimelines.firstframedp=e._hasFirstFramed?1:0,e._startTimelines.playerstate=t.state,!e._hasFirstFramed){var n=t.getBufferedRange();e._startTimelines.startbufferlength=n[1]-n[0],e.emit(P)}}return JSON.parse(JSON.stringify(e._startTimelines))},configurable:!0},encryptedInfo:{get:function(){var t,i=0;return e._secretkey&&(i=null!==(t=e._secretkey.config)&&void 0!==t&&t.useEME?1:2),{encryptedType:i}},configurable:!0}}),this._isInit=!0)}},{key:"destroy",value:function(){var e,t,i=this.player,r=this.config;i.preloader&&i.preloader.removePlayingId(i.playerId),i.removeHooks("replay",this._replayHook),i.removeHooks("play",this._playHook),i.removeHooks("pause",this._pauseHook),i.removeHooks("retry",this._retryHook),null===(e=this._requestTimer)||void 0===e||e.destroy(),this._requestTimer=null,this._reset(),this.states=[],this.checkReUseMSE(!1,r.enableMsePatches),this._secretkey&&(this._secretkey.off(n.EVENT_EME.ERROR,this._errorHandler),this._secretkey.destroy()),this.player.playNext=O,this.player._startInit=w,this.player.changeDefinition=M,this.player.switchURL=A,this._unbindNetworkStateChange(),this._unbindEvents(),i.video&&i.video.removeEventListener(m.fD.BUFFERED_RESET,this._onBufferedReset),this._bufferCheckTimer&&clearInterval(this._bufferCheckTimer),this._removeBufferTimer&&(clearTimeout(this._removeBufferTimer),this._removeBufferTimer=null),(null===(t=this.logger)||void 0===t?void 0:t.reset)&&this.logger.reset(),this.timerStepList=[]}},{key:"_proxyPlayer",value:function(){var e=this;"function"==typeof this.player.playNext&&(O=this.player.playNext),this.player.playNext=function(){e.playNext.apply(e,arguments)},w=this.player._startInit,A=this.player.switchURL,M=this.player.changeDefinition,this.player._startInit=this.playerStartInit.bind(this),this.player.switchURL=this.switchURL.bind(this),this.player.changeDefinition=this.changeDefinition.bind(this)}},{key:"getInitBitrate",value:function(){var e=this.player,t=this.playerConfig,i=null,r=e.definitionList;if(r&&r.length>0){var n={},a=e.preloader;if(a){var o=a.getPreloadMetaByVid(t.vid);if(o){var s=a.getDataUniqueKey(o),l=(0,E.Vh)(o,r);l?(l.cacheKey=s,(i=l).type="preload",i.preLoadMeta=o,n={m:1,t:2,ck:s}):n={m:0,t:1,ck:s}}}else n={t:0};if(this.changeState(m.fp.PRELOAD_CHECK,n),i&&t.userSelectDefinition&&t.focusUserDefinition){var d={m:1,ud:t.userSelectDefinition,d:i.definition};t.userSelectDefinition!==i.definition&&(i=null,d.m=1),this.changeState(m.fp.USER_DEFI_CHECK,d)}!i&&this.bitRateAdapter&&(this.bitRateAdapter.speed=y.Yx.speed,(i=this.getDefinitonFromAdapter(r,t.userSelectDefinition))&&(i.type="bitRateAdapter"))}if(!i||!i.url){var c,f=(null===(c=t.definition)||void 0===c?void 0:c.defaultDefinition)||t.defaultDefinition;if("Array"===u.Util.typeOf(t.url)&&t.url.length>0||"String"===u.Util.typeOf(t.url)&&t.url){var h=this._getDefinitionItem(f),p=t.defaultBitrate||t.bitrate||(null==h?void 0:h.bitrate);i={url:t.url,definition:(null==h?void 0:h.definition)||f||-1,duration:(null==h?void 0:h.duration)||t.duration||this.config.duration||0,bitrate:p,uri:t.uri||(null==h?void 0:h.uri),file_id:null==h?void 0:h.file_id,size:(null==h?void 0:h.size)||t.size,type:"default"}}else i=r[r.length-1]}return this.playerConfig.url=i.url,i.networkSpeed=y.Yx.speed,e.curDefinition=i,i}},{key:"_setPlayerSrc",value:function(e){var t=this.player;this._removeVideoSource();var i="Array"===u.Util.typeOf(e);e=i?this._processArrayUrl(e):this._processUrl(e),i?(t.video.removeAttribute("src"),t._detachSourceEvents||e.forEach(function(e){t.video.appendChild(u.Util.createDom("source","",{src:"".concat(e.src),type:"".concat(e.type||"")}))}),t._attachSourceEvents(t.video,e)):t.video.src=e,t.play(),t.mp4MseFlag=!1,t.emit("playertypechange"),this._startTimelines.downgradetime=S.Z.nowTime()}},{key:"_removeVideoSource",value:function(e){var t=this.player,i=(e=e||t.video).children;if(i.length>0)for(t._detachSourceEvents(e);i.length>0;)e.removeChild(i[0])}},{key:"_getDefinitionItem",value:function(e){var t=this.playerConfig;if(!t.definition||!t.definition.list)return null;for(var i=0;i<t.definition.list.length;i++){var r=t.definition.list[i];if(r.definition===e)return r}return null}},{key:"_initAbrDefinition",value:function(){var e,t=this.player,i=this.playerConfig;if(i.definition.list.length>0&&(!t.curDefinition&&(t.curDefinition=i.definition.list[0]),!t.curDefinition.vwidth&&Object.assign(t.curDefinition,this._getDefinitionItem(t.curDefinition.definition)),this._abrService.updateAbrCacheData()),this._abrService&&this._abrService.isCurrentAutoDefi){var r=i.definition.list.length;t.curDefinition=i.definition.list[r-1]}for(var n=0;n<i.definition.list.length;n++){var a=i.definition.list[n];t.curDefinition.definition===a.definition?a.selected=!0:a.selected=!1}this.player.emit("resourceReady",i.definition.list);var o=null===(e=t.curDefinition)||void 0===e?void 0:e.bitrate;if(!o)for(var s=0;s<i.definition.list.length;s++){var l=i.definition.list[s];l.definition===t.curDefinition.definition&&(o=l.bitrate)}o&&this._abrService.updateBitrate(o)}},{key:"_initAbrService",value:(i=(0,r.x)((0,r.l5)().mark(function e(){var t,i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.playerConfig,!(!(i=this.config).autoBitrateOpts||!i.autoBitrateOpts.isOpenAutoDefi)){e.next=3;break}return e.abrupt("return");case 3:return this._abrService=new p.Z(this,this.abrSwitchURL),e.next=6,this._abrService.init({video:t.definition.list.concat()});case 6:this._initAbrDefinition();case 7:case"end":return e.stop()}},e,this)})),function(){return i.apply(this,arguments)})},{key:"_initMp4Kernel",value:function(){var e=this,t=this.playerConfig,i=this.config,r=new D.Z;try{var n=this.player.curDefinition;if(this.log(c._.LOG,"[_initMp4Kernel] ".concat(t.vid," curDefinition"),null==n?void 0:n.definition),!this._handlerUrl(t.url))return this.log(c._.LOG,"emptyUrl"),r.reject(Error("emptyUrl")),r;if(i.forceVideoPlay&&(this.codecType===a.u7.H264||i.supportHevc))return this.useVideoLoad=!0,this.log(c._.LOG,"forceVideoPlay"),r.reject(Error("forceVideoPlay")),r;var o=[];this._secretkey&&o.push(this._secretkey.getLicenseSecret()),o.push(this._checkPreloader()),Promise.all(o).then(function(t){if(e.isDestroy){r.reject(Error("destroy"));return}var o=null;if(t&&t.length>0&&(t.length>1&&(!i.keyValue&&t[0].secretKey&&(i.secretKey=t[0].secretKey),i.decryptKey=t[0].decryptKey),o=t[t.length-1].data),!o&&i.needPreloadCheck&&(e.codecType!==a.u7.H265||i.supportHevc))e.useVideoLoad=!0,e.log(c._.LOG,"no_preload"),r.reject(Error("no_preload"));else if(e.vtype&&"MP3"===e.vtype)e.useVideoLoad=!0,e.log(c._.LOG,"vtype_not_MP4"),r.reject(Error("vtype_not_MP4"));else{var s,l=i._mainURL;e._initMp4(l,o,{fileSize:n?n.size:0}),e.updateLoadInfo(null===(s=o)||void 0===s?void 0:s.cacheKey),e.checkPCDN(),e.initAdaptRange(),e._initAbrService()}}).catch(function(i){e.log(c._.ERROR,"getLicense or checkPreloader reject",null==i?void 0:i.message,null==i?void 0:i.stack);var a,o,s,l=(null==i||null===(a=i.error)||void 0===a?void 0:a.code)||("getLicense"===i.method?_.O1.custom_drm:_.O1.other),d=(null==i?void 0:i.message)||(null==i||null===(o=i.error)||void 0===o?void 0:o.message)||"getLicense or checkPreloader reject";"getLicense"===i.method?(s=new u.Errors(e.player,{errorType:_.iR.DRM,errorCode:l,errorMessage:d,vid:t.vid}),e.emit("GET_LICENSE_ERROR",s),e.changeState("LICENSE_ERROR",{d:n?n.definition:0})):s=new u.Errors(e.player,{errorType:_.iR.OTHER,errorCode:l,errorMessage:d,vid:t.vid}),r.reject(s)})}catch(e){r.reject(e)}return r}},{key:"updateLoadInfo",value:function(e){var t;if(!!e&&!!this.mp4)this.mp4.loadInfo=null===(t=this.preloader)||void 0===t?void 0:t.getLoadInfoAndDelete(e)}},{key:"initAdaptRange",value:function(){var e=this.config,t=this.player,i=this.playerConfig,r=t.curDefinition,n=r.bitrate,a=r.duration;null!=e&&e.adaptRange&&(this.adaptRange=new s.Q(t,n,a||i.duration,e.adaptRange))}},{key:"getPCDNReqId",value:function(){var e=this.player.curDefinition,t=this.playerConfig.vid;return e.uri?e.uri.slice(-20)+e.bitrate:t?t.slice(-20)+e.bitrate:void 0}},{key:"checkPCDN",value:function(){var e,t=this,i=this.config,r=this.player,n=this.mp4,a=r.curDefinition;if(null!==(e=i.pcdnConfig)&&void 0!==e&&e.openPCDN&&a.duration>=i.pcdnConfig.minDuration){i.pcdnConfig.app_id&&(m.tE.app_id=i.pcdnConfig.app_id),i.pcdnConfig.sid&&(m.tE.sid=i.pcdnConfig.sid);var s,l=i._mainURL;if(!a.uri||!a.bitrate||0>=l.indexOf("video/")){this.log(c._.LOG,"uri null or bitrate null or url not contain video cannot use pcdn"),this.pcdn=null;return}!(0,E.Pj)(l)&&(l=document.location.protocol+l);var d={vid:a.uri,sfid:a.file_id,cdn_url:l,file_type:null===(s=this.vtype||"MP4")||void 0===s?void 0:s.toLowerCase(),bitrate:a.bitrate,duration:Math.floor((null==a?void 0:a.duration)||0),size:(null==a?void 0:a.size)||S.Z.getFileSize(a.bitrate,a.duration)};if(this.pcdn)this.pcdn.resetTrackeArgs();else{var u=Object.assign({},{productConfig:m.tE},i.pcdnConfig),f=d.bitrate,h=d.duration;this.pcdn=new o.e(u,r,f,h)}this.pcdn.fetchPCDNNode(null,d,this.getPCDNReqId()).then(function(e){var i,r,a=t.getPCDNReqId();if(null!=e&&e.req_id&&a!==e.req_id){t.log(c._.LOG,",fetchPCDNNode is not match curDefinition reqId",a,", pcdnRet.req_id",e.req_id);return}n&&e&&(t.log(c._.LOG,"".concat(t.playerConfig.vid," get peer end,pcdn node update,"),null==e||null===(i=e.nodes)||void 0===i?void 0:i.length),n.updateNode(null==e?void 0:e.nodes),n.pcdnTraceInfo={uri:e.vid,fid:e.fid,trace_id:null==e?void 0:e.trace_id},n.pcdnVVStat&&(n.pcdnVVStat.try_req_node+=1,n.pcdnVVStat.req_node_succ+=1,n.pcdnVVStat.has_ret_node+=(null==e||null===(r=e.nodes)||void 0===r?void 0:r.length)>0?1:0))}).catch(function(e){(null==n?void 0:n.pcdnVVStat)&&(n.pcdnVVStat.try_req_node+=1),t.checkURLExpired(e,"_fetchPCDNNode")})}else this.pcdn=null}},{key:"initTimer",value:function(){if(!this._requestTimer){var e=this.config.timerInWorker;this._requestTimer=new v.f({frequency:this._tickInSeconds,timerInWorker:e}),this._requestTimer.on(m.sW,this.timerHandle)}}},{key:"playerStartInit",value:(d=(0,r.x)((0,r.l5)().mark(function e(t){var i,o,s,l,d,h,p,g,v,y,T,k,C,b,D,L,x,I,O,w,M,A,N,B,U,H,G,V,F=this;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log(c._.LOG,"playerStartInit",this.player.hasStart,this.playerId,t),!this.isDestroy){e.next=4;break}return this._setStartTimelines(a.l1.START_INIT_DESTROY),e.abrupt("return");case 4:if(i=this.playerConfig,o=this.player,s=this.config,this.states=[],this._sTime=S.Z.nowTime(),this._lastBufferPoint=void 0,this._usePaused=!1,this.isActive&&(null==o?void 0:o.currentTime)!==0&&(this.log(c._.LOG,"[playerStartInit] reset current  = 0 ,buffer,",JSON.stringify(null==o||null===(l=o.buffered2)||void 0===l?void 0:l.bufferedList)),this.player.currentTime=0),this._isH265SoftDecoder=this.softDecode,s.reUseMSE&&this.mse&&"String"===u.Util.typeOf(t)&&/^blob/.test(t)&&t!==this.mse.url&&(t=i.url,this._destroyMSE()),(!t||"__auto__"===t||"anytext"===t)&&(d=i.definition)&&d.list&&d.list.length>0&&d.defaultDefinition&&(d.list.map(function(e){e.definition===d.defaultDefinition&&(i.url=e.url,F.player.curDefinition=e)}),(!i.url||"__auto__"===t||"anytext"===t)&&(t=(h=d.list[0]).url,i.url=h.url,d.defaultDefinition=h.definition,this.player.curDefinition=h)),this.initTimer(),p=o.oldBit,g=this._defInited?null:this.getInitBitrate(),o.oldBit=null==o||null===(G=o.curDefinition)||void 0===G?void 0:G.bitrate,!(!o.changeDefinitionFlag&&p&&p!==(null==o||null===(V=o.curDefinition)||void 0===V?void 0:V.bitrate))){e.next=23;break}if(!this.mp4){e.next=22;break}return this.canDownload=!1,e.next=22,this.mp4.cancelLoading();case 22:if(this.mse){this.once(u.Events.LOAD_START,function(){F.log(c._.LOG,"playerStartInit changeBtrate changeDefinitionSeekState = 1, currentTime += 0.001"),o.changeDefinitionSeekState=1,F.player.currentTime+=.001});try{this.mse.clearOpQueues(f.d1.VIDEO,!!s.enableMsePatches),this.mseAbort(),this.mse.remove(f.d1.VIDEO,0,1/0).then(function(){F.log(c._.LOG,"playerStartInit remove all buffer end")})}catch(e){this.log(c._.LOG,"playerStartInit mse func err, ".concat(null==e?void 0:e.message))}}case 23:if(o.changeDefinitionFlag=void 0,y=(v=this.config).kid,T=v.drmKeyToken,k=v.secretKey,C=v.keyValue,b=v.drm,y||T||k||C||b?this._secretkey?this._secretkey.updateConfig(this.config):(this._secretkey=new n.XGSecretKey(this.config),this._secretkey.on(n.EVENT_EME.ERROR,this._errorHandler)):this._secretkey=null,this._defInited=!0,this.log(c._.LOG,"[playerStartInit] ".concat(i.vid," curDefinition"),g||this.player.curDefinition),L=(D=this.player).preloader,x=D.playerId,L&&L.addPlayingId(i.vid,x),s.needPreloadCheck&&!this.softDecode&&!this._secretkey&&(I=!1,O="",L&&(w=this.player.curDefinition,M=(0,E.F5)(w),A=L.hasItemSameVid(M),O=L.getDataUniqueKey(M),A&&(I=!0)),!I&&(N=L?"no preload data":"no preloader",this.useVideoLoad=!0,this.player.vtype=a.l0.MP4_0,this._setStartTimelines(a.l1.NO_PRELOAD,{message:a.l0.MP4_0}),this.log(c._.LOG,"[playerStartInit] ".concat(i.vid," ").concat(N),!!L),B=new u.Errors(this.player,{errorType:"runtime",errorTypeCode:_.iR.runtime,errorCode:_.O1.other,vid:this.playerConfig.vid,errorMessage:N}),this.changeState(m.fp.PRELOAD_MATCH,{m:0,ck:O}),this.player.emit("playCatch",this.player.vtype,B))),!this.useVideoLoad){e.next=39;break}if(t=this.playerConfig.url,!s.closeDowngrade){e.next=36;break}return this._setStartTimelines(a.l1.CLOSE_DWNGRADE,{message:"isDestroy"}),e.abrupt("return");case 36:return this._playerStartInitCall(t),this._startProgress(),e.abrupt("return");case 39:if(!this.isDestroy){e.next=42;break}return this._setStartTimelines(a.l1.START_INIT_DESTROY,{message:"isDestroy"}),e.abrupt("return");case 42:this.player.mp4MseFlag=!0,this._tm=new Date().getTime(),this._reset(),U=this.playerConfig.vid,this.changeState("PLAYER_START_INIT"),this.mse||s.bindSrcTiming!==m.Iv.INIT?this._bindSrcTiming=m.Iv.META_READY:(this._bindSrcTiming=m.Iv.INIT,this.log(c._.LOG,"playerStartInit new MSE",this._bindSrcTiming),this.mse=new f.d1(this.player.video)),H=this._initMp4Kernel(),this._initPromise=H,this._addPendingPromise(this._initPromise),H.then(function(){if(F.isDestroy){F._setStartTimelines(a.l1.START_INIT_DESTROY,{message:"then destroy"});return}F.mse&&(t=F.mse.url),F.changeState("PLAY_INIT_OK"),F._bindEvents(),F._startProgress()}).catch(function(e){var i,r,n=!!F._initPromise&&F._initPromise.isBreak;if(F.isDestroy||n||e===R){var o="isDestroy:".concat(F.isDestroy,",isBreak:").concat(n,",e:").concat(e);F._setStartTimelines(a.l1.INIT_PROMISE_CATCH,{message:o});return}if(F.log(c._.LOG,"_initMp4Kernel.catch: ".concat(U," isDestroy:").concat(F.isDestroy,",\n          errorCode:").concat((null==e?void 0:e.errorCode)||_.O1.other,",errMsg:").concat((null==e?void 0:e.errorMessage)||(null==e?void 0:e.message))),(null==e?void 0:e.errorCode)===_.O1["403"]&&(F._setStartTimelines(a.l1.HTTP_ERROR,{message:"request 403",httpCode:403}),F._emitExpireEvent(e)&&s.urlExpireDisableErrorEvent)){F._initPromise=null,F.log(c._.LOG,"initMp4Kernel urlExpireDisableErrorEvent",s.urlExpireDisableErrorEvent,",errorCode,",e.errorCode),F._stopProgress(),F.emit(P);return}var l=e;!l.errorCode&&((l=new u.Errors(F.player,{errorType:_.iR.RUNTIME,errorCode:(null==e?void 0:e.errorCode)||_.O1.other,vid:F.playerConfig.vid,errorMessage:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),mediaError:{code:(null==e?void 0:e.httpCode)||_.O1.other,message:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),errorType:null==e?void 0:e.errorType}})).url=t),F._setStartTimelines(a.l1.INIT_PROMISE_CATCH,{message:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message)}),F.changeState("PLAY_INIT_CATCH",{c:l.errorCode,m:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),t:null==e?void 0:e.errorType}),F.useVideoLoad=!0,F.player.vtype=a.l0.MP4_1,F.player.emit("playCatch",F.player.vtype,l);var d=F.checkIsDegraded(l);if(F.log(c._.WARN,"PLAY_INIT_CATCH final error !!!!, ",U,null===(i=l)||void 0===i?void 0:i.errorCode,null===(r=l)||void 0===r?void 0:r.errorMessage,",degrade:",d),F.emit(P),!d){F.player.pause(),F._reset(),F.states=[],F.emit("error",l),F._initPromise=null;return}}).finally(function(){if(!!F._initPromise){var e,i=F._initPromise.isBreak;F._initPromise&&F._removePendingPromise(F._initPromise),F._initPromise=null,F._usePaused&&(F.playerConfig.autoplay=!1),F.softDecode&&"Array"===u.Util.typeOf(t)&&(t=t[0].src),"String"===u.Util.typeOf(t)&&!/^blob/.test(t)&&F._destroyMSE();var r=(null===(e=F.player)||void 0===e?void 0:e.currentSrc)===t;F.changeState("PLAY_INIT_FINALLY",{isDestroy:F.isDestroy,isBreak:i,reUseSrc:r}),F.isDestroy||i||F._playerStartInitCall(t),F._bindSrcTiming===m.Iv.META_READY&&F.reUseMSEEmitEvents(r),F._abrService&&F._abrService.isCurrentInAbr()&&(F._abrService.enable(),F._abrService.execute())}});case 52:case"end":return e.stop()}},e,this)})),function(e){return d.apply(this,arguments)})},{key:"_playerStartInitCall",value:function(e){e="Array"===u.Util.typeOf(e)?this._processArrayUrl(e):this._processUrl(e),w.call(this.player,e),this._startTimelines.downgradetime=S.Z.nowTime()}},{key:"_destroyMSE",value:function(){var e=this;if(!!this.mse)try{this.mse.clearOpQueues(f.d1.VIDEO,!!this.config.enableMsePatches);var t=this.config.enableMsePatches?this.mseAbort():this.mse.abort();if(!t)return;t.then((0,r.x)((0,r.l5)().mark(function t(){var i,n;return(0,r.l5)().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,null===(i=e.mse)||void 0===i?void 0:i.unbindMedia();case 2:e.mse&&e.log(c._.LOG,"destroyMSE ",null===(n=e.playerConfig)||void 0===n?void 0:n.vid),e.mse=null;case 4:case"end":return t.stop()}},t)}))).catch(function(){})}catch(e){}}},{key:"reUseMSEEmitEvents",value:function(e){var t,i=this;e&&/^blob/.test(null===(t=this.player)||void 0===t?void 0:t.currentSrc)&&(clearTimeout(this.loadstartTimer),clearTimeout(this.loadedmetadataTimer),clearTimeout(this.loadeddataTimer),clearTimeout(this.canplayTimer),this.loadstartTimer=setTimeout(function(){clearTimeout(i.loadstartTimer),i.loadstartTimer=null,i.emit(u.Events.LOAD_START),i.log(c._.LOG,"reUseMSE add emit loadstart event")},10),this.loadedmetadataTimer=setTimeout(function(){clearTimeout(i.loadedmetadataTimer),i.loadedmetadataTimer=null,i.emit(u.Events.LOADED_METADATA),i.log(c._.LOG,"reUseMSE add emit loadedmetadata event")},25),this.loadeddataTimer=setTimeout(function(){clearTimeout(i.loadeddataTimer),i.loadeddataTimer=null,i.emit(u.Events.LOADED_DATA),i.log(c._.LOG,"reUseMSE add emit loadeddata event")},50),this.canplayTimer=setTimeout(function(){clearTimeout(i.canplayTimer),i.canplayTimer=null,i.emit(u.Events.CANPLAY),i.log(c._.LOG,"reUseMSE add emit canplay event")},90))}},{key:"playNext",value:function(e){var t=this,i=this.player;this._setTimelineData(),this._defInited=!1,this._hasTriggerBufferThreshold=!1,i.resetState(),i._currentTime=0,i._duration=0,i.isPlaying=!1,this._useVideoLoad=!1,this._MSEError=!1;var r=this.softDecode;i.pause(),this._reset(),this.states=[],e.vtype&&(this.vtype=e.vtype.toUpperCase()),i.setConfig(e),this.checkReUseMSE(this.config.reUseMSE),this.softDecode?i.vtype=a.l0.MP4_MSE_SOFT:i.vtype=a.l0.MP4_MSE,this.codecType=this.playerConfig.codecType?this.playerConfig.codecType.toLowerCase():a.u7.H264,r!==this.softDecode&&this.h265_h264_switch(this.playerConfig.mediaType||"video"),this.checkConfig(),this.log(c._.LOG,"[Index] playNext",e.vtype,e.vid),i.start(),this.config.reUseMSE&&!this.isH265DegradeH264&&(this.__onmetadataHandle=function(){t.log(c._.LOG,"[Index] playNext metadata update currentTime = 0"),0!==i.currentTime&&(i.currentTime=0),i.video.removeEventListener("loadedmetadata",t.__onmetadataHandle),t.__onmetadataHandle=null},i.video.addEventListener("loadedmetadata",this.__onmetadataHandle)),this.emit("playnext")}},{key:"h265_h264_switch",value:function(e){this.log(c._.LOG,"[Index],h265_switch_h264",e);var t=this.player,i=u.Util.createDom(e,"",this.getVideoConfig(this.playerConfig),"xgplayer-".concat(e,"-img"));this.removeVideoList.push(t.video),i.muted=t.video.muted,i.volume=t.video.volume,t.media?t.media=i:t.video=i,t.attachVideoEvents(t.video)}},{key:"getVideoConfig",value:function(e){var t=Object.assign({},{controls:!1,autoplay:e.autoplay,playsinline:e.playsinline,"x5-playsinline":e.playsinline,"webkit-playsinline":e.playsinline,"x5-video-player-fullscreen":e["x5-video-player-fullscreen"]||e.x5VideoPlayerFullscreen,"x5-video-orientation":e["x5-video-orientation"]||e.x5VideoOrientation,airplay:e.airplay,"webkit-airplay":e.airplay,tabindex:2,mediaType:e.mediaType||"video"},e.videoConfig,e.videoAttributes);return e.loop&&(t.loop="loop"),t}},{key:"next",value:function(e){this.playNext(e)}},{key:"oldChangeDefinition",value:(B=(0,r.x)((0,r.l5)().mark(function e(t,i){var n,a,o,s,l,d,h,p,g,m,v,_,y=this;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.config,a=this.player,o=this.playerConfig,a.changeDefinitionFlag=!0,a.emit(u.Events.DEFINITION_CHANGE,{from:i,to:t}),a.emit(u.Events.WAITING),l=(s=a.definitionList).filter(function(e){return e.definition===t.definition||e.definition===Number(t.definition)}),(d=s.filter(function(e){return e.definition===i.definition||e.definition===Number(i.definition)})).length>0&&(d[0].selected=!1),!(l.length>0)){e.next=13;break}(t=l[0]).selected=!0,e.next=14;break;case 13:return e.abrupt("return");case 14:return a.curDefinition=t,this.log(c._.LOG,"[oldChangeDefinition],currentTime,",a.currentTime,",from,",i,",to,",t),h=a.currentTime,(p=a.paused)&&(this.config.autoplayBack=o.autoplay,o.autoplay=!1),this._changeDefState={currentTime:h,paused:p},n.definition=t.definition,["keyValue","kid","secretKey","drm","getLicenseUrl","drmKeyToken","sessionId"].forEach(function(e){n[e]=t[e]}),e.next=24,null===(m=this.mp4)||void 0===m?void 0:m.cancelLoading();case 24:if(null===(v=this.mse)||void 0===v||v.clearOpQueues(f.d1.VIDEO,!!n.enableMsePatches),g=null===(_=this.mse)||void 0===_?void 0:_.abort(f.d1.VIDEO)){e.next=28;break}return e.abrupt("return");case 28:g.then(function(){o.url=t.url,o.userSelectDefinition=t.definition,o.defaultDefinition=t.definition,a.currentTime=0,a.pause(),y._reset(),y.states=[],y.checkReUseMSE(!1,n.enableMsePatches),y._isMseInit=!1,y.eme=null,y._handlerUrl(t.url),y.once(u.Events.CANPLAY_THROUGH,function(){void 0!==y.config.autoplayBack&&y.config.autoplayBack!==o.autoplay&&(o.autoplay=y.config.autoplayBack,y.config.autoplayBack=void 0)}),a.video.removeEventListener("loadedmetadata",y._changeDefineCanPlay),y._changeDefineCanPlay=function(){y.changeDefineCanPlay(h,p,i,t),a.video.removeEventListener("loadedmetadata",y._changeDefineCanPlay)},a.video.addEventListener("loadedmetadata",y._changeDefineCanPlay),a.video.load(),y.playerStartInit(o.url)}).catch(function(){});case 29:case"end":return e.stop()}},e,this)})),function(e,t){return B.apply(this,arguments)})},{key:"_emitDefinitionChangeDetailEvent",value:function(e){var t=this._currDefinition,i=t.bitrate,r=t.definition,n=t.file_id,a=t.width,o=t.vwidth,s=t.height,l=t.vheight;this.player.emit("definitionChangeDetail",{start:e,bitrate:i,definition:r,mediaType:"video",url:this.config._mainURL,fileid:n});this.player.emit("RESOLUTION_UPDATE",{width:a||o,height:s||l})}},{key:"getCurGopEndTime",value:function(e){var t=this.player;if(!t)return 0;var i=this.mp4,r=i.getFragmentIdx(e||t.currentTime);return i.timeRange[r].endTime}},{key:"_setCurrentDefinition",value:function(e){var t=this.player.config;if(t.definition&&t.definition.list){var i=t.definition.list.filter(function(t){return t.bitrate===e.bitrate||t.definition===e.definition});this._currDefinition=i&&i[0]}!this._currDefinition&&(this._currDefinition={})}},{key:"switchURL",value:function(e,t){var i=this;if(t&&"object"===(0,r.Ac)(t)&&t.action===I.UPDATE_URL){this._updateURL({url:null==e?void 0:e.url});return}if(this.useVideoLoad){A.call(this.player,e);return}var n=this.player,a=this.config;n.config.definition.list=[e],n.config.url=e.url,n.config.defaultBitrate=e.bitrate,n.config.defaultDefinition=e.definition;["keyValue","kid","secretKey","drm","getLicenseUrl","drmKeyToken","sessionId"].forEach(function(t){a[t]=e[t]}),this.__onmetadataHandle=function(){n.currentTime=0,n.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},n.video.addEventListener("loadedmetadata",this.__onmetadataHandle),this.playNext(a)}},{key:"_updateURL",value:function(e){var t=this.player,i=this.config,r=(e||{}).url;return!!t&&!!r&&((t.config.url=r,t.curDefinition&&(t.curDefinition.url=r),this._handlerUrl(r),!this.useVideoLoad&&this.mp4)?(this.mp4.updateUrl(i._mainURL,i._backupURL),!0):!!this.useVideoLoad&&(A.call(this.player,r),!0))}},{key:"_handlerUrl",value:function(e){var t,i=this.config,r=this.playerConfig;if(!e)return!1;var n=[];if("String"===u.Util.typeOf(e))t=e,r.backupURL&&n.push(r.backupURL);else if("Array"===u.Util.typeOf(e)&&e.length>0&&(t=e[0].src,e.length>1))for(var a=1;a<e.length;a++){var o=this._processUrl(e[a].src);n.push(o)}return(!!t||0!==n.length)&&(i._mainURL=this._processUrl(t),i._backupURL=n,!0)}},{key:"_processUrl",value:function(e){var t=this.config,i=this.playerConfig,n=S.Z.extUrl(e,(0,r.Zj)({__vid:i.vid},t.reqParams));if(i&&"function"==typeof i.preProcessUrl){var a=i.preProcessUrlOptions||{};n=i.preProcessUrl(n,a).url}return n}},{key:"_processArrayUrl",value:function(e){var t=this;return e.map(function(e){return(0,r.Zj)((0,r.Zj)({},e),{},{src:t._processUrl(e.src)})})}},{key:"_bindEvents",value:function(){var e=this;this.log(c._.LOG,"bindEvents,",this._isEventInit);var t=this.config,i=this.player;!this._isEventInit&&(this.on("seeking",this._onSeeking),this.on("waiting",this._onWaiting),this.on("error",this._onVideoError),this.on("playing",this._onPlaying),this.on("detectGap",function(){t.gapDegrade&&t.useEME&&(t.useEME=!1,e._replay())}),this.on(l.J.CHANGE_FLYING_PLUGIN_CONFIG,this._onChangeConfig),i.setEventsMiddleware({error:function(t,r){var n,o,s,l,d,u,f={errorCode:null==t||null===(n=t.error)||void 0===n?void 0:n.code,errorMessage:null==t||null===(o=t.error)||void 0===o?void 0:o.message,videoType:e.useVideoLoad};if(e.changeState("video_error.Middleware",f),e._setPlayerError(f),e.codecType===a.u7.H265&&(null==t||null===(s=t.error)||void 0===s?void 0:s.message.indexOf("video decoder initialization failed"))>=0&&e.emit("DECODER_FAILED",{codecType:e.config.codecType,vid:null===(l=e.playerConfig)||void 0===l?void 0:l.vid,message:null==t||null===(d=t.error)||void 0===d?void 0:d.message}),e.log(c._.ERROR,"error middleware",JSON.stringify(f),", isDegrade,",!e._MSEError&&!e.useVideoLoad,i.currentTime),!e._MSEError&&!e.useVideoLoad){i.vtype=a.l0.MP4_2,e._MSEError=!0,null===(u=e.mp4)||void 0===u||u.cancelLoading(),e._startDegradedPlayback(f,i.paused),e.emit(P);return}e.emit(P),e.useVideoLoad&&r(t.eventName,null==t?void 0:t.error)}})),this._isEventInit=!0}},{key:"getBufferDur",value:function(){if(!(null!==(e=this.player)&&void 0!==e&&e.buffered))return 0;for(var e,t=this.player.buffered,i=0,r=0,n=t.length;r<n;r++)i+=t.end(r)-t.start(r);return i}},{key:"deleteVideo",value:function(){var e;if((null===(e=this.removeVideoList)||void 0===e?void 0:e.length)>0){for(var t=0;t<this.removeVideoList.length;t++){var i=this.removeVideoList[t],r=i.parentNode;r&&r.removeChild(i),this.log(c._.WARN,"[_removeVideoSource]")}this.removeVideoList=[]}}},{key:"_unbindEvents",value:function(){var e,t;this.log(c._.LOG,"unbindEvents,",this._isEventInit),this.off("seeking",this._onSeeking),this.off("waiting",this._onWaiting),this.off("ended",this._onEnded),this.off("error",this._onError),this.off("playing",this._onPlaying),this.off(l.J.CHANGE_FLYING_PLUGIN_CONFIG,this._onChangeConfig),this._isEventInit=!1,null!==(e=this.config)&&void 0!==e&&e.enableFPSStuckHandle&&this.off(u.Events.FPS_STUCK,this.fpsStuckHandle),null!==(t=this.playerConfig)&&void 0!==t&&t.fixOOM&&(this.off("source_error",this._onSourceError),this.off("error",this._onSourceError))}},{key:"changeState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!this._pTime&&(this._pTime=S.Z.nowTime());var i=S.Z.nowTime()-this._pTime,r=S.Z.nowTime()-this._sTime;this.log(c._.LOG,">>>changeState[".concat(e,"]"),i,r,JSON.stringify(t)),this.states.push({state:e,t1:i,t2:r,data:t}),this._pTime=S.Z.nowTime()}},{key:"_initMseProxy",value:function(){var e,t=this.player.video||this.player.media;t instanceof HTMLVideoElement&&this.h265_h264_switch(this.playerConfig.mediaType),this.softDecode&&t&&(this.mseProxy=t,null===(e=t.setPlayMode)||void 0===e||e.call(t,"VOD"),t.addEventListener("lowdecode",this._lowDecoder),t.addEventListener("error",this._onError),this.player.forceDegradeToVideo=function(){})}},{key:"notSupportError",value:function(e){return this.log(c._.LOG,e,m.eT),new u.Errors(this.player,{errorType:_.iR.MEDIA,errorCode:_.O1.mse,errorMessage:"".concat(e," ").concat(m.eT),vid:this.playerConfig.vid})}},{key:"removeAndRejectInitPromise",value:function(e){this._initPromise&&(this._removePendingPromise(this._initPromise),this._initPromise.reject(e))}},{key:"_initMp4",value:function(e,t){var i,n,a,o,s,l,d,u,f,h=this,p=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},g=this.config,v=this.player,_=this.playerConfig;this.mp4&&(this.mp4.destroy(),this.mp4=null),this._startTimelines.reqtime=S.Z.nowTime(),this.changeState("MP4_NEW",{});var C=0;null!=g&&null!==(o=g.pcdnConfig)&&void 0!==o&&o.openPCDN&&(C=(null==g||null===(n=g.pcdnConfig)||void 0===n?void 0:n.switchPCDNMaxCnt)||2),null!=g&&null!==(s=g.pcdnConfig)&&void 0!==s&&s.adaptPCDNConfig&&null!=g&&null!==(l=g.pcdnConfig)&&void 0!==l&&null!==(l=l.adaptPCDNConfig)&&void 0!==l&&l.PCDNBufferControl&&(C=0),this._setCurrentDefinition(v.curDefinition);var D=T.Z;(null==g?void 0:g.loadRangeType)===m.TJ.SIZE&&(D=k.Z);var L=null===(d=v.curDefinition)||void 0===d||null===(d=d.pktOffsetMap)||void 0===d?void 0:d.find(function(e){return(null==e?void 0:e.time)===((null==g?void 0:g.firstLoadTimePos)||m.he)}),R=g.enableWorker,x=g.useUrlRange,I=g.retryCount,O=g.retryDelay,w=g.timeout,M=g.processMaxGapTime,A=g.onProcessMinLen,B=g.supportHevc,U=g.afterLoadeddataCallBackLen,H=g.firstLoadBuffer,G=g.memoryOpt,V=g.emitMediaListControl,F=g.reqOptions,j=g.audioGroupingStrategy,q=g.fixEditListOffset,K=g.fixEditListOffsetThreshold,Z=g.isAddRange,W=g.disableRepeatRange,Y=g.alwaysStreamingLoad,J=g.loadRangeType;this.mp4=new D(e,v.curDefinition.bitrate,{segmentDuration:g.segmentMinDuration,enableWorker:R,softDecode:this.softDecode,codecType:this.codecType,chunkSize:g.preloadSize,firstLoadSize:null==L?void 0:L.offset,duration:_.duration||0,fileSize:p.fileSize||0,playerId:this.playerId,vid:_.vid,useUrlRange:x,retryCount:I,retryDelay:O,timeout:w,processMaxGapTime:M,onProcessMinLen:A,supportHevc:B,afterLoadeddataCallBackLen:U,firstLoadBuffer:H,logger:this.logger,memoryOpt:G,emitMediaListControl:V,switchPCDNMaxCnt:C,reqOptions:F,audioGroupingStrategy:j,fixEditListOffset:q,fixEditListOffsetThreshold:K,isAddRange:Z,disableRepeatRange:W,alwaysStreamingLoad:Y,loadRangeType:J,enableMsePatches:g.enableMsePatches},this.config._backupURL,""),this.mp4.once(y.kL.META_READY,this._onMp4MetaReady),this.mp4.on(y.kL.ERROR,this._onMp4Error),this.mp4.on(y.kL.UPDATE_EME,this._updateDrmConfig),this.mp4.on(y.kL.INIT_MSE,this._updateMSE),this.mp4.on(y.kL.TASK_PROGRESS,this._onMp4Progress),this.mp4.on(y.kL.MOOV_REQ_PROGRESS,this._onMp4DataCallBack),this.mp4.on(y.kL.LOAD_ERROR,function(e){var t;null===(t=h.player)||void 0===t||t.emit("source_error",e)}),this.mp4.on(y.kL.REMOVE_PCDN_NODE,function(e){h.pcdn&&e&&h.pcdn.removePCDNNode(e.vid,e.bitrate,e.url)}),this.mp4.on(y.kL.CHANGE_URL,function(e){h.player&&(h.player.emit("initialUrl",{url:e}),h.player.emit("changeHost",S.Z.getHostFromUrl(e)))}),this.mp4.on(y.kL.UPDATE_LOAD_IDX,(i=(0,r.x)((0,r.l5)().mark(function e(t){var i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null===(i=h.mp4)||void 0===i?void 0:i.cancelLoading();case 2:h._curLoadSegmentIdx=t,h.log(c._.LOG,"[update curLoadSegmentIdx]",t);case 4:case"end":return e.stop()}},e)})),function(e){return i.apply(this,arguments)})),this.mp4.on(y.kL.CANCEL_LOADED_LEN,function(e){if(!!h.player){var t,i,r=_.vid,n=(null==e?void 0:e.load_type)||y._R.CDN,a=null===(t=h.mp4)||void 0===t?void 0:t.getCurSwitchPCDNCnt(),o=h._currDefinition,s=o.bitrate,l=o.definition,d=o.file_id;n===y._R.CDN?h.player.emit("prf_data_size",{vid:r,task_type:1,cdn_size:e.len,change_cnt:a,definition:l,bitrate:s,fileid:d}):h.player.emit("prf_data_size",{vid:r,task_type:1,pcdn_size:e.len,trace_id:null===(i=h.mp4)||void 0===i||null===(i=i.pcdnTraceInfo)||void 0===i?void 0:i.trace_id,change_cnt:a,definition:l,bitrate:s,fileid:d}),h.mp4&&h.mp4.updateLoadInfo(n,e.len),b.XO}}),this.mp4.MP4Loader.on(m.kW,function(e){N=e.speed,!h.debugInfo.speed&&(h.debugInfo.speed=[]),h.debugInfo.speed.push(N),h.debugInfo.speed.length>10&&h.debugInfo.speed.shift();var t=(null==e||null===(S=e.priOptions)||void 0===S?void 0:S.type)||y._R.CDN;h.emit(m.kW,(0,r.Zj)((0,r.Zj)({},e),{},{type:t}));var i=(null===(C=h.playerConfig)||void 0===C?void 0:C.vid)||(null==e?void 0:e.vid);if((null==e?void 0:e.len)>0){if(!h.player)return;var n=(null==e||null===(D=e.priOptions)||void 0===D?void 0:D.type)||y._R.CDN,a=(0,E.pl)(e.len,e.time),o=(null===(L=h.adaptRangeRes)||void 0===L?void 0:L.length)>0?h.adaptRangeRes.shift():{},s=o.cachedBufferDur,l=o.loadTarDuration,d=o.loadDuration,u=o.forceSetMin;o.idx;var c=o.PCDNInBuffer,f=o.PCDNOutBuffer,p=o.loadSize,g=null===(R=h.mp4)||void 0===R?void 0:R.getCurSwitchPCDNCnt(),v=h._currDefinition,_=v.bitrate,T={vid:i,task_type:1,buffer_dur:s||-1,load_tar_dur:l||-1,load_dur:d||-1,force_set_min:u,in_buf:c||-1,out_buf:f||-1,change_cnt:g,bitrate:_,definition:v.definition,fileid:v.file_id,load_size:p||-1};n===y._R.CDN?(T.cdn_size=e.len,T.cdn_speed=a):(T.pcdn_size=e.len,T.pcdn_speed=a),h.player.emit("prf_data_size",T),b.XO;var k=e.index?null===(P=h.mp4)||void 0===P||null===(P=P.adaptTimeRange[e.index])||void 0===P||null===(P=P.timeRangeIdx)||void 0===P?void 0:P[1]:null;if(k&&k>=h.mp4.timeRange.length-1)for(;(null===(x=h.adaptRangeRes)||void 0===x?void 0:x.length)>0;){var S,C,D,L,R,P,x,I,O=h.adaptRangeRes.shift(),w=O.cachedBufferDur,M=O.loadTarDuration,A=O.loadDuration,B=O.forceSetMin,U=(O.idx,O.loadSize),H=O.PCDNInBuffer,G=O.PCDNOutBuffer,V=null===(I=h.mp4)||void 0===I?void 0:I.getCurSwitchPCDNCnt();T.buffer_dur=w||-1,T.load_tar_dur=M||-1,T.load_dur=A||-1,T.force_set_min=B||-1,T.in_buf=H||-1,T.out_buf=G||-1,T.load_size=U||-1,T.change_cnt=V,h.player.emit("prf_data_size",T),b.XO}h.mp4&&h.mp4.updateLoadInfo(n,e.len)}}),this.mp4.on(m.fD.MEDIA_LIST,function(e){var t;null===(t=h.player)||void 0===t||t.emit(m.fD.MEDIA_LIST,e)}),this.mp4.on(m.fD.FIRST_MET_MUX_NOT_CONTINUE,function(){h.emit(P)}),null!=g&&null!==(u=g.pcdnConfig)&&void 0!==u&&u.adaptPCDNConfig&&null!=g&&null!==(f=g.pcdnConfig)&&void 0!==f&&null!==(f=f.adaptPCDNConfig)&&void 0!==f&&f.PCDNBufferControl&&(null===(a=this.mp4)||void 0===a||a.setSwitchPCDNCallBack(function(){var e=h.pcdn;if(!e)return -1;var t=e.getPCDNChangeCnt()||-1;return h.log(c._.LOG,"[updateSwitchPCDNMaxCnt]",t),t})),this.changeState("MP4_INIT",{destroy:this.mp4.hasDestroyed}),this.emit("loadstart_mse"),this.mp4.bufferTimeFuncCallBack=function(){return v.bufferedPoint.end-v.currentTime},this.mp4.init(t),this._emitDefinitionChangeDetailEvent(0)}},{key:"_checkPreloader",value:(U=(0,r.x)((0,r.l5)().mark(function e(){var t,i,n,a,o,s,l,d,u,f,h,p,g;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=(t=this.player).curDefinition,n=t.preloader,o=(a=Promise.withResolvers()).promise,s=a.resolve,l={method:"checkPreloader",success:0,type:"error",cacheKey:""},n){e.next=9;break}return this.changeState(m.fp.PRELOAD_ERROR,{t:2}),l.success=0,l.error=Error("no_preloader"),s(l),e.abrupt("return",o);case 9:if(d=(0,E.F5)(i),u=n.getDataUniqueKey(d),l.cacheKey=u,!u){e.next=46;break}return e.next=15,n.getPreLoadData(d);case 15:if(!(f=e.sent)){e.next=39;break}if(p=f.bitrate,g=f.orgDefinition,delete f.generateBy,!(p&&i.bitrate&&p!==i.bitrate)){e.next=27;break}return this.preLoadData=null,l.success=0,l.error=Error("bitrate_not_match_cut_".concat(i.bitrate,"_cache_").concat(p)),this.changeState(m.fp.PRELOAD_ERROR,{t:1,bitrate:p,ck:u}),s(l),this.log(c._.LOG,">>>check Preloader bitrate_not_match cacheKey".concat(u,"\n              curDefinition:").concat(i.bitrate,"  cache:").concat(p)),e.abrupt("return",o);case 27:i.orgDefinition=g,b.i5,this.preLoadData=f,this.emit("PRELOAD_INFO",this.preLoadData),l.success=1,l.data=f,null===(h=this.preloader)||void 0===h||h.setUsePreloadInfo(u,!0),this.changeState(m.fp.PRELOAD_OK,{t:4,l:this.preLoadData.byteLength,ck:u}),f.mediaSegList&&f.mediaSegList.length>0||f.buffer&&f.buffer.byteLength>0?this.hitpreload=!0:this.hitpreload=!1,s(l),e.next=44;break;case 39:this.preLoadData=null,this.changeState(m.fp.PRELOAD_ERROR,{t:0,ck:u}),l.success=0,l.error=Error("none_preload"),s(l);case 44:e.next=50;break;case 46:this.changeState(m.fp.PRELOAD_ERROR,{t:3,ck:u}),l.success=0,l.error=Error("none_preload"),s(l);case 50:return e.abrupt("return",o);case 51:case"end":return e.stop()}},e,this)})),function(){return U.apply(this,arguments)})},{key:"_initEME",value:function(e){var t,i,r=this.config,a=r.kid,o=r.drmKeyToken,s=r.secretKey,l=r.keyValue,d=r.drm,f=r.useEME;if((a||o||s||l||d)&&f&&!(0,n.checkEMEValid)()){this.log(c._.ERROR,"checkEMEInValid"),this._errorHandler(new u.Errors(this.player,{errorType:_.iR.MEDIA,errorCode:_.O1.eme_hijack,errorMessage:"checkEMEInValid",vid:this.playerConfig.vid}));return}var h=this.player,p=this.config;this._updateDrmConfig(e),this.log(c._.LOG,"useEME: ",p.useEME),null===(t=this._secretkey)||void 0===t||t.setOptions('video/mp4; codecs="avc1.64001E"','audio/mp4; codecs="mp4a.40.2"'),null===(i=this._secretkey)||void 0===i||i.setupEME(h.video)}},{key:"_initMse",value:(H=(0,r.x)((0,r.l5)().mark(function e(t){var i,a=this,o,s,l,d,h,p,g,v,y,T,k,E,S,C,b,D,L,R,P=arguments;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=P.length>1&&void 0!==P[1]&&P[1],l=(s=this.config).kid,d=s.drmKeyToken,h=s.secretKey,p=s.keyValue,g=s.drm,v=s.useEME,!((l||d||h||p||g)&&v&&!(0,n.checkMSEValid)())){e.next=6;break}return this.log(c._.ERROR,"checkMSEInValid "),this._errorHandler(new u.Errors(this.player,{errorType:_.iR.MEDIA,errorCode:_.O1.mse_hijack,errorMessage:"checkMSEInValid",vid:this.playerConfig.vid})),e.abrupt("return");case 6:null===(i=this.player)||void 0===i||i.emit("codecsupdate",t.videoCodec),this.updateMSEDuration(),y=this.mp4&&this.mp4.checkCodecH265(),T=this.mp4&&this.mp4.checkCodecH266(),k=!!t.videoCodec,E=!!t.audioCodec,S=k&&E?y?'video/mp4; codecs="hev1.1.6.L93.B0, mp4a.40.5"':T?'video/mp4; codecs="bvc2.1.6.L93.B0, mp4a.40.5"':'video/mp4; codecs="avc1.64001E, mp4a.40.5"':k?y?'video/mp4; codecs="hev1.1.6.L93.B0"':T?'video/mp4; codecs="bvc2.1.6.L93.B0"':'video/mp4; codecs="avc1.64001E"':'video/mp4; codecs="mp4a.40.5"',C=(0,r._x)({},f.d1.VIDEO,{mimeType:"video/mp4",codec:S}),this.mse?this._bindSrcTiming===m.Iv.INIT?b=this.mse._openPromise:(this.log(c._.LOG,"MSE exist"),L=(D=Promise.withResolvers()).promise,R=D.resolve,b=L,R()):(this.log(c._.LOG,"new MSE",this._bindSrcTiming),this.mse=new f.d1,b=this.mse.bindMedia(this.player.video)),b.then(function(){if(!!a.mse){a.changeState("MSE_OPEN");try{var e=Object.keys(C).map(function(e){return a.mse.createOrChangeSource(e,C[e].codec)});Promise.all(e).then(function(){a.changeState("MSE_OPEN_DONE"),a._isMseInit=!0;var e=a.seekTimeAfterMetaReady;if(a.config.enableMsePatches&&a.player&&"number"==typeof e&&e>=0){var t=a.player.bufferedPoint;a.seekTimeAfterMetaReady=void 0,e>=t.start&&e<=t.end?a._onSeeking():a.player.currentTime=e}else try{a._onTimeUpdate()}catch(e){throw a.log(c._.ERROR,"MSE createOrChangeSource onTimeUpdate catch err: ",null==e?void 0:e.message),e}}).catch(function(){var e=(0,r.x)((0,r.l5)().mark(function e(t){var i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a.config.reUseMSE=!1,a.log(c._.WARN,"MSE createOrChangeSource catch err: ",null==t?void 0:t.message),e.next=4,null===(i=a.mse)||void 0===i?void 0:i.unbindMedia();case 4:a.mse=null,a._isMseInit=!1,o?a.MSEErrorHandle(t):a._initMse(a.mp4.meta,!0);case 7:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}())}catch(e){a.MSEErrorHandle(e)}}}),this.changeState("MSE_INIT");case 17:case"end":return e.stop()}},e,this)})),function(e){return H.apply(this,arguments)})},{key:"MSEErrorHandle",value:function(e){var t=new u.Errors(this.player,{errorType:_.iR.mse,errorCode:_.O1.mse,vid:this.playerConfig.vid,errorMessage:e.message,mediaError:{code:_.O1.mse,message:e.message}});this.log(c._.ERROR,"initMse error: ",null==e?void 0:e.message),this._errorHandler(t)}},{key:"_appendInitSeg",value:function(e){var t=this;if(!!this.mse&&!this._MSEError)this.changeState("MSE_INITSEG"),this.mse.append(f.d1.VIDEO,e,{vid:this.playerConfig.vid,range:null,dataLen:e.byteLength,isinit:!0}).then(function(e){t.changeState("MSE_INITSEG_OK",{costtime:null==e?void 0:e.costtime})}),this.config.useEME&&this._secretkey&&(this._secretkey.emit(n.EVENT_EME.ENCRYPTED),this.player.emit(n.EVENT_EME.ENCRYPTED))}},{key:"_checkMetaInfo",value:function(e){if(!e)return new u.Errors(this.player,{errorType:_.iR.DEMUX,errorCode:_.O1.metaError,errorMessage:"meta is null",vid:this.playerConfig.vid});var t,i=this.player.video||this.player.media,r=this.mp4.checkCodecH265(),n=this.mp4.checkCodecH266();if(this.changeState("MP4_META_READY",{isH265:r,isH266:n}),r&&(this.codecType!==a.u7.H265&&(this.codecType=a.u7.H265,this.log(c._.LOG,"codecType fix ".concat(this.codecType,", ").concat(e.videoCodec))),!this.softDecode&&!this.config.supportHevc)||n&&(this.codecType!==a.u7.H266&&(this.codecType=a.u7.H266,this.log(c._.LOG,"codecType fix ",this.codecType,e.videoCodec)),!(this.softDecode&&(null===(t=i.canPlayType)||void 0===t?void 0:t.call(i,'video/mp4; codecs="'.concat(e.videoCodec,'"')))==="probably")&&!this.config.supportVvcc))return this.notSupportError("".concat(this.codecType," - ").concat(e.videoCodec));var o=this.config,s=o.enableCheckTrackGap,l=o.trackGap;if(e.videoCodec&&e.audioCodec&&s){var d=e.moov.trak,f=e.moov.mvhd.timescale;if(Math.abs(this._getTrakDuration(d[0],f)-this._getTrakDuration(d[1],f))>l)return new u.Errors(this.player,{errorType:_.iR.DEMUX,errorCode:_.O1.metaError,errorMessage:"video track and audio track duration long gap, mse cannot play to end",vid:this.playerConfig.vid})}return null}},{key:"_getTrakDuration",value:function(e,t){return e.tkhd.duration/t}},{key:"_stopProgress",value:function(){this.log(c._.LOG,"stopProgress",this._hasStartProgress),this._hasStartProgress=!1,this._requestTimer&&this._requestTimer.stop(),this._bufferBreakTimer&&(clearTimeout(this._bufferBreakTimer),this._bufferBreakTimer=null,this._bufferBreakFlag=void 0),this._seekResumTimer&&(clearTimeout(this._seekResumTimer),this._seekResumTimer=null)}},{key:"checkReStartTimer",value:function(){var e=S.Z.nowTime()-this._lastTimeupdateTime2;e>2*this._tickInSeconds*1e3&&!this._offineLine&&(this.log(c._.LOG,"checkReStartTimer reStart timer",e,S.Z.nowTime()),this._stopProgress(),this._startProgress(),this._lastTimeupdateTime2=S.Z.nowTime())}},{key:"_bindNetworkStateChange",value:function(){window.addEventListener("online",this._onOnlineHandler),window.addEventListener("offline",this._onOfflineHandler)}},{key:"_unbindNetworkStateChange",value:function(){window.removeEventListener("online",this._onOnlineHandler),window.removeEventListener("offline",this._onOfflineHandler)}},{key:"_onSuperStart",value:function(e){var t=this,i=this.player;(0,b.cM)("_onSuperStart:".concat(e),this.mse),i.video.src=e,this.once("canplay",function(){i.play(),t.on("waiting",t._onWaiting)})}},{key:"_appendBuffer",value:function(e,t,i,r){var n=this,o=this.mse,s=this.playerConfig,l=this.player,d=s.vid;if(i=i||{},this.log(c._.LOG,"appendStart",i.fragIndex,JSON.stringify(i.range)),this._MSEError){this.log(c._.ERROR,"_MSEError, not append return");return}o.append(e,t,{vid:d,state:r,context:JSON.stringify(i)}).then(function(e){2===l.changeDefinitionSeekState&&(l.changeDefinitionSeekState=3,n.log(c._.LOG,"appendEnd changeDefinitionSeekState += 0.001"),l.currentTime+=.001);var t,a,o,s,d=n.getAllBufferRange(),u=null!=e&&null!==(t=e.context)&&void 0!==t&&t.context?JSON.parse(null==e||null===(a=e.context)||void 0===a?void 0:a.context):{};if(n.log(c._.LOG,"appendEnd ",null==u?void 0:u.fragIndex,JSON.stringify(null==u?void 0:u.range),", costTime,",null==e?void 0:e.costtime,", opt,",null==e?void 0:e.name,",buffer,",JSON.stringify(d),l.currentTime),!n.loadedDataEventRev){var f=(null==e?void 0:e.costtime)||0,h=n.states.findIndex(function(e){return"APPEND_DATA_OK"===e.state});h>=0?(n.states[h].data.cnt+=1,n.states[h].data.costtime+=f):n.changeState("APPEND_DATA_OK",{costtime:f,cnt:1})}if(n.mse&&r&&(null!==(o=n.mp4)&&void 0!==o&&o.checkIsLoadEnd(null===(s=i.range)||void 0===s?void 0:s[1])||n._loadedEnd)){var p=n.player.buffered;n._loadedEnd=!0;var g=0;p&&(null==p?void 0:p.length)>0&&(g=p.end(p.length-1)),n._isEnded(),n.log(c._.LOG,"loaded ended !!!===>>>",JSON.stringify(i.range),", fragIndex,",i.fragIndex,", bufferEndTime,",g,",meta_duration,",n.mp4.meta.duration)}}).catch(function(e){var t=n.player,r=n.mse;if(!n._hasFirstFramed&&n._setStartTimelines(a.l1.MSE_ERROR,{message:null==e?void 0:e.message}),!n._MSEError&&!!t){var o=t.media||t.video;if(e&&null!=r&&r.isFull()){n.log(c._.WARN,"[MSE is full]");var s=t.getBufferedRange();n._checkRemovePlayedBuffer(s,t.currentTime,!0)}else{var l,f,h,p,g="".concat(null!=o&&o.error?[o.error.code,o.error.message].join("-"):"MEDIA_EMPTY"),m="".concat((null==e?void 0:e.errorCode)||"","-").concat((null==e?void 0:e.errorMessage)||(null==e?void 0:e.message)||"MSE_EMPTY"),v="".concat(m,"|").concat(g);n._MSEError=!0,n.changeState("_MSEError",{fragIndex:null===(l=i)||void 0===l?void 0:l.fragIndex,range:null===(f=i)||void 0===f?void 0:f.range}),n.log(c._.LOG,"MSE append error",null===(h=i)||void 0===h?void 0:h.fragIndex,JSON.stringify(null===(p=i)||void 0===p?void 0:p.range));var y=new u.Errors(t,{errorType:_.iR.MEDIA,errorCode:_.O1.mseAppend,vid:d,errorMessage:v,mediaError:{code:_.O1.mseAppend,message:v}});n._errorHandler(y)}}})}},{key:"_loadData",value:(G=(0,r.x)((0,r.l5)().mark(function e(){var t,i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(!this.mp4||!this._isMseInit&&!this.softDecode)){e.next=2;break}return e.abrupt("return");case 2:if(e.prev=2,t=this.player,i=h.l.info(h.l.get(t.media||t.video),t.currentTime),!(!this.config.alwaysStreamingLoad&&i.remaining>5)){e.next=10;break}return e.next=8,this.mp4.loadAllFragmentData(this._curLoadSegmentIdx,this._loadDataSuccess);case 8:e.next=12;break;case 10:return e.next=12,this.mp4.load(this._curLoadSegmentIdx,this._loadDataSuccess);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),this.log(c._.ERROR,"[Index] _loadData error",this.playerConfig.vid,null===e.t0||void 0===e.t0?void 0:e.t0.message);case 17:case"end":return e.stop()}},e,this,[[2,14]])})),function(){return G.apply(this,arguments)})},{key:"getDataBitRate",value:function(e){var t=this.mp4,i=this.playerConfig;if(!t)return 0;for(var r=t.getDataBitRate(e),n=i.definition.list,a=0,o=0;n&&o<n.length;o++)if(n[o].bitrate===r){a=n[o];break}return a}},{key:"_loadStuckCheck",value:function(){var e=this,t=this.config,i=this.player;if(!t.disableBufferBreakCheck){if((!this.playerConfig.autoplay||this.softDecode)&&!this.playFlag)return;var r=i.isUserActive;if(i.currentTime-(this._lastCurrentTime||0)>.1||!r&&i.paused||r&&this.playFlag&&i.paused)(1===this._bufferBreakFlag||2===this._bufferBreakFlag)&&(this.log(c._.LOG,"视频没有卡死,重置卡死标记,curtime,",i.currentTime),this._bufferBreakFlag=0,clearTimeout(this._bufferBreakTimer),this._bufferBreakFlag=null);else if(!this._bufferBreakFlag){this._bufferBreakFlag=1;var n=JSON.stringify(this.getAllBufferRange()),a=this.getWaitingTimeOut();this.log(c._.LOG,"卡死计时开始! ".concat(a,"ms后确认卡死,"),i.currentTime,n),this._bufferBreakTimer=setTimeout(function(){if(!e.isDestroy&&!t.disableInactiveWaitingCheck&&(!!r||!i.paused)&&(!r||!e.playFlag||!i.paused)){if(1===e._bufferBreakFlag){var n=i.currentTime,a=i.bufferedPoint;if(a.end>0&&a.end-n>=2){e.retrySeekResum(n);return}}e._bufferBreakFlag=2,e.waitTimeoutDegrade()}},a)}this._lastCurrentTime=i.currentTime}}},{key:"getWaitingTimeOut",value:function(){var e=this.player,t=this.config.waitingTimeOut;if(!this.playFlag){var i,r=null===(i=e.curDefinition)||void 0===i?void 0:i.duration;if(r>0){var n=m.zb.find(function(e){return r>=e.range[0]&&r<e.range[1]});n&&(t=n.time)}}return t}},{key:"waitTimeoutDegrade",value:function(){var e,t=this.player;this.changeState("wait_timeout"),this.log(c._.LOG,"确认卡死!!!,curtime,",t.currentTime,JSON.stringify(this.getAllBufferRange()),",duration,",null===(e=this.mp4)||void 0===e||null===(e=e.meta)||void 0===e?void 0:e.duration),this.emit("waittimeout");var i=document.hidden||"hidden"===document.visibilityState,r=new u.Errors(this.player,{errorType:_.iR.RUNTIME,errorCode:i?_.O1.waitTimeoutWithHidden:_.O1.waitTimeout,errorMessage:"wait_timeout",vid:this.playerConfig.vid});this._errorHandler(r)}},{key:"retrySeekResum",value:(V=(0,r.x)((0,r.l5)().mark(function e(t){var i,n,a,o,s=this;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.player,n=this.config,this.changeState("retrySeek"),this.log(c._.LOG,"卡死但有超过2s的buffer,seek下!!!"),clearTimeout(this._seekResumTimer),this._resumePlay=!1,!(n.waitingRetrySeekTimes>0&&n.waitingRetryDuration)){e.next=14;break}return a=Math.min(n.waitingRetrySeekTimes,3),this._currentSeekTimes=0,this.off("playing",this._onResumePlaying),this.once("playing",this._onResumePlaying),o=function(){if(!i||s._resumePlay||i.paused){s.log(c._.LOG,"当前播放实例已恢复或处于暂停状态，退出重试 player=".concat(!!i,",_resumePlay=").concat(s._resumePlay,",paused=").concat(null==i?void 0:i.paused));return}if(s._currentSeekTimes<a){s._seekOnce(t),s._seekResumTimer=setTimeout(o,n.waitingRetryDuration);return}s.waitTimeoutDegrade(),s._seekResumTimer=null},this._seekOnce(t),this._seekResumTimer=setTimeout(o,n.waitingRetryDuration),e.abrupt("return");case 14:i.currentTime=t+1,this.once("playing",function(){s._resumePlay=!0}),this._seekResumTimer=setTimeout(function(){!s._resumePlay&&s.waitTimeoutDegrade(),s._seekResumTimer=null},Math.ceil(n.waitingTimeOut/2));case 17:case"end":return e.stop()}},e,this)})),function(e){return V.apply(this,arguments)})},{key:"_isInBuffer",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=!1,r=this.player.video.buffered,n=0;n<r.length;n++){var a=r.start(n)-t,o=r.end(n)+t;if(a<=e.startTime&&e.endTime<=o){i=!0;break}}return i}},{key:"_doubleCheckBuffer",value:function(e){var t=this.player;return!(e.startTime>t.currentTime)||!t.video||!t.video.buffered||1===t.video.buffered.length||this._isInBuffer(e,.2)}},{key:"isOpenPCDN",value:function(e){var t=this;if(this.pcdn&&this.mp4){var i=e-this.player.currentTime,r=this.pcdn,n=this.config,a=this.mp4,o=n.pcdnConfig,s=r.getPCDNInBuffer()||o.enterMinBuffer,l=r.getPCDNOutBuffer()||o.outMaxBuffer;if(i>=s){if(a.updatePCDNState(y.oy.OPEN),a.isUpdateNode){var d=this.player.curDefinition,u=d.uri,f=d.bitrate;this.pcdn.getPCDNNode(u,f,this.getPCDNReqId()).then(function(e){if(!!a){var i,n=t.getPCDNReqId();if(null!=e&&e.req_id&&n!==e.req_id){t.log(c._.LOG,",getPCDNNode is not match curDefinition reqId",n,", pcdnRet.req_id",e.req_id);return}a.updateNode(null==e?void 0:e.nodes),r.updatePCDNBitrate(f),e&&(a.pcdnTraceInfo={uri:e.vid,fid:e.fid,trace_id:null==e?void 0:e.trace_id}),e&&a.pcdnVVStat&&(a.pcdnVVStat.try_req_node+=1,a.pcdnVVStat.req_node_succ+=1,a.pcdnVVStat.has_ret_node+=(null==e||null===(i=e.nodes)||void 0===i?void 0:i.length)>0?1:0)}}).catch(function(e){(null==a?void 0:a.pcdnVVStat)&&(a.pcdnVVStat.try_req_node+=1),t.checkURLExpired(e,"_getPCDNNode")})}}else i<l&&a.updatePCDNState(y.oy.CLOSE)}}},{key:"checkURLExpired",value:function(e,t){var i,r,n,a,o=S.Z.checkUrlIsExpired(this.config._mainURL);1===o&&this.pcdn&&(this.pcdn=null);var s=(null==e||null===(i=e.response)||void 0===i?void 0:i.url)||(null===(r=this.config.pcdnConfig)||void 0===r?void 0:r.trackerUrl);null===(n=this.player)||void 0===n||n.emit("source_error",{host:S.Z.getHostFromUrl(s),src:s,errorCode:null==e||null===(a=e.response)||void 0===a?void 0:a.status,message:"".concat(null==e?void 0:e.message,"-").concat(o).concat(t)})}},{key:"pushTimerStep",value:function(){var e;(null===(e=this.timerStepList)||void 0===e?void 0:e.length)>m.zK&&this.timerStepList.shift(),this._lastTimeupdateTime2>0&&this.timerStepList.push(S.Z.nowTime()-this._lastTimeupdateTime2)}},{key:"_onTimeUpdate",value:function(){this.pushTimerStep(),this._lastTimeupdateTime2=S.Z.nowTime();var e=this.mse,t=this.mp4,i=this.player,r=this.config;if(!i)return;if((0,C.yx)()&&i.paused!==this._usePaused&&(this._usePaused?i.pause():i.play()),this.useVideoLoad||!t){this.useVideoLoad&&null!==(o=this.expiryCheckPlugin)&&void 0!==o&&null!==(o=o.config)&&void 0!==o&&o.enableExpiryCheck&&S.Z.nowTime()-this._lastCheckTime>1e3&&(this._lastCheckTime=S.Z.nowTime(),this._startUrlExpiredCheck());return}var n=i.getBufferedRange();S.Z.nowTime()-this._lastCheckTime>1e3&&(this._lastCheckTime=S.Z.nowTime(),this._loadStuckCheck(),this._startUrlExpiredCheck(),this._checkRemovePlayedBuffer(n,i.currentTime));var a=t.timeRange;if(!!a&&!(a.length<1)){if((e||this.mseProxy)&&this.canDownload&&!this._suspendLoading){var o,s,l,d=this._maxBufferLength,u=!1;(this.playFlag&&i.paused||!this.isActive)&&(u=!0),u?d=i.isInstNext&&this._nextBufferLength>=0?this._nextBufferLength:this._minBufferLength:null!==(l=this.config)&&void 0!==l&&null!==(l=l.adaptRange)&&void 0!==l&&l.targetCacheControl&&(d=this.adaptRange.getAdaptCacheBuffer()),!this.preLoadData&&null!==(s=this.config)&&void 0!==s&&null!==(s=s.adaptRange)&&void 0!==s&&s.targetCacheControl&&(d+=this.config.noPreloadAddBufferLen);var c=i.currentTime+d;n[1]-c<0&&(this.isOpenPCDN(n[1]),(null==r?void 0:r.loadRangeType)===m.TJ.SIZE?this.sizeRangeCheckLoad(u,d,n[1]-i.currentTime):this.gopRangeCheckLoad(u,d)),this.playFlag&&!this._hasTriggerBufferThreshold&&this._startBufferCheck()}}}},{key:"sizeRangeCheckLoad",value:function(e,t,i){var r=this.player,n=this.mp4;this.config;var a=n.adaptTimeRange,o=a.length,s=n.size-1||r.curDefinition.size-1;if(!(null!=a&&a.length)||(null===(d=a[o-1])||void 0===d?void 0:d.range[1])<s||!a[o-1].isLoading||n.changeBitRateTime>0){var l=a.findIndex(function(e){return!e.downloaded});if(!(null!=a&&a.length)||l>=0||a[o-1].downloaded){var d,u,f=this.calculateAdaptRange(e,t),h=f.adaptRangeRes,p=f.loadDuration;if(h.loadDuration=p,l<0?n.changeBitRateTime>0&&(null===(u=a[o-1])||void 0===u?void 0:u.range[1])>=s?(this._curLoadSegmentIdx=a.length-1,this.log(c._.LOG,"changeBitRateTime> 0 and load last adaptTime")):this._curLoadSegmentIdx=n.updateAdaptTimeRange(null,p):this._curLoadSegmentIdx=l,l>0&&n.changeBitRateTime<=0){var g=a[l-1];if(null!=g&&g.downloaded&&i>0&&(null==g?void 0:g.endTime)-r.currentTime>=t)return}var m=a[this._curLoadSegmentIdx];if(this._curLoadSegmentIdx>=0&&this._isInBuffer(m)&&this._removeBuffEndTime<=0&&this._curLoadSegmentIdx>=0&&m.endTime-m.startTime>1){this.log(c._.LOG,"onTimeUpdate, ".concat(this._curLoadSegmentIdx," download segment, has buffer: "),m.startTime,m.endTime,r.currentTime),m.downloaded=!0,m.isLoading=!0,n.seekTime<m.endTime&&(n.seekTime=m.endTime,this.log(c._.LOG,"".concat(this._curLoadSegmentIdx," download segment, has buffer adjust seekTime")));return}h.idx=this._curLoadSegmentIdx,this.adaptRangeResPush(h),(!a[this._curLoadSegmentIdx].isLoading||n.changeBitRateTime>0)&&(this.log(c._.LOG,"[onTimeUpdate],load index==>>>, ",this._curLoadSegmentIdx,JSON.stringify(a[this._curLoadSegmentIdx])),this._loadData())}}}},{key:"adaptRangeResPush",value:function(e){var t;(!this.adaptRangeRes.length||(null===(t=this.adaptRangeRes[e.length-1])||void 0===t?void 0:t.idx)!==this._curLoadSegmentIdx)&&(this.adaptRangeRes.push(e),this.log(c._.LOG,"adaptRangeRes>>>>",e))}},{key:"gopRangeCheckLoad",value:function(e,t){var i=this,r=this.player,n=this.mp4,a=n.timeRange,o=n.adaptTimeRange,s=n.changeBitRateTime;a.every(function(n,a){if(void 0!==n.adaptTimeRangeIdx&&n.adaptTimeRangeIdx>=0&&o&&o[n.adaptTimeRangeIdx].downloaded&&!(s>0&&n.adaptTimeRangeIdx===o.length-1&&o[n.adaptTimeRangeIdx].downloaded))return!0;var l=i.mp4.getAdaptIdxBySrcIdx(a,!0),d=l>=0?o[l]:null,u=l>=0&&i._isInBuffer(d);if(i._removeBuffEndTime<=0&&l>=0&&d.endTime-d.startTime>1&&u)return o[l].downloaded=!0,o[l].isLoading=!0,i.log(c._.LOG,"onTimeUpdate, ".concat(l," download segment, has buffer"),d.startTime,d.endTime,r.currentTime),!0;if(n.startTime-r.currentTime<t){var f,h=i.calculateAdaptRange(e,t),p=h.adaptRangeRes,g=h.loadDuration;i._curLoadSegmentIdx=i.mp4.updateAdaptTimeRange(a,g),p.idx=i._curLoadSegmentIdx,(null===(f=i.config)||void 0===f||null===(f=f.adaptRange)||void 0===f?void 0:f.rangeControl)&&(p.loadDuration=i.mp4.adaptTimeRange[i._curLoadSegmentIdx].duration),i.adaptRangeResPush(p);var m=o[i._curLoadSegmentIdx];if(i._isInBuffer(m))return m.downloaded=!0,m.isLoading=!0,i.log(c._.LOG,"onTimeUpdate_, ".concat(i._curLoadSegmentIdx," download segment, has buffer"),m.startTime,m.endTime,r.currentTime),!0;(!o[i._curLoadSegmentIdx].isLoading||s>0)&&(i.log(c._.LOG,"[onTimeUpdate],load index==>>>, ",i._curLoadSegmentIdx,JSON.stringify(o[i._curLoadSegmentIdx])),i._loadData())}})}},{key:"calculateAdaptRange",value:function(e,t){var i,r,n,a,o,s={forceSetMin:e};return null!==(i=this.pcdn)&&void 0!==i&&i.isOpenAdaptPCDN&&(s.PCDNInBuffer=this.pcdn.curPCDNInBuffer,s.PCDNOutBuffer=this.pcdn.curPCDNOutBuffer),!this.playFlag||e?a=this._minBufferLength:null!==(o=this.config)&&void 0!==o&&null!==(o=o.adaptRange)&&void 0!==o&&o.rangeControl?(a=this.adaptRange.getAdaptLoadDuration(),s.loadTarDuration=a):a=this.config.rangeMaxDuration,(null===(r=this.config)||void 0===r||null===(r=r.adaptRange)||void 0===r?void 0:r.targetCacheControl)&&(s.cachedBufferDur=t),!this.playFlag&&null!==(n=this.config)&&void 0!==n&&null!==(n=n.adaptRange)&&void 0!==n&&n.rangeControl&&(s.loadTarDuration=a),{adaptRangeRes:s,loadDuration:a}}},{key:"checkReUseMSE",value:function(e){var t=this,i=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=this.mse;if(!!r)if(e||this.config.reUseMSE){r.clearOpQueues(f.d1.VIDEO,i),this.mseAbort();var n,a=null===(n=this.player)||void 0===n?void 0:n.buffered;if((null==a?void 0:a.length)>0){var o=a.end(a.length-1);this.log(c._.LOG,"reUseMSE remove buffer, 0-",o),this._canUpdateDuration=!1,this.removeBuffer(f.d1.VIDEO,0,o,function(){var e;t._canUpdateDuration=!0,(null===(e=t.mp4)||void 0===e||null===(e=e.meta)||void 0===e?void 0:e.duration)&&t.updateMSEDuration()})}}else r.unbindMedia(),this.mse=null,this._unloadVideo()}},{key:"updateMSEDuration",value:function(){var e,t=this.mse,i=this.mp4;this._canUpdateDuration&&null!=i&&null!==(e=i.meta)&&void 0!==e&&e.duration&&i.meta.duration!==t.duration&&(this.log(c._.LOG,"updateMSEDuration ",i.meta.duration,",oldDuration,",t.duration),t.updateDuration(i.meta.duration),this._canUpdateDuration=null)}},{key:"_reset",value:function(){this._bindSrcTiming=m.Iv.META_READY,this._definitionChangePointInfo=null,this.adaptRangeRes=[],this.hitpreload=!1,this._sTime=S.Z.nowTime(),this._removeBuffEndTime=0,this._usePaused=!1,this.useVideoLoad=!1,this._isMseInit=!1,this.loadedDataEventRev=!1,this.needStarLoadFirstSegment=!1,this._curLoadSegmentIdx=0,this.emitExpireTimestamp=null,this.preLoadData=null,this.forPreloadTimeCache=null,this.playFlag=!1,this.waitLevelStartTime=-1,this._waitAdjustTimeCnt=0,this._firstMetFPSStuck=!1,this._initPromise&&"pending"===this._initPromise.state&&this._initPromise.reject(R),this.checkResumePlayTimer&&(clearTimeout(this.checkResumePlayTimer),this.checkResumePlayTimer=null),this._stopProgress(),this.mp4&&(this.mp4.destroy(),this.mp4=null),this.mseProxy&&(this.player.video.removeEventListener("lowdecode",this._onDegrade),this.player.video.removeEventListener("error",this._onError)),this.__onmetadataHandle&&(this.player.video.removeEventListener("loadedmetadata",this.__onmetadataHandle),this.__onmetadataHandle=null),this._unloadVideo(),this._cancelPendingPromises(),this._abrService&&(this._abrService.destroy(),this._abrService=null),this._waitInBufferTimer&&(clearTimeout(this._waitInBufferTimer),this._waitInBufferTimer=null),this.canDownload=!0,this._suspendLoading=!1,this._mediaCodec={videoCodec:"",audioCodec:""}}},{key:"removeErrorUrls",value:function(e,t,i){return e.errorCode===_.O1["403"]&&this._emitExpireEvent(e),i}},{key:"_setPlayerError",value:function(e){if(!this._hasFirstFramed){var t="".concat(this.player.vtype," ").concat(null==e?void 0:e.errorCode,"-").concat(null==e?void 0:e.errorMessage,"-").concat(null==e?void 0:e.rangeStart,"-").concat(null==e?void 0:e.rangeEnd);this._setStartTimelines(a.l1.PLAYER_ERROR,{message:t,httpCode:null==e?void 0:e.errorCode})}}},{key:"checkIsDegraded",value:function(e){var t=this.config,i=t.notDegradeErrorList,r=t.drm,n=t.kid,a=t.drmKeyToken,o=t.keyValue,s=t.secretKey;return!(r||n||a||o||s||e.errorCode>=7e3&&e.errorCode<=7999||(null==i?void 0:i.length)>0&&(e.errorCode===_.O1.timeout&&i.indexOf("timeout")>=0||e.errorCode===_.O1["403"]&&(i.indexOf(403)>=0||i.indexOf("403")>=0)||e.errorCode===_.O1["404"]&&(i.indexOf(404)>=0||i.indexOf("404")>=0)))&&!0}},{key:"_startDegradedPlayback",value:function(e,t){var i=this;this.canDownload=!1;var r=this.player,n=this.playerConfig,o=this.config;if(!r){this._setStartTimelines(a.l1.DESTROY,{message:"-degrade"});return}this.mse&&(this.mse.clearOpQueues(f.d1.VIDEO,!!o.enableMsePatches),this.mseAbort()),this._currentTime=r.currentTime||0,this.player.pause(),this._reset(),this.states=[],this._replay=null;var s=n.H264DefinitionList;if(this.codecType===a.u7.H265&&this.softDecode)this.log(c._.LOG,"h265 softDecode err,degrade use 264 play",n.vid),this._onDegrade(e);else if(this.codecType===a.u7.H264||o.supportHevc||o.supportVvcc||(null==s?void 0:s.length)>0){var l=o.drm,d=o.kid,u=o.drmKeyToken,h=o.keyValue,p=o.secretKey;if(l||d||u||h||p)l&&Object.keys(l).map(function(t){l&&(e[t]=l[t])}),this.log(c._.ERROR,"final error !!!!, ",n.vid,null==e?void 0:e.errorCode,null==e?void 0:e.errorMessage),this.emit("error",e);else{this.log(c._.LOG,this.codecType,"MSE degrade video,",n.vid,r.currentTime),this.emit(x,{errc:null==e?void 0:e.errorCode,err_msg:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),CodecTypes:this.codecType,media_type:n.mediaType}),this.useVideoLoad=!0,this.__onmetadataHandle=function(){var e;if(!!i.player)i._currentTime&&(i.player.currentTime=i._currentTime),i.log(c._.LOG,"DegradedPlayback update currentTime",null===(e=i.playerConfig)||void 0===e?void 0:e.vid,i.codecType,i._currentTime),t?i.player.pause():i.player.play(),i.player.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},r.video.addEventListener("loadedmetadata",this.__onmetadataHandle);var g,v=n.url;if((null==e||null===(g=e.message)||void 0===g?void 0:g.indexOf(m.eT))>=0&&(null==s?void 0:s.length)>0){var _=s.length,y=this.player.curDefinition.definition,T=y&&s.find(function(e){return e.definition===y});!T&&(n.H264DefinitionList.sort(function(e,t){return e.bitrate-t.bitrate}),T=n.H264DefinitionList[Math.floor(_/2)]),T&&(v=T.url,this.playerConfig.codecType=a.u7.H264,this.codecType=a.u7.H264)}this._setPlayerSrc(v)}}else this.log(c._.ERROR,"degrade player failed"),this.emit("error",e)}},{key:"mseAbort",value:function(){var e;if(null!==(e=this.mse)&&void 0!==e&&e.abort){var t=this.mse.abort(f.d1.VIDEO);if(t)return t.catch(function(){}),t}}},{key:"isSeekingInSameBuffer",value:function(e,t){var i=!1,r=this.mp4,n=this._lastBufferPoint;return r.meta&&r.meta.duration-t.end<.5&&(i=!0),n&&0!==e&&e>=n.start&&e<n.end&&(i=!0),this._lastBufferPoint=t,i}},{key:"getAdaptTimeRangeIdx",value:function(e){var t,i,r=this.config,n=this.adaptRange,a=r.segmentMinDuration;return n&&null!=r&&null!==(t=r.adaptRange)&&void 0!==t&&t.rangeControl&&(a=n.getAdaptLoadDuration()),null===(i=this.mp4)||void 0===i?void 0:i.updateAdaptTimeRange(e,a)}},{key:"_startProgress",value:function(){this.initTimer(),this._requestTimer.start(),this._hasStartProgress=!0}},{key:"_unloadVideo",value:function(){this.log(c._.LOG,"unloadVideo");var e=this.player;try{e.video&&e.video.src&&!/^blob/.test(e.currentSrc)&&!/^blob/.test(e.video.src)&&(this.log(c._.LOG,"unloadVideo src"),e.video.removeAttribute("src"),e.video.load())}catch(e){this.log(c._.ERROR,"unloadVideo error",null==e?void 0:e.message)}}},{key:"_addPendingPromise",value:function(e){this._pendingPromises.push(e)}},{key:"_removePendingPromise",value:function(e){this.log(c._.LOG,"removePendingPromise",null==e?void 0:e.id);var t=this._pendingPromises.indexOf(e);t>-1&&this._pendingPromises.splice(t,1)}},{key:"_cancelPendingPromises",value:function(){this._pendingPromises.length>0&&this._pendingPromises.forEach(function(e){e.reject(R)}),this._pendingPromises=[]}},{key:"_onMediaExpired",value:function(){this.log(c._.LOG,"MediaExpired stopProgress"),this._stopProgress(),this.emit(m.fD.MEDIA_EXPIRED)}},{key:"_isEnded",value:function(){var e,t,i,r,n=this.player,a=this.mp4;if(!n)return!1;var o=n.bufferedPoint,s=o?o.end:0;this.checkStartLoadFirstSegment(s);var l=n.currentTime;l>1&&s>l&&(s-l>=2||n.duration-l<1)&&2===n.video.readyState?S.Z.nowTime()-this._lastCheckLagTime>=3e3&&(this.log(c._.LOG,"[has buffer but waiting,seek 0.2 adjust],curTime,",l,", bufferend,",s,", duration,",null==a||null===(r=a.meta)||void 0===r?void 0:r.duration),n.currentTime=l+.2,this._lastCheckLagTime=S.Z.nowTime()):this._lastCheckLagTime=S.Z.nowTime();var d=(null===(e=n.buffered)||void 0===e?void 0:e.length)||0;if(d<=0||!n.buffered)return!1;var u=(null===(t=n.buffered)||void 0===t?void 0:t.end(d-1))||0;return!!(null!=a&&null!==(i=a.meta)&&void 0!==i&&i.duration&&a.meta.duration-n.currentTime<1&&(this._loadedEnd||1>Math.abs(a.meta.duration-u)))&&(this._stopProgress(),this.log(c._.LOG,"[isEnded],stopProgress and endOfStream,curTime, ",n.currentTime,", bufferend,",u,", duration,",a.meta.duration),this.mse&&this.mse.endOfStream().then(function(){}),!0)}},{key:"checkStartLoadFirstSegment",value:function(e){var t=this.player,i=this.mp4,r=this.config;if(!!t&&!!r.loadFirstGopData&&!!(null!=i&&null!==(n=i.meta)&&void 0!==n&&n.duration)&&!!(null!=t&&null!==(a=t.buffered)&&void 0!==a&&a.length)&&!!this.needStarLoadFirstSegment){if((this._loadedEnd||.5>Math.abs(e-this.mp4.meta.duration))&&t.buffered.start(0)>=i.timeRange[0].endTime){this.log(c._.LOG,"changeBitrate load end, reload loadFirstSegment"),this.needStarLoadFirstSegment=!1,i.resetDemuxSampleIdx(0),i._loadSuccessCallBack=this._loadDataSuccess;var n,a,o,s=(null===(o=i.timeRange[0])||void 0===o?void 0:o.range)||i.calculateRange(0);i.fillFirstSegment=!0,i.startLoad(s,0)}}}},{key:"_clearMediaKeys",value:function(){var e=this.player;e.video&&"function"==typeof e.video.setMediaKeys&&e.video.setMediaKeys(null).catch(function(){})}},{key:"_checkRemovePlayedBuffer",value:function(e,t,i,r){var n=this,a=this.mse,o=this.mp4,s=this.player;if(!a||!o||!s)return;if(i&&(clearTimeout(this._removeBufferTimer),this._removeBufferTimer=null),!e&&(e=s.getBufferedRange()),!t&&(t=s.currentTime),!(!i&&S.Z.nowTime()-this._checkRemoveBufferLastTime<=this.config.removeBufferLen)){if(this._checkRemoveBufferLastTime=S.Z.nowTime(),e&&e[0]>=0&&(t-e[0]>this.config.removeBufferLen||a.isFull())){var l=r?e[1]:t-(a.isFull()?0:15),d=o.getFragmentIdx(l);if(d>0&&(r||o.timeRange[d].startTime<t)){var u=Math.floor(Math.min(o.timeRange[d].startTime,e[1])),h=Math.max(o.timeRange[0].endTime+1,e[0]);h<u?(this.log(c._.LOG,"[checkremoveSourceBuffer], remove range==>>>",h,u,t),this.removeBuffer(f.d1.VIDEO,h,u)):a.isFull()&&!this._removeBufferTimer&&(this._removeBufferTimer=setTimeout(function(){n._checkRemovePlayedBuffer(null,null,!0)},1e4))}}}}},{key:"onMediaUpdate",value:function(e){var t=e.vid,i=e.kid,r=e.url,n=this.player,a=this.config;if(t===this.playerConfig.vid&&i===a.kid&&r){this.playerConfig.url=r,this._handlerUrl(r);var o=a._mainURL;return this.useVideoLoad?n.src=r:this.mp4&&this.mp4.updateUrl(o),!0}return!1}},{key:"enableAutoBuffer",value:function(e){var t=this;if(e){if(!this._allInitPromise){this.log(c._.LOG,"player destroyed!!");return}this._allInitPromise.then(function(){t.log(c._.LOG,"enableAutoBuffer true"),t._startProgress()})}else this._stopProgress(),this.log(c._.LOG,"enableAutoBuffer false")}},{key:"bitRateAdapter",get:function(){return this.player&&this.player.plugins?this.config.needAutoBitrate?this.player.plugins.bitrateselector:null:null}},{key:"getDefinitonFromAdapter",value:function(e,t){if(!this.bitRateAdapter)return null;var i=this.bitRateAdapter;return i.getSuitableBitrate?i.getSuitableBitrate(e,t):i.bitRateAdapter?i.bitRateAdapter.select(e):null}},{key:"log",value:function(e,t){for(var i=(this.playerConfig||{}).vid,r=i?"[Index]".concat(i," ").concat(t):"[Index] ".concat(t),n=arguments.length,a=Array(n>2?n-2:0),o=2;o<n;o++)a[o-2]=arguments[o];b.cM.apply(void 0,[this.logger,e,r].concat(a))}},{key:"_emitInitFail",value:function(e){this.log(c._.ERROR,"initFail, reason:",e),this.emit(m.fD.INIT_FAIL,e)}},{key:"useVideoLoad",get:function(){return this._useVideoLoad},set:function(e){this._useVideoLoad=e}},{key:"ready",get:function(){return this._allInitPromise}},{key:"speed",get:function(){return parseInt(y.Yx.speed,10)}},{key:"version",get:function(){return L.i}},{key:"realTimeSpeed",get:function(){return N}},{key:"opQueueLen",get:function(){var e=this.mse&&this.mse._queue?this.mse._queue[f.d1.VIDEO]:[];return e?e.length:0}},{key:"loadSegmentTimeRange",get:function(){return[0,0,0,0]}},{key:"moovSize",get:function(){return 0}},{key:"isDestroy",get:function(){return!this.player}},{key:"domain",get:function(){return S.Z.getHostFromUrl(this.loadURL)}},{key:"loadURL",get:function(){var e=this.player,t=e.currentSrc;return/^blob/.test(e.currentSrc)&&(t=this.mp4.currentLoadUseUrl()),t}},{key:"abrInstance",get:function(){return this._abrService?this._abrService.abrInstance:null}},{key:"expiryCheckPlugin",get:function(){return this.player&&this.player.plugins?this.player._customExpiryCheck?this.player.plugins.expirycheck:null:null}},{key:"isSuspendLoading",get:function(){return this._suspendLoading}},{key:"_handleUrlExpire",value:function(){var e=this,t=this.config,i=this.player,r=i.paused;new Date().getTime()/1e3>=this.urlExpireTimestamp&&this.urlExpireTimestamp>0&&!r&&t.getServerTime&&(i.serverTimeDiffPromise=i.serverTimeDiffPromise||t.getServerTime().catch(function(){return 0}),i.serverTimeDiffPromise.then(function(t){if(t&&(i.serverTimeDiff=new Date().getTime()/1e3-t),new Date().getTime()/1e3>=e.urlExpireTimestamp+i.serverTimeDiff){e.urlExpireTimestamp=new Date().getTime()/1e3+86400;var r=new _.oO("network",_.O1["403"]);e._emitExpireEvent(r)}}))}},{key:"_emitExpireEvent",value:function(e){var t=this.player,i=new Date().getTime()/1e3;return this.emitExpireTimestamp?!!(i-this.emitExpireTimestamp>300)&&(this.emitExpireTimestamp=i,t.emit("MEDIA_EXPIRED",e),!0):(this.emitExpireTimestamp=i,t.emit("MEDIA_EXPIRED",e),!0)}},{key:"reportBugPostPlayerLog",value:function(){this.log(c._.LOG,"reportBugPostPlayerLog"),this.emit(P)}},{key:"getAllBufferRange",value:function(){var e=[],t=this.player;if(!t||!(null!=t&&t.buffered))return e;var i=t.buffered;if(i)for(var r=0,n=i.length;r<n;r++)e.push([null==i?void 0:i.start(r),null==i?void 0:i.end(r)]);return e}}],[{key:"pluginName",get:function(){return"Mp4EncryptPlayer"}},{key:"defaultConfig",get:function(){return g.g}},{key:"speed",get:function(){return N}},{key:"realTimeSpeed",get:function(){return N}},{key:"version",get:function(){return L.i}}])}(d.q);B.isSupported=C.Gb,B.isEMESupported=C.KI,B.isSupportedWithXgmse=C.pU,B.isMediaSourceSupported=C.Hs,B.isWebAssemblySupported=C.qK,B.CUSTOM_EVENTS=m.fD,B.updateUnionInfo=n.XGSecretKey.updateUnionInfo,B.generateEncryptInfo=n.XGSecretKey.generateEncryptInfo,B.registerPreloader=d.q.registerPreloader},585130:function(e,t,i){i.d(t,{Z:function(){return f}});var r=i(22450);i(836654),i(910795),i(464135),i(981168),i(47513),i(98601),i(110617),i(927234),i(250440),i(742611);var n=i(258817),a=i(810815),o=i(663153),s=i(749517),l=i(212401),d=i(805229),u=i(734123),c=i(546041),f=(0,r.qH)(function e(t){var i=this;(0,r.PA)(this,e),(0,r._x)(this,"start",function(){var e=i._pluginInst.player;i._pluginInst.originStartInit.call(e,i._url);var t="dash mp4 kernal start";i._pluginInst.info({msg:t}),s.ZP.log(t)}),(0,r._x)(this,"_errorHandler",function(e){var t,r,n=i._pluginInst,a=n.player,o=n.config;if(!i._hasHandleError){if(a.video.error)e=new u.Errors(a,{errorType:l.wb.MEDIA,errorCode:5100+a.video.error.code});else{var d=e;if("string"!=typeof e)try{d=JSON.stringify(e)}catch(e){d="other"}e=new u.Errors(a,{errorType:l.wb.OTHER,errorCode:0,errorMessage:d})}i._stat.error.push({err:e}),s.ZP.log(null==o?void 0:o.vid,"mp4 error",e);var f=new Date().getTime()/1e3>=i.urlExpireTimestamp&&i.urlExpireTimestamp>0;if(i._pluginInst.info({msg:"dash mp4 kernal error happend, url expired ".concat(f),err:e}),f&&a.video.error&&(4===a.video.error.code||2===a.video.error.code)){!i._urlExpiredWhenInit&&i._mp4CheckExpire();return}i._pluginInst.setStartTimelines(c.l1.PLAYER_ERROR,{message:"dashmp4-".concat(e.errorMessage,"-").concat(e.errorCode)}),i._hasHandleError=!0,null!==(t=e.src)&&void 0!==t&&t.includes("downgrade_264=1")&&(null===(r=e)||void 0===r?void 0:r.readyState)===0&&a.fallBackFail&&(a.fallBackFail=!1,a.isNetError=!0),a.emit("error",e)}}),(0,r._x)(this,"_updateMp4Auto",function(){setTimeout(function(){i._updateMp4AutoDesc()},0)}),this._url=null,this._pluginInst=t,this._urlExpiredWhenInit=!1,this._hasHandleError=!1,this._initialize(),this._proxyPlayer(),this._stat={type:"mp4",error:[]}},[{key:"executeReady",value:function(){var e=this._pluginInst.player;e.dashState=a.Y9,e.emit("nextEnded")}},{key:"_initialize",value:function(){var e=this,t=this._pluginInst.config;this._handleMp4Definitions(t.defaultDefinition),this._getMp4Opts();var i=this._pluginInst.player;i.dash=!1,setTimeout(function(){i.emit("resourceReady",e._mp4Definitions||[],[].concat(e._RawMp4Definitions)),e._updateMp4Auto()}),this.urlExpireTimestamp&&(this._urlExpiredWhenInit=new Date().getTime()/1e3>=this.urlExpireTimestamp&&this.urlExpireTimestamp>0,this._mp4CheckExpire())}},{key:"onPreChangeDefinition",value:function(e){var t=this._pluginInst,i=t.config,r=t.player;return!i.mp4Opts&&(i.mp4Opts={}),i.mp4Opts.mp4List=e,this._handleMp4Definitions(this._currDefinition),r.config.definition&&(r.config.definition.defaultDefinition=this._currDefinition,r.plugins.definition&&(r.plugins.definition.config.defaultDefinition=this._currDefinition)),r.emit("resourceReady",this._mp4Definitions),this._mp4Definitions}},{key:"_handleMp4Definitions",value:function(e){var t=this;e=e&&e.toString();var i=this._pluginInst,r=i.player,n=i.config,s=i.playerConfig;if(s.downgradeUrl&&(!n.mp4Opts||!n.mp4Opts.list||0===n.mp4Opts.list.length)){var c=[{url:s.downgradeUrl,definition:"1",vtype:"MP4",size:0,codecType:"h264"}];n.mp4Opts={mp4List:c}}if(n.mp4Opts){this.mp4AutoItem=null;var f,h=[].concat(n.mp4Opts.mp4List||[]);h.every(function(e){return!!e.bitrate})&&h.sort(function(e,t){return t.bitrate-e.bitrate});var p=n.mp4Opts.isOpenAutoDefi,g=n.mp4Opts.isPlayAutoDefi,m=!1;if(p){var v={};h.forEach(function(e){v[(e.definition||"").toLowerCase()]=e});for(var _=["720p","480p","360p"],y=null,T=0;T<_.length;T++){var k=v[_[T]];if(k){y=k;break}}if(y){this.mp4AutoItem=y;var E=n.mp4Opts.autoDefiText||"自动",S="".concat(E,"(").concat(y.definition,")");h.push({definition:E,url:o.UV,name:S,url_expire:y.url_expire||0,selected:!!g}),m=g}}if(h.length>0){h.forEach(function(e){if(e.definition&&(e.definition=e.definition.toString()),s&&"function"==typeof s.preProcessUrl){var t=s.preProcessUrlOptions||{};e.url=s.preProcessUrl(e.url,t).url}});var C=h[0].url,b=h[0].url;h.forEach(function(i){i.definition===e&&(C=i.url,b=i.url,t._currDefinition=e)}),p&&g&&this.mp4AutoItem&&(C=this.mp4AutoItem.url,b=o.UV),this._mp4Url=b,this._url=C,this._pluginInst.loadURL=C}if(!m){for(var D=0;D<h.length;D++){var L=h[D];if(e===L.definition){L.selected=!0,m=!0,this._currDefinition=e;break}}if(!m){if(h.length>0)h[0].selected=!0,this._currDefinition=String(h[0].definition);else{setTimeout(function(){var e=l.WE[l.wb.MEDIA][l.wb.SUB_TYPES.MEDIA_ERR_URL_EMPTY],t=new u.Errors(r,{errorType:l.wb.MEDIA,errorCode:e});r.emit(d.K.ERROR,t)});return}}}this._mp4Definitions=h.map(function(i){e===i.definition&&(t._url=i.url,!g&&(i.selected=!0));var r=JSON.parse(JSON.stringify(i));return r.name=n.definitionText&&n.definitionText[i.definition]||i.definition,r.url_expire=i.url_expire||0,r}),this._backup_url=this._mp4Definitions[0].backup_url,this._RawMp4Definitions=h;var R=!1;this._pluginInst.setCodeInfo(null===(f=h[0])||void 0===f?void 0:f.codec_type);for(var P=0;P<h.length;P++){var x=h[P];x.codec_type&&x.vtype&&("h264"!==x.codec_type||"mp4"!==x.vtype)&&(R=!0)}R&&r.emit("log",{type:"oneevent",end_type:a.c9})}}},{key:"_getMp4Opts",value:function(){var e=this._pluginInst.player,t={url:this._mp4Url,realUrl:this._url,mp4Definitions:[].concat(this._mp4Definitions)};return this._getPlayInfoTimestamp=new Date().getTime()/1e3,t.mp4Definitions&&t.mp4Definitions.length>0&&t.mp4Definitions[0]&&(this.urlExpireTimestamp=t.mp4Definitions[0].url_expire||0),this._destroyMp4AutoHandler(),e.on("canplay",this._updateMp4Auto),this.urlExpireTimestamp&&(this.mp4CheckExpire=this._mp4CheckExpire.bind(this),e.on("timeupdate",this.mp4CheckExpire)),t}},{key:"_proxyPlayer",value:function(){var e=this._pluginInst,t=e.player,i=e.config;this._originSwitchURL=t.switchURL,this._originErrorHandler=t.errorHandler,i.defaultFormat="mp4",t._startInit=this.start,t.errorHandler=this._errorHandler,t.switchURL=this._switchURLMp4.bind(this),t.config.url=this._url}},{key:"_switchURLMp4",value:function(e){var t=this,i=this._pluginInst.player,r=(Array.isArray(e)?e:e.split("/")[e.split("/").length-1])===o.UV,a=r?this.mp4AutoItem.url:e;this._pluginInst.loadURL=a,i.curTime=i.currentTime;var s=i.paused;this._url=r?o.UV:e,!i.ended&&(i.src=a,n.Z.once(i,"canplay",function(){if(i.currentTime=i.curTime,!s){var e=i.play();void 0!==e&&e&&e.catch(function(){})}s&&i.pause()}));r?this._setCurrentDefitionInfos("自动 ".concat(this.mp4AutoItem.definition),this.mp4AutoItem):n.Z.once(i,"definitionChange",function(e){for(var i=e.to,r=null,n=t._pluginInst.cnofig,a=0;a<n.mp4Opts.mp4List.length;a++){var o=n.mp4Opts.mp4List[a];if(o.definition===i){r=o,t._currDefinition=String(r.definition);break}}t._setCurrentDefitionInfos("".concat(i),r)})}},{key:"_mp4CheckExpire",value:function(){var e;null===(e=this._pluginInst)||void 0===e||e.handleUrlExpire(this,!0)}},{key:"_updateMp4AutoDesc",value:function(){var e=this._pluginInst.player,t=this._url!==o.UV||void 0;this.mp4AutoItem&&(e.emit("MP4_AUTO_DESC_CHANGE",JSON.parse(JSON.stringify(this.mp4AutoItem)),!!t||void 0),!t&&this._setCurrentDefitionInfos(this.mp4AutoItem.definition,this.mp4AutoItem))}},{key:"_setCurrentDefitionInfos",value:function(e,t){this._pluginInst.setCurrentDefitionInfos(e,t)}},{key:"_destroyMp4AutoHandler",value:function(){var e=this._pluginInst.player;e.off("canplay",this._updateMp4Auto),e.off("timeupdate",this._mp4CheckExpire)}},{key:"destroy",value:function(){var e=this._pluginInst.player;e.errorHandler=this._originErrorHandler,e._startInit=this._pluginInst._originStartInit,this._destroyMp4AutoHandler(),this._pluginInst.unloadVideo(),e.switchURL=this._originSwitchURL}},{key:"getStat",value:function(){var e=this._pluginInst.player;this._stat.currentTime=e.currentTime;var t=e.video.error;return this._stat.videoError=t?{code:t.code,message:t.message}:null,this._stat}}])},174328:function(e,t,i){i.d(t,{F:function(){return a}});var r=i(622109);i(465132),i(499045),i(891555),i(110617),i(742611);var n=i(746249),a=function(e){function t(){var e;return(0,r.PA)(this,t),e=(0,r.$w)(this,t,arguments),e._oldContext=null,e._curContext=null,e}return(0,r.XW)(t,e),(0,r.qH)(t,[{key:"start",value:function(){var e=this,t=this.instManager;this.stop(),t.on(n.L.VIDEO_LIST_CONTEXT_CHANGED,function(){var i=t.getVideoListContext();if(!!i)e._curContext&&(e._oldContext=e._curContext),e._curContext=i,e._execTask()})}},{key:"stop",value:function(){this.instManager.off(n.L.VIDEO_LIST_CONTEXT_CHANGED)}},{key:"_execTask",value:function(){this._cancelPrevVideoTask(),this._tryResumeDownloadTask()}},{key:"_getDistanceToNearestLiveVideo",value:function(e){if(!e)return -1;var t=this.instManager.getVideoListContext();if(!t||!t.allVideos||0===t.allVideos.length)return -1;var i=t.allVideos.findIndex(function(t){return t.vid===e});if(-1===i)return -1;for(var r=-1,n=i+1,a=n;a<t.allVideos.length;a++)if(t.allVideos[a].isLive){r=a-i;break}return r}},{key:"_getSelectBitrateFactor",value:function(e){if(!e)return 1;var t=this._getDistanceToNearestLiveVideo(e);if(t<=0)return 1;var i=this.config,r=i.degradeBitrateType,n=i.degradeBitrateFactors;if("factor"===r){if(Array.isArray(n))return Math.max(0,Math.min(1,n[t-1]||1))}else if("force"===r)return Array.isArray(n)&&n[t-1]||0;return 1}},{key:"getSelectBitrateFactor",value:function(e){var t=this.config,i=t.degradeBitrateType,r=t.degradeBitrateFactorType;return{value:this._getSelectBitrateFactor(e),factorType:r,degradeBitrateType:i}}},{key:"_cancelPrevVideoTask",value:function(){if(!this._oldContext||!this._curContext)return;var e=this._curContext,t=e.current,i=e.allVideos,r=i.findIndex(function(e){return e.vid===t.vid});if(-1!==r){var n=this.config,a=n.cancelType,o=n.cancelNum,s=i.find(function(e,t){return t===r-1});switch(a){case"all":this._suspendDownload(s);break;case"pre":var l=i.slice(r).findIndex(function(e){return e.isLive});l>-1&&"number"==typeof o&&o>0&&l+1<=o&&this._suspendDownload(s)}}}},{key:"_satisfyToCancel",value:function(e){return!!e&&(!!(e.getBufferedRange()[1]>=(this.config.cancelMinBuffer||0))||!1)}},{key:"_getWorkingPlugin",value:function(e){if(!!e)return e.plugins.mp4encryptplayer||e.plugins.dashplugin}},{key:"_suspendDownload",value:function(e){var t=this;if(!!e&&!!e.vid&&!e.isLive)this.instManager.findAll(function(t){var i;return(null===(i=t.config)||void 0===i?void 0:i.vid)===e.vid}).forEach(function(e){if(!!t._satisfyToCancel(e)){var i,r=t._getWorkingPlugin(e);r&&(null===(i=r.suspendLoading)||void 0===i||i.call(r))}})}},{key:"_tryResumeDownloadTask",value:function(){var e=this;if(!!this._curContext){var t=this._curContext.current,i=this.instManager.findAll(function(e){var i;return(null===(i=e.config)||void 0===i?void 0:i.vid)===t.vid||e.isUserActive});i.length>0&&i.forEach(function(t){var i,r=e._getWorkingPlugin(t);null!=r&&r.isSuspendLoading&&(null===(i=r.resumeLoading)||void 0===i||i.call(r))})}}}])}(i(719515).N);a.STRATEGY_NAME="vod-live-joint-optimize"},896167:function(e,t,i){i.d(t,{e:function(){return d}});var r=i("42787");i("836654"),i("691842"),i("511141"),i("464135"),i("206642"),i("429532"),i("98601"),i("110617"),i("914613"),i("271692"),i("296702"),i("828514"),i("187562"),i("166613"),i("801402"),i("862956"),i("703327"),i("573545"),i("170399"),i("544805"),i("463724"),i("279651"),i("874386");var n=i("444352"),a=i("29898"),o=i("145594"),s=(0,r.qH)(function e(t,i,n,a){var o=this;(0,r.PA)(this,e),this.config=e.getDefaultConfig(),Object.keys(a).map(function(e){void 0!==a[e]&&null!==a[e]&&(o.config[e]=a[e])}),this.duration=n,this.player=t,this.updateBitrate(i),this.curPCDNInBuffer=this.config.maxPCDNInBuffer,this.curPCDNOutBuffer=this.config.maxPCDNOutBuffer,this.PCDNChangeCnt=0},[{key:"updateBitrate",value:function(e){this.bitrate=e,!this.bitrate&&(this.bitrate=this.config.minBandwidth)}},{key:"getPCDNInBuffer",value:function(){var e=this.config,t=this.player,i=this.bitrate;if(!e.PCDNBufferControl)return null;var r=e.estPlayTime,n=r;e.estPTcontrol&&(n=Math.min(r,Math.max(0,this.duration-((null==t?void 0:t.currentTime)||0))));var a=e.safePCDNInFactor,o=e.minBandwidth,s=e.maxPCDNInBuffer,l=e.minPCDNInBuffer,d=a*Math.max((null==t?void 0:t.avgSpeedPCDN)*1024||0,o),u=i>0?(1-d/i)*n:0;return this.curPCDNInBuffer=Math.min(s,Math.max(l,u)),this.curPCDNInBuffer}},{key:"getPCDNOutBuffer",value:function(){var e=this.config,t=this.player,i=this.bitrate;if(!e.PCDNBufferControl)return null;var r=e.estPlayTime,n=r;e.estPTcontrol&&(n=Math.min(r,Math.max(0,this.duration-((null==t?void 0:t.currentTime)||0))));var a=e.safePCDNOutFactor,o=e.minBandwidth,s=e.maxPCDNOutBuffer,l=e.minPCDNOutBuffer,d=a*Math.max((null==t?void 0:t.avgSpeedPCDN)*1024||0,o),u=i>0?(1-d/i)*n:0;return this.curPCDNOutBuffer=Math.min(s,Math.max(l,u)),this.curPCDNOutBuffer}},{key:"getPCDNChangeCnt",value:function(){var e=this.config,t=e.PCDNCntControl,i=e.alpha,r=this.curPCDNInBuffer,n=this.player,a=(null==n?void 0:n.bufferedPoint)||null,o=a&&a.end?a.end-n.currentTime:0;return t?o>r+(this.PCDNChangeCnt-1)*i&&this.PCDNChangeCnt++:o>=r&&this.PCDNChangeCnt<2&&this.PCDNChangeCnt++,this.PCDNChangeCnt}}],[{key:"getDefaultConfig",value:function(){return{PCDNBufferControl:!1,PCDNCntControl:!1,estPTcontrol:!1,minPCDNInBuffer:8,maxPCDNInBuffer:12,minPCDNOutBuffer:3,maxPCDNOutBuffer:6,safePCDNInFactor:.1,safePCDNOutFactor:.4,alpha:.5,estPlayTime:12,minBandwidth:1e6}}}]),l=new Map,d=function(){var e,t;function i(e,t,a,o){var l,d=this;(0,r.PA)(this,i),this.options=i.getDefaultConfig(),Object.keys(e).map(function(t){void 0!==e[t]&&null!==e[t]&&(d.options[t]=e[t])}),!this.options.productConfig||this.options.productConfig.app_id,this.loader=new n.mf(this.options),this.resetTrackeArgs(),this._lastFileInfo=null,this.lastfetchNodeTime=-1,this._lastRetFileKey=null,this._minUpdateNodeStep=this.options.ErrorTimeStep,null!==(l=this.options)&&void 0!==l&&null!==(l=l.adaptPCDNConfig)&&void 0!==l&&l.PCDNBufferControl&&(this.pcdnAdapt=new s(t,a,o,this.options.adaptPCDNConfig))}return(0,r.qH)(i,[{key:"isOpenAdaptPCDN",get:function(){return!!this.pcdnAdapt}},{key:"curPCDNInBuffer",get:function(){return this.pcdnAdapt.curPCDNInBuffer}},{key:"getPCDNInBuffer",value:function(){var e;return null===(e=this.pcdnAdapt)||void 0===e?void 0:e.getPCDNInBuffer()}},{key:"curPCDNOutBuffer",get:function(){return this.pcdnAdapt.curPCDNOutBuffer}},{key:"getPCDNOutBuffer",value:function(){var e;return null===(e=this.pcdnAdapt)||void 0===e?void 0:e.getPCDNOutBuffer()}},{key:"curPCDNChangeCnt",get:function(){return this.pcdnAdapt.PCDNChangeCnt}},{key:"getPCDNChangeCnt",value:function(){var e;return null===(e=this.pcdnAdapt)||void 0===e?void 0:e.getPCDNChangeCnt()}},{key:"updatePCDNBitrate",value:function(e){var t;return null===(t=this.pcdnAdapt)||void 0===t?void 0:t.updateBitrate(e)}},{key:"resetTrackeArgs",value:function(e){this.trackeArgs={fid:null,trace_id:null,req_times:(null==e?void 0:e.req_times)||0,resp_times:(null==e?void 0:e.resp_times)||0,token:null,node_num:this.options.node_num,client_info:this.options.client_info}}},{key:"getPCDNNode",value:function(e,t,i){var r,n=c(t),o=l.get(u(e,n)),s=new a.Q;return!(null!=o&&o.nodes)||(null==o||null===(r=o.nodes)||void 0===r?void 0:r.length)<1?this.fetchPCDNNode(null,null,i).then(function(e){s.resolve(e)}).catch(function(e){s.reject(e)}):(o.fromCache=!0,s.resolve(o)),s}},{key:"removePCDNNode",value:function(e,t,i){var r=c(t),n=l.get(u(e,r)),a=null==n?void 0:n.nodes;a&&(i?n.nodes=a.filter(function(e){return e&&0>i.indexOf(e.url)}):a.shift(),l.set(u(e,r),n)),(!a||!a.length)&&this.fetchPCDNNode().then().catch(function(){})}},{key:"fetchPCDNNode",value:(e=(0,r.x)((0,r.l5)().mark(function e(t,o,s){var d,f,h,p,g,m,v,_,y,T,k,E,S,C,b,D;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(d=new a.Q,o){e.next=5;break}o=this._lastFileInfo,e.next=15;break;case 5:if(o.byterate=c(o.bitrate),this.options.trackerOptions&&Object.assign(o,this.options.trackerOptions),this._lastFileInfo=Object.assign({},o,{byterate:o.byterate}),!((null==(h=l.get(u(o.vid,o.byterate)))||null===(f=h.nodes)||void 0===f?void 0:f.length)>0)){e.next=13;break}return h.fromCache=!0,d.resolve(h),e.abrupt("return",d);case 13:delete o.bitrate,this._lastFileInfo=o;case 15:if(o){e.next=18;break}return d.resolve(null),e.abrupt("return",d);case 18:if(p=!1,g=u(o.vid,o.byterate),this._lastRetFileKey!==g&&(this.resetTrackeArgs(),p=!0),!(Date.now()-this.lastfetchNodeTime<this._minUpdateNodeStep&&!p)){e.next=24;break}return d.resolve(null),e.abrupt("return",d);case 24:if(this.lastfetchNodeTime=Date.now(),this._lastRetFileKey=g,o.sfid?o.version=1:o.vid&&(o.version=2),this.options.withReferer&&(o.with_referer=this.options.withReferer),m=JSON.stringify(Object.assign(this.options.productConfig,{file_info:o},this.trackeArgs,{req_id:s})),!(this.trackeArgs.req_times>=this.options.maxCnt)){e.next=33;break}return d.resolve(null),e.abrupt("return",d);case 33:return!this.loader&&(this.loader=new n.mf(this.options)),this.trackeArgs.req_times+=1,e.prev=35,i.pcdn_tracker_request_cnt++,e.next=39,this.loader.load(t||this.options.trackerUrl,{body:m});case 39:v=e.sent,_=null,v&&(this.trackeArgs.resp_times+=1,T=8*o.byterate,v.done&&null!==(y=v.data)&&void 0!==y&&y.Result?((_=(k=v.data.Result).nodes)&&_.length>0?i.pcdn_tracker_success_cnt++:this._minUpdateNodeStep=this.options.NULLNodeTimeStep,_.map(function(e){e.vid=o.vid,e.bitrate=T}),E=k.fid,S=k.trace_id,C=k.req_id,b={nodes:_,fid:E,vid:o.vid,trace_id:S,req_id:C,bitrate:T},D=u(o.vid,o.byterate),l.set(D,b),this.trackeArgs.fid=k.fid,this.trackeArgs.trace_id=k.trace_id,this.trackeArgs.token=k.token,d.resolve(b)):(this._minUpdateNodeStep=this.options.ErrorTimeStep,d.reject(v))),e.next=49;break;case 44:e.prev=44,e.t0=e.catch(35),this._minUpdateNodeStep=this.options.ErrorTimeStep,d.reject(e.t0);case 49:return e.abrupt("return",d);case 50:case"end":return e.stop()}},e,this,[[35,44]])})),function(t,i,r){return e.apply(this,arguments)})}],[{key:"pluginName",get:function(){return"PCDN"}},{key:"pcdnReqCnt",get:function(){var e=i.pcdn_tracker_request_cnt,t=i.pcdn_tracker_success_cnt;return i.pcdn_tracker_request_cnt=0,i.pcdn_tracker_success_cnt=0,{pcdn_tracker_request_cnt:e,pcdn_tracker_failed_cnt:e-t}}},{key:"getDefaultConfig",value:function(){return{trackerUrl:"",loaderType:o.t.FETCH,responseType:o.U.JSON,mode:"cors",method:"POST",retry:0,retryDelay:3e3,timeout:5e3,node_num:5,client_info:null,maxCnt:30,withReferer:0,NULLNodeTimeStep:6e4,ErrorTimeStep:15e3}}},{key:"gainPCDNNode",value:(t=(0,r.x)((0,r.l5)().mark(function e(t,o,s,l){var d,u,f,h,p,g;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return d=i.getDefaultConfig(),Object.keys(o).map(function(e){void 0!==o[e]&&null!==o[e]&&(d[e]=o[e])}),!l||l.app_id,u=new a.Q,s?(s.byterate=c(s.bitrate),this.options.trackerOptions&&Object.assign(s,this.options.trackerOptions),delete s.bitrate):u.reject("video fileInfo need set"),f=JSON.stringify(Object.assign(l,{file_info:s},{node_num:(null==o?void 0:o.node_num)||3})),h=new n.mf(d),e.prev=8,i.pcdn_tracker_request_cnt++,e.next=12,h.load(t,{body:f});case 12:(g=e.sent).done&&(null===(p=g.data)||void 0===p||null===(p=p.Result)||void 0===p||null===(p=p.nodes)||void 0===p?void 0:p.length)>0&&i.pcdn_tracker_success_cnt++,u.resolve(g),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(8),u.reject((null===e.t0||void 0===e.t0?void 0:e.t0.message)||"get pcdnNode error");case 20:return e.abrupt("return",u);case 21:case"end":return e.stop()}},e,this,[[8,17]])})),function(e,i,r,n){return t.apply(this,arguments)})}])}();function u(e,t){return"".concat(e,"-").concat(t)}function c(e){return Math.floor(e/8)}(0,r._x)(d,"pcdn_tracker_request_cnt",0),(0,r._x)(d,"pcdn_tracker_success_cnt",0)},282850:function(e,t,i){i.d(t,{_:function(){return n}});var r=i(758772),n=function(){function e(t,i,n){(0,r.PA)(this,e),(0,r._x)(this,"flag",{}),(0,r._x)(this,"keyframe",!1),(0,r._x)(this,"gopId",0),(0,r._x)(this,"duration",0),(0,r._x)(this,"size",0),(0,r._x)(this,"units",[]),(0,r._x)(this,"chromaFormat",420),this.originPts=this.pts=t,this.originDts=this.dts=i,n&&(this.units=n)}return(0,r.qH)(e,[{key:"cts",get:function(){return this.pts-this.dts}},{key:"setToKeyframe",value:function(){this.keyframe=!0,this.flag.dependsOn=2,this.flag.isNonSyncSample=0}}]),e}()}}]);
/*! For license information please see player-10.58f8eeec.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).xss={})}(this,function(e){"use strict";var t=function(){return(t=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function i(e,t,i){if(i||2==arguments.length)for(var n,r=0,a=t.length;r<a;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))}var n=/[^a-zA-Z0-9\\_:.-]/gim,r=/</g,a=/>/g,o=/&#([a-zA-Z0-9]*);?/gim,s=/&quot;/g,l=/&colon;?/gim,d=/&newline;?/gim,c=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a):/gi,u=/u\s*r\s*l\s*\(.*/gi,h=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,f=/"/g,p=function(e){return e.replace(r,"&lt;").replace(a,"&gt;")},v={indexOf:function(e,t){var i,n;for(i=0,n=e.length;i<n;i++)if(e[i]===t)return i;return -1},forEach:function(e,t,i){var n,r;for(n=0,r=e.length;n<r;n++)t.call(i,e[n],n,e)},some:function(e,t,i){var n,r;for(n=0,r=e.length;n<r;n++)if(t.call(i,e[n],n,e))return!0;return!1},trim:function(e){return e.replace(/(^\s*)|(\s*$)/g,"")},includes:function(e,t){if("string"==typeof e)return -1!==e.indexOf(t);for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1},spaceIndex:function(e){var t=/\s|\n|\t/.exec(e);return t?t.index:-1},uniq:function(e){for(var t={},i=[],n=0;n<e.length;n++)t[e[n]]||(i.push(e[n]),t[e[n]]=!0);return i},from:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t},keys:function(e){var t=[];for(var i in e)t.push(i);return t}};function g(e){return null==e}function _(e){var t;return'"'===(t=e)[0]&&'"'===t[t.length-1]||"'"===t[0]&&"'"===t[t.length-1]?e.substr(1,e.length-2):e}function m(e){var t,i,n,r,a,o,s,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d="",c=0;for(e=function(e){e=e.replace(/rn/g,"n");for(var t="",i=0;i<e.length;i++){var n=e.charCodeAt(i);n<128?t+=String.fromCharCode(n):n>127&&n<2048?t+=String.fromCharCode(n>>6|192)+String.fromCharCode(63&n|128):t+=String.fromCharCode(n>>12|224)+String.fromCharCode(n>>6&63|128)+String.fromCharCode(63&n|128)}return t}(e);c<e.length;)r=(t=e.charCodeAt(c++))>>2,a=(3&t)<<4|(i=e.charCodeAt(c++))>>4,o=(15&i)<<2|(n=e.charCodeAt(c++))>>6,s=63&n,isNaN(i)?o=s=64:isNaN(n)&&(s=64),d=d+l.charAt(r)+l.charAt(a)+l.charAt(o)+l.charAt(s);return d}function y(e){var t,i,n,r,a,o,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l="",d=0;for(e=e.replace(/[^A-Za-z0-9+/=]/g,"");d<e.length;)t=s.indexOf(e.charAt(d++))<<2|(r=s.indexOf(e.charAt(d++)))>>4,i=(15&r)<<4|(a=s.indexOf(e.charAt(d++)))>>2,n=(3&a)<<6|(o=s.indexOf(e.charAt(d++))),l+=String.fromCharCode(t),64!==a&&(l+=String.fromCharCode(i)),64!==o&&(l+=String.fromCharCode(n));return function(e){for(var t="",i=0,n=0,r=0,a=0;i<e.length;)(n=e.charCodeAt(i))<128?(t+=String.fromCharCode(n),i++):n>191&&n<224?(t+=String.fromCharCode((31&n)<<6|63&(a=e.charCodeAt(i+1))),i+=2):(a=e.charCodeAt(i+1),t+=String.fromCharCode((15&n)<<12|(63&a)<<6|63&(r=e.charCodeAt(i+2))),i+=3);return t}(l)}function k(e,t,i){var n="",r=0,a=!1,o=!1,s=0,l=e.length,d="",c="";e:for(s=0;s<l;s++){var u=e.charAt(s);if(!1===a){if("<"===u){a=s;continue}}else if(!1===o){if("<"===u){n+=i(e.slice(r,s)),a=s,r=s;continue}if(">"===u||s===l-1){n+=i(e.slice(r,a)),d=function(e){var t,i=v.spaceIndex(e);return t=-1===i?e.slice(1,-1):e.slice(1,i+1),"/"===(t=v.trim(t).toLowerCase()).slice(0,1)&&(t=t.slice(1)),"/"===t.slice(-1)&&(t=t.slice(0,-1)),t}(c=e.slice(a,s+1)),n+=t(a,n.length,d,c,"</"===c.slice(0,2)),r=s+1,a=!1;continue}if('"'===u||"'"===u)for(var h=1,f=e.charAt(s-h);""===f.trim()||"="===f;){if("="===f){o=u;continue e}f=e.charAt(s-++h)}}else if(u===o){o=!1;continue}}return r<l&&(n+=i(e.substr(r))),n}function b(e,t){var i=0,r=0,a=[],o=!1,s=e.length;function l(e,i){if(!((e=(e=v.trim(e)).replace(n,"").toLowerCase()).length<1)){var r=t(e,i||"");r&&a.push(r)}}for(var d=0;d<s;d++){var c=e.charAt(d),u=void 0;if(!1!==o||"="!==c){if(!1===o||d!==r){if(/\s|\n|\t/.test(c)){if(e=e.replace(/\s|\n|\t/g," "),!1===o){if(-1===(u=function(e,t){for(;t<e.length;t++){var i=e[t];if(" "!==i)return"="===i?t:-1}return -1}(e,d))){l(v.trim(e.slice(i,d))),o=!1,i=d+1;continue}d=u-1;continue}if(-1===(u=function(e,t){for(;t>0;t--){var i=e[t];if(" "!==i)return"="===i?t:-1}return -1}(e,d-1))){l(o,_(v.trim(e.slice(i,d)))),o=!1,i=d+1;continue}}}else{if(-1===(u=e.indexOf(c,d+1)))break;l(o,v.trim(e.slice(r+1,u))),o=!1,i=(d=u)+1}}else o=e.slice(i,d),i=d+1,r='"'===e.charAt(i)||"'"===e.charAt(i)?i:function(e,t){for(;t<e.length;t++){var i=e[t];if(" "!==i)return"'"===i||'"'===i?t:-1}return -1}(e,d+1)}return i<e.length&&(!1===o?l(e.slice(i)):l(o,_(v.trim(e.slice(i))))),v.trim(a.join(" "))}function S(e,t,i){if(i=function(e){return e=function(e){for(var t="",i=0,n=e.length;i<n;i++)t+=32>e.charCodeAt(i)?" ":e.charAt(i);return v.trim(t)}(e=(e=(e=e.replace(s,'"')).replace(o,function(e,t){return"x"===t[0]||"X"===t[0]?String.fromCharCode(parseInt(t.substr(1),16)):String.fromCharCode(parseInt(t,10))})).replace(l,":").replace(d," "))}(i),"href"===t||"src"===t){if("#"===(i=v.trim(i)))return"#";if("http://"!==i.substr(0,7)&&"https://"!==i.substr(0,8)&&"mailto:"!==i.substr(0,7)&&"tel:"!==i.substr(0,4)&&"data:image/"!==i.substr(0,11)&&"ftp://"!==i.substr(0,6)&&"./"!==i.substr(0,2)&&"../"!==i.substr(0,3)&&"#"!==i[0]&&"/"!==i[0])return""}else if("background"===t){if(c.lastIndex=0,c.test(i))return""}else if("style"===t&&(h.lastIndex=0,h.test(i)||(u.lastIndex=0,u.test(i)&&(c.lastIndex=0,c.test(i)))))return"";return i=function(e){return e=p(e=e.replace(f,"&quot;"))}(i)}var I=function(e){return"string"==typeof e?e.replace(/'/g,'"').replace('=""',"").replace(/\s+/g,"").toLowerCase():""},E=function(){function e(e){var t=function(e){var t={};for(var i in e)t[i]=e[i];return t}(e||{});t.stripIgnoreTag&&(t.onIgnoreTag,t.onIgnoreTag=function(){return""}),t.whiteList={},t.onTag=function(){},t.onTagAttr=function(){},t.onIgnoreTag=function(){},t.onIgnoreTagAttr=function(){},t.safeAttrValue=S,t.escapeHtml=p,this.options=Object.assign(t,e)}return e.prototype.process=function(e){if(!(e=(e=e||"").toString()))return"";var t,i,n,r,a,o,s=this.options,l=s.whiteList,d=s.onTag,c=s.onIgnoreTag,u=s.onTagAttr,h=s.onIgnoreTagAttr,f=s.safeAttrValue,p=s.escapeHtml;s.stripBlankChar&&(e=(t=(t=e.split("")).filter(function(e){var t=e.charCodeAt(0);return!(127===t||t<=31&&10!==t&&13!==t)})).join("")),s.allowCommentTag||(e=function(e){for(var t="",i=0;i<e.length;){var n=e.indexOf("\x3c!--",i);if(-1===n){t+=e.slice(i);break}t+=e.slice(i,n);var r=e.indexOf("--\x3e",n);if(-1===r)break;i=r+3}return t}(e));var g=!1;s.stripIgnoreTagBody&&(i=s.stripIgnoreTagBody,"function"!=typeof(n=c)&&(n=function(){}),r=!Array.isArray(i),a=[],o=!1,c=(g={onIgnoreTag:function(e,t,s){var l;if(l=e,r||-1!==v.indexOf(i,l)){if(s.isClosing){var d="[/removed]",c=s.position+d.length;return a.push([!1!==o?o:s.position,c]),o=!1,d}return o||(o=s.position),"[removed]"}return n(e,t,s)},remove:function(e){var t="",i=0;return v.forEach(a,function(n){t+=e.slice(i,n[0]),i=n[1]}),t+=e.slice(i)}}).onIgnoreTag);var _=k(e,function(e,t,i,n,r){var a={sourcePosition:e,position:t,isClosing:r,isWhite:Object.prototype.hasOwnProperty.call(l,i)},o=d(i,n,a);if(null!=o)return o;if(a.isWhite){if(a.isClosing)return"</".concat(i,">");var s=function(e){var t=v.spaceIndex(e);if(-1===t)return{html:"",closing:"/"===e[e.length-2]};var i="/"===(e=v.trim(e.slice(t+1,-1)))[e.length-1];return i&&(e=v.trim(e.slice(0,-1))),{html:e,closing:i}}(n),g=l[i],_=b(s.html,function(e,t){var n=-1!==v.indexOf(g,e),r=u(i,e,t,n);return null==r?n?(t=f(i,e,t,null))?"".concat(e,'="').concat(t,'"'):e:null==(r=h(i,e,t,n))?void 0:r:r});return n="<".concat(i),_&&(n+=" ".concat(_)),s.closing&&(n+=" /"),n+=">"}return null==(o=c(i,n,a))?p(n):o},p);return g&&(_=g.remove(_)),_},e}(),D=Function("\nvar _checkXSS = function (it) {\n  return it && it.Math == Math && it;\n};\nreturn _checkXSS(typeof globalThis === 'object' && globalThis) ||\n_checkXSS(typeof window === 'object' && window) ||\n_checkXSS(typeof self === 'object' && self) ||\n_checkXSS(typeof global === 'object' && global) ||\nFunction('return this')();\n")(),P=new(function(){function e(){var e=this;this.batchData=[],this.uniqKeys=new Set,this.timeout=2e3,this.lock=!1,this.getSlardarBid=function(){var t,i,n="douyin_web";if(!v.includes(n,"bid"))return n;if(e.config&&e.config.bid)return e.config.bid;if(D&&D._xssBid)return D._xssBid;if(D&&D.slardar&&"function"==typeof D.slardar.config){var r=(D.slardar.config()||{}).bid;if(r)return r}if(D&&D.Slardar&&"function"==typeof D.Slardar.config){var a=(D.Slardar.config()||{}).bid;if(a)return a}return(null===(i=null===(t=null==D?void 0:D.Slardar)||void 0===t?void 0:t._baseParams)||void 0===i?void 0:i.bid)||"argus"},this.getConfigRegion=function(){var t;return v.includes("cn","region")?e.config&&e.config.region?e.config.region:((null===(t=null==D?void 0:D.gfdatav1)||void 0===t?void 0:t.region)||"cn").toLowerCase():"cn"},this.gerReportUrl=function(){var t={cn:y("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boe:y("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),ttp:y("aHR0cHM6Ly9tb24udXMudGlrdG9rdi5jb20vbW9uaXRvcl9icm93c2VyL2NvbGxlY3QvYmF0Y2gvc2VjdXJpdHkvP2JpZD0="),va:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),maliva:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),sg:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boei18n:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9")}[e.getConfigRegion()];if(t)return t+e.getSlardarBid()}}return e.prototype.setConfig=function(e){this.config=e},e.prototype.upload=function(){var e=this,t=this.gerReportUrl();!this.lock&&t&&0!==this.batchData.length&&(this.lock=!0,setTimeout(function(){var i=e.batchData.slice(0,100);e.batchData=e.batchData.slice(100),D.fetch(t,{method:"post",body:JSON.stringify(i),headers:{"Content-Type":"application/json"}}).catch(function(e){}),e.lock=!1,e.upload()},this.timeout))},e.prototype.generateKey=function(e){return e.collectKey?[e.collectMode,e.collectKey].join("___"):""},e.prototype.push=function(e){this.batchData.push(e),this.upload()},e.prototype.report=function(e){var t=this.generateKey(e);if(D.fetch&&e.collectKey){var i="object"==typeof window?window.location.href:"SSR";e.documentUrl=i;var n={age:Math.floor(Date.now()),type:"xss",url:i,body:e,"user-agent":""};"enforce"===e.disposition&&"SSR"!==i||(n.url=t),"SSR"===i&&(n.url="SSR___".concat(n.url),n.body.ssr=!0),this.push(n)}},e}()),x=function(e){for(var t=0,i=function(i){Array.isArray(e[i])?0===e[i].length?delete e[i]:(e[i]=v.from(v.uniq(e[i])),t+=e[i].length):0===v.keys(e[i]).length?delete e[i]:v.keys(e[i]).forEach(function(n){e[i][n]=v.from(v.uniq(e[i][n])),t+=e[i][n].length})},n=0,r=v.keys(e);n<r.length;n++)i(r[n]);return{count:t,ret:e}};function T(e,t){return P.setConfig(t),new E(t).process(e)}function w(e){var t,i=(t=/\s|\n|\t/.exec(e))?t.index:-1;if(-1===i)return{html:"",closing:"/"===e[e.length-2]};var n="/"===(e=e.slice(i+1,-1).trim())[e.length-1];return n&&(e=e.slice(0,-1).trim()),{html:e,closing:n}}var C=function(e){return -1===(e=(e=(e=(e=e.replace(/&colon;/gi,":")).replace(/&tab;/gi,"")).replace(/&newline;/gi,"")).replace(/(\t|\n|\r)/g,"")).indexOf("&#")?e.trim().toLowerCase():e.trim().replace(/&#(?:(x)([0-9a-f]+)|([0-9]+));?/gi,function(e,t,i,n){return String.fromCharCode(t?parseInt(i,16):parseInt(n))}).replace(/(\t|\n|\r)/g,"").toLowerCase()};function L(e,t){if(void 0===e&&(e=""),"string"!=typeof e)return!0;if(e=C(e),v.includes(e,"base64")&&!function(e){if(""===e||""===e.trim())return!0;try{return!v.includes(e,"data:text/html;base64")}catch(e){return!0}}(e))return t&&t("data:text/html;base64"),!1;var i=["expression(","behavior:","view-source:"];if(v.some(i,function(t){return -1!==e.indexOf(t)}))return v.forEach(i,function(i){-1!==e.indexOf(i)&&t&&t(i)}),!1;var n=["data:application","data:javascript","data:text/html","data:texthtml"];if(v.some(n,function(t){return -1!==e.indexOf(t)}))return v.forEach(n,function(i){-1!==e.indexOf(i)&&t&&t(i)}),!1;if(e.indexOf("javascript:")>0)return t&&t("javascript:"),!1;if(/^javascript:/i.test(e)){var r=e.slice(11).replace(/\s/g,"").trim();return!!v.some(["void","void(0)","void0","false","undefined",";"],function(e){return e===r})||(t&&t("javascript:"),!1)}return!0}var A=function(e,t){var i,n,r="<%= isSaveValidUrl =>";if("string"!=typeof e||(n=Number("<%= urlLimit =>"),void 0!==i&&(n=i),"NaN"!==e.toString()&&-1!==n&&e.length>=n)||L(e,t))return e;try{if(!0===(r=JSON.parse(r))||"true"===r){var a=new URL(e);return a.origin+a.pathname}}catch(e){}return"#"};function R(e,t,n){if(void 0===e&&(e=""),void 0===t&&(t=[]),"string"!=typeof e)return!0;if(!L(e=C(e)))return!1;var r,a={url:(r=e.match(/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/)||[])[0],scheme:r[1],slash:r[2],host:r[3],port:r[4],path:r[5],query:r[6],hash:r[7]},o=a.scheme,s=a.host;return n?!!n(e):!(!o||!s)&&(!v.includes(["http","https","file"],o)||("object"==typeof window&&window&&(t=i(i([],t,!0),[location.host],!1)),v.some(t,function(e){return!!(e instanceof RegExp&&e.test(s))||e===s})))}var O={a:["target","title","spellcheck","rel"],canvas:[],abbr:["title"],address:[],area:["shape","coords","alt"],article:[],aside:[],audio:["autoplay","controls","loop","preload"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:["dir"],dl:[],dt:[],em:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["alt","title","width","height","decoding"],ins:["datetime"],li:[],mark:[],nav:[],ol:["start"],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],sup:[],delete:[],form:[],strong:[],mask:["maskunits","x","y","width","height","fill"],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],wbr:[],video:["autoplay","controls","loop","preload","height","width"],svg:["viewBox","version","xmlns","fill","width","height","stroke","stroke-width","style"],path:["d","fill","opacity","stroke","p-id","fill-rule","clip-rule","stroke-width","stroke-linecap","stroke-linejoin","fill-opacity","mask"],rect:["x","y","width","height","fill","stroke","rx"],g:[]},N={collect:null,initCollect:function(){this.collect={whiteList:{},filterProtocol:[]}},removeCollect:function(){var e=x(this.collect),t=e.count,i=e.ret;return this.collect=null,{collectKey:0===t?null:JSON.stringify(i),collectMode:"white"}},onIgnoreTagAttr:function(e,t,n){return e&&v.indexOf(["href","src"],t)>-1?N.domainWhiteList&&Array.isArray(N.domainWhiteList)&&N.domainWhiteList.length>0&&!R(n,i([],N.domainWhiteList,!0))?"":"".concat(t,'="').concat(A(n,function(e){var t;null===(t=N.collect)||void 0===t||t.filterProtocol.push(e)}),'"'):e&&(v.indexOf(["style","class","id"],t)>-1||t.indexOf("data-")>-1)?"".concat(t,'="').concat(n,'"'):(N.collect.whiteList[e]=N.collect.whiteList[e]||[],void N.collect.whiteList[e].push(t))},onIgnoreTag:function(e,t){if("style"===e)return t;k(t,function(e,t,i,n){b(w(n).html.replace("/",""),function(e){N.collect.whiteList[i]=N.collect.whiteList[i]||[],N.collect.whiteList[i].push(e)})},p)},whiteList:O,mergeWhiteList:function(e){for(var t,i={},n=0,r=v.keys(O);n<r.length;n++)i[t=r[n]]=v.from(O[t]);for(var a=0,o=v.keys(e);a<o.length;a++)i[t=o[a]]=t in O?O[t].concat(e[t]):v.from(e[t]);return i},setWhiteList:function(e){for(var t=0,i=v.keys(e);t<i.length;t++){var n=i[t];this.whiteList[n]=n in O?O[n].concat(e[n]):v.from(e[n])}}};try{var Z={},B="merge";v.includes(B,"override")&&(N.whiteList=Z.whiteList),v.includes(B,"merge")&&N.setWhiteList(Z.whiteList)}catch(e){}var M=function(e,t){for(var i={},n=0,r=v.keys(e);n<r.length;n++){var a=r[n];Array.isArray(e[a])?i[a]=v.from(e[a]):i[a]=M({},e[a])}for(var o=0,s=v.keys(t);o<s.length;o++)(a=s[o])in e?Array.isArray(e[a])?i[a]=e[a].concat(t[a]):i[a]=M(e[a],t[a]):Array.isArray(t[a])?i[a]=v.from(t[a]):i[a]=M({},t[a]);return i},U={blackList:{a:["folder"],meta:["content"],iframe:["srcdoc"],input:["pattern"],vmlframe:["xmlns"]},blackTags:["script","xml","embed","isindex","object","base","set","handler","animate","payload","import"],blackAttrs:["charset","ns","namespace","formaction","xlink:href","xmlns:xlink","handler","repeat","repeat-start","repeat-end"],blackAttrRegExps:[/^on/],filterList:{param:["value"],video:["poster"],form:["action"]},filterAttrs:["href","src","background","style","dynsrc","lowsrc","content"]};try{var V={};V.blackAttrRegExps&&(V.blackAttrRegExps=V.blackAttrRegExps.map(function(e){return new RegExp(e.toString().slice(1,e.toString().length-1))}));var j="merge";v.includes(j,"override")&&(U=V),v.includes(j,"merge")&&(U=M(U,V))}catch(e){}var q={mode:"black",whiteList:{},blackConfig:U,collect:null,initCollect:function(){q.collect={blackList:{},blackTags:[],blackAttrs:[],blackAttrRegExps:[],filterAttrs:[],filterList:{},filterProtocol:[]}},removeCollect:function(){var e=x(q.collect),t=e.count,i=e.ret;return q.collect=null,{collectKey:0===t?null:JSON.stringify(i),collectMode:"black"}},onIgnoreTag:function(e,t){var i;if(!v.includes(U.blackTags,e))return k(t,function(e,t,i,n,r){if(-1!==i.indexOf("/"))return p(n);if(r)return"</".concat(i,">");var a=w(n),o=b(a.html,function(e,t){var n,r=0;if(U.blackList[i]&&v.includes(U.blackList[i],e)&&(q.collect.blackList[i]=q.collect.blackList[i]||[],q.collect.blackList[i].push(e),r++),U.blackAttrRegExps.length&&U.blackAttrRegExps.some(function(t){return t.test(e)})&&v.forEach(U.blackAttrRegExps,function(t){t.test(e)&&(q.collect.blackAttrRegExps.push("".concat(t.toString(),"->").concat(e)),r++)}),U.blackAttrs.length&&v.includes(U.blackAttrs,e)&&(U.blackAttrs.push(e),r++),!r){if(U.filterList&&U.filterList[i]&&v.includes(U.filterList[i],e)){var a=A(t,function(e){var t;null===(t=q.collect)||void 0===t||t.filterProtocol.push(e)});return a!==t&&(q.collect.filterList[i]=q.collect.filterList[i]||[],q.collect.filterList[i].push(e)),t?"".concat(e,"='").concat(a,"'"):e}return U.filterAttrs&&v.includes(U.filterAttrs,e)?((a=A(t,function(e){var t;null===(t=q.collect)||void 0===t||t.filterProtocol.push(e)}))!==t&&(null===(n=q.collect)||void 0===n||n.filterAttrs.push(e)),t?"".concat(e,"='").concat(a,"'"):e):t?"".concat(e,"='").concat(t,"'"):e}});return n="<".concat(i),o&&(n+=" ".concat(o)),a.closing&&(n+=" /"),n+=">"},p);null===(i=q.collect)||void 0===i||i.blackTags.push(e)}},K=function(e){var t=e.reportOnly,i=void 0===t||t,n=e.block;return i&&"all"===i?"report":("string"==typeof i&&("true"===i&&(i=!0),"false"===i&&(i=!1)),n?"enforce":i?"report":"enforce")},F=function(e){return function(i,n,r){if(!i||"string"!=typeof i)return i;var a=n;e===T&&(a=N).initCollect();var o=e(i,a);if(I(o)===I(i))return i;if(!r)return o;var s=r.logType,l=K(r),d=a.removeCollect();return P.report(t(t({type:s,disposition:l},d),{sourceText:m(i),filterText:m(o)})),"enforce"===l?o:i}},H=F(function(e,t){return void 0===t&&(t={}),t&&t.whiteList||(t.whiteList={a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}),new E(t).process(e)}),z=F(T),J=function(e,t,i){var n=[],r=A(e,function(e){n.push(e)});if(r===e)return e;n=v.from(v.uniq(n));var a=t||i||{};if(!a)return r;var o=a.logType,s=K(i);return P.report({type:o,disposition:s,collectKey:n.join("___"),collectData:JSON.stringify(n),collectMode:"black",sourceText:m(e),filterText:m(r)}),"enforce"===s?r:e},W=D._xssProject||{},Y=D.xssNamespace||{},X="3.0.26",G={FilterXSS:E,version:X,webpackPluginVersion:"<%= webpackPluginVersion =>",reportOnly:"<%= reportOnly =>",filterXSS:H,_filterXSS:z,filterUrl:J,Config:N,BlackConfig:q,project:W,setProjectName:function(e){W[e]=this,D._xssProjectName=e}};Y.douyin_web=G,D.xssNamespace=Y,D.Math&&!D.Math.xssNamespace&&(D.Math.xssNamespace=Y),W[X]=G,D.globalThis=D,D.getFilterXss=function(){return void 0!==this._xssProjectName?this._xssProject[this._xssProjectName]:G},D.xss=G,D.isSafeUrl=R,D.isSafeDomain=R,D.isSafeProtocol=L,D._xssProject=W,D._xssProjectName&&(W[D._xssProjectName]=G);var Q=G.setProjectName.bind(G);e.BlackConfig=q,e.Config=N,e.FilterXSS=E,e._filterXSS=z,e.filterUrl=J,e.filterXSS=H,e.isSafeDomain=R,e.isSafeProtocol=L,e.isSafeUrl=R,e.project=W,e.setProjectName=Q,e.setXssNamespace=function(e){var t=e.appId,i=e.bid,n=e.region;Y[t]=G;N.bid=i,N.region=n,N.enabled=!0},e.xssNamespace=Y,Object.defineProperty(e,"__esModule",{value:!0})});"use strict";(self.webpackChunkdouyin_web=self.webpackChunkdouyin_web||[]).push([["67333"],{956333:function(e,t,i){i.d(t,{i:function(){return n}});let n="3.0.35"},174883:function(e,t,i){i.d(t,{Z:function(){return M}});var n,r,a,o,s,l,d,c,u=i(22450);i(836654),i(691842),i(910795),i(511141),i(499953),i(469577),i(721911),i(429532),i(98601),i(110617),i(675373),i(819117),i(927234),i(250440),i(914613),i(792315),i(329913),i(868352),i(17322),i(63249),i(950665),i(180138),i(911234),i(387605),i(936097),i(786120),i(339597),i(877193),i(391375),i(632637),i(645524),i(800599),i(69896),i(660999),i(12946),i(416555),i(747644),i(404948),i(789680),i(742611),i(874386),i(882732),i(315997),i(544943);var h=i(696452),f=i.n(h),p=i(502154),v=i.n(p),g=i(943495),_=i(118608),m=i(180893),y=i(805229),k=i(380653),b=i(212401),S=i(907769),I=i(806394),E=i(749517),D=i(810815),P=i(258817),x=i(262416),T=i(193863),w=i(294747),C=i(726169),L=i(127685),A=i(119106),R=i(720556),O=i(546041),N=i(663153),Z=g.EVENT_EME.CDM_LICENSE_ERROR,B=g.EVENT_EME.CDM_LICENSE_SUCCESS;let M=(0,u.qH)(function e(t,i,n){var r,a=this;(0,u.PA)(this,e),f()(this),this._pluginInst=i,this.__dash__=n;var o=i.config,s=i.player,l=i._kernal;this.kernal=l,this.mse=void 0,this.config=o,this.player=s,this.url=t,this.inited=!1,this.loadingTasks=[],this.keyValue=void 0,this.dynamic_video=this.config.dashOpts.dynamic_video,this.useEME=this.config.useEME,this.intertrustServerURL=this.config.intertrustServerURL,this.taskErrorList=[],this.defaultDefinition=this.config.defaultDefinition,this.selectedIdx=0,this.getLicenseUrl=this.config.getLicenseUrl,this.egleIds={},this._resetOptionDataLenInfo(),this._initStates={emitEncrypt:!1};var d=this.config,c=d.loader,h=d.reqOptions,p=d.vid;this.loader=new m.Z(Object.assign({openLog:E.qu,vid:p},c,h),this._pluginInst.preloadManager),this.loader.on(y.K.REAL_TIME_SPEED,function(e){a.player.emit(y.K.REAL_TIME_SPEED,e)}),this._vTrack=null,this._aTrack=null,this._onLoadingItems=[],this._videoEncryption=!1,this._audioEncryption=!1;var v=this.config.duration||this.config.dashOpts.video_duration||this.config.dashOpts.dynamic_video.video_duration;this.config.duration=v;var g=(null===(r=this.config.dashOpts)||void 0===r||null===(r=r.dynamic_video)||void 0===r?void 0:r.dynamic_type)==="segment_base";this._vid=o.vid;var _=this.player.config.uri||o.vid;this._pcdnScv=new R.Z({config:o,isOpenPCDN:g,videoDuration:v,uri:_},this.player),this._dynamicBufferService=new L.Z(this.player,0,v,this.config.adaptRange),this._audioMetaReadyPromise=null,this._videoMetaReadyPromise=null,this._aduioMetaReady=!1,this._videoMetaReady=!1,this._resetProgressInfos(),this._appendBufferDelta={video:this._genEmptyBufferDelta(),audio:this._genEmptyBufferDelta()},this._lastAppendBufferEnd={video:{prevRangeEnd:0,prevItem:null},audio:{prevRangeEnd:0,prevItem:null}},this._preloadSegDatas={video:[],audio:[]},this._allCacheKeys=[],this._pendingAppnedDatas={video:[],audio:[]},this._extDataCache={video:null,audio:null},this._lastVideoBufferAppendEnd=0,this._pcdnDelta={video:{index:0,isPCDNTimeout:!1,pcdnTimeoutDelta:0},audio:{index:0,isPCDNTimeout:!1,pcdnTimeoutDelta:0}}},[{key:"_genEmptyBufferDelta",value:function(){return{delta:0,item:null,requestDelta:0,isPCDN:!1}}},{key:"_resetProgressInfos",value:function(){this._progressInfos={video:this._genEmptyProgressInfo(),audio:this._genEmptyProgressInfo()}}},{key:"_genEmptyProgressInfo",value:function(){return{data:new Uint8Array(0),range:null,extData:null,done:!1}}},{key:"cachePreloadData",value:function(){var e;null===(e=this.loader)||void 0===e||e.cachePreloadData({vid:this._vid,codecType:this.mpd.getCodecType()},this._progressInfos),this._progressInfos.video.done&&(this._progressInfos.video=this._genEmptyProgressInfo()),this._progressInfos.audio.done&&(this._progressInfos.audio=this._genEmptyProgressInfo())}},{key:"_updateLoadInfo",value:function(e,t){!this.loadInfo&&(this.loadInfo={}),!this.loadInfo[e]&&(this.loadInfo[e]={},this.loadInfo[e].size=0),this.loadInfo[e].size+=t}},{key:"_resetOptionDataLenInfo",value:function(){this._optionDataLenInfo={video:(0,u._x)((0,u._x)({},C.Lj.PCDN,{size:0}),C.Lj.CDN,{size:0}),audio:(0,u._x)((0,u._x)({},C.Lj.PCDN,{size:0}),C.Lj.CDN,{size:0})}}},{key:"getPCDNInOutBuffer",value:function(){var e;return null===(e=this._pcdnScv)||void 0===e?void 0:e.getPCDNInOUtBuffer()}},{key:"updateDynamicBufferServiceBitrate",value:function(e){this._dynamicBufferService.updateBitrate(e)}},{key:"getAdaptCacheBuffer",value:function(e){return this._dynamicBufferService.getAdaptCacheBuffer(e)}},{key:"pushDynamicBufferServiceRes",value:function(e){this._dynamicBufferService.push(e)}},{key:"popDynamicBufferServiceRes",value:function(){var e;return(null===(e=this._dynamicBufferService)||void 0===e?void 0:e.pop())||{}}},{key:"getPCDNTraceInfo",value:function(){var e;return null===(e=this._pcdnScv)||void 0===e?void 0:e.getPCDNTraceInfo()}},{key:"_abortAndRemove",value:(n=(0,u.x)((0,u.l5)().mark(function e(t,i,n){var r,a,o,s,l,d,c,h,f=arguments;return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=!(f.length>3)||void 0===f[3]||f[3],this.config){e.next=3;break}return e.abrupt("return");case 3:if(!a){e.next=6;break}return e.next=6,null===(o=this.loader)||void 0===o?void 0:o.cancelTasks(t,!0);case 6:s=(null===(r=this.player)||void 0===r?void 0:r.currentTime)||-1,l=i.startRaw<s&&s<i.endRaw,this.config.usePCDNOpt||l?this._appendBufferDelta&&(h=this._appendBufferDelta[t]).range&&i.range&&i.range[0]<h.range[1]&&h.range[1]<i.range[1]&&(i.extRange=[h.range[1],i.range[1]],this._extDataCache[t]=i,E.ZP.log("_abortAndRemove",t,"start",i.startRaw,"end",i.endRaw,"extRange",JSON.stringify(i.extRange),"range",JSON.stringify(i.range),n),this._appendBufferDelta[t]=this._genEmptyBufferDelta()):(i.isSatisfied&&(E.ZP.log("_abortAndRemove isSatisfied abort and clear"),null===(d=this.__dash__)||void 0===d||d.abort(t),null===(c=this.__dash__)||void 0===c||c.clearBufferDirect(t,i)),this.updateItemState(i),E.ZP.log("_abortAndRemove",t,"start",i.startRaw,"end",i.endRaw,"from",n));case 10:case"end":return e.stop()}},e,this)})),function(e,t,i){return n.apply(this,arguments)})},{key:"_checkBuffer",value:function(e,t){for(var i=!1,n=0;n<t.length;n++){var r=t.start(n),a=t.end(n);if(r<=e&&e<=a-1){i=!0;break}}return{enoughBuffer:i}}},{key:"onTimeUpdate",value:function(){if(!this._appendBufferDelta)return;var e=this.config,t=e.usePCDNProgressiveCheck,i=e.progressiveTimeout,n=e.useCDNProgressiveCheck,r=e.usePCDNOpt,a=e.pcdnDelays;if(!!t||!!n)for(var o=Object.keys(this._appendBufferDelta),s=P.Z.nowTime(),l=0;l<o.length;l++){var d=o[l],c=this._appendBufferDelta[d],u=c.delta,h=c.requestDelta,f=c.item,p=c.isPCDN,v=!1,g="";if(t&&p&&(v=!0,g="PCDN"),n&&!p&&(v=!0,g="CDN"),f&&v){var _=this.player.playbackRate,m=u>0&&s-u>i,y=h>0&&s-h>(f.end-f.start)*1e3/_,k=!1;r&&p&&(g="PCDN_stall",this.player.getBufferedRange(this.player.buffered)[1]-this.player.currentTime<2&&(k=!0)),(m||y||k)&&(E.ZP.log("_abortAndRemove PCDN request cancel, progressiveTimeout",m,"delta",u,"deltaTime",s-u,"requestTimeout",y,"requestDelta",h,"requestDeltaTime",s-h,"willStall",k),this.player&&this.player.emit("log",{type:"oneevent",end_type:m?"progressive_timeout_".concat(g):"pcdn_request_timeout_".concat(g)}),r&&p&&(this._pcdnDelta[d].isPCDNTimeout=!0,this._pcdnDelta[d].pcdnTimeoutDelta=s,this._pcdnDelta[d].index++,this._pcdnDelta[d].index>a.length&&(this._pcdnDelta[d].index=a.length-1)),this._abortAndRemove(d,f,"pcdn onTimeUpdate",!0))}}}},{key:"_emitAbrNextSegmentPredictEvt",value:function(e){var t;null===(t=this.player)||void 0===t||t.emit(N._c.NEXT_SEGMENT_PREDICT,e)}},{key:"getData",value:(r=(0,u.x)((0,u.l5)().mark(function e(t){var i=this,n,r,a,o,s,l,d,c,h,f,p,v,g,_,m,y,S,I,E,D,x,T,w,L=arguments;return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=L.length>1&&void 0!==L[1]?L[1]:[],r=L.length>2?L[2]:void 0,a=L.length>3&&void 0!==L[3]?L[3]:{},o=L.length>4&&void 0!==L[4]&&L[4],s=L.length>5&&void 0!==L[5]?L[5]:null,l=L.length>6&&void 0!==L[6]?L[6]:null,d=L.length>7&&void 0!==L[7]?L[7]:null,c=L.length>8&&void 0!==L[8]?L[8]:null,h=a.isPCDN?C.Lj.PCDN:C.Lj.CDN,a.url=t,e.next=13,this.loader.load(r,t,n,a,o,s?function(e,t,o,l){var d=h;if(!!i._optionDataLenInfo){var c=i._optionDataLenInfo[r][d];if(e&&e.byteLength&&(c.size+=e.byteLength,c.range=n,c.extData=a),t&&!o.fromCache){var u=n[1]-n[0]+1,f=Date.now()-o.st;i._emitPrfDataSizeEvent(h,u,r,n,a,0,f),c.size=0,c.range=null,c.extData=null}if(a.checkPreload&&!o.fromCache&&i._progressInfos){var p=i._progressInfos[r];p.data=(0,k.gJ)(p.data,e),p.extData=a,null===p.range?p.range=o.range:p.range[1]=Math.min((null==n?void 0:n[1])||1/0,o.range[1]),p.done=t,t&&i.cachePreloadData()}t&&i.config.usePCDNOpt&&(i._pcdnDelta[r].index--,i._pcdnDelta[r].index<0&&(i._pcdnDelta[r].index=0)),t&&o.fromCache&&(a.fromCache=!0),s(e,t,o,l,a)}}:null,l,d,c);case 13:if(!((f=e.sent)&&f.res instanceof ArrayBuffer)){e.next=20;break}return p=f.res,v=f.headers,g=f.status,_=f.fromCache,m=f.cacheKey,y=f.orgDefinition,S=f.duration,_?this.emitPreloadHit(m):this._emitPrfDataSizeEvent(h,f.res.byteLength,r,n,a,0,f.costTime),e.abrupt("return",{res:p,headers:v,status:g,fromCache:_,orgDefinition:y,duration:S});case 20:f&&"error"===f.res&&(T=this._isAbort(null==f?void 0:f.error),w=(null==f||null===(I=f.error)||void 0===I?void 0:I.isTimeout)===!0,(!T||w)&&this.player&&this.player.emit("source_error",{host:P.Z.getHostFromUrl(null==f?void 0:f.url),src:null==f?void 0:f.url,errorCode:w?b.WE[b.wb.NETWORK_TIMEOUT]:(null==f?void 0:f.status)||"networkError",message:w?"timeout":null==f||null===(E=f.error)||void 0===E?void 0:E.message,range:n,headers:null==f?void 0:f.header,error:{msg:null==f||null===(D=f.error)||void 0===D?void 0:D.message,stack:null==f||null===(x=f.error)||void 0===x?void 0:x.stack},mediaType:r}));case 21:return e.abrupt("return",f);case 22:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"_emitPrfDataSizeEvent",value:function(e,t,i,n,r){var a,o,s,l,d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:-1,h=m.Z.currentSpeed,f=r.fileId,p=r.definition,v=r.adaptItemParam,g=r.bitrate,_=r.first_gop,y=r.segmentDuration,k=r.start,b=r.end,S=r.url,I=(null===(a=this.player)||void 0===a?void 0:a.config.uri)||(null===(o=this.config)||void 0===o?void 0:o.vid),E="cdn";e===C.Lj.CDN?null===(s=this.player)||void 0===s||s.emit("prf_data_size",(0,u.Zj)((0,u.Zj)({vid:this._vid,task_type:1,cdn_size:t,mediaType:i,range:JSON.stringify(n),fileid:f,definition:p,cdn_speed:h},v),{},{emitType:d,bitrate:g,format:"DASH",uri:I,first_gop:_,segmentDuration:y,costTime:c,start:k,end:b,url:S})):(E="pcdn",null===(l=this.player)||void 0===l||l.emit("prf_data_size",(0,u.Zj)((0,u.Zj)({vid:this._vid,task_type:1,pcdn_size:t,mediaType:i,range:JSON.stringify(n),fileid:f,definition:p,pcdn_speed:h},v),{},{emitType:d,bitrate:g,format:"DASH",uri:I,first_gop:_,segmentDuration:y,costTime:c,start:k,end:b,url:S}))),this._updateLoadInfo(E,t)}},{key:"_getCryptInfos",value:function(){var e="",t="";if(this.dynamic_video.dynamic_video_list&&this.dynamic_video.dynamic_video_list.length>0){for(var i=0;i<this.dynamic_video.dynamic_video_list.length;i++)if(this.dynamic_video.dynamic_video_list[i].kid){e=this.dynamic_video.dynamic_video_list[i].kid,t=this.dynamic_video.dynamic_video_list[i].spade_a,this._videoEncryption=!0;break}}else if(this.dynamic_video.dynamic_audio_list){for(var n=0;n<this.dynamic_video.dynamic_audio_list.length;n++)if(this.dynamic_video.dynamic_audio_list[n].kid){e=this.dynamic_video.dynamic_audio_list[n].kid,t=this.dynamic_video.dynamic_audio_list[n].spade_a,this._audioEncryption=!0;break}}return{keyId:e,spade_a:t}}},{key:"init",value:(a=(0,u.x)((0,u.l5)().mark(function e(t){var i,n,r,a,o,s,l,d;return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._hasDestroyed){e.next=2;break}return e.abrupt("return");case 2:if(this._initStartMs=Date.now(),this.kernal.setNodeTime("initdash"),n=(i=this._getCryptInfos()).keyId,r=i.spade_a,a=this,a.config.usePlaySpade&&(a.config.secretKey=r),s=(o=a.config).secretKey,l=o.drmKeyToken,d=o.playDomain,!(n||s||l&&d)){e.next=18;break}return e.prev=10,e.next=13,this._initSecret(n);case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(10);case 18:return e.abrupt("return",a.initDash(t));case 19:case"end":return e.stop()}},e,this,[[10,15]])})),function(e){return a.apply(this,arguments)})},{key:"_initSecret",value:function(e){var t=this,i=new x.XK,n=this.config,r=n.secretKey,a=n.drmKeyToken,o=n.playDomain,s=n.useUnionInfoDRM,l=n.keyTokenExpiredDuration,d=n.sessionId,c=n.drmType;if(this.player.plugins.drm)return i.resolve(),i;var u=new g.XGSecretKey({kid:e,getLicenseUrl:this.getLicenseUrl,secretKey:r,drmType:c,vid:this.config.vid||"",useUnionInfoDRM:s,drmKeyToken:a||this.config.keyToken,keyTokenExpiredDuration:l,playDomain:o,sessionId:d,useEME:this.useEME,intertrustServerURL:this.config.intertrustServerURL});return this._secret=u,u.getLicenseSecret().then(function(e){if(!t._pluginInst){E.ZP.log("getLicense callback destroy"),i.reject("getLicense callback destroy");return}t.config.dashOpts&&t.useEME?(t._initEME(),null==u||u.setOptions(),null==u||u.setupEME(t.player.video)):(t.__dash__.crypto&&t.__dash__.crypto.updateValue(e),t.keyValue=!0),E.ZP.encrypt("getLicense resolve"),i.resolve()}).catch(function(e){var n;E.ZP.log("DRM_ERROR",e),i.reject("catch error"),t._hasDestroyed||t.emit("error",new I.Z(b.wb.DRM,(null===(n=e.error)||void 0===n?void 0:n.code)||b.wb.SUB_TYPES.CUSTOM_LICENSE,{url:t.getLicenseUrl,httpCode:e.status,message:"CUSTOM_LICENSE_ERROR"}))}),i}},{key:"_initEME",value:function(){var e=this;if(!(0,g.checkEMEValid)()){this.player.errorHandler(new I.Z(b.wb.MEDIA,b.wb.SUB_TYPES.EME_HIJACK,{message:"EME API被劫持"})),this.__dash__.destroy();return}this._secret.on(Z,function(t){e.player&&e.player.emit("log",(0,u.Zj)({type:"oneevent",end_type:Z,ua:navigator.userAgent},t)),E.ZP.log("EME CDM_LICENSE_ERROR"),e.player.errorHandler(new I.Z(b.wb.DRM,b.wb.SUB_TYPES.LICENSE,{message:"DRM接口失败".concat(t.data)}))}),this._secret.on(B,function(t){e.player&&e.player.emit("log",(0,u.Zj)({type:"oneevent",end_type:B,ua:navigator.userAgent},t)),E.ZP.log("EME CDM_LICENSE_SUCCESS")})}},{key:"_initDefaultDefinition",value:function(){var e=this,t=this.config,i=this.mpd.mediaList.video,n=t.defaultDefinition?t.defaultDefinition.toString():null,r=this.player.preloader&&this.player.preloader.getPreloadMetaByVid(this.config.vid),a=!1;if(r&&r.definition){n=r.definition,a=!0;var o=this._pluginInst.preloadManager;if(o&&o.supportSync()){var s=this.mpd.getCodecType(),l=o.getPreLoadDataSync({vid:this._vid,codecType:s,vtype:O.l0.DASH});delete l.cacheKey,delete l.loadInfo,this._allCacheKeys=Object.keys(l),this._allCacheKeys.forEach(function(t){var i,n,r,a=l[t];a&&!a.isInitSegment&&(null===(i=a.range)||void 0===i?void 0:i.length)>0&&(null===(n=a.range)||void 0===n?void 0:n[1])<a.rangeEnd&&(null===(r=e._preloadSegDatas[a.mediaType])||void 0===r||r.push(a))})}E.ZP.log("dashDefinition",this.config.vid,"hasPreload",n)}var d=this.player.config;if(d.userSelectDefinition&&d.focusUserDefinition&&(n!==d.userSelectDefinition.toString()&&a&&(a=!1,E.ZP.log("dashDefinition",this.config.vid,"hasPreload",n,"change to userSelectDefinition",d.userSelectDefinition)),n=d.userSelectDefinition.toString()),this._pluginInst.bitRateAdapter&&!a){var c=this.player?d.userSelectDefinition:null,u=P.Z.getBitrateItem(this.config.dashOpts.dynamic_video,this._pluginInst.bitRateAdapter,this.config.dashOpts.dynamic_video.duration,c);if(E.ZP.log("[dashDefinition] onReady BitRateAdapter",this.config.vid,"item",u),u){n=u.definition.toString();var h=this.config.dashOpts.dynamic_video.dynamic_video_list,f=null==h?void 0:h.filter(function(e){return e.definition===u.definition})[0];f&&(f.fromType=u.fromType,f.orgDefinition=u.orgDefinition,f.type=u.type)}}E.ZP.log("[dashDefinition] onReady",this.config.vid,"video definition",n);var p=!1;n&&i.forEach(function(t,r){t.definition.toString()===n.toString()&&(e.config.defaultDefinition=n.toString(),i.selectedIdx=r,p=!0)}),!p&&(i.selectedIdx=0),this.selectAudio()}},{key:"selectAudio",value:function(e){var t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],i=this.mpd.mediaList.video,n=this.mpd.mediaList.audio,r=(0,A.Ft)(i,n,e),a=r;return -1===a&&(a=0),t&&(n.selectedIdx=a),E.ZP.log(this._vid,"audio definition",n.selectedIdx),r}},{key:"_initMSE",value:function(){var e,t,i,n=this;this.kernal.setNodeTime("initmse_sbopen");var r=Date.now(),a=this.mpd.mediaList.audio,o=this.mpd.mediaList.video,s={};if(this._hasAudio&&(s[S.d1.AUDIO]={mimeType:"audio/mp4",codec:'audio/mp4; codecs="'.concat(a[a.selectedIdx].codecs,'"')}),this._hasVideo&&(s[S.d1.VIDEO]={mimeType:"video/mp4",codec:'video/mp4; codecs="'.concat(o[o.selectedIdx].codecs,'"')}),this._hasVideo&&this._pluginInst.softVideo){var l=this.player.video;l.setPlayMode&&l.setPlayMode("VOD"),(e=l).url=URL.createObjectURL(new Blob),t=Promise.resolve()}else{if(this._secret&&!(0,g.checkMSEValid)()){this.player.errorHandler(new I.Z(b.wb.MEDIA,b.wb.SUB_TYPES.MSE_HIJACK,{message:"MSE被劫持"}));return}t=(e=new S.d1(void 0,{openLog:E.qu})).bindMedia(this.player.video),null===(i=this.player)||void 0===i||i.emit("mseAttaching"),t.then(function(){var t;if((0,A.iR)(D.Hy,0),!n._pluginInst){E.ZP.log("open promise ready destroy");return}null===(t=n.player)||void 0===t||t.emit("mseAttached"),n.kernal.setNodeTime("initmse_sbopendone"),n._mseOpenDone=!0,E.ZP.log(n._vid,"open promise ready"),n._pluginInst.info({msg:"mse init success",name:"mseInit",startMs:r,profile:!0});try{for(var i=Object.keys(s),a=0;a<i.length;a++){var o=i[a];e.createSource(o,s[o].codec)}}catch(e){E.ZP.log("MSE MSE_MEDIA_TYPES_NOT_SUPPORTED",JSON.stringify({msg:e.message})),n&&n.player&&n.player.errorHandler(new I.Z(b.wb.MEDIA,b.wb.SUB_TYPES.MSE_ADD_SB,{line:329,message:"mse init fail"})),E.ZP.log("mse init error",e,"player destroyed ? ",!(n&&n.player))}}).catch(function(e){})}return this.mse=e,t}},{key:"_addBuffer",value:function(e,t){var i=this,n=this;if(this._hasDestroyed){E.ZP.log("addBuffer destroy");return}if(!this.mpd){E.ZP.log("addBuffer mpd empty");return}var r=this.mpd.mediaList[t],a=this.mpd.mediaList[t];if(a.length<1||!a[a.selectedIdx]||!a[a.selectedIdx].mimeType)return;if(!e.initSegmentRes){E.ZP.log("initSegment null, task request error, stop"),n.emit("error",new I.Z(b.wb.RUNTIME,I.Z.SEG_PARSE_ERROR,{message:"wrapperData.initSegmentRes is null"}));return}if(!!n.__dash__)n.__dash__._appendInitSegment(t,e,a.selectedIdx).then(function(){var e,a,o="video"===t?i._videoMetaReadyPromise:i._audioMetaReadyPromise;o&&(i.kernal.setNodeTime("initSegment ".concat(t," append")),o.resolve()),n.inited=!0;var s=r.selectedIdx;r.length>0&&(r[s].encrypted||r[s].kid)&&!i._hasEmitEncrypt&&(i._hasEmitEncrypt=!0,n._secret&&n._secret.emit(g.EVENT_EME.ENCRYPTED),null===(e=n.player)||void 0===e||e.emit(g.EVENT_EME.ENCRYPTED)),"vod"===n.type&&(null===(a=n.__dash__)||void 0===a||a.loadData(0),n.emit("start_play"))}).catch(function(e){if(!i._hasCatchAppendError){var t;i._hasCatchAppendError=!0,null===(t=n.player)||void 0===t||t.errorHandler(new I.Z(b.wb.MEDIA,b.wb.SUB_TYPES.MSE_APPEND_BUFFER,{line:329,message:"mse append error ".concat(e.message?e.message:e)}))}})}},{key:"appendFirstSegment",value:function(e){var t=this,i=this._pendingAppnedDatas[e];if(i.length>0){for(var n=[],r=0;r<i.length;r++)!function(){var a=i[r];t.mse.isOpened?t.appendSegment(e,a.res,a.item,{},a.extData,!1,a.done):t._openPromise.then(function(){t.appendSegment(e,a.res,a.item,{},a.extData,!1,a.done)}),n.push(a.range)}();this._pendingAppnedDatas[e]=[],E.ZP.log("appendFirstSegment",e,"ranges",n)}if(!("video"===e?this._videoMetaReady:this._audioMetaReady)){var a=function(){"video"===e?t._videoMetaReady=!0:t._audioMetaReady=!0};this.mse.isOpened?a():this._openPromise.then(function(){a()})}}},{key:"initDash",value:(o=(0,u.x)((0,u.l5)().mark(function e(t){var i,n;return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._pluginInst){e.next=3;break}return E.ZP.log("dash.js init dash destroy"),e.abrupt("return");case 3:return this._pluginInst.info({msg:"dash init",data:"dash init",startMs:this._initStartMs,profile:!0}),this.kernal.setNodeTime("initdashdone"),i=this,this.kernal.setNodeTime("initmpd"),n=new _.Z(t,i.config.dashOpts,i),i.mpd=n,n.init(),e.next=12,n.readyPromise;case 12:return this._onMPDReady(n),e.abrupt("return",this.mse);case 14:case"end":return e.stop()}},e,this)})),function(e){return o.apply(this,arguments)})},{key:"_createMoofSegment",value:function(e,t){var i=t.mediaList[e],n=i[i.selectedIdx].firstMoofMdatRange;if(n){E.ZP.log(null===(r=this.config)||void 0===r?void 0:r.vid,"createMoofSegment, mediaType",e);var r,a,o,s=new x.XK;e===S.d1.VIDEO?this._videoMetaReadyPromise=s:this._audioMetaReadyPromise=s;var l=(0,u._x)({codecType:this.mpd.getCodecType(),range:n,url:i[i.selectedIdx].initSegment,idx:1,start:0,startRaw:0,moof:!0,checkPreload:!0,mediaType:e,selectedIdx:i.selectedIdx,fileId:i[i.selectedIdx].fileId,vid:this.config.vid,vtype:O.l0.DASH,bitrate:i[i.selectedIdx].bandwidth,definition:i[i.selectedIdx].definition},"codecType",this.mpd.videoCodecType),d=P.Z.generateRequestUniqueKey((0,u.Zj)((0,u.Zj)({},l),{},{range:n}));this._allCacheKeys.includes(d)?(E.ZP.log(null===(o=this.config)||void 0===o?void 0:o.vid,"createMoofSegment mediaType",e,"hit cache, no moof request, use seq requset"),this._resetMoofSegmentDownloadState(e)):(E.ZP.log(null===(a=this.config)||void 0===a?void 0:a.vid,"createMoofSegment mediaType",e,"no cache, request moof request"),this._makeSegmentRequestByItem(l,e,{},!1,s))}}},{key:"_resetMoofSegmentDownloadState",value:function(e){var t=this.mpd;if(t&&t.mediaList){var i,n=t.mediaList[e];n[n.selectedIdx].cancelFirstSegmentReq=!0;var r=null===(i=n[n.selectedIdx].mediaSegments)||void 0===i?void 0:i[0];r&&(r.downloaded=D.Kc.NO_START)}}},{key:"_onMPDReady",value:function(e){var t=this,i=Date.now();if(!this._pluginInst){E.ZP.log("mpd ready destroy");return}E.ZP.log("mpd ready"),this.kernal.setNodeTime("initmpddone"),this._pluginInst.info({msg:"mpd ready",name:"mpd ready",startMs:i,profile:!0}),this.type=e.type;var n=e.mediaList.video,r=e.mediaList.audio;this._initDefaultDefinition();var a=!!(n.length>0&&n[n.selectedIdx])&&this.config&&!this.config.dashOpts.audioOnly,o=!!(r.length>0&&r[r.selectedIdx]);this._hasVideo=a,this._hasAudio=o;var s=this._initMSE();if(!!s){this._pluginInst.setStartTimelineAttr("reqtime",P.Z.nowTime()),this._openPromise=s;var l=[],d=this.config?this.config.dashOpts.audioOnly:null;if(this.config&&!d&&n&&n.length>0&&n[n.selectedIdx]&&n[n.selectedIdx].initSegment){var c=this.__dash__._makeInitSegemntRequestWithRetry("video",n.selectedIdx,!0);c.then(function(e){t._addBufferSafe(e,S.d1.VIDEO,s)}).catch(function(e){E.ZP.log("video init error",e)}),l.push(c),this._createMoofSegment(S.d1.VIDEO,e)}if(r[r.selectedIdx]&&r[r.selectedIdx].initSegment){var u=this.__dash__._makeInitSegemntRequestWithRetry("audio",r.selectedIdx,!0);u.then(function(e){t._addBufferSafe(e,S.d1.AUDIO,s)}).catch(function(e){E.ZP.log("audio init error",e)}),l.push(u),this._createMoofSegment(S.d1.AUDIO,e)}Promise.all(l).catch(function(e){var i;t.player&&!(null!=e&&null!==(i=e.ext)&&void 0!==i&&i.destroy)&&t.player.errorHandler(e),E.ZP.log("appendInitPromise error",e,"player destroyed ? ",!(t&&t.player))})}}},{key:"_addBufferSafe",value:function(e,t,i){var n=this;this._mseOpenDone?this._addBuffer(e,t):i.then(function(){n._addBuffer(e,t)})}},{key:"seek",value:function(e,t){var i,n,r,a=this,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,l=this.mpd.seek(t,s,e),d=this.popDynamicBufferServiceRes(),c=null===(i=this.mpd)||void 0===i||null===(i=i.mediaList)||void 0===i?void 0:i.video,u=null===(n=this.mpd)||void 0===n||null===(n=n.mediaList)||void 0===n?void 0:n.audio;if(!this.mpd){E.ZP.log("dash seek destroy");return}var h=!!(c.length>0&&c[c.selectedIdx]),f=!!(u.length>0&&u[u.selectedIdx]);if(h&&f&&2*c[c.selectedIdx].mediaDuration<u[u.selectedIdx].mediaDuration){!this._hastEmitDurErr&&(this._hastEmitDurErr=!0,this.emit("error",new I.Z(b.wb.RUNTIME,I.Z.DUR_PARSE_ERROR,{message:"the video.mediaDuration not match audio.mediaDuration"})));return}var p={},v=["video","audio"];v.forEach(function(e){l[e]&&l[e].length>0&&(p[e]=[],l[e].forEach(function(t){var i=t.idx,n=t.start,r=t.end,a=t.downloaded,o=t.range;p[e].push({idx:i,start:n,end:r,downloaded:a,range:o})}))}),E.ZP.log(null===(r=this.config)||void 0===r?void 0:r.vid,"currentTime",t,JSON.stringify(p)),(this.config.dashOpts&&this.config.dashOpts.audioOnly?["audio"]:v).forEach(function(e){l[e]&&l[e].length>0&&l[e].every(function(t){return a._makeSegmentRequestByItem(t,e,d,o)})})}},{key:"loadFirstVideoGop",value:function(){var e=this.mpd.getVideoFirstGop();e&&(E.ZP.log("loadFirstVideoGop"),this._makeSegmentRequestByItem(e,S.d1.VIDEO,{},!1,null,!1))}},{key:"_makeSegmentRequestByItem",value:function(e,t,i,n){var r,a=this,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=!(arguments.length>5)||void 0===arguments[5]||arguments[5],l=this;if(e.downloaded===D.Kc.APPEND||e.downloaded===D.Kc.GOING)return!0;e.downloaded=D.Kc.GOING;var d=Object.assign({},i,{load_tar_dur:e.end-e.start,load_dur:e.end-e.start});e.adaptItemParam=d;var c=this._videoEncryption||this._audioEncryption,h=!c||c&&this.useEME,f=l.config.useProgressiveAppend&&!this._pluginInst.softVideo&&h&&this.loader.isSupportedProgress(),p=0===e.start||n,v=l.mpd.mediaList[t],g=v[v.selectedIdx],_=p&&this.loader.checkProgressSatisfied(g.bandwidth||g.bitrate),m=l.config.useProgressiveAppendAll,y=f&&(_||m);p&&E.ZP.log("progressDownloaded match, config p ".concat(l.config.useProgressiveAppend,", \n      progressDownloaded ").concat(f,", encEnableProgress :").concat(h,",\n      useProgressiveAppendAll:").concat(m)),y&&0===e.start&&("video"===t?l._pluginInst.pvStartup=!0:l._pluginInst.paStartup=!0);var k=function(){if(e.downloaded===D.Kc.APPEND){E.ZP.log("abr_log oncancel appended return",e);return}l.updateItemState(e,!1),E.ZP.log("onCancel",e),l._removeFromList(e),l._setLoading(t,!1),y&&(null==l||l._abortAndRemove(t,e,"oncancel",!1))};if(e.isSatisfied=y,l._addToList(e),this._setLoading(t,!0,!1),e.requestTime=P.Z.nowTime(),y){;E.ZP.log("progressDownloaded, mediaType:".concat(t,",\n              start:").concat(e.start,", bitrate:").concat(g.bandwidth||g.bitrate)),l.makeSegmentRequest(t,e,(r=(0,u.x)((0,u.l5)().mark(function i(n,r,d,c,h){var f,p,v,g,_;return(0,u.l5)().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(i.prev=0,null!==(f=a._appendBufferDelta)&&void 0!==f&&f[t]&&((p=a._appendBufferDelta[t]).delta=P.Z.nowTime(),p.item=e,!p.requestDelta&&(p.requestDelta=P.Z.nowTime())),v=d.range||e.range,h.range=v,h.status=null==c?void 0:c.status,!(200===h.status&&"ftyp"===P.Z.getTopBoxType(n))){i.next=10;break}return i.next=8,a.loader.cancel(t);case 8:return l._onRequestFail({message:"response 200, cancel"},e,t),i.abrupt("return");case 10:o?(t===S.d1.VIDEO?a._videoMetaReady:a._audioMetaReady)?(E.ZP.log(null===(_=l.config)||void 0===_?void 0:_.vid,"createMoof metaPromise ready",t,v),l.appendSegment(t,n,e,{},h,!1,r,o)):(a._pendingAppnedDatas[t].push({range:v.concat(),res:n,item:JSON.parse(JSON.stringify(e)),extData:JSON.parse(JSON.stringify(h)),done:r}),E.ZP.log(null===(g=l.config)||void 0===g?void 0:g.vid,"createMoof metaPromise not ready",t,v,n)):l.appendSegment(t,n,e,{},h,!1,r,o),!r&&d.range[1]>=e.range[1]&&(r=!0),r&&(e.extRange=void 0,l._removeFromList(e),a._setLoading(t,!1,s,e.idx),a._appendBufferDelta&&(a._appendBufferDelta[t]=a._genEmptyBufferDelta()),E.ZP.log("mediaType",t,"item",e.idx,"done")),i.next=18;break;case 15:i.prev=15,i.t0=i.catch(0),a.__dash__?(a._abortAndRemove(t,e,"errorCatch"),l._onRequestFail(i.t0,e,t)):E.ZP.log("__dash__ null, destroy");case 18:case"end":return i.stop()}},i,null,[[0,15]])})),function(e,t,i,n,a){return r.apply(this,arguments)}),k,o).catch(function(i){l._onRequestFail(i,e,t)})}else l.makeSegmentRequest(t,e,null,k).then(function(i){var n=i.res,r=i.headers,a=i.extData;E.ZP.log("append ".concat(t," ").concat(e.start," ").concat(e.end)),l._setLoading(t,!1,!0,e.idx),l.appendSegment(t,n,e,r||{},a,!0,!0,o),l._removeFromList(e)},null,o).catch(function(i){l._onRequestFail(i,e,t)}).finally(function(){l._setLoading(t,!1)})}},{key:"_onRequestFail",value:function(e,t,i){if(t&&t.moof&&(E.ZP.log("createMoof request fail, mediaType",i),this._resetMoofSegmentDownloadState(i)),this._setLoading(i,!1),this.updateItemState(t),this._removeFromList(t),e.isPCDN){var n,r;null===(n=this._pcdnScv)||void 0===n||n.setSetRetryInfo(i,e.url),null===(r=this._pcdnScv)||void 0===r||r.removePCDNNode(i,e.bitrate,e.url)}if(!this.mpd){E.ZP.log("_onRequestFail destroy");return}var a=this.mpd.mediaList;E.ZP.log("_onRequestFail",null==e?void 0:e.message,JSON.stringify(t));var o="video"===i?a.video:a.audio,s=o[o.selectedIdx],l=!this._isAbort(e.error)&&!e.isPCDN;if(!s.hasBackup&&s.backupUrl&&l){s.hasBackup=!0;return}s.fallbackUrl&&l&&(s.hasFallback=!0)}},{key:"_setLoading",value:function(e,t){var i,n,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;E.ZP.log("setLoading",e,"isLoading",t,"addNext",r,"prevIdx",a),null===(i=this.mpd)||void 0===i||i.setLoadingState(e,t),r&&(null===(n=this.mpd)||void 0===n||n.moveNextSegmentIndex(e,a))}},{key:"_isAbort",value:function(e){var t=null==e?void 0:e.message;return(null==t?void 0:t.includes("The user aborted a request"))||(null==t?void 0:t.includes("Fetch is aborted"))||(null==t?void 0:t.includes("signal is aborted without reason"))}},{key:"_addToList",value:function(e){this._onLoadingItems&&this._onLoadingItems.push(e)}},{key:"_removeFromList",value:function(e){if(this._onLoadingItems)for(var t=this._onLoadingItems.length-1;t>-1;t--)this._onLoadingItems[t]===e&&this._onLoadingItems.splice(t,1)}},{key:"_doSizePreloadCheck",value:function(e){if((this._pluginInst.softVideo||this.__dash__.dashVideoEncrypted||this.__dash__.dashAudioEncrypted)&&!1===this.useEME&&this.__dash__.crypto||"segment_template"===this.mpd.dashType)return{isSlice:!1};var t=e.mediaType,i=e.range,n=this._preloadSegDatas[t];if(!n||(null==n?void 0:n.length)===0)return{isSlice:!1};var r,a=(0,u.sf)(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o.range[0]===i[0]&&e.fileId===o.fileId){var s=o.res,l=o.duration;return{isSlice:!0,range:[o.range[1]+1,i[1]],res:s,duration:l}}}}catch(e){a.e(e)}finally{a.f()}return{isSlice:!1}}},{key:"makeSegmentRequest",value:function(e,t){var i,n,r=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,l=this,d=new x.XK;void 0===t.range&&(t.range=[]),"video"===e&&E.ZP.network(null===(i=l.config)||void 0===i?void 0:i.vid,"http get video start: ".concat(t.start,", end: ").concat(t.end," ,range: ").concat(t.range)),l.player&&l.__dash__._checkUrlRange(t.url);var c={limitSizeM:1/0,segment_resolution:"",isVideo:"video"===e,ratio:l.config.segmentRatio||7.5,vid:l.config.vid,mediaType:e,start:t.start,end:t.end,useUrlRange:l.config.useUrlRange},h=1/0,f=l.mpd.mediaList[e],p=f[f.selectedIdx],v=t.url;p.hasFallback?v=p.fallbackUrl:p.hasBackup&&(v=p.backupUrl);var g=(null===(n=t.extRange)||void 0===n?void 0:n.length)>0,_=this.config,m=_.pcdnDelays,y=_.usePCDNOpt,k=this._pcdnDelta[e],S=k.index,T=k.pcdnTimeoutDelta,w=k.isPCDNTimeout;y&&w&&P.Z.nowTime()-T<m[S]?g=!0:this._pcdnDelta[e].isPCDNTimeout=!1;var C=!1;if(this._pcdnScv){var L=this._pcdnScv.selectedPCDN(e,!1,p.bandwidth),A="audio"===e||(null==L?void 0:L.includes(p.fileId));L&&!A&&(this._pcdnScv.removePCDNNode(e,p.bandwidth),E.ZP.log("PCDNURL remove, url,",L,"fileid",p.fileId)),A&&L&&!g&&(C=!0,(!this._cdnHost||0>v.indexOf(this._cdnHost))&&(this._cdnHost=P.Z.getHostFromUrl(v)),!this._cdnHost&&(this._cdnHost=P.Z.getHostFromUrl(v)),c.cdnHost=this._cdnHost,v=L,E.ZP.log("PCDNURL",v))}if("video"===e){try{var R=p.definition||l.__dash__.bandwidth2item[p.bandwidth].definition;R=R.toString(),h=D.Y2[R.toLowerCase()],c.segment_resolution=R.toLowerCase(),c.definition=c.segment_resolution,t.definition=R,this.setCurrentHost(v)}catch(e){h=1/0}c.limitSizeM=h}var O=t.range;c.bitrate=p.avg_bitrate||p.bandwidth||p.bitrate,c.bandwidth=p.bandwidth||p.bitrate,c.idx=p.idx,c.first_gop=0===t.start?1:0,c.isPCDN=C,c.fileId=p.fileId,c.codecType=this.mpd.videoCodecType,c.adaptItemParam=t.adaptItemParam,c.segmentDuration=t.end-t.start,delete t.adaptItemParam,c.moof=t.moof;var N=P.Z.generateRequestUniqueKey((0,u.Zj)((0,u.Zj)({},c),{},{range:O})),Z=this._allCacheKeys.includes(N);c.checkPreload=t.checkPreload||c.first_gop||Z,c.isSatisfied=t.isSatisfied,c.startRaw=t.startRaw,c.endRaw=t.endRaw;var B=this.config.timeout;if(c.first_gop&&this.kernal.setNodeTime("init".concat(e,"_segstart")),this._appendBufferDelta[e].isPCDN=C,this._extDataCache[e]){var M=this._extDataCache[e];M.moof&&0===t.start&&(t.extRange=M.extRange)}if(t.extRange&&(E.ZP.log("_PCDN extRange",t.extRange,"medaiType",e,"isPCDNTimeout",g),t.extRange[0]<t.extRange[1]&&(O=t.extRange)),c.checkPreload){var U=this._doSizePreloadCheck(t),V=U.isSlice,j=U.range,q=U.res,K=U.duration;if(V){O=j,c.isSlice=!0,E.ZP.log("hit preload size",e,"newRange",JSON.stringify(j),"allRange",JSON.stringify(t.range)),c.rangeEnd=t.range[1],c.rangeStart=t.range[0];var F=(0,u.Zj)((0,u.Zj)({},t),{},{range:[t.range[0],j[0]-1]});this.appendSegment(e,q,F,{},c,!1,!1,s),this.kernal.setPreloadData("init".concat(e,"_segcache"),{fromCache:!0,mediaType:e,definition:c.definition,duration:K,byteLength:q.byteLength})}}return this.getData(v,O,e,c,!1,a,o,B,function(){E.ZP.log("onTimeout",t),l._removeFromList(t),l._onRequestFail(Object.assign({url:v,error:{message:"Timeout"}},c),t,e)}).then(function(i){if(!!r._pluginInst)if(i){var n=i.res,o=i.fromCache,s=i.duration,u=n instanceof ArrayBuffer;if(c.first_gop&&!(null!=i&&null!==(v=i.error)&&void 0!==v&&v.isTimeout)){var h="init".concat(e,"_segdone");r.kernal.setNodeTime(h)}if(o&&r.kernal.setPreloadData("".concat(e,"-").concat(c.bitrate,"-").concat(O[0],"-").concat(O[1]),{fromCache:o,mediaType:e,definition:c.definition,duration:s,byteLength:u?n.byteLength:0,error:u||n.done?null:n}),n instanceof ArrayBuffer)d.resolve({res:n,headers:null,extData:{status:i.status,segment_resolution:c.segment_resolution}}),l.mseLog("task loadsucc",t,e);else if(!(206===i.status||200===i.status)){if(l.mseLog("task loaderror",t,e),a&&r._abortAndRemove(e,t,"onProgress task loaderror",!1),403===i.status)!p.fallbackUrl&&(null==l||l.__dash__.clearProgressTimer()),null==l||null===(g=l._pluginInst)||void 0===g||g.emitExpireEvent({url:t.url,response:i});else{var f=r._isAbort(null==i?void 0:i.error);if(p.hasFallback&&!f){E.ZP.log("fallUrl fail",null==i||null===(_=i.error)||void 0===_?void 0:_.message),null==l||l.__dash__.clearProgressTimer();var v,g,_,m,y=new I.Z(b.wb.RUNTIME,I.Z.BACK_URL_FAIL,{message:"fall url fail ".concat(null==i||null===(m=i.error)||void 0===m?void 0:m.message)});r.player.errorHandler(y)}}d.reject(i)}}else d.reject(Error("request error"))}),d}},{key:"setCurrentHost",value:function(e){this._pluginInst.loadURL=e}},{key:"reportMonitorEvent",value:function(e,t,i,n,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},o=this.getReportData(i,n,r,a),s=r.eagleid;if(s){if(!this.egleIds||this.egleIds[s])return;this.egleIds[s]=1}this.player&&this.player.emit("log",{type:"oneevent",end_type:e,cdnUrl:t,ext:o})}},{key:"getReportData",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return Object.assign({},{start:e||-1,end:t||-1},P.Z.transformHeaders(i,D.ne),n)}},{key:"reportMenuEvent",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=this._pluginInst.player,o=this.getReportData(t,i,n,r);o.url=e,a.emit("menusegment",o)}},{key:"_reportInvalidEvent",value:function(e,t,i,n){var r=0,a=e.byteLength,o=i.status,s=i.segment_resolution,l=t.realUrl||t.url;try{var d=P.Z.getTopBoxType(e);if("moof"!==d&&"styp"!==d&&(E.ZP.media("segment content error",t,n),r=1,this.reportMonitorEvent(D.wW,l,t.range[0],t.range[1],n,{segment_size:e.byteLength,status:o,segment_resolution:s,box_type:d,step:r,segment_origin_size:a})),"ftyp"===d&&200===o&&2===t.range.length){this.player&&this.player.emit("source_error",{host:P.Z.getHostFromUrl(l),src:l,errorCode:o,message:"boxType error",range:t.range,headers:n}),r=2;var c=t.range[0];if(e=e.subarray(c,t.range[1]+1),d=P.Z.getTopBoxType(e),"moof"!==d&&"styp"!==d)return this.emit("error",new I.Z(b.wb.RUNTIME,I.Z.SEGMENT_CONTENT_ERROR,{message:"boxType is ".concat(d,", range:").concat(JSON.stringify(t.range),", url:").concat(l,", respHeaders:").concat(JSON.stringify(n),", isPCDN:").concat(i.isPCDN)})),this.reportMonitorEvent(D.wW,l,t.range[0],t.range[1],n,{segment_size:e.byteLength,status:o,segment_resolution:s,box_type:d,step:r,segment_origin_size:a}),null;return e}}catch(i){this.reportMonitorEvent(D.wW,l,t.range[0],t.range[1],n,{segment_size:e.byteLength,status:o,segment_resolution:s,step:r,box_type:"error",segment_origin_size:a}),E.ZP.media("segment content catch",t,i)}return null}},{key:"appendSegment",value:function(e,t,i,n,r){var a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=!(arguments.length>6)||void 0===arguments[6]||arguments[6],s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=this;if(!this._hasDestroyed&&!!l.mpd&&!!t){if(!P.Z.isArrayBuffer(t)){E.ZP.log("appendSegment return done",o);return}var d=new Uint8Array(t instanceof ArrayBuffer?t:t.buffer),c=P.Z.checkValidTopBox(d),u=r.status,h=r.segment_resolution,f=l.mpd.mediaList[e],p=i.selectedIdx;i.fromCache=r.fromCache;var v=i.realUrl||i.url;if(a&&!c){if(null===(d=l._reportInvalidEvent(d,i,r,n))){E.ZP.log("segment content response 200, res is null"),l.updateItemState(i);return}E.ZP.log("segment content response 200, subrange is ok, go ahead")}l.reportMenuEvent(v,i.range[0],i.range[1],n,{segment_size:d.byteLength,status:u,segment_resolution:h});var g=this._pluginInst.softVideo;if(l.keyValue||g){var _=0;(g||l.__dash__.dashVideoEncrypted||l.__dash__.dashAudioEncrypted)&&!1===l.useEME&&l.__dash__.crypto?(_=performance.now(),l.mseLog("decryptBody start",i,e),l.__dash__.crypto.decryptBody(d,"video"===e,!g).then(function(t){var n=t.data,r=t.id,a=t.headerId;if(!n.res&&!g){l.updateItemState(i);return}var d=n.res,c=n.videoTrack,u=n.audioTrack,h=performance.now();if(!l.encryptTotalAll&&(l.encryptTotalAll=0),l.encryptTotalAll+=h-_,E.ZP.encrypt("encryptTotalAll:".concat(l.encryptTotalAll)),"video"===e&&(!l.encryptTotal&&(l.encryptTotal=0),l.encryptTotal+=h-_,E.ZP.encrypt("encryptVideo:".concat(l.encryptTotal)),r<a&&!s)){l.updateItemState(i);return}l.doAppendSegment(e,f,d,i,p,null,o,c,u,s)})):l.doAppendSegment(e,f,d,i,p,r.range,o,null,null,s)}else l.doAppendSegment(e,f,d,i,p,r.range,o,null,null,s)}}},{key:"isAllAppend",value:function(){var e=this.mpd;if(!e)return!1;var t=this.player.currentTime,i=e.isSegmentAppendFromIdx(S.d1.VIDEO,t),n=i.res,r=i.emptySegments,a=e.isSegmentAppendFromIdx(S.d1.AUDIO,t),o=a.res,s=a.emptySegments,l=this._hasVideo&&r,d=this._hasAudio&&s;return!l&&!d&&(!!n&&!!o||!1)}},{key:"_checkStuckAndHandle",value:function(e){var t=e.mediaType,i=e.ml,n=e.mse,r=e.item,a=e.allAppended,o=this._pluginInst.config,s=o.useStuckCheck,l=o.useStuckWaitBuffer,d=i.switchTag;if(i.switchTag=!1,t===S.d1.VIDEO){if(s){var c,u=this._lastVideoBufferAppendEnd,h=(null==n||null===(c=n._sourceBuffer)||void 0===c||null===(c=c.video)||void 0===c?void 0:c.buffered)||null,f=this.player.currentTime;if(h){for(var p={start:0,end:0},v=0;v<h.length;v++){var g=h.start(v),_=h.end(v);g<f&&f<_&&(this._lastVideoBufferAppendEnd=_,p={start:g,end:_})}if(u>0){var m=u>p.start&&u<f&&this._lastVideoBufferAppendEnd>f&&!r.AppendCur,y=this._pluginInst.removedCurrBuf,k=d&&r.start<this.player.currentTime;if(m||y||k){m&&(r.AppendCur=!0);var b=this.player.getBufferedRange(this.player.buffered),I=!1;(!l||l&&((null==b?void 0:b[1])>0||a))&&(this.player._invalidSeekTag=!0,this._pluginInst.removedCurrBuf=!1,this.player.currentTime-=1e-4,this._isFpsStuck=!1,I=!0),E.ZP.log("appendSuccessVideoBuffer seek back 0.001 prevBufferEnd",u,"last",this._lastVideoBufferAppendEnd,"current.start",p.start,"inBuffer",I,"isAddCurBuf",m)}}}}d&&r.start<this.player.currentTime&&!s&&(this.player._invalidSeekTag=!0,this.player.currentTime-=1e-4,E.ZP.log("appendSuccess seek 0.001"))}}},{key:"doAppendSegment",value:function(e,t,i,n,r,a,o,s,l,d){var c=this;if(!this._hasDestroyed){var h=this,f=h.mse,p=h.mpd,v={start:n.start,end:n.end,index:r,bandwidth:t[t.selectedIdx].bandwidth,fps:t[t.selectedIdx].fps,mediaType:e,sequence:n.idx,definition:t[t.selectedIdx].definition,fromCache:n.fromCache};if(e===S.d1.VIDEO&&-1!==this.__dash__.curVideoInitSegmentIdx&&r!==this.__dash__.curVideoInitSegmentIdx&&this.__dash__.curVideoFileId!==t[r].fileId){this.updateItemState(n),E.ZP.log("init 与 segment不匹配, curVideoInitSegmentIdx",this.__dash__.curVideoInitSegmentIdx,"selectedIdx",r);return}var g=function(i){if((null==i||!i.used)&&(null==i||null===(r=i.context)||void 0===r||!r.used)){if(c._checkStuckAndHandle({mediaType:e,ml:t,mse:f,item:n,allAppended:o}),0===n.start&&c.kernal.setNodeTime("init".concat(e,"SegmentAppend"),i),i&&(i.used=!0),!h.player){E.ZP.log("appendBuffer destroy return");return}if(n.range[1]<=(null==a?void 0:a[1])||o){if(n.AppendCur=!1,h.updateItemState(n,!0),"video"===e){null===(s=h.player)||void 0===s||s.emit("addVideoBufferEnd",v);var r,s,l,g,_,m=P.Z.nowTime()-n.requestTime,y=v.end-v.start;!v.end&&(y=null===(_=t[t.selectedIdx])||void 0===_||null===(_=_.mediaSegments)||void 0===_?void 0:_[0].segmentDuration);var k=(null==f||null===(l=f._sourceBuffer)||void 0===l||null===(l=l.audio)||void 0===l?void 0:l.buffered)||null,b=0;if(k){var I=c.player.getBufferedRange(k);b=0===I[1]?0:I[1]-c.player.currentTime}else!(null!=f&&null!==(g=f._sourceBuffer)&&void 0!==g&&g.audio)&&(b=-1);c._emitAbrNextSegmentPredictEvt((0,u.Zj)((0,u.Zj)({},v),{},{fix:!0,costTime:m,gopSize:y,audioBuffer:b}))}if(d){var D,x,T=null===(D=c.mpd)||void 0===D?void 0:D.mediaList[e],w=T&&(null===(x=T[T.selectedIdx])||void 0===x?void 0:x.mediaSegments);w.length>0&&h.updateItemState(w[0],!0)}}if(c.mseLog("appendBuffer success",n,e,a),o){h.updateItemState(n,!0);var C=h.mpd._getBuffered(e);E.ZP.log("fixbuffer: mediaType",e,"buffered",JSON.stringify(C),"item.start",n.start,"item.end",n.end);for(var L=!0,A=0;A<C.length;A++){var R=C[A].start,O=C[A].end;if(n.start>=R-1&&n.end<=O+1){L=!1;continue}}if(L&&n.end>n.start){var N=h.mse.getSourceBuffer(e);E.ZP.log("fixbuffer: buffer Miss",!!N),N&&c._abortAndRemove(e,n,"fixbuffer")}}"video"===e&&h.player.emit("addVideoBufferEnd",v);var Z=p.isLastSegmentAndAppend(e,n.idx),B=e===S.d1.AUDIO?S.d1.VIDEO:S.d1.AUDIO,M=p.isLastSegmentAndAppend(B,n.idx);Z&&M&&(E.ZP.log("append check endofStream"),f.endOfStream()),c.isAllAppend()&&f.endOfStream()}},_=(0,u.Zj)((0,u.Zj)({range:a,rangesring:JSON.stringify(a)},v),{},{callback:g,item:n});this.appendBuffer(e,new Uint8Array(i),_,s,l,d).then(g).catch(function(e){E.ZP.log("append buffer catch",e);var t=e&&e.errorCode===b.WE[b.wb.MEDIA][b.wb.SUB_TYPES.MSE_FULL];!t&&h.updateItemState(n,!1),t&&h.__dash__&&h.__dash__.checkRemoveBuffer(!0),e&&e.errorCode&&h.player&&h.player.emit(new I.Z(b.wb.MEDIA,e.errorCode,{line:800,message:"append buffer".concat(e.message)}))})}}},{key:"appendBuffer",value:function(e,t,i,n,r,a){var o=this;if(i&&(i.vid=this.config.vid),this._appendBufferDelta&&(this._appendBufferDelta[e].range=i.range),this._lastAppendBufferEnd){var s=this._lastAppendBufferEnd[e],l=s.prevRangeEnd,d=s.prevItem;if(i.initSegment||i.range&&i.range.length>0){var c,u,h,f,p,v=l===(null==d?void 0:d.range[1]),g=l>0&&(l===(null==d?void 0:d.range[1])+1||v);l>0&&!g&&l!==(null===(c=i.range)||void 0===c?void 0:c[0])&&(i.initSegment||i.range[1]<i.item.range[1])&&(E.ZP.log("appendBuffer seek remove current",null===(u=this.player)||void 0===u?void 0:u.currentTime,e,l,"now",null===(h=i.range)||void 0===h?void 0:h[0],"start",d.startRaw,"endRaw",d.endRaw,"initSegment",i.initSegment),null===(f=this.__dash__)||void 0===f||f.abort(e),null===(p=this.__dash__)||void 0===p||p.clearBufferDirect(e,d),d.extRange=void 0),i.initSegment?this._lastAppendBufferEnd[e]={prevRangeEnd:0,prevItem:null}:this._lastAppendBufferEnd[e]={prevRangeEnd:i.range[1],prevItem:i.item}}}var _=function(){return o._pluginInst.softVideo?(o._hasVideo&&"video"===e&&(o._vTrack=new T.q,Object.keys(n).forEach(function(e){o._vTrack[e]=n[e]})),o._hasAudio&&"audio"===e&&(o._aTrack=new w.W,Object.keys(r).forEach(function(e){o._aTrack[e]=r[e]})),o.mse.appendBuffer(o._vTrack,o._aTrack),Promise.resolve()):o.mse.append(e,new Uint8Array(t),i)};if(!a)return _();var m,y=Date.now();return(e===S.d1.VIDEO?this._videoMetaReady:this._audioMetaReady)&&i.fromCache&&null!==(m=this.config)&&void 0!==m&&m.useGopCacheAcc?(E.ZP.log("createMoof ready append cost",Date.now()-y,"ms mediaType",e,"range",JSON.stringify(i.range),"fromCache",i.fromCache),_()):a.then(function(){return E.ZP.log("createMoof append cost",Date.now()-y,"ms mediaType",e,"range",JSON.stringify(i.range)),_()})}},{key:"changeType",value:function(e,t){var i="";i=e===S.d1.VIDEO?'video/mp4; codecs="'.concat(t,'"'):'audio/mp4; codecs="'.concat(t,'"'),this.mse.changeType&&this.mse.changeType(e,i)}},{key:"emptyAction",value:function(e,t){var i=this.mse;return i._enqueueOp(e,function(){i._onSBUpdateEnd(e)},"emptyAction",t)}},{key:"isProgressiveLoading",value:function(e){var t=this.loader.getCurrentTask(e);return this._isLoadingTaskCancellable(t)}},{key:"getCurrentTask",value:function(e){return this.loader.getCurrentTask(e)}},{key:"_isLoadingTaskCancellable",value:function(e){if(!e||!e._config.priOptions)return{isCancellable:!0,data:null};var t,i=null===(t=this.player)||void 0===t?void 0:t.currentTime,n=e._config.priOptions.extData,r=n.start<=i&&i<=n.end&&n.isSatisfied,a=n.range&&n.range[0]===n.range[1];return{isCancellable:this.config.usePCDNOpt||!r&&!a,data:n,oriIsCancellable:!r&&!a}}},{key:"_cancelTasks",value:(s=(0,u.x)((0,u.l5)().mark(function e(t,i){var n,r,a,o,s,l,d,c,h,f,p;return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.loader){e.next=2;break}return e.abrupt("return",[]);case 2:o=(a=this.isProgressiveLoading(t)).isCancellable,s=a.data,E.ZP.log(null===(n=this.config)||void 0===n?void 0:n.vid,"_cancelTasks",t,"isCancellable",o,"data",!!s),l=[],d=null===(r=this.player)||void 0===r?void 0:r.currentTime,c=(0,u.sf)(i);try{for(c.s();!(h=c.n()).done;)(f=h.value).mediaType===t&&!o&&(p=f.start<=d&&d<=f.end&&f.isSatisfied,(f.isInitSegment||p)&&l.push(f))}catch(e){c.e(e)}finally{c.f()}return e.next=10,this.loader.cancelTasks(t,o);case 10:return o&&s&&s.isSatisfied&&E.ZP.log("isCancellable abort"),e.abrupt("return",l);case 12:case"end":return e.stop()}},e,this)})),function(e,t){return s.apply(this,arguments)})},{key:"abortLoadingTasks",value:(l=(0,u.x)((0,u.l5)().mark(function e(t){var i,n,r,a,o;return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=[],n=!t,!this._onLoadingItems){e.next=18;break}if(!n){e.next=14;break}return e.next=6,this._cancelTasks(S.d1.VIDEO,this._onLoadingItems);case 6:return r=e.sent,e.next=9,this._cancelTasks(S.d1.AUDIO,this._onLoadingItems);case 9:a=e.sent,i.push.apply(i,(0,u.u)(r)),i.push.apply(i,(0,u.u)(a)),e.next=18;break;case 14:return e.next=16,this._cancelTasks(t,this._onLoadingItems);case 16:o=e.sent,i.push.apply(i,(0,u.u)(o));case 18:this._onLoadingItems=i;case 19:case"end":return e.stop()}},e,this)})),function(e){return l.apply(this,arguments)})},{key:"_doCancel",value:(d=(0,u.x)((0,u.l5)().mark(function e(t){return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.loader.cancel(t);case 2:this._emitCancel();case 3:case"end":return e.stop()}},e,this)})),function(e){return d.apply(this,arguments)})},{key:"_emitCancel",value:function(){var e=this;try{Object.keys(this._optionDataLenInfo).forEach(function(t){var i=e._optionDataLenInfo[t];Object.keys(i).forEach(function(n){var r=i[n]||{},a=r.size,o=r.range,s=r.extData;a>0&&e._emitPrfDataSizeEvent(Number(n),a,t,o,s,1)})})}catch(e){}this._resetOptionDataLenInfo()}},{key:"updateItemState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=[];e.length>0?i=e:i.push(e),i.forEach(function(e){t?e.downloaded=D.Kc.APPEND:e.downloaded=D.Kc.NO_START}),!t&&e.moof&&this._resetMoofSegmentDownloadState(e.mediaType)}},{key:"mseLog",value:function(e,t,i,n){var r;E.ZP.mse(null===(r=this.config)||void 0===r?void 0:r.vid,"type-".concat(i,"-start-").concat(t.start,"-end-").concat(t.end,"-").concat(e,",range:").concat(JSON.stringify(n||t.range)))}},{key:"emitPreloadHit",value:function(e){E.ZP.preload("emit preloadhit",e),this.player&&this.player.emit("log",{type:"onetemp",action:"append",data:{preload_hit:"".concat(e,"|")}})}},{key:"destroy",value:function(){var e,t;this._doCancel(),v()(this.loader),null===(e=this._secret)||void 0===e||e.destroy(),this._hasDestroyed=!0,null===(t=this._dynamicBufferService)||void 0===t||t.destroy()}},{key:"checkPCDN",value:(c=(0,u.x)((0,u.l5)().mark(function e(){var t,i,n,r,a;return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.player&&this.player.readyState<=HTMLVideoElement.HAVE_CURRENT_DATA)){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,t=this._pluginInst.currentDefitionFromPlayer.item,e.next=7,this._pcdnScv.checkPCDN((0,u.Zj)((0,u.Zj)({},t),{},{mediaType:"video"}));case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2);case 12:if(e.prev=12,0!==(i=this.mpd.mediaList.audio).length){e.next=16;break}return e.abrupt("return");case 16:return r=(n=i[i.selectedIdx]).bandwidth,a=n.baseURL,e.next=19,this._pcdnScv.checkPCDN((0,u.Zj)((0,u.Zj)({},i[i.selectedIdx]),{},{bitrate:r,main_url:a,mediaType:"audio"}));case 19:e.next=24;break;case 21:e.prev=21,e.t1=e.catch(12);case 24:case"end":return e.stop()}},e,this,[[2,9],[12,21]])})),function(){return c.apply(this,arguments)})},{key:"isOpenPCDN",value:function(e){var t=this;if(this._pcdnScv){var i,n,r=this._pluginInst.currentDefitionFromPlayer;if(!r){E.ZP.log("isOpenCPDN curDef is null");return}var a=r.item,o=a.bitrate,s=null===(i=this.mpd)||void 0===i?void 0:i._getCurBuffered(S.d1.VIDEO),l=null===(n=this.mpd)||void 0===n?void 0:n._getCurBuffered(S.d1.AUDIO),d=(e=Math.max(e,null==s?void 0:s[1],null==l?void 0:l[1]))-this.player.currentTime,c=d,h=d,f=this.player.currentTime;this.config.useSeparationMode&&(h=Math.max(0,(null==l?void 0:l[1])-f),c=Math.max(0,(null==s?void 0:s[1])-f)),this._pcdnScv.isOpenPCDN("video",c,o,(0,u.x)((0,u.l5)().mark(function e(){return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.abortLoadingTasks("video");case 2:case"end":return e.stop()}},e)})),a);var p=this.__dash__.dash.mpd.mediaList;if(p.audio.length>0){var v=p.audio[p.audio.selectedIdx],g=this.config.dashOpts.dynamic_video.dynamic_audio_list.filter(function(e){return e.bitrate===v.bandwidth})[0];this._pcdnScv.isOpenPCDN("audio",h,v.bandwidth,(0,u.x)((0,u.l5)().mark(function e(){return(0,u.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.abortLoadingTasks("audio");case 2:case"end":return e.stop()}},e)})),g)}}}},{key:"pcdnReqCnt",value:function(){return this._pcdnScv.pcdnReqCnt||{}}},{key:"pcdnVVStat",value:function(){return this._pcdnScv.pcdnVVStat||{}}}])},246451:function(e,t,i){i.d(t,{s:function(){return p}});var n=i(893050);i(836654),i(691842),i(981168),i(499953),i(429532),i(98601),i(110617),i(675373),i(742611);var r=i(995214),a=i(879146),o=i.n(a),s=i(266510),l=i(55748),d=i(410652),c=i(945271),u=i(673520),h=["vid","loadType","size","speed","cacheKey","vtype","duration","bitrate"],f=!1,p=function(e){var t,i,a,o,p,v;function g(){var e;return(0,n.PA)(this,g),(e=(0,n.$w)(this,g))._loaders={},e._loaderInsts={},e._taskIntervalId=0,e._currentPreloadInst=null,e._preloadDataList=[],e._player=null,e._stepwise=!1,e._playingVids=[],e._isOpen=!0,e._userDefinition=null,e._startDefinition=null,e.onPreloadNext=(0,n.x)((0,n.l5)().mark(function t(){var i,r,a,o,l,d,c,u,h,f,p,v,g,_;return(0,n.l5)().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(o=(a=e)._preloadDataList,l=a._config,!(!e._isOpen||e._currentPreloadInst||e._preloadDataList.length<1)){t.next=3;break}return t.abrupt("return",!1);case 3:if(c=null==(d=e.findPreloadItem(o,!1))?void 0:d.data,!(!d||!(null!=c&&c.payload))){t.next=7;break}return t.abrupt("return",!1);case 7:if(u=null,u=e.selectBeforeStart(c),e._filterMixPayload(c,u),e.setStartDefinition(null===(i=u)||void 0===i?void 0:i.definition),e.log("log","selectBeforeStart",null===(r=u)||void 0===r?void 0:r.vtype,u),h=e._getPreloaderKey(u||c)){t.next=17;break}return e.log("warn","need to set vtype, no preloader",c),l.autoPreload&&e.emit(s.KR.PRELOAD_NEXT),t.abrupt("return",!1);case 17:if(f=e._getLoaderInst(h)){t.next=23;break}if(p=e._getLoader(h)){t.next=22;break}return t.abrupt("return",!1);case 22:f=new p(e,e._config);case 23:return e._currentPreloadInst=f,e._currentPreloadInst.setData(c),e._emitEvtByStart(c),t.prev=26,e.log("log","loaderInst.start",h,e.getStartDefinition(),c),t.next=30,f.start(c,e.getStartDefinition());case 30:(v=t.sent)&&v.remove&&(g=o.indexOf(d))>-1&&o.splice(g,1),t.next=37;break;case 34:t.prev=34,t.t0=t.catch(26),e.log("error","preload data error!",t.t0);case 37:return t.prev=37,null===(_=e._currentPreloadInst)||void 0===_||_.setData(null),e._currentPreloadInst=null,e._config.autoPreload&&e.emit(s.KR.PRELOAD_NEXT),t.finish(37);case 42:return t.abrupt("return",!0);case 43:case"end":return t.stop()}},t,null,[[26,34,37,42]])})),e._stats=new d.Z(e),e}return(0,n.XW)(g,e),(0,n.qH)(g,[{key:"VTYPES",get:function(){return r.l0}},{key:"player",get:function(){return this._player}},{key:"stepwise",get:function(){return this._stepwise}},{key:"realTimeSpeed",get:function(){return this._stats.realTimeSpeed}},{key:"currentPreloadInst",get:function(){return this._currentPreloadInst}},{key:"cacheInst",get:function(){return this._cacheInst}},{key:"preloadDataList",get:function(){return this._preloadDataList}},{key:"log",value:function(e){for(var t,i=arguments.length,n=Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];f&&(t=console)[e].apply(t,["[PreloaderManager]"].concat(n))}},{key:"register",value:function(e){try{if("undefined"==typeof window){this.log("preloader in ssr");return}var t=g.getDefaultConfig();this._config=Object.assign({},t,e.config),this._options=e;var i=this._config,n=i.preloadMaxCacheCount,r=i.preloadCacheType;this._stepwise=!!this._config.stepwise,this._cacheInst=new l.Z(n,r),this._selector=e.BitrateSelector,this.on(s.KR.PRELOAD_NEXT,this.onPreloadNext);for(var a=e.loaders,o=0;o<a.length;o++)this.registerLoader(a[o].vtype,a[o])}catch(e){this.log("register error",e)}}},{key:"registerLoader",value:function(e,t){e&&(this._loaders[e]&&this.log("warn","vtype:".concat(e," Preloader already exist")),this._loaders[e]=t,this._loaderInsts[e]=new t(this,this._config))}},{key:"_checkIfCanPreload",value:function(){if(null===this._currentPreloadInst&&this._preloadDataList.length>0){var e=this.findPreloadItem(this._preloadDataList),t=null==e?void 0:e.data;if(this._wipPreloadTask=e,e&&null!=t&&t.payload){if(!this._getPreloaderKey(t))return this.log("warn","need to set vtype"),this.stopCheckTask(),!1;var i=this._config.checkIfCanPreload;if(i&&"function"==typeof i)return i(t);if(this._config.autoCheckPreload)return this._autoCheckPreload(t,e);else this.stopCheckTask()}}return!1}},{key:"_autoCheckPreload",value:function(e,t){var i,n=null==t||null===(i=t.data)||void 0===i?void 0:i.force;if("always"===n)return!0;if(!this._player)return"no-player"===n||(this.log("warn","need set video"),!1);return(0,u.xF)(this._player,this._config,this.log)}},{key:"_getPreloaderKey",value:function(e){return e.vtype?e.vtype.toUpperCase():""}},{key:"_sort",value:function(e){e.sort(function(e,t){return void 0===e.order&&void 0===t.order||"number"==typeof e.order&&"number"==typeof t.order&&e.order<t.order?-1:1})}},{key:"_addPlayingVid",value:function(e,t){var i=this._playingVids,n=(0,u.PK)(this._playingVids,"playerId",e);n>-1?i[n].vid=t:i.push({vid:t,playerId:e})}},{key:"selectBeforeStart",value:function(e){var t=e.targetDefinition,i=e.defaultDefinition;if(t)return(0,n.Zj)({},t);var r=this.getUserSelectDefinition(),a=this.selectBitrate(null==e?void 0:e.payload,i,r),o=(null==a?void 0:a.vtype)||e.vtype,s=(0,n.Zj)((0,n.Zj)({},a),{},{vtype:o});return e.targetDefinition=s,this.log("log","selectBeforeStart",null==e?void 0:e.vid,o,null==a?void 0:a.definition,null==e?void 0:e.payload,a),s}},{key:"selectBitrate",value:function(e,t,i){if(e.length<1)return null;var r,a,o,s=null;if(this._selector)s=this._selector.getSuitableBitrate(e,i),this.log("log","BitRateAdapter result",null===(r=s)||void 0===r?void 0:r.vtype,null===(a=s)||void 0===a?void 0:a.definition,null===(o=s)||void 0===o?void 0:o.bitrate);else{for(var l=-1,d=-1,c=0;c<e.length;c++){var u=e[c];i&&u.definition===i?l=c:t&&u.definition===t&&(d=c)}s=e[l>=0?l:d>=0?d:0]}return(0,n.Zj)({},s)}},{key:"startCheckTask",value:function(){var e=this,t=this._preloadDataList,i=this._currentPreloadInst,n=this._config.autoCheck;if(this._taskIntervalId&&(clearTimeout(this._taskIntervalId),this._taskIntervalId=0),null!=i&&i.taskInProgress&&(0,u.fQ)(this._player,this._config,this.log)){this.cancelPreloadingTask();return}if(0!==t.length)this._checkIfCanPreload()&&this.onPreloadNext(),this._taskIntervalId=setTimeout(function(){e.startCheckTask()},n.interval)}},{key:"cancelPreloadingTask",value:function(){var e,t=this._preloadDataList,i=this._wipPreloadTask,n=this._config.endPreloadTaskStrategy;this.cancel(),i&&(this.stepwise?"number"==typeof(null===(e=i.data)||void 0===e?void 0:e.stepIdx)&&i.data.stepIdx>-1&&i.data.stepIdx--:0!==n&&t.unshift(i),this._emitEvtByCancel(i.data),this._wipPreloadTask=void 0)}},{key:"stopCheckTask",value:function(){this._taskIntervalId&&(clearTimeout(this._taskIntervalId),this._taskIntervalId=-1)}},{key:"getPreloadMetaByVid",value:function(e,t){for(var i=this.getAllCachedDataKeys(),n=[],r="",a=0;a<i.length;a++){var o=i[a],s=g.parseKey(o);if(s.vid!==e)continue;if(r=s.vtype,null==t||!t.vtype||t.vtype===r)n.push(o)}if(0===n.length)return null;var l=this._getLoaderInst(r);return l?l.parseKey(n):null}},{key:"preloadNext",value:function(){this.onPreloadNext()}},{key:"_filterMixPayload",value:function(e,t){var i=t.vtype;if(i&&Array.isArray(e.payload)){var n=e.vtype===i;e.vtype=i,e.payload=e.payload.filter(function(e){return e.vtype===i||n})}}},{key:"_emitEvtByStart",value:function(e){var t=this._player;if(e&&t)try{this.emit(s.KR.PRELOAD_START,this._getEventPayload(e,t))}catch(e){this.log("warn","preload emit start error",null==e?void 0:e.stack)}}},{key:"_emitEvtByCancel",value:function(e){var t=this._player;if(e&&t)try{this.emit(s.KR.PRELOAD_CANCEL,this._getEventPayload(e,t))}catch(e){this.log("warn","preload emit cancel error",null==e?void 0:e.stack)}}},{key:"_getEventPayload",value:function(e,t){var i=t.config.vid,n=this._config,r=n.minBufferLength,a=n.startPreloadControl,o=n.startPreloadMinBuffer,s=n.startPreloadMinPosTime,l=n.endPreloadMinBuffer,d=n.endPreloadControl,c=(0,u.lh)(t.video.buffered,t.currentTime),h=c[1]?c[1]-t.currentTime:0;return{vid:i,pid:e.vid,buffer:c,bufferHead:h,currentTime:t.currentTime,minBufferLength:r,startPreloadControl:a,startPreloadMinBuffer:o,startPreloadMinPosTime:s,endPreloadControl:d,endPreloadMinBuffer:l}}},{key:"addPreloadList",value:(t=(0,n.x)((0,n.l5)().mark(function e(t){var i,r,a;return(0,n.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this._sort(t),i=(0,n.sf)(t),e.prev=2,i.s();case 4:if((r=i.n()).done){e.next=10;break}return a=r.value,e.next=8,this._addData(a);case 8:e.next=4;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),i.e(e.t0);case 15:return e.prev=15,i.f(),e.finish(15);case 18:this._checkAutoTask();case 19:case"end":return e.stop()}},e,this,[[2,12,15,18]])})),function(e){return t.apply(this,arguments)})},{key:"addPlayingId",value:function(e,t){for(var i=this._preloadDataList,n=-1,r=0;r<i.length;r++)if(e===i[r].data.vid){n=r;break}if(n>-1){var a=i.splice(n,1);this.log("log","cancelPreloadByVid remove from list",a.length>0&&a[0].data.vid)}var o=this._currentPreloadInst,s=o?o.getData():null;this.log("log","_currentPreloadInst",s),s&&s.vid===e&&this.cancel(),t&&this._addPlayingVid(t,e)}},{key:"removePlayingId",value:function(e){var t=this._playingVids,i=(0,u.PK)(t,"playerId",e);if(i>-1){var n=t.splice(i,1);this.log("log","removePlayingId",n.length>0&&n[0].playerId)}}},{key:"addPreload",value:(i=(0,n.x)((0,n.l5)().mark(function e(t){return(0,n.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._addData(t);case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:this._sort(this._preloadDataList),this._checkAutoTask();case 7:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"_addData",value:(a=(0,n.x)((0,n.l5)().mark(function e(t){var i,r,a,o,s,l,d,c,h,f=this;return(0,n.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.vtype){e.next=3;break}return this.log("warn","vtype is null, can\xb7t select loader"),e.abrupt("return",!1);case 3:if(i=t.data,r=this._getLoader(i.vtype)){e.next=8;break}return this.log("warn","the loader for ".concat(i.vtype," not registered")),e.abrupt("return",!1);case 8:if(a=this._playingVids,!((o=(0,u.PK)(a,"vid",t.data.vid))>=0)){e.next=14;break}return s=a[o],this.log("log","vid:".concat(s.vid," is already instantiated and loaded, playerId is ").concat(s.playerId)),e.abrupt("return");case 14:return l=this._getUniqueKey(t),e.next=17,this.getItem(t.data,!0);case 17:if(!(d=e.sent)||!r.isUniqueCache(d)){e.next=22;break}return this.log("log","".concat(l," already exist in cache")),e.abrupt("return",!1);case 22:if(!this._currentPreloadInst||!(c=this._currentPreloadInst.getData())||this._getUniqueKey({data:c,order:0})!==l){e.next=29;break}return this.log("log","currentKey repeat"),e.abrupt("return");case 29:if(h=this._preloadDataList.filter(function(e){return f._getUniqueKey(e)===l}),this.log("log","addedItems",l,h),0!==h.length){e.next=35;break}return this._stepwise&&void 0===t.data.steps&&(t.data.steps=[0]),this._preloadDataList.push(t),e.abrupt("return",!0);case 35:return this.log("log","".concat(l," already exist in preloadList")),e.abrupt("return",!1);case 37:case"end":return e.stop()}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"_getUniqueKey",value:function(e){return e.data.vtype?g.generateUniqueCacheKey(e.data):e.data.vid}},{key:"_checkAutoTask",value:function(){var e=this,t=this._config,i=t.autoCheck,n=t.autoPreload;Promise.resolve().then(function(){n&&e.emit(s.KR.PRELOAD_NEXT),null!=i&&i.enable&&!e._taskIntervalId&&e.startCheckTask()})}},{key:"setItem",value:function(e,t,i,r){var a=g.generateUniqueCacheKey(e);if(!i){var o=this._getLoader(e.vtype);if(!o)return this.log("warn","no ".concat(e.vtype," preloader, register")),Promise.resolve(!1);var s=o.generateUniqueKey(e);t=(0,n._x)({},s,t)}return this._cacheInst.setItem(a,t,r)}},{key:"getItem",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=g.generateUniqueCacheKey(e),r=this._getLoader(e.vtype);if(!r)return this.log("warn","no ".concat(e.vtype," preloader, register")),Promise.resolve(!1);var a=t?"":r.generateUniqueKey(e);return this._cacheInst.getItem(n,i,a)}},{key:"getItemSync",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=g.generateUniqueCacheKey(e),r=this._getLoader(e.vtype);if(!r)return this.log("warn","no ".concat(e.vtype," preloader, register")),!1;var a=t?"":r.generateUniqueKey(e);return this._cacheInst.getItemSync(n,i,a)}},{key:"supportSync",value:function(){return this._cacheInst.supportSync()}},{key:"removeItem",value:function(e,t){var i=g.generateUniqueCacheKey(e);return this._cacheInst.removeItem(i,t)}},{key:"getPreLoadData",value:(o=(0,n.x)((0,n.l5)().mark(function e(t){var i,r,a;return(0,n.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.vtype,!(r=this._getLoaderInst(i))){e.next=7;break}return e.next=5,r.getPreLoadData(t);case 5:return a=e.sent,e.abrupt("return",a);case 7:return e.abrupt("return",null);case 8:case"end":return e.stop()}},e,this)})),function(e){return o.apply(this,arguments)})},{key:"getPreLoadDataSync",value:function(e){var t=e.vtype,i=this._getLoaderInst(t);return i?i.getPreLoadDataSync(e):null}},{key:"removeAll",value:function(){var e=this;this.getAllCachedDataKeys().forEach(function(t){var i=e.getPreloadMetaByVid(t.split("#")[0]);i&&e.removeItem(i,null)})}},{key:"removeAllPreloadTask",value:function(){this.cancel(),this._preloadDataList=[],this._playingVids=[]}},{key:"disable",value:function(){this._isOpen=!1,this.stopCheckTask()}},{key:"enable",value:function(){this._isOpen=!0,this._config.autoCheck.enable&&!this._taskIntervalId&&this._preloadDataList.length>0&&this.startCheckTask()}},{key:"setUserSelectDefinition",value:function(e){this._userDefinition=e}},{key:"getUserSelectDefinition",value:function(){return this._userDefinition||null}},{key:"getStartDefinition",value:function(){return this._startDefinition}},{key:"setStartDefinition",value:function(e){this._startDefinition=e}},{key:"destroy",value:(p=(0,n.x)((0,n.l5)().mark(function e(){var t,i,r,a;return(0,n.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this._stats.destroy(),t=Object.keys(this._loaderInsts),i=0;case 3:if(!(i<t.length)){e.next=12;break}if(r=t[i],!(a=this._getLoaderInst(r))){e.next=9;break}return e.next=9,a.destroy();case 9:i++,e.next=3;break;case 12:this.removeAllListeners(),this._loaderInsts={},this._loaders={},this._playingVids=[],this.detachPlayer();case 17:case"end":return e.stop()}},e,this)})),function(){return p.apply(this,arguments)})},{key:"cancel",value:(v=(0,n.x)((0,n.l5)().mark(function e(){var t;return(0,n.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._currentPreloadInst){e.next=4;break}return e.next=3,this._currentPreloadInst.cancel();case 3:null===(t=this._currentPreloadInst)||void 0===t||t.setData(null);case 4:this._currentPreloadInst=null;case 5:case"end":return e.stop()}},e,this)})),function(){return v.apply(this,arguments)})},{key:"removeByPlayInst",value:function(e,t){for(var i=this._preloadDataList.length-1;i>-1;i--){var n=this._preloadDataList[i];if(n.data.vid===e&&n.playerId===t){this._preloadDataList.splice(i,1);break}}}},{key:"getAllCachedDataKeys",value:function(){var e;return(null===(e=this._cacheInst)||void 0===e?void 0:e.getAllCachedDataKeys())||[]}},{key:"getDataUniqueKey",value:function(e){var t=this._getLoader(e.vtype);return!!t&&t.generateUniqueKey(e)}},{key:"hasItemSameVid",value:function(e){var t=this._getLoader(e.vtype),i=this._getLoaderInst(e.vtype);if(t&&i){var n=t.generateUniqueKey(e);return i.hasItemSameVid(n)}return!1}},{key:"_getLoader",value:function(e){e=e||"";var t=this._loaders[e]||this._loaders[e.toLocaleLowerCase()];return t?t:(this.log("warn","no ".concat(e," preloader, register")),null)}},{key:"_getLoaderInst",value:function(e){e=e||"";var t=this._loaderInsts[e]||this._loaderInsts[e.toLocaleLowerCase()];return t?t:(this.log("warn","no ".concat(e," preloader, register")),null)}},{key:"getPreloadMemoryInfo",value:function(){return this._cacheInst.getMemoryInfo()}},{key:"attachPlayer",value:function(e){this._player=e}},{key:"detachPlayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;(!e||this._player===e)&&(this._player=null)}},{key:"setPreloadBandwidth",value:function(e,t){this._stats.setPreloadBandwidth(e,t)}},{key:"getPreloadBandwidth",value:function(e){return this._stats.getPreloadBandwidth(e)}},{key:"getLoadInfoAndDelete",value:function(e){return this._stats.getLoadInfoAndDelete(e)}},{key:"getPreloadUnuseInfo",value:function(){return this._stats.getPreloadUnuseInfo()}},{key:"setUsePreloadInfo",value:function(e,t){this._stats.setUsePreloadInfo(e,t)}},{key:"bwEventEmit",value:function(e){var t=e.vid,i=e.loadType,r=e.size,a=e.speed,o=e.cacheKey,s=e.vtype,l=e.duration,d=e.bitrate,c=(0,n.Kd)(e,h);this._stats.bwEventEmit((0,n.Zj)({vid:t,loadType:i,size:r,speed:a,cacheKey:o,vtype:s,duration:l,bitrate:d},c))}},{key:"findPreloadItem",value:function(e){var t,i=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(this._stepwise){var n=e.reduce(function(e,t){return void 0===t.data.stepIdx||"number"==typeof t.data.stepIdx&&"number"==typeof e.data.stepIdx&&t.data.stepIdx<e.data.stepIdx?t:e}),r=e.filter(function(e){return e.data.stepIdx===n.data.stepIdx});if(r.length>1&&this._sort(r),t=r[0],!i){if("number"!=typeof t.data.stepIdx&&(t.data.stepIdx=-1),t.data.stepIdx++,Array.isArray(t.data.steps)&&t.data.stepIdx>=t.data.steps.length-1){var a=e.indexOf(t);e.splice(a,1)}t.data.stepIdx===1/0&&(t=void 0)}}else t=i?e[0]:e.shift();return t}},{key:"updateConfig",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t?this._config=Object.assign({},g.getDefaultConfig(),e):Object.assign(this._config,e);var i=this._config.autoCheck;i&&!i.enable&&this.stopCheckTask(),i&&i.enable&&this.startCheckTask()}},{key:"preProcessUrl",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=this._config,n=i.preProcessUrl,r=i.preProcessUrlOptions;return"function"==typeof n?n(e,Object.assign({},r,t)):{url:e}}}],[{key:"getDefaultConfig",value:function(){return(0,c._)()}},{key:"generateUniqueCacheKey",value:function(e){var t=e.vid,i=e.codecType,n=e.vtype;return"".concat(t,"#").concat(i,"#").concat(n.toUpperCase())}},{key:"parseKey",value:function(e){if(!e)throw Error("key ".concat(e," is empty"));var t=e.split("#");if(t.length<6)throw Error("key ".concat(e," is not right format"));var i=t[0],n=t[1],r=t[2],a=t[3],o=t[4];return{vid:i,mediaType:n,codecType:r,vtype:a,definition:o,bitrate:parseInt("".concat(t[5]||0),10)||0}}},{key:"debugger",set:function(e){f=!!e}}])}(o())},746249:function(e,t,i){i.d(t,{L:function(){return d},w:function(){return l}});var n,r,a=i(622109);i(465132),i(499045),i(891555),i(499953),i(110617),i(742611);var o=i(734123),s=i.n(o),l=function(e){function t(){var e;return(0,a.PA)(this,t),e=(0,a.$w)(this,t,arguments),e._ploys=[],e._curInstContext=null,e}return(0,a.XW)(t,e),(0,a.qH)(t,[{key:"_findIndexFromPloys",value:function(e){for(var t=-1,i=this._ploys,n=0;n<i.length;n++)if(i[n]===e){t=n;break}return t}},{key:"_checkStrategy",value:function(e){return!(!(null!=e&&e.start)||!e.stop||this._findIndexFromPloys(e)>-1)&&!0}},{key:"registerStrategy",value:function(e){var t=this;if(!!e)!Array.isArray(e)&&(e=[e]),e.forEach(function(e){var i=e.Strategy,n=e.config;if(!!n)try{var r=new i(n,t);t._checkStrategy(r)&&(r.start(),t._ploys.push(r))}catch(e){}})}},{key:"unregisterStrategy",value:function(e){if(e){e.stop();var t=this._findIndexFromPloys(e);t>-1&&this._ploys.splice(t,1)}else this._ploys.forEach(function(e){e.stop()}),this._ploys.splice(0,this._ploys.length)}},{key:"findStrategy",value:function(e){return this._ploys.find(function(t){return t.constructor.STRATEGY_NAME===e})}},{key:"updateStrategyConfig",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!!e&&!!t)this._ploys.forEach(function(n){n instanceof e&&n.updateConfig(t,i)})}},{key:"setActive",value:function(e,i,n){var r=(0,a.Vx)(t,"setActive",this,3)([e,i]);return i&&n&&this.setVideoListContext(n),this.emit("UPDATE_INST_ORDER"),r}},{key:"setNext",value:function(e){var i=(0,a.Vx)(t,"setNext",this,3)([e]);return this.emit("UPDATE_INST_ORDER"),i}},{key:"getVideoListContext",value:function(){return this._curInstContext}},{key:"setVideoListContext",value:function(e){if(!e)return;var t,i=(null===(t=e.allVideos)||void 0===t?void 0:t.slice(0))||[],n=[],r=[],a=i.findIndex(function(e){return e.isActive});if(-1!==a){for(var o=i[a],s=0;s<e.allVideos.length;s++)s<a?n.push(e.allVideos[s]):s>a&&r.push(e.allVideos[s]);this._curInstContext={current:o,prevVideos:n,nextVideos:r,allVideos:i},this.emit("VIDEO_LIST_CONTEXT_CHANGED")}}}],[{key:"getInstance",value:function(){return r||(r=new t),r}}])}(o.InstManager||Object.prototype.constructor);s().instManager=l.getInstance();var d=((n=d||{}).UPDATE_INST_ORDER="UPDATE_INST_ORDER",n.VIDEO_LIST_CONTEXT_CHANGED="VIDEO_LIST_CONTEXT_CHANGED",n)},719515:function(e,t,i){i.d(t,{N:function(){return r}});var n=i(622109);i(429532);var r=(0,n.qH)(function e(t,i){(0,n.PA)(this,e),this.config=t,this.instManager=i},[{key:"updateConfig",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!!e)t?Object.assign(this.config,e):this.config=e}}])},467514:function(e,t,i){i.d(t,{Z:function(){return m}}),i(223047);var n=i(874838),r=i(758698),a=i(569395),o=i(284016),s=i(812523),l=i(151176),d=i(53285),c=i(344137);i(836654),i(429532);var u=i(675161),h=i(111795),f=i(822535),p=i(219139),v=i(187295),g=i(761690),_=i(540931),m=function(e){(0,s.Z)(m,e);var t,i,h=(t=m,i=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n=(0,d.Z)(t);return e=i?Reflect.construct(n,arguments,(0,d.Z)(this).constructor):n.apply(this,arguments),(0,l.Z)(this,e)});function m(){var e;(0,n.Z)(this,m);for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];return e=h.call.apply(h,[this].concat(i)),(0,c.Z)((0,a.Z)(e),"TAG","VideoRenderWithDecoder"),(0,c.Z)((0,a.Z)(e),"_hideRenderFlag",0),(0,c.Z)((0,a.Z)(e),"_recentMeta",null),(0,c.Z)((0,a.Z)(e),"_inChaseFrame",!1),(0,c.Z)((0,a.Z)(e),"_decoderErrorCallback",function(t){e._emitError(t,1)}),(0,c.Z)((0,a.Z)(e),"_decoderMessageCallback",function(t){var i,n,r,o=t.type,s=t.data;switch(o){case"DECODER_READY":e.analyse.addWasmReady(),e._startDecode();break;case"RECEIVE_FRAME":if(e._inChaseFrame&&!(null!==(i=e._decodeController)&&void 0!==i&&i.webcodec))return;e._receiveFrame(s);break;case"BATCH_FINISH":null===(n=(0,a.Z)(e))||void 0===n||n._decodeEstimate.resetDecodeDot(),e._inChaseFrame&&(e._inChaseFrame=!1,e._frameQueue.empty()),!e._ready&&!e.inSeeking&&null!==(r=e._decodeController)&&void 0!==r&&r.decoderReady&&e._startDecode()}}),e}return(0,r.Z)(m,[{key:"wasmInitCost",get:function(){var e;return null===(e=this._decodeController)||void 0===e?void 0:e.wasmInitCost}},{key:"hevcThread",get:function(){return 1===this.decodeMode}},{key:"lowlatency",get:function(){return this._parent.lowlatency}},{key:"nextFrameTime",get:function(){var e=this._frameQueue.nextFrame();return(e&&e.info&&e.info.dts||0)/1e3}},{key:"offscreenUsed",get:function(){return(0,g.tT)().offscreenCanvas}},{key:"ajustSeekTime",value:function(e,t){var i;u.kg.warn(this.TAG,"ajust seek time[preciseSeek:".concat(!!t,"]: "),e),this._frameQueue.empty(),null===(i=this._decodeController)||void 0===i||i.flushDecoder(),this._switchVideoBuffer(e,t)}},{key:"canSeek",value:function(){return!0}},{key:"_appendChunk",value:function(e){if(!this.noVideo&&!!this._timeRange){if(this._meta){if(this._recentMeta.width!==e.width||this._recentMeta.height!==e.height){u.kg.warn(this.TAG,"metadata changed! width: ".concat(this._recentMeta.width," -> ").concat(e.width,", height: ").concat(this._recentMeta.height," -> ").concat(e.height));var t=e.samples[0];t&&(this._recentMeta=t.meta=Object.assign({},e,{samples:null}))}}else{this._emitTimelineEvents(_.ZP.TIMELINE.PLAY_EVENT,_.ZP.VIDEO_EVENTS.LOADEDMETADATA),this._recentMeta=this._meta=Object.assign({},e,{samples:null}),u.kg.warn(this.TAG,"video set metadata",this._meta,"configuration:",this.configuration);var i,n,r=e.fpsNum/e.fpsDen;r?u.kg.log(this.TAG,"detect fps:",r):u.kg.warn(this.TAG,"no detect fps,start estimate"),this._selectDecoder(),this._initDecoder(),this._initFrameRender()}this._timeRange.append(e.samples,this._isLive&&this.noAudio,!this.videoDecode),e.samples=[],!this.inSeeking&&(!this.isLive&&!this._timeRange.frameLength&&this._switchVideoBuffer(this._parent.currentTime),!this._ready&&null!==(i=this._decodeController)&&void 0!==i&&i.decoderReady&&(this.noAudio||!(null!==(n=this._decodeController)&&void 0!==n&&n.inDecoding))&&this._startDecode(),this.noAudio&&this._emitTimelineEvents(_.ZP.TIMELINE.PLAY_EVENT,_.ZP.VIDEO_EVENTS.DURATION_CHANGE))}}},{key:"_selectDecoder",value:function(){if(!this.isHevc&&f.Z.isSupported()){this._decodeController=new f.Z(this),this._decodeEstimate.webcodec=!0;return}this._decodeController=new p.Z(this)}},{key:"_initDecoder",value:function(){var e;null===(e=this._decodeController)||void 0===e||e.init(this._decoderMessageCallback,this._decoderErrorCallback)}},{key:"_initFrameRender",value:function(){try{if(this.offscreenUsed){this._renderWorker.initRenderContext({meta:this._meta,type:this._decodeController.webcodec?"2d":""}),this._frameRender=function(){};return}var e=Object.assign(this._config,{meta:this._meta,canvas:this._canvas,type:this._decodeController.webcodec?"2d":""});this._frameRender=new v.S(e,this),u.kg.log(this.TAG,"create frameRender with config",e)}catch(e){this._emitError(e&&e.message,2)}}},{key:"_startDecode",value:function(){var e;null===(e=this._decodeController)||void 0===e||e.doDecode()}},{key:"_switchVideoBuffer",value:function(e,t){var i,n=this._timeRange.switchBuffer(e);if(n){if(this.noAudio&&this._parent.emit(_.ZP.TIMELINE.SYNC_DTS,this.getDtsOfTime(n.start)),t){null===(i=this._decodeController)||void 0===i||i.preciseSeek(e);return}this._startDecode(t)}}},{key:"_checkToDecode",value:function(){var e;!this.inSeeking&&(null===(e=this._decodeController)||void 0===e||e.checkToDecode(this._frameQueue.length))}},{key:"_render",value:function(e){if(!this.noVideo){var t,i,n,r=this._frameQueue&&this._frameQueue.nextFrame();if(!r){if(u.kg.log(this.TAG,"lack frame, ","inDecoding:",null===(i=this._decodeController)||void 0===i?void 0:i.inDecoding),this._checkToDecode(),this.noAudio){if(!this.isLive&&.5>Math.abs(this.currentTime-this.duration)){this===null||void 0===this||this._emitTimelineEvents(_.ZP.TIMELINE.PLAY_EVENT,_.ZP.VIDEO_EVENTS.TIMEUPDATE),this===null||void 0===this||this._emitTimelineEvents(_.ZP.TIMELINE.PLAY_EVENT,_.ZP.VIDEO_EVENTS.ENDED),null===(n=this._timeRange)||void 0===n||n.clean();return}!this._timeRange.frameLength&&(this._ready=!1,this.emit(_.ZP.VIDEO.VIDEO_WAITING))}return}var a=r.info;if(!a){this._frameQueue.shift();return}this._renderDts=a.dts;var o=a.dts-this.preciseVideoDts;if(!!e||!(o>0)||!(o<6e4)){this._frameQueue.shift(this.preciseVideoDts),Math.abs(this._lastTimeupdate-a.dts)>250&&(this._emitTimelineEvents(_.ZP.TIMELINE.PLAY_EVENT,_.ZP.VIDEO_EVENTS.TIMEUPDATE,{pts:a.originPts/90}),this._lastTimeupdate=a.dts),u.kg.long&&u.kg.log(this.TAG,"render delay:".concat(o," , timelinePosition:").concat(this.preciseVideoDts," , dts:").concat(a.dts," , cost:").concat(a.cost," , gopID:").concat(a.gopId," , rest:").concat(this._frameQueue.length,", buffer frame:").concat(this._timeRange.frameLength));var s=performance.now();this._hideRenderFlag++,"visible"===document.visibilityState?this.offscreenUsed?this._renderWorker.render(r.buffer,r.width,r.height,r.yLinesize,r.uvLinesize):this._frameRender.render(r.buffer,r.width,r.height,r.yLinesize,r.uvLinesize):this._hideRenderFlag%15&&(this.offscreenUsed?this._renderWorker.render(r.buffer,r.width,r.height,r.yLinesize,r.uvLinesize):this._frameRender.render(r.buffer,r.width,r.height,r.yLinesize,r.uvLinesize)),null!==(t=this._decodeController)&&void 0!==t&&t.webcodec&&r.buffer.close(),this._renderCost=performance.now()-s,this._checkToDecode()}}}},{key:"_updateSegmentEnd",value:function(e){var t;null===(t=this._timeRange)||void 0===t||t.updateSegmentEnd(e)}},{key:"_doChaseFrame",value:function(e){var t=e.frame;this._inChaseFrame=!0,this._timeRange.deletePassed(t.dts),this._frameQueue.empty(),this.noAudio&&this._parent.emit(_.ZP.TIMELINE.SYNC_DTS,t.dts)}},{key:"_destroy",value:function(e){var t;u.kg.log(this.TAG,"destroy video render"),(0,o.Z)((0,d.Z)(m.prototype),"destroy",this).call(this,e),null===(t=this._decodeController)||void 0===t||t.destroy(),this._decodeController=null}}]),m}(h.Z)},75999:function(e,t,i){i.d(t,{d1:function(){return p}}),i(223047);var n=i(83915),r=i(344137),a=i(758698),o=i(874838),s=i(116774),l=i.n(s);i(511141),i(110617),i(914613),i(874386),i(882732),i(544943),i(742611),i(98601),i(675373),i(826893);var d=i(921180),c=i(752578),u=i(440805),h=i(431497),f=function(){try{return h.j?window.MediaSource:null}catch(e){}}(),p=function(){var e,t,i;function s(e){var t=this;(0,o.Z)(this,s),(0,r.Z)(this,"media",null),(0,r.Z)(this,"mediaSource",null),(0,r.Z)(this,"_openPromise",(0,d.Q)()),(0,r.Z)(this,"_queue",Object.create(null)),(0,r.Z)(this,"_sourceBuffer",Object.create(null)),(0,r.Z)(this,"_onSBUpdateEnd",function(e){var i=t._queue[e];if(i){var n=i.shift();n&&(n.promise.resolve(),t._startQueue(e))}}),(0,r.Z)(this,"_onSBUpdateError",function(e,i){var n=t._queue[e];if(n){var r=n[0];r&&r.promise.reject(new u.Fc(u.wb.MEDIA,u.wb.SUB_TYPES.MSE_APPEND_BUFFER,i))}}),e&&this.bindMedia(e)}return(0,a.Z)(s,[{key:"isOpened",get:function(){var e;return(null===(e=this.mediaSource)||void 0===e?void 0:e.readyState)==="open"}},{key:"duration",get:function(){var e;return(null===(e=this.mediaSource)||void 0===e?void 0:e.duration)||-1}},{key:"updateDuration",value:function(e){var t=this;return this._enqueueBlockingOp(function(){t.mediaSource&&(t.mediaSource.duration=e)})}},{key:"open",value:function(){var e=this;if(this._openPromise.used&&!this.isOpened&&this.mediaSource){var t=this.mediaSource;t.addEventListener("sourceopen",function i(){t.removeEventListener("sourceopen",i),e._openPromise.resolve()}),this._openPromise=(0,d.Q)()}return this._openPromise}},{key:"bindMedia",value:(e=(0,n.Z)(l().mark(function e(t){var i,n,r=this;return l().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.mediaSource||this.media)){e.next=3;break}return e.next=3,this.unbindMedia();case 3:if(!(!t||!f)){e.next=5;break}throw Error("Param media or MediaSource does not exist");case 5:return this.media=t,i=this.mediaSource=new f,t.src=URL.createObjectURL(i),n=function e(){i.removeEventListener("sourceopen",e),URL.revokeObjectURL(t.src),r._openPromise.resolve()},i.addEventListener("sourceopen",n),e.abrupt("return",this._openPromise);case 11:case"end":return e.stop()}},e,this)})),function(t){return e.apply(this,arguments)})},{key:"unbindMedia",value:(t=(0,n.Z)(l().mark(function e(){var t,i=this;return l().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._openPromise.used&&this._openPromise.resolve(),t=this.mediaSource){if(Object.keys(this._queue).forEach(function(e){var t=i._queue[e];t&&t.forEach(function(e){return e.promise.resolve})}),"open"===t.readyState)try{t.endOfStream()}catch(e){}Object.keys(this._sourceBuffer).forEach(function(e){try{t.removeSourceBuffer(i._sourceBuffer[e])}catch(e){}})}if(this.media){this.media.removeAttribute("src");try{this.media.load()}catch(e){}this.media=null}this.mediaSource=null,this._openPromise=(0,d.Q)(),this._queue=Object.create(null),this._sourceBuffer=Object.create(null);case 8:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"createSource",value:function(e,t){var i;if(!this._sourceBuffer[e]&&this.mediaSource){try{i=this._sourceBuffer[e]=this.mediaSource.addSourceBuffer(t)}catch(e){throw new u.Fc(u.wb.MEDIA,u.wb.SUB_TYPES.MSE_ADD_SB,e)}i.mimeType=t,i.addEventListener("updateend",this._onSBUpdateEnd.bind(this,e)),i.addEventListener("error",this._onSBUpdateError.bind(this,e))}}},{key:"changeType",value:function(e,t){var i=this._sourceBuffer[e];return this.mediaSource&&i&&i.mimeType!==t&&"function"==typeof i.changeType?this._enqueueOp(function(){i.changeType(t)}):Promise.resolve()}},{key:"createOrChangeSource",value:function(e,t){return this.createSource(e,t),this.changeType(e,t)}},{key:"append",value:function(e,t){var i=this;return t&&t.byteLength&&this._sourceBuffer[e]?this._enqueueOp(e,function(){var n;i.mediaSource&&(null===(n=i._sourceBuffer[e])||void 0===n||n.appendBuffer(t))}):Promise.resolve()}},{key:"remove",value:function(e,t,i){var n=this;if(1!==Object.keys(this._sourceBuffer).length)return this._enqueueOp(e,function(){if(n.mediaSource){var r=n._sourceBuffer[e];if(t>=i||!r){n._onSBUpdateEnd(e);return}r.remove(t,i)}})}},{key:"clearBuffer",value:function(e,t){var i,n=this;return Object.keys(this._sourceBuffer).forEach(function(r){i=n._enqueueOp(r,function(){n.mediaSource&&n._sourceBuffer[r].remove(e,t)})}),i}},{key:"clearAllBuffer",value:function(){var e,t=this;return Object.keys(this._sourceBuffer).forEach(function(i){e=t._enqueueOp(i,function(){if(t.mediaSource){var e=t._sourceBuffer[i];e.remove(0,c.l.end(c.l.get(e)))}})}),e}},{key:"endOfStream",value:function(e){var t=this;return this.mediaSource&&"open"===this.mediaSource.readyState?this._enqueueBlockingOp(function(){var i=t.mediaSource;i&&"open"===i.readyState&&(e?i.endOfStream(e):i.endOfStream())}):Promise.resolve()}},{key:"setLiveSeekableRange",value:function(e,t){var i=this.mediaSource;!(e<0)&&!(t<e)&&null!=i&&i.setLiveSeekableRange&&"open"===i.readyState&&i.setLiveSeekableRange(e,t)}},{key:"buffered",value:function(e){return c.l.get(this._sourceBuffer[e])}},{key:"bufferStart",value:function(e){return c.l.start(this.buffered(e))}},{key:"bufferEnd",value:function(e){return c.l.end(this.buffered(e))}},{key:"_enqueueOp",value:function(e,t){if(!this.mediaSource)return Promise.resolve();var i=this._queue[e]=this._queue[e]||[],n={exec:t,promise:(0,d.Q)()};return i.push(n),1===i.length&&this._startQueue(e),n.promise}},{key:"_enqueueBlockingOp",value:(i=(0,n.Z)(l().mark(function e(t){var i,n,r=this;return l().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.mediaSource){e.next=2;break}return e.abrupt("return",Promise.resolve());case 2:if((i=Object.keys(this._sourceBuffer)).length){e.next=5;break}return e.abrupt("return",t());case 5:return n=[],i.forEach(function(e){var t=r._queue[e],i=(0,d.Q)();n.push(i),t.push({exec:function(){return i.resolve()},promise:i}),1===t.length&&r._startQueue(e)}),e.abrupt("return",Promise.all(n).then(function(){try{return t()}finally{i.forEach(function(e){var t=r._queue[e],i=r._sourceBuffer[e];null==t||t.shift(),(!i||!i.updating)&&r._startQueue(e)})}}));case 8:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"_startQueue",value:function(e){var t=this._queue[e];if(t){var i=t[0];if(i)try{i.exec()}catch(n){i.promise.reject(new u.Fc(u.wb.MEDIA,u.wb.SUB_TYPES.MSE_OTHER,n)),t.shift(),this._startQueue(e)}}}}],[{key:"isSupported",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:'video/mp4; codecs="avc1.42E01E,mp4a.40.2"';if(!f)return!1;try{return f.isTypeSupported(e)}catch(e){return!1}}}]),s}();(0,r.Z)(p,"VIDEO","video"),(0,r.Z)(p,"AUDIO","audio")},468425:function(e,t,i){i.d(t,{C:function(){return a}});var n=i(670537),r=i(145594),a=function(e){(0,n.XW)(i,e);var t=(0,n.WY)(i);function i(e,a,o,s){var l;return(0,n.PA)(this,i),l=t.call(this,s),(0,n._x)((0,n.Lc)(l),"retryCount",0),(0,n._x)((0,n.Lc)(l),"isTimeout",!1),(0,n._x)((0,n.Lc)(l),"loaderType",r.t.FETCH),(0,n._x)((0,n.Lc)(l),"startTime",0),(0,n._x)((0,n.Lc)(l),"endTime",0),(0,n._x)((0,n.Lc)(l),"options",{}),l.url=e,l.request=a,l.response=o,l}return(0,n.qH)(i)}((0,n.wm)(Error))},382541:function(e,t,i){i.d(t,{U:function(){return r},t:function(){return n}});var n={FETCH:"fetch",XHR:"xhr"},r={ARRAY_BUFFER:"arraybuffer",TEXT:"text",JSON:"json"}}}]);
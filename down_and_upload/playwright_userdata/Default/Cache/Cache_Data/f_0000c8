/*! For license information please see 96919.2da06ac3.js.LICENSE.txt */
(self.webpackChunkdouyin_web=self.webpackChunkdouyin_web||[]).push([["96919"],{971699:function(e,t,n){"use strict";n.d(t,{m:function(){return o}});var i=n(839954),r=n(963212),s=function(){return(s=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n],t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},o=function(e){var t=e.appKey,n=e.aid,o=e.host,a=new TextEncoder;return function(e){if(!t||!n)return Promise.resolve(e);try{var d=e.url,c=void 0===d?"":d;c=String(c).split("?")[0];var u=(0,i.AU)(c,o),l=new Date,h=Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate(),12,0,0,0),v=String(h/1e3),g=a.encode(v),f=a.encode(t),p=(0,i.Di)(g,f,new Uint8Array,32),m=(0,i.lk)(n,u,v),_=(0,i.bD)(p,m);return!e.headers&&(e.headers={}),e.headers[r.A]=_,e.params=s({ts:v},e.params||{}),Promise.resolve(e)}catch(t){return Promise.resolve(e)}}}},684941:function(e,t,n){"use strict";n.d(t,{e:function(){return s}});var i=n(885774),r=function(){return(r=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n],t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},s=function(e,t){var n,s,o=(null===(n=null==e?void 0:e.config)||void 0===n?void 0:n.url)||"",a=(null===(s=null==e?void 0:e.headers)||void 0===s?void 0:s["x-tt-logid"])||"",d=function(e){var t,n,i=(null===(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.data)||void 0===n?void 0:n.response)||(null==e?void 0:e.data)||{};if("string"==typeof i)try{i=JSON.parse(i)}catch(e){}return i}(e),c=(null==t?void 0:t.printLog)||!1;return(null==d?void 0:d.message)==="success"?(c&&(0,i.Jz)("call ".concat(o," result >>>>"),{SUCCESS:d.data,Logid:a},!1),Promise.resolve(r(r({},d.data||{}),{log_id:a}))):(c&&(0,i.Jz)("call ".concat(o," result >>>>"),{ERROR:d.data,Logid:a},!1),Promise.reject(r(r({},d.data),{log_id:a,originConfig:e.config})))}},885774:function(e,t,n){"use strict";n.d(t,{GZ:function(){return h},IC:function(){return a},Jz:function(){return o},ej:function(){return r},hp:function(){return s},uF:function(){return l}});var i=n(213257);function r(e){var t,n=new RegExp("(^| )".concat(e,"=([^;]*)(;|$)"));return(t=document.cookie.match(n))?unescape(t[2]):""}function s(e){return"undefined"!=typeof FormData&&e instanceof FormData}function o(e,t,n){void 0===n&&(n=!0),t&&Object.keys(t).forEach(function(e){})}function a(e){return Object.keys(e).map(function(t){var n=e[t];return"object"==typeof n?"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(JSON.stringify(n))):"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))}).join("&")}var d=function(e){for(var t,n=e.toString(),i=[],r=0;r<n.length;r++)0<=(t=n.charCodeAt(r))&&t<=127?i.push(t):128<=t&&t<=2047?(i.push(192|31&t>>6),i.push(128|63&t)):(2048<=t&&t<=55295||57344<=t&&t<=65535)&&(i.push(224|15&t>>12),i.push(128|63&t>>6),i.push(128|63&t));for(var s=0;s<i.length;s++)i[s]&=255;return i},c=function(e){var t=[],n=[];if(void 0===e)return"";n=d(e);for(var i=0,r=n.length;i<r;++i)t.push((5^n[i]).toString(16));return t.join("")},u=function(e,t){void 0===e&&(e={}),void 0===t&&(t=-1);var n=Object.keys(e).sort()||[];return t>=0&&n.splice(t),{str:n.map(function(t){var n=e[t];return"object"==typeof n?"".concat(t,"=").concat(JSON.stringify(n)):"".concat(t,"=").concat(n)}).join("&"),arr:n}},l=function(e,t,n){if(void 0===e&&(e={}),void 0===t&&(t={}),void 0===n&&(n=""),!n)return{};var r=u(e,10),s=r.str,o=r.arr,a=u(t),d=a.str;a.arr;var l="".concat(void 0===s?"":s,"&").concat(void 0===d?"":d,"&app_key=").concat(n);return{sign:(0,i.sha256)(l),qs:c((void 0===o?[]:o).join(","))}},h=function(e){return Uint8Array.from((e.match(/.{1,2}/g)||[]).map(function(e){return parseInt(e,16)}))}},597552:function(e,t,n){"use strict";n.d(t,{r:function(){return v}});var i=n(193533),r=n(621631),s=n(651889),o=n(832141),a=n(746705),d=n(586539),c=n.n(d),u=n(592242),l=n(835649),h=n(124125);class v extends l.mA{constructor(){super(...arguments),this.isMember=!0,this._badgeCount=0,this.muteBadgeCountInfos=[],this.__internal_pullCursor=i.MAX_VALUE,this.cacheUnreadCountCalc=void 0,this.cacheUnreadCountWithWhiteListCalc=void 0}get type(){return 15&this.bizType}set type(e){this.bizType=e}get inboxType(){return this.coreInfo.inboxType}mergeMuteBadgeCountInfos(e){if(!!e)e.forEach(e=>{let t=this.muteBadgeCountInfos.findIndex(t=>t.message_type===e.message_type);t>-1?this.muteBadgeCountInfos[t]=e:this.muteBadgeCountInfos.push(e)})}get badgeCount(){return this._badgeCount}set badgeCount(e){if(void 0!==e){if(void 0===this._badgeCount){this._badgeCount=e;return}e>this._badgeCount&&(this._badgeCount=e)}}get partMuteBadgeCount(){var e,t,n,i;return null!==(i=null===(n=null===(t=null===(e=this.muteBadgeCountInfos)||void 0===e?void 0:e.find)||void 0===t?void 0:t.call(e,e=>e.message_type===r.m.MuteMessageType.TYPE_PART_MUTE))||void 0===n?void 0:n.badge_count)&&void 0!==i?i:0}get mode(){return 0}get isStrangerConversation(){return 0!==this.mode}get isMuted(){return this.pushStatus!==s.Bs.Unknown?this.pushStatus===s.Bs.Disable:void 0!==this.settingInfo&&this.settingInfo.mute===s.I7.On}get pushStatus(){var e;return null!==(e=this.settingInfo.pushStatus)&&void 0!==e?e:s.Bs.Unknown}get weakMuteInfo(){return this.settingInfo.weakMuteInfo}get isStickOnTop(){return void 0!==this.settingInfo&&this.settingInfo.stickTop===s.uX.On}get isFavorite(){return void 0!==this.settingInfo&&this.settingInfo.favor===s.Lk.On}get ext(){let e={};return this.coreInfo&&this.coreInfo.ext&&(e=Object.assign(e,this.coreInfo.ext)),this.settingInfo&&this.settingInfo.ext&&(e=Object.assign(e,this.settingInfo.ext)),e}get rankScore(){var e,t,n,r,s;return this.isStickOnTop?(null!==(e=this.settingInfo.setTopTime)&&void 0!==e?e:i.ZERO).add(8e15).toNumber():null!==(s=null===(r=null===(n=null===(t=this.lastPopVisibleMessage)||void 0===t?void 0:t.createdAt)||void 0===n?void 0:n.getTime)||void 0===r?void 0:r.call(n))&&void 0!==s?s:-1}get lastMessage(){return this.filterLastMessage()}get lastVisibleMessage(){return this.filterLastMessage(e=>e.visible)}get lastPopVisibleMessage(){return this.filterLastMessage(e=>!e.unpop)}get firstMessage(){return this.filterFirstMessage()}get readIndex(){return this.settingInfo.readIndex}get readIndexV2(){return this.settingInfo.readIndexV2}get minIndex(){return this.settingInfo.minIndex}get version(){return this.coreInfo.version}get unreadCount(){return this.ctx.option.useBadgeCountForUnread&&this.settingInfo.readBadgeCount?this.unreadCountFromReadBadge:this.unreadCountFromReadIndex}get unreadCountFromReadBadge(){return Math.max(this.badgeCount-this.settingInfo.readBadgeCount,0)}get unreadCountFromReadIndex(){var e,t,n;return void 0===this.cacheUnreadCountCalc&&(this.cacheUnreadCountCalc=c()(e=>this.unreadMessageList.length,{maxSize:1})),this.cacheUnreadCountCalc(`${null===(t=null===(e=this.updatedAt)||void 0===e?void 0:e.getTime)||void 0===t?void 0:t.call(e)}:${null===(n=this.readIndex)||void 0===n?void 0:n.toString()}`)}get unreadCountWithWhiteList(){return this.ctx.option.useBadgeCountForUnread&&this.settingInfo.partMuteReadBadgeCount?this.unreadCountWithWhiteListFromReadBadge:this.unreadCountWithWhiteListFromReadIndex}get unreadCountWithWhiteListFromReadBadge(){return Math.max(this.partMuteBadgeCount-this.settingInfo.partMuteReadBadgeCount,0)}get unreadCountWithWhiteListFromReadIndex(){var e,t,n;return void 0===this.cacheUnreadCountWithWhiteListCalc&&(this.cacheUnreadCountWithWhiteListCalc=c()(e=>this.unreadMessageListWithWhiteList.length,{maxSize:1})),this.cacheUnreadCountWithWhiteListCalc(`${null===(t=null===(e=this.updatedAt)||void 0===e?void 0:e.getTime)||void 0===t?void 0:t.call(e)}:${null===(n=this.readIndex)||void 0===n?void 0:n.toString()}`)}forceRefreshUnreadCount(){var e;let t=this.unreadMessageList.length;t!==this.unreadCount&&void 0!==this.cacheUnreadCountCalc&&void 0!==this.cacheUnreadCountCalc.clear&&(u.Y.ctxDebug(this.ctx,`force refresh unread count: ${this.id}, value: ${t}`),null===(e=this.cacheUnreadCountCalc)||void 0===e||e.clear())}get unreadMessageList(){return this.readIndex?this.resolve(l.Uk.MessageManager).getList(this.id).filter(e=>e.indexInConversation.gt(this.readIndex)&&e.indexInConversation.gt(this.minIndex)&&e.increaseUnread):[]}get unreadMessageListWithWhiteList(){return this.unreadMessageList.filter(e=>this.isMsgInWeakMuteWhiteList(e))}isMsgInWeakMuteWhiteList(e){var t,n,i;return(null===(t=e.ext)||void 0===t?void 0:t[s.v9.MustNotify])||(null===(n=this.settingInfo.weakMuteInfo.whiteUids)||void 0===n?void 0:n.find(t=>t.toString()===e.sender))||(null===(i=this.settingInfo.weakMuteInfo.whiteMsgTypes)||void 0===i?void 0:i.find(t=>t===e.type))}getLocalMessageRangeList(e,t){return this.resolve(l.Uk.MessageManager).getList(this.id).filter(n=>n.indexInConversation.lte(t)&&n.indexInConversation.gt(e)&&n.indexInConversation.gt(this.minIndex)&&n.increaseUnread)}get updatedAt(){return this.lastMessage?this.lastMessage.createdAt:new Date(0)}get firstMessageIndex(){var e,t;return null!==(t=null===(e=this.filterFirstMessage(e=>e.indexInConversation&&e.indexInConversation.gt(0)))||void 0===e?void 0:e.indexInConversation)&&void 0!==t?t:i.ZERO}get lastMessageIndex(){var e,t;return null!==(t=null===(e=this.filterLastMessage(e=>e.indexInConversation&&e.indexInConversation.gt(0)))||void 0===e?void 0:e.indexInConversation)&&void 0!==t?t:i.ZERO}get lastMessageIndexV2(){var e,t;return null!==(t=null===(e=this.filterLastMessage(e=>e.indexInConversation&&e.indexInConversation.gt(0)))||void 0===e?void 0:e.indexInConversationV2)&&void 0!==t?t:i.ZERO}get lastMessageOrder(){var e,t;return null!==(t=null===(e=this.filterLastMessage(e=>e.orderInConversation&&e.orderInConversation.gt(0)))||void 0===e?void 0:e.orderInConversation)&&void 0!==t?t:i.ZERO}getMessageList(e=e=>e.visible){return this.resolve(l.Uk.MessageManager).getList(this.id).filter(e)}getParticipantList(){return this.resolve(l.Uk.ParticipantManager).get(this.id)}get toParticipantUserId(){if(this.type===r.m.ConversationType.GROUP_CHAT)return;let e=this.id.split(":");return e[2]===this.ctx.option.userId?e[3]:e[2]}get isBlocked(){return(0,h.vP)(this.ext,s.v9.RelationIsMuted)}get isServerBlocked(){return(0,h.vP)(this.ext,s.v9.RelationIsMutedServer)}get isBlockNormalOnly(){return this.isBlocked&&(0,h.vP)(this.ext,s.v9.RelationNormalOnly)}get tagIds(){let e=this.ext[s.v9.ConversationTags]||"";return""===e?[]:e.split(",")}get userTagIds(){let e=this.ext[s.v9.UserCustomConversationTags]||"";return""===e?[]:e.split(",")}static fromServerConversation(e,t,n){var i;let r=new v(e);r.id=t.conversation_id,r.shortId=t.conversation_short_id.toString(),r.type=t.conversation_type,r.ticket=t.ticket,r.participantCount=t.participants_count,r.isMember=t.is_participant,r.isOffline=!1,r.firstPageParticipant=t.first_page_participants,r.badgeCount=t.badge_count,r.muteBadgeCountInfos=null!==(i=t.mute_badge_count_infos)&&void 0!==i?i:[],r.coreInfo=new o._(r,t.conversation_core_info),r.settingInfo=new a.H(r,t.conversation_setting_info);let d=Object.keys(r.coreInfo.ext);for(let e of Object.keys(r.settingInfo.ext))d.includes(e)&&u.Y.ctxDebug(r.ctx,`conversation: ${r.shortId} ext duplicate key: ${e}`);return void 0!==n&&r.ctx.option.debug&&(r.coreInfo.ext[s.v9.LocalLogId]=n),r}filterLastMessage(e){let t=this.getMessageList(()=>!0),n=null;if(0===t.length)return null;if(void 0===e)return t[t.length-1];for(let i=t.length-1;i>=0;i--)if(e(t[i])){n=t[i];break}return n}filterFirstMessage(e){let t=this.getMessageList(()=>!0),n=null;if(0===t.length)return null;if(void 0===e)return t[0];for(let i of t)if(e(i)){n=i;break}return n}}},746705:function(e,t,n){"use strict";n.d(t,{H:function(){return c}});var i=n(193533),r=n(592242),s=n(621631),o=n(651889),a=n(835649),d=n(358115);class c extends a.mA{constructor(e,t){var n,r;super(e.ctx),this.version=i.ZERO,this._pushStatus=o.Bs.Allow,this.minIndex=i.ZERO,this._readIndex=i.ZERO,this._readIndexV2=i.ZERO,this._readBadgeCount=0,this.muteReadBadgeCountInfos=[],this.parent=e,void 0!==t&&(this.ext=t.ext,this.favor=t.favorite,this.mute=t.mute,this.stickTop=t.stick_on_top,this.version=i.fromValue(null!==(n=t.setting_version)&&void 0!==n?n:i.ZERO),this.readIndex=t.read_index,this.readIndexV2=t.read_index_v2,this.minIndex=t.min_index,this.setFavoriteTime=t.set_favorite_time,this.setTopTime=t.set_top_time,this.pushStatus=t.push_status,this.readBadgeCount=t.read_badge_count,this.mergeMuteReadBadgeCountInfos(null!==(r=t.mute_read_badge_count_infos)&&void 0!==r?r:[]))}get conversationId(){return this.parent.id}get pushStatus(){return this._pushStatus}set pushStatus(e){[o.Bs.Allow,o.Bs.PartAllow,o.Bs.Disable].includes(e)?this._pushStatus=e:this._pushStatus=o.Bs.Unknown}get readIndex(){return this._readIndex}set readIndex(e){if(void 0===e)return;let t=i.fromValue(e);if(void 0===this._readIndex){this._readIndex=t;return}t.gt(this._readIndex)&&(this._readIndex=t)}get readIndexV2(){return this._readIndexV2}set readIndexV2(e){if(void 0===e)return;let t=i.fromValue(e);if(void 0===this._readIndexV2){this._readIndexV2=t;return}t.gt(this._readIndex)&&(this._readIndexV2=t)}get readBadgeCount(){return this._readBadgeCount}set readBadgeCount(e){if(void 0!==e){if(this.parent.badgeCount&&e>this.parent.badgeCount&&(e=this.parent.badgeCount),void 0===this._readBadgeCount){this._readBadgeCount=e;return}e>this._readBadgeCount&&(this._readBadgeCount=e)}}mergeMuteReadBadgeCountInfos(e){if(!!e)e.forEach(e=>{let t=this.muteReadBadgeCountInfos.findIndex(t=>t.message_type===e.message_type);t>-1?this.muteReadBadgeCountInfos[t]=e:this.muteReadBadgeCountInfos.push(e)})}get partMuteReadBadgeCount(){var e,t,n,i;return null!==(i=null===(n=null===(t=null===(e=this.muteReadBadgeCountInfos)||void 0===e?void 0:e.find)||void 0===t?void 0:t.call(e,e=>e.message_type===s.m.MuteMessageType.TYPE_PART_MUTE))||void 0===n?void 0:n.read_badge_count)&&void 0!==i?i:0}get ext(){return!this.innerExt&&(this.innerExt={}),this.innerExt}set ext(e){this.innerExt=null!=e?e:{}}mergeSetting(e){return e.version.lt(this.version)?(r.Y.ctxDebug(this.ctx,"setting info version local > online, local: ",this.version.toString(),"new: ",e.version.toString()),this):e.conversationId!==this.conversationId?(r.Y.ctxDebug(this.ctx,"setting info conversation not match, local:",this.conversationId.toString(),"new: ",e.conversationId.toString()),this):(this.stickTop=e.stickTop,this.setTopTime=e.setTopTime,this.mute=e.mute,this.favor=e.favor,this.setFavoriteTime=e.setFavoriteTime,this.innerExt=Object.assign(Object.assign({},this.innerExt),e.ext),this.readIndex=e.readIndex,this.readIndexV2=e.readIndexV2,this.minIndex=e.minIndex,this.version=e.version,this.pushStatus=e.pushStatus,this.readBadgeCount=e.readBadgeCount,this.mergeMuteReadBadgeCountInfos(e.muteReadBadgeCountInfos),this)}get weakMuteInfo(){var e,t,n;let s={whiteUids:[],whiteMsgTypes:[]};if(!this.innerExt[o.v9.PushPartDisableConfig])return s;try{let r=d.parse(this.innerExt[o.v9.PushPartDisableConfig]),s=null==r?void 0:r[o.O9],a=null!==(t=null===(e=null==s?void 0:s.white_uids)||void 0===e?void 0:e.map(i.fromValue))&&void 0!==t?t:[],c=null!==(n=null==s?void 0:s.white_msg_types)&&void 0!==n?n:[];return{whiteUids:a,whiteMsgTypes:c}}catch(e){return r.Y.ctxWarn(this.ctx,"conversation setting weak mute info parse error: ",e),s}}}},775073:function(e,t,n){"use strict";n.d(t,{G:function(){return s}});var i=n(621631);let r={[i.m.IMCMD.SEND_MESSAGE]:"v1/message/send",200:"v1/message/get_by_user",203:"v2/message/get_by_user_init",300:"v1/conversation/get_list",301:"v1/message/get_by_conversation",400:"v1/account/online",401:"v1/account/offline",410:"v1/client/user_action",411:"v1/client/input_status",603:"v1/conversation/delete",608:"v2/conversation/get_info",609:"v2/conversation/create",610:"v2/conversation/get_info_list",611:"v2/conversation/get_by_favorite",612:"v2/conversation/get_by_top",614:"v1/conversation/dissolve",605:"v1/conversation/participants_list",650:"v1/conversation/add_participants",651:"v1/conversation/remove_participants",652:"v1/conversation/leave",655:"v1/conversation/update_participant",701:"v1/message/delete",702:"v1/message/recall",705:"v1/message/set_property",902:"v1/conversation/set_core_info",904:"v1/conversation/upsert_core_ext_info",921:"v1/conversation/set_setting_info",922:"v1/conversation/upsert_settings_ext",1001:"v1/stranger/get_conversation_list",1002:"v1/stranger/get_messages",1003:"v1/stranger/delete_message",1004:"v1/stranger/delete_conversation",1005:"v1/stranger/delete_all_conversations",1006:"v1/stranger/mark_read_conversation",1007:"v1/stranger/mark_read_all_conversations",2e3:"v3/conversation/get_read_index",2001:"v3/conversation/get_min_index",2002:"v3/conversation/mark_read",2003:"v1/media/get_upload_token",2004:"v1/media/get_urls",2005:"v1/conversation/get_ticket",2006:"v1/conversation/list",2007:"v1/broadcast/send_message",2008:"v1/broadcast/recv_message",2009:"v1/broadcast/user_counter",2010:"v1/client/ack",2011:"v1/voip/create",2012:"v1/voip/call",2013:"v1/voip/update",2014:"v1/channel/heartbeat",2015:"v1/profile/get_info",2016:"v1/client/report_metrics",2017:"v1/config/get",[i.m.IMCMD.GET_MESSAGE_BY_INIT]:"v1/message/get_message_by_init",[i.m.IMCMD.MODIFY_MESSAGE_EXT]:"v1/message/modify_ext",[i.m.IMCMD.UNREAD_COUNT_REPORT]:"v1/client/unread_count",[i.m.IMCMD.SEND_MESSAGE_P2P]:"v1/send_message/p2p",[i.m.IMCMD.BATCH_GAT_CONVERSATION_PARTICIPANTS_READINDEX]:"v1/conversation/batch_get_conversation_participants_readindex",[i.m.IMCMD.GET_CONVERSATIONS_CHECKINFO]:"v1/conversation/get_checkinfo",[i.m.IMCMD.GET_MESSAGES_CHECKINFO_IN_CONVERSATION]:"v1/message/get_checkinfo",[i.m.IMCMD.MARK_MESSAGE]:"v1/message/mark",[i.m.IMCMD.PULL_MARK_MESSAGE]:"v1/message/pull_mark",[i.m.IMCMD.GET_CONVERSATION_CORE_INFO]:"v1/conversation/get_core_info",[i.m.IMCMD.GET_UNREAD_COUNT]:"v1/client/get_unread_count",[i.m.IMCMD.BLOCK_MEMBERS]:"v1/conversation/block_member",[i.m.IMCMD.BLOCK_CONVERSATION]:"v1/conversation/block_conversation",[i.m.IMCMD.CHECK_IN_BLOCKLIST]:"v1/blocklist/check",[i.m.IMCMD.SET_BLOCKLIST]:"v1/blocklist/set",[i.m.IMCMD.GET_BLOCKLIST]:"v1/blocklist/get",[i.m.IMCMD.BATCH_UNMARK_MESSAGE]:"v1/message/batch_unmark",[i.m.IMCMD.MARK_MSG_UNREAD_COUNT_REPORT]:"v1/message/report_mark_count",[i.m.IMCMD.MARK_MSG_GET_UNREAD_COUNT]:"v1/message/get_mark_count",[i.m.IMCMD.GET_MESSAGE_INFO_BY_SERVER_ID]:"v1/message/get_by_id",[i.m.IMCMD.CLIENT_BATCH_ACK]:"v1/client/batch_ack",[i.m.IMCMD.AUDIO_RECOGNITION]:"v1/message/audio_recognition",[i.m.IMCMD.BATCH_MARK_CONVERSATION_READ_V3]:"v3/conversation/batch_mark_read",[i.m.IMCMD.GET_USER_MESSAGE]:"v1/message/get_user_message",[i.m.IMCMD.GET_TAG_META_INFO]:"v1/tag/get_meta_info",[i.m.IMCMD.SET_CONVERSATION_TAG]:"v1/conversation/set_tag",[i.m.IMCMD.MANAGE_TAG_META_INFO]:"v1/tag/manage_meta_info",[i.m.IMCMD.GET_CONVERSATIONS_BY_TAG]:"v1/conversation/get_by_tag",[i.m.IMCMD.ADD_CONVERSATION_BOTS]:"v1/conversation/add_bots",[i.m.IMCMD.REMOVE_CONVERSATION_BOTS]:"v1/conversation/remove_bots"};function s(e){var t;return null!==(t=r[e])&&void 0!==t?t:""}},10672:function(e,t,n){"use strict";n.d(t,{IL:function(){return r},KQ:function(){return h},RQ:function(){return u},fC:function(){return l},u_:function(){return v}});var i,r,s=n(621631),o=n(592242),a=n(651889);let d={appId:0,token:"",deviceId:"",userId:"",biz:"",apiUrl:"",frontierUrl:"",fpId:89,appKey:"e0f82475ab9dbf5717d18b4a9c0d7fd0",service:2,method:1,authType:s.m.AuthType.TOKEN_AUTH,inboxType:[0],headers:{},httpHeaders:{},sendMessageHeader:{},devicePlatform:"web",timeout:2e3,pullInterval:3e4,throttle:100,triggerStrategy:{[a.c5.ConversationChange]:a.zn.Debounce,[a.c5.MessageUpsert]:a.zn.Debounce,[a.c5.ConversationUpsert]:a.zn.ThrottleWithArgs},maxMessageCount:1e3,enableServerConfig:!1};function c(e,t,n){for(let i of Object.keys(n))"string"!=typeof n[i]&&o.Y.ctxError(e,`${t}[${i}] is not a string!`)}function u(e,t){"number"!=typeof t.appId&&o.Y.ctxError(e,"opt.appId is not a number! did you pass a string?"),"string"!=typeof t.deviceId&&o.Y.ctxError(e,"opt.deviceId is not a string! did you pass a number?"),"string"!=typeof t.userId&&o.Y.ctxError(e,"opt.userId is not a string! did you pass a number?"),("string"!=typeof t.apiUrl||0===t.apiUrl.length)&&o.Y.ctxError(e,"opt.apiUrl invalid"),("string"!=typeof t.frontierUrl||0===t.frontierUrl.length)&&o.Y.ctxError(e,"opt.frontierUrl invalid"),"object"==typeof t.headers&&c(e,"opt.headers",t.headers),"object"==typeof t.httpHeaders&&c(e,"opt.httpHeaders",t.httpHeaders),"object"==typeof t.monitorTagKv&&c(e,"opt.monitorTagKv",t.monitorTagKv),(Array.isArray(t.inboxType)&&(0===t.inboxType.length||t.inboxType.some(e=>e<0))||"number"==typeof t.inboxType&&t.inboxType<0)&&o.Y.ctxError(e,"opt.inboxType invalid"),"number"==typeof t.pullInterval&&t.pullInterval<5e3&&o.Y.ctxDebug(e,"opt.pullInterval too short")}function l(e){return Object.assign(Object.assign(Object.assign({},d),e),{triggerStrategy:Object.assign(Object.assign({},d.triggerStrategy),e.triggerStrategy)})}function h(e){return Object.assign(Object.assign(Object.assign({debug:!0,boe:!0},d),e),{triggerStrategy:Object.assign(Object.assign({},d.triggerStrategy),e.triggerStrategy)})}(i=r||(r={})).sharkEnabled="sharkEnabled",i.autoFetchMsgEnabled="autoFetchMsgEnabled",i.autoFetchMsgInterval="autoFetchMsgInterval",i.conversationMsgRepairInterval="conversationMsgRepairInterval",i.conversationMsgRepairStart="conversationMsgRepairStart",i.conversationMsgRepairCount="conversationMsgRepairCount",i.conversationMsgRepairRatio="conversationMsgRepairRatio",i.UnreadCountReport="UnreadCountReport",i.autoPollingMsgEnabled="autoPollingMsgEnabled",i.triggerPollingMsgEnabled="triggerPollingMsgEnabled",i.defaultPollingMsgInterval="defaultPollingMsgInterval",i.unmuteWhiteUidsLen="unmuteWhiteUidsLen";let v=[[r.conversationMsgRepairCount,100],[r.conversationMsgRepairInterval,864e5]]},59498:function(e,t,n){"use strict";n.d(t,{T:function(){return o},j:function(){return r}});var i,r,s=n(835649);(i=r||(r={})).SdkVersion="sdk.version",i.DbVersion="sdk.db.version",i.DbLastOpen="sdk.db.last_open",i.DbEncyption="sdk.db.encryption",i.UserToken="user.token",i.ConversationCheckTime="sdk.db.conversation.check.time",i.ConversationMsgCheckTime="sdk.db.conversation.msg.check.time";class o extends s.mA{}},491822:function(e,t,n){"use strict";n.d(t,{BX:function(){return h},mf:function(){return l},qC:function(){return c},vB:function(){return u}});var i=n(621631),r=n(592242);let s=i.m.Request,o=i.m.Response,a=i.m.Frame;function d(e){return"undefined"!=typeof btoa?btoa(String.fromCharCode.apply(null,new Uint8Array(e))):""}function c(e){return new Uint8Array(s.encode(e).finish())}function u(e,t){let n=new Uint8Array(t);try{return o.decode(n)}catch(i){let t=d(n);throw r.Y.ctxWarn(e,"decode response error: ",i),r.Y.ctxDebug(e,"hex dump: ",t),t}}function l(e){return new Uint8Array(a.encode(e).finish())}function h(e,t){let n=new Uint8Array(t);try{return a.decode(n)}catch(i){let t=d(n);throw r.Y.ctxWarn(e,"decode frame error: ",i),r.Y.ctxDebug(e,"hex dump: ",t),t}}},492173:function(e,t,n){"use strict";n.d(t,{j:function(){return i}});class i{static fromServerTag(e){var t;let n=new i;return n.id=e.tag_id.toString(),n.name=e.tag_name,n.ext=null!==(t=e.ext)&&void 0!==t?t:{},n.isDeleted=!!e.status,n}}},206637:function(e,t,n){"use strict";n.d(t,{W:function(){return u}});var i=n(101380),r=n(358115),s=n(193533),o=n.n(s),a=n(621631),d=n(835649);n(689845);var c=n(190638);class u extends c.f{process(e){return(0,i.mG)(this,void 0,void 0,function*(){return e.data.type===a.m.MessageType.MESSAGE_TYPE_VISIBLE_MESSAGE_COMMAND&&(e.needContinue=!1,yield this.handle(e)),e})}handle(e){return(0,i.mG)(this,void 0,void 0,function*(){let t=r.parse(e.data.content),n=o().fromValue(t.message_id).toString(),i=yield this.resolve(d.Uk.ExtensionPlugin).getMessageByServerId({conversation:{id:t.conversation_id,shortId:o().fromValue(t.conversation_short_id).toString(),type:t.conversation_type,inboxType:t.inbox_type},serverMessageId:n});i&&this.resolve(d.Uk.MessageManager).upsert(i)})}}},811092:function(e,t,n){"use strict";n.d(t,{a:function(){return s}}),n(193533);var i=n(651889),r=n(592242);n(358115),n(689845);class s{constructor(e){this.errorTypeBlacklist=[i.NI.NetworkError],this.slardar=e}emitError(e,t){!this.errorTypeBlacklist.includes(e.type)&&this.slardar("captureException",e,Object.assign(Object.assign({},t),{type:`${e.type}:${i.NI[e.type]}`,msg:e.msg,logid:e.logid,args:e.args}))}emitNetwork(e,t,n){void 0!==t&&0!==t.status_code&&this.slardar("sendLog",{level:"error",content:`Response Error:${t.status_code}, cmd: ${t.cmd} msg: ${t.error_desc}, logid: ${t.log_id}`,extra:Object.assign({cmd:`${t.cmd}`},n)})}emitEvent(e,t,n){}emitLog(e,t){if(e===r.h.debug)return;let n={};t.forEach((e,t)=>{n[t]=e}),this.slardar("sendLog",{level:r.h[e],content:t.join(","),extra:Object.assign({},n)})}emitTracker(e,t){this.slardar("sendLog",{level:"debug",content:e,extra:t})}emitMetrics(e,t={},n={}){}}},927275:function(e,t,n){"use strict";n.d(t,{$:function(){return o}});var i=n(193533);n(358115);var r=n(792243);n(689845);var s=n(504025);class o{static formatMessageKey(e){return`${e.conversationId}:${e.clientId}`}static convertPropertyStore(e){return e.map(e=>({messageId:e.messageId,conversationId:e.conversationId,key:e.key,userId:e.userId,secUid:e.secUid,createTime:e.createTime,idempotentId:e.idempotentId,value:e.value,version:e.version.toString(),status:e.status}))}static fromPropertyStore(e){return e.map(e=>{let t=new s.z;return t.messageId=e.messageId,t.conversationId=e.conversationId,t.key=e.key,t.userId=e.userId,t.secUid=e.secUid,t.createTime=new Date(e.createTime),t.idempotentId=e.idempotentId,t.value=e.value,t.version=i.fromValue(e.version),t.status=e.status,t})}static toStore(e){var t,n,i;let r=new o;for(let t of(r.clientId=e.clientId,r.content=e.content,r.conversationId=e.conversationId,r.conversationShortId=e.conversationShortId,r.conversationType=e.conversationBizType,r.createdAt=e.createdAt,r.ext=e.ext,r.indexInConversation=e.indexInConversation.toString(),r.indexInConversationV2=e.indexInConversationV2.toString(),r.orderInConversation=e.orderInConversation.toString(),r.secSender=e.secSender,r.sender=e.sender,r.serverId=e.serverId,r.serverStatus=e.serverStatus,r.type=e.type,r.version=e.version.toString(),r.property={},r.isOffline=e.isOffline,r.source=e.source,"number"==typeof e.flightStatus&&(r.flightStatus=e.flightStatus),Object.keys(e.property)))r.property[t]=o.convertPropertyStore(e.property[t]);return"number"==typeof e.flightStatus&&(r.flightStatus=e.flightStatus),e.referenceInfo&&(r.referenceInfo={referenceMessageId:e.referenceInfo.referenced_message_id.toString(),hint:e.referenceInfo.hint,refMessageType:e.referenceInfo.ref_message_type.toString(),referenceMessageStatus:e.referenceInfo.referenced_message_status,rootMessageId:null===(t=e.referenceInfo.root_message_id)||void 0===t?void 0:t.toString(),rootMessageConvIndex:null===(n=e.referenceInfo.root_message_conv_index)||void 0===n?void 0:n.toString(),ext:null!==(i=e.referenceInfo.ext)&&void 0!==i?i:{}}),r}static fromStore(e,t){var n,s;let a=new r.v(e);for(let e of(a.clientId=t.clientId,a.content=t.content,a.conversationId=t.conversationId,a.conversationShortId=t.conversationShortId,a.conversationBizType=t.conversationType,a.createdAt=new Date(t.createdAt),a.ext=t.ext,a.indexInConversation=i.fromValue(t.indexInConversation),a.indexInConversationV2=i.fromValue(null!==(n=t.indexInConversationV2)&&void 0!==n?n:"0"),a.orderInConversation=i.fromValue(t.orderInConversation),a.secSender=t.secSender,a.sender=t.sender,a.serverId=t.serverId,a.serverStatus=t.serverStatus,a.type=t.type,a.version=i.fromValue(t.version),a.isOffline=t.isOffline,a.source=t.source,"number"==typeof a.flightStatus&&(t.flightStatus=a.flightStatus),a.property={},Object.keys(t.property)))a.property[e]=o.fromPropertyStore(t.property[e]);return"number"==typeof t.flightStatus&&(a.flightStatus=t.flightStatus),t.referenceInfo&&(a.referenceInfo={referenced_message_id:i.fromValue(t.referenceInfo.referenceMessageId),hint:t.referenceInfo.hint,ref_message_type:i.fromValue(t.referenceInfo.refMessageType),referenced_message_status:t.referenceInfo.referenceMessageStatus,root_message_id:t.referenceInfo.rootMessageId?i.fromValue(t.referenceInfo.rootMessageId):void 0,root_message_conv_index:t.referenceInfo.rootMessageConvIndex?i.fromValue(t.referenceInfo.rootMessageConvIndex):void 0,ext:null!==(s=t.referenceInfo.ext)&&void 0!==s?s:void 0}),a}}},590381:function(e,t,n){"use strict";n.d(t,{s:function(){return c}});var i=n(101380);n(193533);var r=n(621631),s=n(651889),o=n(592242),a=n(835649);n(358115),n(689845);var d=n(190638);class c extends d.f{process(e){return(0,i.mG)(this,void 0,void 0,function*(){if(e.data.type===r.m.MessageType.MESSAGE_TYPE_MODE_CHANGE){let t=this.resolve(a.Uk.ConversationManager).getRaw(e.data.conversationId);if(!t)return o.Y.ctxDebug(this.ctx,`conversation ${e.data.conversationId} not exist, ignore upgrade`),e;if(!t.isStrangerConversation)return o.Y.ctxDebug(this.ctx,`conversation ${e.data.conversationId} not stranger, ignore upgrade`),e;this.resolve(a.Uk.ConversationManager).delete(e.data.conversationId);let n=yield this.resolve(a.Uk.ConversationManager).getWithOnline(e.data.conversationId,e.data.conversationShortId,e.data.conversationType);if(!n)return o.Y.ctxDebug(this.ctx,`conversation ${e.data.conversationId} not exist, ignore upgrade`),e;this.resolve(a.Uk.ConversationManager).markRead(n.id,n.lastMessageIndex,n.badgeCount,[]),o.Y.ctxDebug(this.ctx,"stranger upgrade,",n),this.resolve(a.Uk.EventBus).emit(s.c5.StrangerUpgrade,this,n),e.needContinue=!1}return e})}}},277928:function(e,t,n){"use strict";n.d(t,{A:function(){return V}});var i=n("101380"),r=n("193533"),s=n("621631"),o=n("45064"),a=n("651889"),d=n("557418"),c=n("400201"),u=n("592242"),l=n("597552"),h=n("792243"),v=n("689845"),g=n.n(v),f=n("359756"),p=n("377319"),m=n("491822"),_=n("473614"),y=n("501297"),I=n("835649");class x extends I.mA{constructor(e){super(e),this.wsLastReceiveTime=0,this.reqMap=new Map,this.manuallyClosed=!1;let{webSocketLevel:t,heartbeatInterval:n,maxHeartbeatEmptyWindow:i}=this.ctx.option;this.heartbeatInterval=null!=n?n:a.HF.heartbeatInterval,this.maxEmptyWindow=null!=i?i:a.HF.maxHeartbeatEmptyWindow,this.net=this.ctx.resolve(I.Uk.CoreInstance).net,this.http=this.ctx.resolve(I.Uk.CoreInstance).http,t!==a._.Disable&&(this.ws=this.ctx.resolve(I.Uk.CoreInstance).websocket,this.prepareWs()),this.onMessage=new f.x(e)}inSignCommandList(e){return[s.m.IMCMD.SEND_MESSAGE,s.m.IMCMD.CREATE_CONVERSATION_V2,s.m.IMCMD.CALL_VOIP,s.m.IMCMD.ADD_CONVERSATION_PARTICIPANTS,s.m.IMCMD.REMOVE_CONVERSATION_PARTICIPANTS,s.m.IMCMD.UPDATE_CONVERSATION_PARTICIPANT,s.m.IMCMD.SET_CONVERSATION_SETTING_INFO,s.m.IMCMD.SET_CONVERSATION_CORE_INFO,s.m.IMCMD.UPSERT_CONVERSATION_CORE_EXT_INFO,s.m.IMCMD.UPSERT_CONVERSATION_SETTING_EXT_INFO,s.m.IMCMD.DISSOLVE_CONVERSATION,s.m.IMCMD.MARK_MESSAGE,s.m.IMCMD.BATCH_UNMARK_MESSAGE,s.m.IMCMD.SET_MESSAGE_PROPERTY,s.m.IMCMD.MODIFY_MESSAGE_EXT].includes(e)}frontierSign(e){let t=g()(e);if("undefined"!=typeof window&&void 0!==window.byted_acrawler&&"function"==typeof window.byted_acrawler.frontierSign){let e=window.byted_acrawler.frontierSign({"X-MS-STUB":t});return null!=e?e:{}}return{}}sendByBeacon(e){return(0,i.mG)(this,void 0,void 0,function*(){return e.method="beacon",u.Y.ctxDebug(this.ctx,`Beacon Request SeqId -> ${e.seqId}`,e.request),this.http.sendBeacon(e.url,e.request),e})}sendByHttp(e){return(0,i.mG)(this,void 0,void 0,function*(){e.method="http",u.Y.ctxDebug(this.ctx,`Http Request SeqId -> ${e.seqId}`,e.request);try{this.reqMap.set(e.seqId,e);let t=yield this.http.sendRequest(e.url,e.request);return e.response=t,0!==t.status_code?u.Y.ctxError(this.ctx,`Http Response SeqId -> ${e.seqId}`,e.response):u.Y.ctxDebug(this.ctx,`Http Response SeqId -> ${e.seqId}`,e.response),e}catch(e){throw new d.G({ctx:this.ctx,msg:"network error",type:a.NI.NetworkError,innerError:e,allowRetry:!0,sender:this,ignoreEvent:!0})}finally{this.reqMap.delete(e.seqId)}})}sendByWs(e){return(0,i.mG)(this,void 0,void 0,function*(){e.method="ws";let t=(0,m.qC)(e.request),n=Object.assign(Object.assign({},this.inSignCommandList(e.cmd)?this.frontierSign(t):{}),this.ctx.option.headers),i=s.m.Frame.create({service:this.ctx.option.service,method:this.ctx.option.method,headers:Object.entries(n).map(([e,t])=>({key:e,value:t})),seqid:r.fromNumber(e.seqId),logid:r.fromNumber(Date.now()),payload_type:"pb",payload:t});e.frame=i;try{this.reqMap.set(e.seqId,e),u.Y.ctxDebug(this.ctx,`WS Request SeqId -> ${e.seqId}`,e.request),this.ws.send((0,m.mf)(i))}catch(t){throw this.reqMap.delete(e.seqId),new d.G({ctx:this.ctx,msg:"network error",type:a.NI.NetworkError,innerError:t,allowRetry:!0,sender:this})}return new Promise((t,n)=>{e.wsPromise={resolve:t,reject:n}})})}receiveRaw(e){var t,n,i;if(this.resetWsHeartbeat(),"hi"!==e.toString())try{let r=(0,m.BX)(this.ctx,e);if(r.service!==this.ctx.option.service&&!this.ctx.option.acceptIncorrectFrame){u.Y.ctxDebug(this.ctx,`WS Response dropped, local serviceId=${this.ctx.option.service}, message=${r.service}`),this.resolve(I.Uk.EventBus).emit(a.c5.WebSocketReceiveUnexpectedFrame,this,r);return}let{payload:o}=r;if(null==o){u.Y.ctxWarn(this.ctx,"payload undefined or null");return}let d=r.payload_encoding;if("__lz4"===d){let e=new Uint8Array(10*o.length),t=0;if(((t=(0,p.t)(o,e))<0||t>e.length||t<o.length)&&(u.Y.ctxDebug(this.ctx,"WS response with lz4 compress, but first time decompressed failed, try second time"),e=new Uint8Array(1024e3),(t=(0,p.t)(o,e))<0||t>e.length||t<o.length)){u.Y.ctxWarn(this.ctx,"WS response with lz4 compress, try second time fail.");return}o=e.slice(0,t)}try{let e=(0,m.vB)(this.ctx,o),a=s.m.Response.create(e);if(!this.resolve(I.Uk.InboxType).isValidInbox(a.inbox_type)&&a.sequence_id.eq(0)){u.Y.ctxWarn(this.ctx,`WS Push dropped, local inboxType=${this.ctx.option.inboxType}, message=${a.inbox_type}`,"resp:",a);return}let d=a.sequence_id.toNumber(),c=this.reqMap.get(d);c?(0!==a.status_code?u.Y.ctxError(this.ctx,`WS Response SeqId -> ${a.sequence_id}`,a):u.Y.ctxDebug(this.ctx,`WS Response SeqId -> ${a.sequence_id}`,a),c.response=a,c.wsPromise.resolve(c),this.reqMap.delete(d)):a.sequence_id.eq(0)?(u.Y.ctxDebug(this.ctx,"WS Push",null===(i=null===(n=null===(t=a.body)||void 0===t?void 0:t.has_new_message_notify)||void 0===n?void 0:n.message)||void 0===i?void 0:i.message_type,a),(c=new y.F(this.ctx,a.cmd)).frame=r,c.response=a,c.seqId=a.sequence_id.toNumber(),this.receive(c)):u.Y.ctxWarn(this.ctx,"WS Response dropped, no handler",a)}catch(e){u.Y.ctxWarn(this.ctx,"WS Response dropped, IM Response deserialize fail, hex dump:",e,"frame:",r)}}catch(e){u.Y.ctxWarn(this.ctx,"WS Response dropped, Frame deserialize fail, hex dump: ",e)}}send(e,t){var n,r,o,c,l,h,v,g,f,p;return(0,i.mG)(this,void 0,void 0,function*(){let m;if(t.useBeacon)return yield this.sendByBeacon(e),e.response=s.m.Response.create({}),e;let y=null!==(n=t.maxWsRetryTimes)&&void 0!==n?n:3,x=0===y?null!==(r=t.maxHttpRetryTimes)&&void 0!==r?r:3:(null!==(o=t.maxHttpRetryTimes)&&void 0!==o?o:null===(c=this.ws)||void 0===c?void 0:c.isOpen())?1:3;0===x&&(x=1),_.u.performanceNow()-this.wsLastReceiveTime-1.5*this.heartbeatInterval>this.maxEmptyWindow&&(null===(l=this.ws)||void 0===l?void 0:l.isOpen())&&(y=0,x=null!==(h=t.maxHttpRetryTimes)&&void 0!==h?h:3,u.Y.ctxWarn(this.ctx,"ws idle too long, fallback to http"));let b=new Date().getTime(),C=0,M=0,S=()=>{let t=!1,n=new Promise((n,i)=>{setTimeout(()=>{!t&&(this.reqMap.delete(e.seqId),i(new d.G({ctx:this.ctx,msg:"request timeout",type:a.NI.NetworkError,args:{cmd:e.cmd,seqId:e.seqId,requestDate:b,ctxId:this.ctx.id},allowRetry:!0,ignoreEvent:!0,sender:this})))},this.ctx.option.timeout)});return Promise.race([n,(0,i.mG)(this,void 0,void 0,function*(){var n;let i;let r=!1;if(C<y&&(null===(n=this.ws)||void 0===n?void 0:n.isOpen())&&(r=!0),0!==y&&C>=y&&0===M&&void 0!==this.ws&&(u.Y.ctxWarn(this.ctx,`Request ${e.seqId} fallback to http (wsRetryTimes)`),r=!1),M>=x)throw new d.G({ctx:this.ctx,msg:"http retry times limit exceeded",type:a.NI.NetworkError,sender:this,args:{cmd:e.cmd,seqId:e.seqId}});r?(C++,i=this.sendByWs(e)):(M++,i=this.sendByHttp(e));try{let n=yield i;t=!0,this.reqMap.delete(e.seqId);let{request:r,response:s}=n;if(this.resolve(I.Uk.Monitor).emitNetwork(r,s),s.status_code===a.NI.ResourceExhausted)throw new d.G({ctx:this.ctx,msg:"demotion enabled",type:a.NI.ResourceExhausted,allowRetry:!1,sender:this,logid:null==s?void 0:s.log_id});if(s.status_code===a.NI.InternalError&&(s.error_desc.includes("i/o timeout")||s.error_desc.includes("rpc timeout")||s.error_desc.includes("RPC timeout"))||s.error_desc.includes("connection timeout")||s.error_desc.includes("request timeout"))throw new d.G({ctx:this.ctx,msg:"request timeout",type:a.NI.NetworkError,allowRetry:!0,ignoreEvent:!0,sender:this,logid:null==s?void 0:s.log_id});return n.retryTimes=C+M,n}catch(e){if(e.type)throw e;throw new d.G({ctx:this.ctx,msg:"request error",type:a.NI.NetworkError,allowRetry:e.allowRetry,innerError:e,sender:this})}finally{this.reqMap.delete(e.seqId)}})])};for(;;){if(e.retryTimes++,e.retryTimes>=10){e.error=new d.G({ctx:this.ctx,msg:"too much retry",type:a.NI.NetworkError,sender:this});break}try{if(e.startTime=Date.now(),m=yield S(),e.endTime=Date.now(),"function"==typeof(null===(g=null===(v=null==m?void 0:m.response)||void 0===v?void 0:v.server_execution_end_time)||void 0===g?void 0:g.toNumber)&&"function"==typeof(null===(p=null===(f=null==m?void 0:m.response)||void 0===f?void 0:f.request_arrived_time)||void 0===p?void 0:p.toNumber)&&_.u.putTimeDelta(e.startTime,e.endTime,m.response.server_execution_end_time.toNumber(),m.response.request_arrived_time.toNumber()),void 0!==m)break}catch(t){if(e.error=t,(null==t?void 0:t.allowRetry)===!0){let n=500+100*e.retryTimes+100*Math.random();n>2e3&&(n=2e3),u.Y.ctxDebug(this.ctx,`req ${e.seqId} failed, retrying @ attempt ${e.retryTimes}, inner err:`,t),yield new Promise(e=>setTimeout(e,n));continue}break}}if(void 0===m)throw void 0===e.error&&(e.error=new d.G({ctx:this.ctx,msg:"unknown error",type:a.NI.NetworkError,sender:this})),e.error;return m})}get isWsOnline(){var e;return(null===(e=this.ws)||void 0===e?!!void 0:!!e.isOpen())&&_.u.performanceNow()-this.wsLastReceiveTime-1.5*this.heartbeatInterval<=this.maxEmptyWindow}sendByHttpTo(e,t,n){return(0,i.mG)(this,void 0,void 0,function*(){return"undefined"!=typeof fetch?(yield fetch(e)).arrayBuffer():this.http.send(e,t,n)})}receive(e){this.resolve(I.Uk.Monitor).emitNetwork(null,e.response),this.onMessage.next(e.response,this)}onWsClose(){return(0,i.mG)(this,void 0,void 0,function*(){u.Y.ctxDebug(this.ctx,"ws closed"),this.resolve(I.Uk.EventBus).emit(a.c5.WebSocketDisconnected,this,this.ws)})}prepareWs(){if(this.ctx.option.webSocketLevel!==a._.Disable)this.ws.onMessage.subscribe(e=>this.receiveRaw(e)),this.ws.onClose.subscribe(()=>this.onWsClose()),this.ws.onError.subscribe(()=>this.onWsClose()),this.ws.onOpen.subscribe(()=>{u.Y.ctxDebug(this.ctx,"ws connected"),this.resolve(I.Uk.EventBus).emit(a.c5.WebSocketConnected,this,this.ws),this.manuallyClosed=!1}),this.wsCheckTicker=this.ctx.resolve(I.Uk.CoreInstance).createTicker(this.ctx,this.heartbeatInterval),this.wsCheckTicker.onTick.subscribe(()=>{var e,t,n,i,r;let s=_.u.performanceNow()-this.wsLastReceiveTime+this.heartbeatInterval/1.5;(null===(e=this.ws)||void 0===e?void 0:e.isOpen())?s>this.maxEmptyWindow?(u.Y.ctxDebug(this.ctx,"not receive any packet in window, ws close connection"),this.resolve(I.Uk.Monitor).emitMetrics(_.U.WebSocketConnectNoHeartbeat,{count:1},{url:null!==(r=null===(i=this.ws)||void 0===i?void 0:i.url)&&void 0!==r?r:"unknown"}),this.connectWs(!0)):s>this.heartbeatInterval&&this.sendWsHeartbeat():(u.Y.ctxDebug(this.ctx,"ws try connect if closed"),this.resolve(I.Uk.Monitor).emitMetrics(_.U.WebSocketConnectAfterClose,{count:1},{url:null!==(n=null===(t=this.ws)||void 0===t?void 0:t.url)&&void 0!==n?n:"unknown"}),this.connectWs(!0))})}closeWs(e){var t,n;if(this.ctx.option.webSocketLevel!==a._.Disable)null===(t=this.ws)||void 0===t||t.close(),this.manuallyClosed=!e,this.manuallyClosed&&(null===(n=this.wsCheckTicker)||void 0===n||n.stop())}connectWs(e){var t,n,r;return(0,i.mG)(this,void 0,void 0,function*(){if(this.ctx.option.webSocketLevel===a._.Disable)return;if(this.manuallyClosed&&e){u.Y.ctxDebug(this.ctx,"ignore connect since manually closed");return}this.closeWs(!0);let i=_.u.performanceNow();try{yield this.ws.performOpen(),this.resolve(I.Uk.Monitor).emitMetrics(_.U.WsConnect,{ws_cost:Math.round(_.u.performanceNow()-i)},{error_code:"0",url:null!==(t=this.ws.option.frontierUrl)&&void 0!==t?t:"unknown"}),this.resetWsHeartbeat(),null===(n=this.wsCheckTicker)||void 0===n||n.start()}catch(e){this.resolve(I.Uk.Monitor).emitMetrics(_.U.WsConnect,{ws_cost:Math.round(_.u.performanceNow()-i)},{error_code:"1",url:null!==(r=this.ws.option.frontierUrl)&&void 0!==r?r:"unknown"})}})}sendWsHeartbeat(){var e;(null===(e=this.ws)||void 0===e?void 0:e.isOpen())?this.ws.send("hi"):u.Y.ctxWarn(this.ctx,"ws not connect but try to send heartbeat")}resetWsHeartbeat(){this.wsLastReceiveTime=_.u.performanceNow()}}var b=n("10672"),C=n("91113"),M=n("832141"),S=n("746705"),k=n("124125"),E=n("812026");class T extends I.mA{constructor(e){super(e),this.refreshBuffer=[],this.refreshDebounce=(0,E.Ds)(()=>{this.triggerRefresh()},1e3,!0),this.conversations=new Map}applyLocal(e){e.forEach(e=>{this.conversations.set(e.id,e)})}clearAll(){this.conversations.clear()}getWithCreateLocal(e,t,n,i){let r=this.getRaw(e);if(!r){let o=new l.r(this.ctx);o.coreInfo=new M._(o),o.settingInfo=new S.H(o),o.id=e,o.shortId=t,o.type=n,o.isOffline=!0,r=o,void 0!==i?o.coreInfo.inboxType=i:void 0===i&&n===s.m.ConversationType.ONE_TO_ONE_CHAT&&4===e.split(":").length&&(o.coreInfo.inboxType=Number.parseInt(e.split(":")[0],10)),u.Y.ctxDebug(this.ctx,"create local conv:",o),this.upsert(r)}return r}upsert(e){var t;if(void 0===e)throw new d.G({ctx:this.ctx,msg:"upsert undefined conv",type:a.NI.InvalidParam,sender:this});if(!this.resolve(I.Uk.InboxType).isValidInbox(e.inboxType))throw new d.G({ctx:this.ctx,msg:`invalid inbox: ${e.inboxType}`,type:a.NI.InvalidParam,sender:this});let n=this.conversations.get(e.id);if(n&&e.isOffline&&(u.Y.ctxDebug(this.ctx,`local exist, try to use offline upsert, ignore, short id: ${n.shortId} with offline:${e.shortId}`),!n.isOffline))return u.Y.ctxDebug(this.ctx,"local is online, ignore update"),n;if(n){u.Y.ctxDebug(this.ctx,`merge conversation local=${n.version.toString()}:`,n,`new=${e.version.toString()}:`,e);let t=n.coreInfo||new M._(n),i=n.settingInfo||new S.H(n);(n=Object.assign(n,e)).coreInfo=t.mergeCore(e.coreInfo),n.settingInfo=i.mergeSetting(e.settingInfo),n.forceRefreshUnreadCount()}return this.conversations.set(e.id,null!=n?n:e),null===(t=this.resolve(I.Uk.DbProxy))||void 0===t||t.upsertConversation(null!=n?n:e),this.ctx.initResult===a.rb.Succeeded&&(this.resolve(I.Uk.EventBus).emit(a.c5.ConversationUpsert,this,null!=n?n:e),this.resolve(I.Uk.EventBus).emitEmpty(a.c5.ConversationChange,this)),e}refreshLocalAsync(){return(0,i.mG)(this,void 0,void 0,function*(){let e=this.getConversationArray().filter(e=>e.isOffline);if(0!==e.length)return this.refreshAsync(e)})}refreshLocal(){let e=Array.from(this.conversations.values()).filter(T.conversationFilter).filter(e=>e.isOffline);if(0!==e.length)this.refresh(e)}triggerRefresh(){if(0===this.refreshBuffer.length)return;u.Y.ctxDebug(this.ctx,"clear refresh buffer:",this.refreshBuffer);let e=[...this.refreshBuffer];this.refreshBuffer=[],this.refreshAsync(e)}refresh(e){var t;let n=(0,k.sS)(e),i=[];if(0===this.refreshBuffer.length)i.push(...n);else{let e={};this.refreshBuffer.forEach(t=>e[t.id]=!0),n.forEach(t=>{!e[t.id]&&i.push(t)})}i.length>0&&this.refreshBuffer.push(...i);let r=null!==(t=this.ctx.option.conversationRefreshCount)&&void 0!==t?t:a.HF.conversationRefreshCount;this.refreshBuffer.length>=r?this.triggerRefresh():this.refreshDebounce()}refreshAsync(e){var t,n,s;return(0,i.mG)(this,void 0,void 0,function*(){let i=null!==(t=(0,k.sS)(e))&&void 0!==t?t:this.refreshBuffer;if(0===i.length)return[];u.Y.ctxDebug(this.ctx,"refresh conv: ",i);let o=[],d=(0,k.vM)(i,e=>e.inboxType.toString());for(let e of Object.keys(d))for(let t of(0,k.F3)(d[e],5))try{let i=yield this.resolve(I.Uk.CoreApi).GetConversationInfoListV2({conversations:t.map(e=>({conversationId:e.id,conversationShortId:r.fromString(e.shortId),conversationType:e.type})),inboxType:Number.parseInt(e,10)}),s=(null===(n=null==i?void 0:i.body)||void 0===n?void 0:n.get_conversation_info_list_v2_body).conversation_info_list;t.forEach(e=>{0===s.filter(t=>t.conversation_id===e.id).length&&(u.Y.ctxDebug(this.ctx,"delete local conv, may not exist online: ",e),this.delete(e.id))}),s.forEach(e=>{let t=this.upsert(l.r.fromServerConversation(this.ctx,e,null==i?void 0:i.log_id));o.push(t)})}catch(e){e&&(null==e?void 0:e.type)===a.NI.InternalError&&(null===(s=null==e?void 0:e.message)||void 0===s?void 0:s.includes("request.MGet empty"))?t.forEach(e=>{u.Y.ctxDebug(this.ctx,"delete local conv, may not exist online: ",e),this.delete(e.id)}):u.Y.ctxError(this.ctx,"unknown refresh error:",e)}return o})}get(e){let t=this.getRaw(e);return(!t&&(t=this.getWithShortIdRaw(e)),t)?t:(u.Y.ctxWarn(this.ctx,"conversation not exist  in local conversationId:",e),null)}getWithShortIdRaw(e){for(let t of this.conversations.values())if(t.shortId===e)return t}getWithOnline(e,t,n){return(0,i.mG)(this,void 0,void 0,function*(){let i=this.getRaw(e);if(!i||i.isOffline){if(t&&n)i=this.getWithCreateLocal(e,t,n);else throw new d.G({ctx:this.ctx,type:a.NI.InvalidParam,msg:"no shortId and type provided",sender:this})}return yield this.refreshAsync(i),this.get(e)})}getRaw(e){return this.conversations.get(e)}getConversationArray(e=T.conversationFilter){return Array.from(this.conversations.values()).filter(e).map(e=>({conv:e,rankScore:e.rankScore})).sort(T.conversationComparator).map(e=>e.conv)}withConversation(e){return t=>{let n=this.get(e);if(!!n)return t(n)}}delete(e,t=!1){var n;let i=this.getRaw(e);if(!!i)!t&&this.getContext().resolve(I.Uk.MessageManager).clearConversation(e),this.conversations.delete(e),null===(n=this.resolve(I.Uk.DbProxy))||void 0===n||n.deleteConversation(i),this.resolve(I.Uk.EventBus).emitEmpty(a.c5.ConversationChange,this),this.resolve(I.Uk.EventBus).emit(a.c5.ConversationDelete,this,i)}markRead(e,t,n,i){let r;try{r=this.get(e)}catch(e){}if(!!r)return r.settingInfo.readIndex=t,n&&(r.settingInfo.readBadgeCount=n),(null==i?void 0:i.length)&&r.settingInfo.mergeMuteReadBadgeCountInfos(i),this.upsert(r)}join(e){var t;let n=this.get(e);if(!!n)n.isMember=!0,null===(t=this.resolve(I.Uk.DbProxy))||void 0===t||t.upsertConversation(n),this.resolve(I.Uk.EventBus).emitEmpty(a.c5.ConversationChange,this),this.resolve(I.Uk.EventBus).emit(a.c5.ConversationJoin,this,n)}leave(e){var t;let n=this.get(e);if(!!n)n.isMember=!1,null===(t=this.resolve(I.Uk.DbProxy))||void 0===t||t.upsertConversation(n),this.resolve(I.Uk.EventBus).emitEmpty(a.c5.ConversationChange,this),this.resolve(I.Uk.EventBus).emit(a.c5.ConversationLeave,this,n)}refreshTicket(e){return(0,i.mG)(this,void 0,void 0,function*(){if(!this.get(e))return})}static conversationFilter(e){return 0===e.mode&&e.isMember}dispose(){this.clearAll()}}T.conversationComparator=(e,t)=>t.rankScore-e.rankScore;var w=n("104524"),R=n("254378"),U=n("175316"),O=n("198721"),A=n("967027"),N=n("111267"),B=n("454333");class D{constructor(e,t){this.disposed=!1,this.plugins=[],this.isProcessing=!1;let n=new I.jO;this.ctx=n,n.register(I.Uk.Monitor,_.u),n.register(I.Uk.CoreInstance,this),!e.headers&&(e.headers={}),!e.httpHeaders&&(e.httpHeaders={}),!e.extended&&(e.extended={}),e.boe?("string"==typeof(e=(0,b.KQ)(e)).boe&&(e.headers[a.HF.envKey]=e.boe,e.headers[a.HF.boeHeaderKey]="1",e.httpHeaders[a.HF.envKey]=e.boe,e.httpHeaders[a.HF.boeHeaderKey]="1"),"boolean"==typeof e.boe&&(e.headers[a.HF.boeHeaderKey]="1",e.httpHeaders[a.HF.boeHeaderKey]="1")):"string"==typeof(e=(0,b.fC)(e)).ppe?(e.headers[a.HF.envKey]=e.ppe,e.headers[a.HF.ppeHeaderKey]="1",e.httpHeaders[a.HF.envKey]=e.ppe,e.httpHeaders[a.HF.ppeHeaderKey]="1"):e.canary&&(e.headers[a.HF.envKey]="canary",e.httpHeaders[a.HF.envKey]="canary"),void 0===e.timeCalibration&&(e.timeCalibration=!0),this.initPlatformOptions(e),n.option=e,(0,b.RQ)(this.ctx,e),this.net=e.network(n),this.http=e.http(n),this.websocket=e.webSocket(n);let i=!1===this.ctx.option.pullInterval||void 0===this.ctx.option.pullInterval?3e4:this.ctx.option.pullInterval;if(u.Y.ctxDebug(this.ctx,"use ticker interval:",i),this.ticker=this.createTicker(this.ctx,i),n.register(I.Uk.AuthManager,A.E),n.register(I.Uk.ConversationManager,T),n.register(I.Uk.MessageManager,w.U),n.register(I.Uk.ParticipantManager,R.a),n.register(I.Uk.EventBus,c.N),n.register(I.Uk.NetworkManager,x),n.register(I.Uk.CoreApi,o.j),n.register(I.Uk.InboxType,U._),e.debug){let t="undefined"!=typeof window?window:e.injectContext,i=`__imsdk_context_${this.ctx.id.split("-")[0]}`;if("object"==typeof e.injectContext&&(t=e.injectContext,e.injectContext=!0),"string"==typeof e.injectContext&&(i=e.injectContext,e.injectContext=!0),void 0===e.injectContext&&(e.injectContext=!0),"boolean"==typeof e.injectContext&&e.injectContext)try{Object.defineProperty(t,i,{enumerable:!1,configurable:!0,get:()=>n})}catch(e){u.Y.ctxDebug(n,"inject ctx:",n,`with name: ${i} to`,t,"failed: ",e)}}if(Array.isArray(t)&&(t.forEach(e=>{let t=new e(n);t.install(),this.plugins.push(t)}),this.ctx.plugin=this.plugins),!this.ctx.resolve(I.Uk.HybridLink)){u.Y.ctxDebug(this.ctx,"Service HybridLink is not registered, load internal IMCloudHybridLinkPlugin");let e=new B.a(n);e.install(),this.plugins.push(e)}u.Y.ctxDebug(this.ctx,"loaded plugin:",this.plugins),e.boe?u.Y.ctxDebug(this.ctx,`using boe env: ${!0===e.boe?"default":e.boe}`):e.ppe&&u.Y.ctxDebug(this.ctx,`using ppe env: ${e.ppe}`),this.initEventHandler(),Object.seal&&(Object.seal(this),Object.seal(n))}getContext(){return this.ctx}resolve(e){return this.ctx.resolve(e)}get initResult(){return this.ctx.initResult}set initResult(e){this.ctx.initResult=e}get event(){return this.resolve(I.Uk.EventBus)}get api(){return this.resolve(I.Uk.CoreApi)}get network(){return this.resolve(I.Uk.NetworkManager)}get inboxType(){return this.resolve(I.Uk.InboxType)}get id(){return this.ctx.id}get option(){return this.ctx.option}init(e){var t,n,r,o,d,c,l,h,v,g,f;return(0,i.mG)(this,void 0,void 0,function*(){let{userId:i,enableServerConfig:p,authType:m,webSocketLevel:y}=this.ctx.option;if(m&&[s.m.AuthType.CERT_AUTH,s.m.AuthType.PASSPORT_CERT_AUTH].includes(m))try{null===(t=this.resolve(I.Uk.SecurityProxy))||void 0===t||t.init(),this.ctx.option.cert=yield null===(n=this.resolve(I.Uk.SecurityProxy))||void 0===n?void 0:n.getCert(),this.ctx.option.tsSign=yield null===(r=this.resolve(I.Uk.SecurityProxy))||void 0===r?void 0:r.getTsSign()}catch(e){u.Y.ctxWarn(this.ctx,"get cert and tsSign error")}let x=_.u.performanceNow();this.initResult=a.rb.Start;let b=null!==(d=yield null===(o=this.resolve(I.Uk.DbProxy))||void 0===o?void 0:o.init(i))&&void 0!==d&&d;b&&(this.initResult=a.rb.Succeeded);try{yield this.resolve(I.Uk.AuthManager).prepareToken()}catch(e){return this.initResult=a.rb.Error,u.Y.ctxError(this.ctx,"prepare token error:",e),this.resolve(I.Uk.Monitor).emitDuration(_.U.BizSdkInit+_.U.ErrorSuffix,x,Object.assign(Object.assign({use_db:null!==(c=b.toString())&&void 0!==c?c:"unknown"},this.resolve(I.Uk.HybridLink).getReportParams()),{reason:"token"})),this.initResult}if(p)try{yield this.initConfig()}catch(e){u.Y.ctxWarn(this.ctx,"init server config error:",e)}for(let t of this.inboxType.getInboxTypeArray())if(!(yield this.prepareHistoryForInbox({inboxType:t,convLimit:null==e?void 0:e.convLimit,msgLimit:null==e?void 0:e.msgLimit,mode:null==e?void 0:e.mode,convTotal:null==e?void 0:e.convTotal,tagIds:null==e?void 0:e.tagIds,userCustomTagIds:null==e?void 0:e.userCustomTagIds})))return this.initResult=a.rb.Error,u.Y.ctxError(this.ctx,"init history error for inbox",t),this.resolve(I.Uk.Monitor).emitDuration(_.U.BizSdkInit+_.U.ErrorSuffix,x,Object.assign(Object.assign({use_db:null!==(l=b.toString())&&void 0!==l?l:"unknown"},this.resolve(I.Uk.HybridLink).getReportParams(t)),{reason:"history"})),this.initResult;yield this.resolve(I.Uk.ConversationManager).refreshLocalAsync(),this.resolve(I.Uk.EventBus).emitEmpty(a.c5.ConversationChange,this);try{for(let e of this.plugins)yield e.init()}catch(e){return this.initResult=a.rb.Error,u.Y.ctxError(this.ctx,"init plugin error:",e),this.resolve(I.Uk.Monitor).emitDuration(_.U.BizSdkInit+_.U.ErrorSuffix,x,Object.assign(Object.assign({use_db:null!==(h=b.toString())&&void 0!==h?h:"unknown"},this.resolve(I.Uk.HybridLink).getReportParams()),{reason:"plugin"})),this.initResult}if(y!==a._.Disable)try{this.resolve(I.Uk.Monitor).emitCounter(_.U.WebSocketConnectFirst,1,{url:null!==(g=null===(v=this.network.ws)||void 0===v?void 0:v.url)&&void 0!==g?g:"unknown"}),yield this.network.connectWs(!0)}catch(e){u.Y.ctxWarn(this.ctx,"skip websocket, init open fail:",e)}return this.ticker.onTick.subscribe(()=>{this.tickerUpdate()}),this.ticker.restart(),this.initResult=a.rb.Succeeded,this.resolve(I.Uk.Monitor).emitDuration(_.U.BizSdkInit+_.U.SuccessSuffix,x,Object.assign({use_db:null!==(f=b.toString())&&void 0!==f?f:"unknown"},this.resolve(I.Uk.HybridLink).getReportParams())),this.resolve(I.Uk.EventBus).emit(a.c5.InitFinish,this,this.initResult),this.initResult})}getMessagesByUser(e){return(0,i.mG)(this,void 0,void 0,function*(){return this.resolve(I.Uk.HybridLink).getMessagesByUser(e)})}getMessagesByConversation(e){var t,n,o,d;return(0,i.mG)(this,void 0,void 0,function*(){let{cursor:i}=e,{direction:c}=e;i instanceof h.v&&(i=i.indexInConversation),void 0===i&&(i=e.conversation.firstMessageIndex,e.conversation.firstMessageIndex.gt(null!==(t=e.conversation.__internal_pullCursor)&&void 0!==t?t:r.ZERO)&&(i=e.conversation.__internal_pullCursor,u.Y.ctxDebug(this.ctx,`using internal cursor: ${i.toString()} < ${e.conversation.firstMessageIndex.toString()} for conversation:`,e.conversation)));let l=yield this.api.GetMessagesByConversation({conversationId:e.conversation.id,conversationShortId:r.fromString(e.conversation.shortId),conversationType:e.conversation.type,anchorIndex:r.fromValue(i),direction:c||s.m.MessageDirection.OLDER,limit:null!==(n=e.limit)&&void 0!==n?n:20,inboxType:e.conversation.inboxType});this.resolve(I.Uk.Monitor).emitMetrics(_.U.GetMessagesByConversation,{count:1},{log_id:l.log_id,from:"user",conversation_id:e.conversation.shortId,cursor:r.fromValue(i).toString()});let v=null===(o=l.body)||void 0===o?void 0:o.messages_in_conversation_body;e.conversation.__internal_pullCursor=null!==(d=v.next_cursor)&&void 0!==d?d:e.conversation.__internal_pullCursor;let{msgs:g}=yield this.resolve(I.Uk.MessageManager).processNewMessagesFromPull(v.messages,a.v$.LoadMore,l.log_id);return{messages:g,hasMore:null==v?void 0:v.has_more,cursor:null==v?void 0:v.next_cursor}})}markConversationRead(e){var t,n;return(0,i.mG)(this,void 0,void 0,function*(){let i,o,{readIndex:a,readIndexV2:d}=e,{conversation:c}=e;void 0===a?a=c.lastMessageIndex:a instanceof h.v&&(a=a.indexInConversation),void 0===d?d=c.lastMessageIndexV2:d instanceof h.v&&(d=d.indexInConversationV2);let u=r.fromValue(a),l=r.fromValue(d),v=c.readIndex;if(!e.force&&u.lt(v))return;let{newReadBadgeCount:g,newMuteReadBadgeCount:f}=this.calcBadgeCount(c,u,v),p=[{message_type:s.m.MuteMessageType.TYPE_PART_MUTE,read_badge_count:f}];if(this.resolve(I.Uk.ConversationManager).markRead(c.id,u,g,p),this.ctx.option.unreadCountReport){let r=this.getConversationList({filter:e=>e.inboxType===c.inboxType&&e.isMember&&0===e.mode}).reduce((e,t)=>e+t.unreadCount,0);o=null!==(t=e.totalUnreadCount)&&void 0!==t?t:r,i=null!==(n=e.convUnreadCount)&&void 0!==n?n:c.unreadCount}yield this.api.MarkConversationReadV3({conversationId:c.id,conversationShortId:r.fromString(c.shortId),conversationType:c.type,readIndex:u,readIndexV2:l.gt(0)?l:r.ONE,inboxType:c.inboxType,unreadCount:void 0!==i?r.fromValue(i):void 0,totalUnreadCount:void 0!==o?r.fromValue(o):void 0,readBadgeCount:g,muteReadBadgeCountInfos:p})})}calcBadgeCount(e,t,n){let i,r;return e.lastMessageIndex.eq(t)?(i=e.badgeCount,r=e.partMuteBadgeCount):(i=Math.min(e.badgeCount,e.settingInfo.readBadgeCount+e.getLocalMessageRangeList(n,t).length),r=Math.min(e.partMuteBadgeCount,e.settingInfo.partMuteReadBadgeCount+e.getLocalMessageRangeList(n,t).filter(t=>e.isMsgInWeakMuteWhiteList(t)).length)),{newReadBadgeCount:i,newMuteReadBadgeCount:r}}batchClearConversationRead(e){var t;return(0,i.mG)(this,void 0,void 0,function*(){let n=null!==(t=e.messageTypes)&&void 0!==t?t:[s.m.MuteMessageType.TYPE_PART_MUTE,0],i=e.conversations.map(e=>{let t=n.includes(s.m.MuteMessageType.TYPE_PART_MUTE),i=n.includes(0),o={muteReadBadgeCountInfos:t?[{message_type:s.m.MuteMessageType.TYPE_PART_MUTE,read_badge_count:e.partMuteBadgeCount}]:[{message_type:s.m.MuteMessageType.TYPE_PART_MUTE,read_badge_count:e.settingInfo.partMuteReadBadgeCount}],readBadgeCount:i?t?e.badgeCount:Math.max(e.badgeCount-e.unreadCountWithWhiteList,0):t?Math.min(e.settingInfo.readBadgeCount+e.unreadCountWithWhiteList,e.badgeCount):e.settingInfo.readBadgeCount},a=r.fromValue(e.settingInfo.readIndexV2);return Object.assign({conversationId:e.id,conversationShortId:r.fromString(e.shortId),conversationType:e.type,readIndex:r.fromValue(e.settingInfo.readIndex),readIndexV2:a.gt(0)?a:r.ONE,inboxType:e.inboxType,unreadCount:r.fromValue(0),totalUnreadCount:r.fromValue(0)},o)});yield this.api.BatchMarkConversationReadV3({batch:i})})}get noticeUnreadCount(){return this.getConversationList().filter(e=>e.pushStatus===a.Bs.Allow||e.pushStatus===a.Bs.Unknown).reduce((e,t)=>e+t.unreadCount,0)+this.getConversationList().filter(e=>e.pushStatus===a.Bs.PartAllow).reduce((e,t)=>e+t.unreadCountWithWhiteList,0)}get mutedUnreadCount(){return this.getConversationList().filter(e=>e.pushStatus===a.Bs.Disable).reduce((e,t)=>e+t.unreadCount,0)+this.getConversationList().filter(e=>e.pushStatus===a.Bs.PartAllow).reduce((e,t)=>e+Math.max(0,t.unreadCount-t.unreadCountWithWhiteList),0)}clearConversationMessages(e){let{conversationIds:t=[]}=e;t=t.length>0?t:this.getConversationList().map(e=>e.id),this.resolve(I.Uk.MessageManager).clearConversationMessages(t,e.limitMessage)}recallMessage(e){return(0,i.mG)(this,void 0,void 0,function*(){if(!e.message.serverId)throw new d.G({ctx:this.ctx,type:a.NI.MessageNotReady,msg:`message ${e.message} is not ready`,sender:this});let t=this.resolve(I.Uk.ConversationManager).get(e.message.conversationId);if(!t)return;let n=yield this.api.RecallMessage({conversationId:e.message.conversationId,conversationShortId:r.fromString(e.message.conversationShortId),conversationType:e.message.conversationType,serverId:r.fromString(e.message.serverId),inboxType:t.inboxType});this.resolve(I.Uk.MessageManager).markRecalled(e.message.conversationId,e.message.serverId,n.log_id)})}createConversation(e){var t,n,o,c,u;return(0,i.mG)(this,void 0,void 0,function*(){let i=_.u.performanceNow(),h=[],v={success:!1,payload:null};if(void 0===e.inboxType&&(e.inboxType=this.inboxType.getDefaultInbox()),!this.inboxType.isValidInbox(e.inboxType))throw new d.G({ctx:this.ctx,msg:"invalid inbox",type:a.NI.InvalidInboxType,sender:this});if(void 0===e.type&&(Array.isArray(e.participants)?e.participants.length<=1?e.type=s.m.ConversationType.ONE_TO_ONE_CHAT:e.type=s.m.ConversationType.GROUP_CHAT:e.type=s.m.ConversationType.ONE_TO_ONE_CHAT),(h=Array.isArray(e.participants)?-1===e.participants.indexOf(this.ctx.option.userId)?e.participants.concat(this.ctx.option.userId):e.participants:[e.participants,this.ctx.option.userId]).length>2&&e.type===s.m.ConversationType.ONE_TO_ONE_CHAT)return v.statusCode=a.NI.InvalidParam,v.statusMsg="one to one chat can only has 2 participants",v;void 0===e.persistent&&void 0!==e.idempotentId&&e.idempotentId.length>0&&(e.persistent=!0);try{let t=yield this.api.CreateConversationV2({type:e.type,participants:h.map(e=>r.fromValue(e)),persistent:e.persistent,idempotentId:e.idempotentId,name:e.name,avatarUrl:e.avatarUrl,desc:e.desc,bizExt:e.bizExt,inboxType:e.inboxType}),n=t.body.create_conversation_v2_body;if(v.checkCode=n.check_code,v.checkMsg=n.check_message,v.statusCode=n.status,v.statusMsg=n.extra_info,v.body=n,(null==n?void 0:n.status)===0){let e=l.r.fromServerConversation(this.ctx,null==n?void 0:n.conversation,t.log_id);this.resolve(I.Uk.ConversationManager).upsert(e),yield this.resolve(I.Uk.ConversationManager).refreshAsync(e);let i=this.resolve(I.Uk.ConversationManager).get(e.id);v.success=!0,v.payload=i,this.resolve(I.Uk.EventBus).emit(a.c5.ConversationCreate,this,i)}}catch(e){v.statusCode=null!==(t=e.type)&&void 0!==t?t:a.NI.NetworkError,v.innerError=e}return this.resolve(I.Uk.Monitor).emitMetrics(_.U.CreateConversation,{create_cost:Math.round(_.u.performanceNow()-i)},{type:null!==(o=null===(n=e.type)||void 0===n?void 0:n.toString())&&void 0!==o?o:"unknown",error_code:null!==(u=null===(c=v.statusCode)||void 0===c?void 0:c.toString())&&void 0!==u?u:"unknown"}),v})}getConversation(e){return this.resolve(I.Uk.ConversationManager).get(e.conversationId)}getConversationOnline(e){return(0,i.mG)(this,void 0,void 0,function*(){return this.resolve(I.Uk.ConversationManager).getWithOnline(e.conversationId,e.shortId,e.type)})}getConversationList(e={}){let{filter:t,tagIds:n,userCustomTagIds:i}=e,r=this.resolve(I.Uk.ConversationManager).getConversationArray(t);if(n||i){let e=Array.isArray(n)?n:[n].filter(Boolean),t=Array.isArray(i)?i:[i].filter(Boolean);if(e.length>0||t.length>0){let n=new Set(e),i=new Set(t);r=r.filter(e=>e.tagIds.find(e=>n.has(e))||e.userTagIds.find(e=>i.has(e)))}}return r}getConversationListOnline(e={}){return(0,i.mG)(this,void 0,void 0,function*(){return yield this.resolve(I.Uk.ConversationManager).refreshLocalAsync(),this.getConversationList(e)})}getConversationMessages(e){var t;let{conversation:n}=e;if(e.isCheckMsg)try{null===(t=this.resolve(I.Uk.DbProxy))||void 0===t||t.checkMessages(n)}catch(e){u.Y.ctxWarn(this.ctx,`check msgs error, conv id: ${n.id}`)}return!e.filter&&(e.filter=e=>e.visible),this.resolve(I.Uk.MessageManager).getList(n.id).filter(e.filter)}createMessage(e){var t;return(0,i.mG)(this,void 0,void 0,function*(){void 0===e.insert&&(e.insert=!0);let n=Object.assign({},e.ext),i=h.v.createClientMessage(this.ctx,{type:e.type,content:e.content,ext:n,id:null!==(t=e.clientId)&&void 0!==t?t:(0,C.k)(),conversationId:e.conversation.id,mentionedUsers:e.mentionedUsers||[],conversationShortId:e.conversation.shortId,conversationType:e.conversation.type,referenceMessage:e.referenceMessage,referenceHint:e.referenceHint});return i.flightStatus=a.b3.Created,i.sendFunc=this.__internal_sendMessageObject.bind(this),i.indexInConversation=e.conversation.lastMessageIndex.add(1),i.orderInConversation=e.conversation.lastMessageOrder.add(1),e.insert&&(yield this.resolve(I.Uk.MessageManager).processNewMessage(i,a.v$.Offline)),i})}sendMessage(e){var t,n,r,s;return(0,i.mG)(this,void 0,void 0,function*(){let{message:i}=e,o=Date.now(),d=yield i.sendFunc(i);this.resolve(I.Uk.EventBus).emit(a.c5.MessageSend,this,i);try{let e=Date.now(),a=this.resolve(I.Uk.ConversationManager).get(i.conversationId);if(!a)return;this.resolve(I.Uk.Monitor).emitMetrics(_.U.SendMessage,{con_member_count:a.participantCount-1,send_cost_time:e-o},{con_type:i.conversationType.toString(),conversation_id:i.conversationId,msg_uuid:i.serverId,msg_type:i.type.toString(),send_start_time:o.toString(),send_end_time:e.toString(),error_code:null!==(n=null===(t=d.statusCode)||void 0===t?void 0:t.toString())&&void 0!==n?n:"unknown",is_ws:(null===(r=this.network.ws)||void 0===r?void 0:r.isOpen())?"1":"0",logid:null!==(s=d.logid)&&void 0!==s?s:""})}catch(e){u.Y.ctxWarn(this.ctx,"Fail to report data after send message",e)}return d})}fetchConversation(e){return(0,i.mG)(this,void 0,void 0,function*(){let t=null;if(void 0!==e.shortId){let t=this.resolve(I.Uk.ConversationManager).getWithShortIdRaw(e.shortId);if(void 0!==t&&!t.isOffline)return t}if(void 0===e.inboxType&&(e.inboxType=this.inboxType.getDefaultInbox()),!this.inboxType.isValidInbox(e.inboxType))throw new d.G({ctx:this.ctx,msg:"invalid inbox",type:a.NI.InvalidInboxType,sender:this});if(void 0!==e.idempotentId&&void 0===e.participantId){let n=yield this.createConversation({type:s.m.ConversationType.GROUP_CHAT,participants:[],inboxType:e.inboxType,idempotentId:e.idempotentId});n.success&&null!==(t=n.payload)&&(yield this.getConversationOnline({conversationId:t.id,shortId:t.shortId,type:s.m.ConversationType.ONE_TO_ONE_CHAT}))}else if(void 0!==e.participantId){let n=yield this.createConversation({type:s.m.ConversationType.ONE_TO_ONE_CHAT,participants:e.participantId,inboxType:e.inboxType});n.success&&null!==(t=n.payload)&&(yield this.resolve(I.Uk.ConversationManager).refreshAsync(t))}else if(void 0!==e.shortId)t=yield this.getConversationOnline({conversationId:e.shortId,shortId:e.shortId,type:s.m.ConversationType.GROUP_CHAT});else throw new d.G({ctx:this.ctx,type:a.NI.InvalidParam,msg:"no valid param provided",reachServer:!1,sender:this});if(null!==t&&!t.isOffline)return yield this.getMessagesByConversation({conversation:t}),t;throw new d.G({ctx:this.ctx,type:a.NI.ConversationNotExist,msg:"fetch failed, conv is null or offline",reachServer:!1,sender:this})})}getMessageReadReceipt(e){if(!e.message.isFromMe||e.message.isOffline)return{finishedParticipants:[],expectedParticipants:[]};let t=this.resolve(I.Uk.ConversationManager).get(e.message.conversationId);if(!t)return;if(0===t.getParticipantList().length)return{finishedParticipants:[],expectedParticipants:[]};let n=e.message.__internal_cachedReadReceipt,i=!0;if(void 0!==n&&(0!==n.expectedParticipants.length&&n.expectedParticipants.length===n.finishedParticipants.length&&(i=!1),e.message.__internal_receiptClean&&(i=!1)),i){let n=[],i=[],r=t.getParticipantList();0!==r.length&&r.forEach(t=>{if(!t.minIndex.gt(e.message.indexInConversation))t.userId!==this.ctx.option.userId&&(i.push(t),(t.readOrder.gte(e.message.orderInConversation)||t.readIndex.gte(e.message.indexInConversation))&&n.push(t))}),e.message.__internal_cachedReadReceipt={finishedParticipants:n,expectedParticipants:i},e.message.__internal_receiptClean=!0}return e.message.__internal_cachedReadReceipt}updateConversationReadReceipt(e){return(0,i.mG)(this,void 0,void 0,function*(){let{conversation:t}=e,n=this.resolve(I.Uk.ParticipantManager).getRaw(t.id);if(!n.length){this.resolve(I.Uk.ParticipantManager).getParticipants(t);return}let i={},{readIndexs:s,minIndexs:o}=yield this.getParticipantsReadAndMinIndex({conversation:e.conversation,batchFetch:e.batchFetch});o.forEach(e=>{i[e.user_id.toString()]={minIndex:e.index,readIndex:e.index}}),s.forEach(e=>{void 0!==i[e.user_id.toString()]?i[e.user_id.toString()].readIndex=e.index:i[e.user_id.toString()]={readIndex:e.index,minIndex:r.ZERO}});let d=[];for(let e of Object.keys(i)){let s=i[e],o=n.find(t=>t.userId===e),a=o?{readIndex:o.readIndex,minIndex:o.minIndex}:{readIndex:r.ZERO,minIndex:r.ZERO},c=(0,N.BR)(a,s);d.push(...c),void 0!==o&&(o.readIndex.neq(s.readIndex)||o.readOrder.neq(s.readIndex)||o.minIndex.neq(s.minIndex))&&(o.readIndex=s.readIndex,o.readOrder=s.readIndex,o.minIndex=s.minIndex,this.resolve(I.Uk.ParticipantManager).upsert(t.id,o))}let c=(0,N.d1)(d),u=[];for(let e of c)u.push(...(0,N.NK)(t,{readIndex:e.minIndex},{readIndex:e.readIndex}));0!==u.length&&(u.forEach(e=>e.__internal_receiptClean=!1),this.resolve(I.Uk.EventBus).emit(a.c5.ReadReceiptChange,this,{conversation:t,messages:u}))})}dispose(){var e,t;this.resolve(I.Uk.EventBus).unsubscribeAll(),null===(e=this.ticker)||void 0===e||e.stop(),this.network.closeWs(),null===(t=this.network.ws)||void 0===t||t.dispose(),this.network.onMessage.unsubscribeAll(),this.plugins.forEach(e=>e.dispose()),this.plugins.length=0,this.resolve(I.Uk.ConversationManager).dispose(),this.resolve(I.Uk.MessageManager).dispose(),this.resolve(I.Uk.ParticipantManager).dispose(),this.ctx.option.monitor=void 0,this.ctx.option.aspectBefore=()=>(u.Y.ctxError(this.ctx,"do not invoke a disposed instance"),!1),this.disposed=!0,u.Y.ctxDebug(this.ctx,"sdk unloaded, do not invoke this instance")}prepareHistoryForInbox(e){return(0,i.mG)(this,void 0,void 0,function*(){return this.resolve(I.Uk.HybridLink).prepareHistoryForInbox(e)})}tickerUpdate(){return(0,i.mG)(this,void 0,void 0,function*(){if((yield this.network.net.getConnectionStatus())!==O.QK.Disconnected&&this.initResult===a.rb.Succeeded){if(this.ctx.option.pullInterval&&!this.isProcessing&&!(this.ctx.option.disablePullIntervalWhenWsIsOnline&&this.network.isWsOnline))for(let e of this.inboxType.getInboxTypeArray())try{yield this.getMessagesByUser({inboxType:e}),this.resolve(I.Uk.Monitor).emitMetrics(_.U.GetMessagesByTicker,{count:1},Object.assign({tick_timer:this.ticker.getTickTimer(),time:Math.round(Date.now()/1e3).toString(),inbox:e.toString()},this.resolve(I.Uk.HybridLink).getReportParams(e)))}catch(e){u.Y.ctxWarn(this.ctx,"ticker running in pull user err:",e)}for(let e of this.plugins)try{yield e.ticker()}catch(e){u.Y.ctxWarn(this.ctx,"ticker running in plugin err:",e)}}})}__internal_sendMessageObject(e){var t,n,o,d,c;return(0,i.mG)(this,void 0,void 0,function*(){let i={success:!1,payload:e};if(e.serverId)return i.statusCode=0,i;let u=this.resolve(I.Uk.ConversationManager).getRaw(e.conversationId);if(void 0===u)return i.statusCode=a.NI.ConversationNotExist,i.statusMsg=`conversation ${e.conversationId} not exist in local`,i;e.flightStatus=a.b3.Inflight,yield this.resolve(I.Uk.MessageManager).processNewMessage(e,a.v$.Offline);try{!u.ticket&&(yield this.resolve(I.Uk.ConversationManager).refreshTicket(u.id))}catch(n){return e.flightStatus=a.b3.Failed,i.statusCode=null!==(t=n.type)&&void 0!==t?t:a.NI.InvalidTicket,i.innerError=n,this.resolve(I.Uk.MessageManager).upsert(e),i}try{if(this.ctx.option.timeCalibration){let t=this.ctx.resolve(I.Uk.Monitor).avgDelta,n=Date.now();e.ext[a.v9.SendTime]=(n+t).toString()}let t=yield this.api.SendMessage({conversationType:u.type,conversationId:u.id,conversationShortId:r.fromString(u.shortId),content:e.content,ticket:u.ticket,ext:e.ext,messageType:e.type,clientId:e.clientId,mentionedUsers:e.mentionedUsers.map(e=>r.fromString(e)),inboxType:u.inboxType,referenceInfo:e.referenceInfo}),c=null===(n=t.body)||void 0===n?void 0:n.send_message_body;if(e.ext[a.v9.SendResponseCheckCode]=null!==(o=null==c?void 0:c.check_code.toString())&&void 0!==o?o:"",e.ext[a.v9.SendResponseCheckMessage]=null==c?void 0:c.check_message,e.ext[a.v9.SendResponseExtraInfo]=null==c?void 0:c.extra_info,e.ext[a.v9.SendResponseStatus]=null!==(d=null==c?void 0:c.status.toString())&&void 0!==d?d:"",this.ctx.option.debug&&(e.ext[a.v9.LocalLogId]=t.log_id),i.body=c,i.checkCode=c.check_code,i.checkMsg=c.check_message,i.statusCode=c.status,i.statusMsg=c.extra_info,i.logid=t.log_id,0===c.status){let t=c.server_message_id.toString();e.serverId=t,e.flightStatus=a.b3.Succeeded,e.isOffline=!1,yield this.resolve(I.Uk.MessageManager).processNewMessage(e,a.v$.Offline),i.success=!0}else e.flightStatus!==a.b3.Received?(e.flightStatus=a.b3.Rejected,c.status===s.m.SendMessageStatus.CHECK_MSG_NOT_PASS_BUT_SELF_VISIBLE&&(e.flightStatus=a.b3.SelfVisible)):i.success=!0}catch(t){e.flightStatus!==a.b3.Received&&(e.flightStatus=a.b3.Failed),i.innerError=t,i.statusCode=null!==(c=t.type)&&void 0!==c?c:a.NI.NetworkError}return this.resolve(I.Uk.MessageManager).upsert(e),i})}receivePacket(e){var t,n;return(0,i.mG)(this,void 0,void 0,function*(){if(this.initResult===a.rb.Succeeded){this.isProcessing=!0;try{if(e.cmd===s.m.IMCMD.NEW_MSG_NOTIFY){let i=null===(t=e.body)||void 0===t?void 0:t.has_new_message_notify;if(i){let t=this.resolve(I.Uk.ConversationManager).getRaw(i.conversation_id);yield this.clientAck({packet:e,inboxType:null!==(n=null==t?void 0:t.inboxType)&&void 0!==n?n:null==e?void 0:e.inbox_type,type:s.m.MsgReportType.MSG_RECEIVE_BY_WS}),this.handleBadgeCount(i,t)}for(let t of(yield this.resolve(I.Uk.HybridLink).receivePacket(e),this.resolve(I.Uk.ConversationManager).refreshLocal(),this.plugins))yield t.receivePacket(e)}}catch(e){throw e}finally{this.isProcessing=!1}}})}handleBadgeCount(e,t){try{t&&(e.badge_count&&(t.badgeCount=e.badge_count),Array.isArray(e.mute_badge_count_info)?t.mergeMuteBadgeCountInfos(e.mute_badge_count_info):e.mute_badge_count_info&&t.mergeMuteBadgeCountInfos([e.mute_badge_count_info]),this.resolve(I.Uk.ConversationManager).upsert(t))}catch(e){u.Y.ctxWarn(this.ctx,"handle badge count data error",e)}}clientAck({packet:e,inboxType:t,type:n}){var o,a,d,c,u,l;return(0,i.mG)(this,void 0,void 0,function*(){let i;if(!(!(null===(o=e.body)||void 0===o?void 0:o.has_new_message_notify)||!e.start_time_stamp||e.start_time_stamp.lte(0))){switch(yield this.network.net.getNetworkType()){case O.td.Cellular_2G:i=s.m.NetworkType.MOBILE_2G;break;case O.td.Cellular_3G:i=s.m.NetworkType.MOBILE_3G;break;case O.td.Cellular_4G:i=s.m.NetworkType.MOBILE_4G;break;case O.td.Cellular_5G:i=s.m.NetworkType.MOBILE_5G;break;case O.td.Wifi:i=s.m.NetworkType.WIFI;break;default:i=s.m.NetworkType.UNKNOWN}this.resolve(I.Uk.Monitor).emitMetrics(_.U.MessageAck,{count:1},{start_timestamp:e.start_time_stamp.toString(),cmd:e.cmd.toString(),network_type:i.toString(),logid:e.log_id,client_timestamp:new Date().getTime().toString(),server_message_id:null!==(c=null===(d=null===(a=e.body.has_new_message_notify.message)||void 0===a?void 0:a.server_message_id)||void 0===d?void 0:d.toString())&&void 0!==c?c:"0",report_net_type:n.toString()}),yield this.api.ClientAck({startTimeStamp:e.start_time_stamp,cmd:e.cmd,NetworkType:i,logid:e.log_id,clientTimeStamp:r.fromNumber(new Date().getTime()),serverId:null!==(l=null===(u=e.body.has_new_message_notify.message)||void 0===u?void 0:u.server_message_id)&&void 0!==l?l:r.ZERO,inboxType:t,type:n})}})}reportMessageDelayTime(e,t){var n,i,r,s,o,d,c,l,h;let v;let g=null===(n=e.create_time)||void 0===n?void 0:n.toNumber();if(!g)return;let f=this.ctx.option.timeCalibration?this.resolve(I.Uk.Monitor).avgDelta:0,p=Date.now(),m=Math.round(p+f-g);if(m<=0){u.Y.ctxDebug(this.ctx,`message reception delay is less than 0, serverId:${e.server_message_id}, current:${p}, createTime:${g}, timeDelta:${f}`);return}let y=Number(null===(i=e.ext)||void 0===i?void 0:i[a.v9.SendTime]);if(Number.isFinite(y)){let t=Math.round(p+f-y);t>0?v=t:u.Y.ctxDebug(this.ctx,`end_end_cost is less than 0, serverId:${e.server_message_id}, current:${p}, sendTimeFromClient:${y}, timeDelta:${f}`)}this.resolve(I.Uk.Monitor).emitMetrics(_.U.ReceiveMessage,Object.assign({receive_cost_time:m},v?{end_end_cost:v}:{}),Object.assign({con_type:null!==(s=null===(r=e.conversation_type)||void 0===r?void 0:r.toString())&&void 0!==s?s:"",conversation_id:null!==(o=e.conversation_id)&&void 0!==o?o:"",msg_uuid:null!==(c=null===(d=e.server_message_id)||void 0===d?void 0:d.toString())&&void 0!==c?c:"",receive_end_time:p.toString(),receive_start_time:g.toString(),time_delta:f.toString(),msg_type:null!==(h=null===(l=e.message_type)||void 0===l?void 0:l.toString())&&void 0!==h?h:"",error_code:"0",ntp_ready:this.ctx.option.timeCalibration?"1":"0",is_ws:"1",logid:t},this.resolve(I.Uk.HybridLink).getReportParams()))}processInitMessage(e,t){return(0,i.mG)(this,void 0,void 0,function*(){e&&(yield this.resolve(I.Uk.MessageManager).processNewMessagesFromPull(e,a.v$.Init,t))})}processInitConversation(e,t){e&&e.map(e=>l.r.fromServerConversation(this.ctx,e,t)).forEach(e=>this.resolve(I.Uk.ConversationManager).upsert(e))}dbClear(e){var t;return(0,i.mG)(this,void 0,void 0,function*(){yield null===(t=this.resolve(I.Uk.DbProxy))||void 0===t?void 0:t.clear(e)})}processPushMessage(e,t){return(0,i.mG)(this,void 0,void 0,function*(){let n=e.message;if(n){this.reportMessageDelayTime(n,t.log_id);let e=h.v.fromServerMessage(this.ctx,n,t.log_id);!e.ext&&(e.ext={}),this.ctx.option.debug&&(e.ext[a.v9.LocalLogId]=t.log_id),yield this.resolve(I.Uk.MessageManager).processNewMessage(e,a.v$.Online)}else u.Y.ctxWarn(this.ctx,"msg body is empty:",e)})}getParticipantsReadAndMinIndex(e){var t;return(0,i.mG)(this,void 0,void 0,function*(){if(e.batchFetch){let{conversation:n}=e,i=(yield this.api.BatchGetConversationParticipantsReadIndex({conversationId:[n.id],conversationShortId:[r.fromString(n.shortId)],min_index_required:!0})).conversationParticipantsReadIndex,s=(null===(t=null==i?void 0:i[0])||void 0===t?void 0:t.participantReadIndex)||[],o=[],a=[];return s.forEach(e=>{e.index&&o.push({user_id:r.fromString(e.user_id.toString()),index:r.fromString(e.index.toString())}),a.push({user_id:r.fromString(e.user_id.toString()),index:r.fromString(e.index_min.toString())})}),{readIndexs:o,minIndexs:a}}{let t=yield this.api.GetConversationParticipantsReadIndexV3({conversationId:e.conversation.id,conversationShortId:r.fromString(e.conversation.shortId),conversationType:e.conversation.type,inboxType:e.conversation.inboxType}),n=yield this.api.GetConversationParticipantsMinIndexV3({conversationId:e.conversation.id,conversationShortId:r.fromString(e.conversation.shortId),conversationType:e.conversation.type,inboxType:e.conversation.inboxType});return{readIndexs:(null==t?void 0:t.indexes)||[],minIndexs:n.indexes||[]}}})}initEventHandler(){this.network.onMessage.subscribe(e=>this.receivePacket(e)),this.resolve(I.Uk.EventBus).subscribe(a.c5.InitParticipant,e=>{this.updateConversationReadReceipt({conversation:e,batchFetch:!0})})}initConfig(){var e;return(0,i.mG)(this,void 0,void 0,function*(){try{let t=yield this.api.GetConfigs();null===(e=null==t?void 0:t.configs)||void 0===e||e.forEach(e=>{let t=e.conf_value;null!=t&&("true"===e.conf_value?t=!0:"false"===e.conf_value?t=!1:!isNaN(Number(e.conf_value))&&(t=Number(e.conf_value)),this.ctx.config.set(e.conf_name,t))}),u.Y.ctxDebug(this.ctx,"load server config",this.ctx.config)}catch(e){u.Y.ctxWarn(this.ctx,"fail to load server config")}})}updateHeaders(e){this.ctx.option.headers=Object.assign(Object.assign({},this.ctx.option.headers),e)}updateSendMessageHeaders(e){this.ctx.option.sendMessageHeader=Object.assign(Object.assign({},this.ctx.option.sendMessageHeader),e)}}var P=n("116645"),L=n("614261"),G=n("173471"),W=n("568161");let j=e=>new P.M(e),H=e=>new L.e(e),Y=e=>new G.y(e);class V extends D{initPlatformOptions(e){e.network=e.network||j,e.http=e.http||H,e.webSocket=e.webSocket||Y,e.sdkType=e.sdkType||"im-web-sdk"}createTicker(e,t,n){return new W.v(e,t,n)}}},380855:function(e,t,n){"use strict";n.d(t,{x:function(){return a}});var i=n(101380),r=n(84105),s=n(592242),o=n(621631);class a extends r.v{constructor(){super(...arguments),this.decrypt=null}install(){try{let e=window.useWebSecsdkApi("imDecrypt");if(e)this.decrypt=e,s.Y.ctxDebug(this.ctx,"content decrypt function:",e);else throw Error("No decrypt function")}catch(e){s.Y.ctxWarn(this.ctx,"get content decrypt function error:",e)}}sendPacket(e){return(0,i.mG)(this,void 0,void 0,function*(){return this.decrypt&&(e.pdes_version=1),e})}decryptMessage(e,t){var n;return(0,i.mG)(this,void 0,void 0,function*(){if(!!e&&!!this.decrypt)try{e.content&&(e.content=yield this.decrypt(e.content,t,"uid",this.ctx.option.userId))}catch(t){s.Y.ctxWarn(this.ctx,`decrypt msg ${null===(n=e.server_message_id)||void 0===n?void 0:n.toString()} error:`,t)}})}decryptMessages(e,t){return(0,i.mG)(this,void 0,void 0,function*(){if(!!e)yield Promise.all(e.map(e=>this.decryptMessage(e,t)))})}receiveApiResponse(e){var t,n,r,s,a,d,c,u,l,h,v,g,f,p,m,_,y,I,x,b,C,M,S,k,E;return(0,i.mG)(this,void 0,void 0,function*(){if(!this.decrypt)return;let i=e.pdes_key;if(i){let T=[];switch(e.cmd){case o.m.IMCMD.GET_MESSAGES_BY_USER:{let i=null===(n=null===(t=e.body)||void 0===t?void 0:t.messages_per_user_body)||void 0===n?void 0:n.messages;i&&T.push(...i);break}case o.m.IMCMD.GET_MESSAGES_BY_USER_INIT_V2:{let t=null===(s=null===(r=e.body)||void 0===r?void 0:r.messages_per_user_init_v2_body)||void 0===s?void 0:s.messages;t&&T.push(...t);break}case o.m.IMCMD.GET_MESSAGE_INFO_BY_SERVER_ID:{let t=null===(c=null===(d=null===(a=e.body)||void 0===a?void 0:a.get_message_by_id_body)||void 0===d?void 0:d.msg_info)||void 0===c?void 0:c.body;t&&T.push(t);break}case o.m.IMCMD.GET_MESSAGES_BY_CONVERSATION:{let t=null===(l=null===(u=e.body)||void 0===u?void 0:u.messages_in_conversation_body)||void 0===l?void 0:l.messages;t&&T.push(...t);break}case o.m.IMCMD.GET_STRANGER_CONVERSATION_LIST:case o.m.IMCMD.GET_STRANGER_MESSAGES_IN_CONVERSATION:{let t=null===(v=null===(h=e.body)||void 0===h?void 0:h.get_stranger_messages_body)||void 0===v?void 0:v.messages;t&&T.push(...t),null===(p=null===(f=null===(g=e.body)||void 0===g?void 0:g.get_stranger_conversation_body)||void 0===f?void 0:f.conversation_list)||void 0===p||p.forEach(e=>e.last_message&&T.push(e.last_message));break}case o.m.IMCMD.GET_MESSAGE_BY_INIT:null===(y=null===(_=null===(m=e.body)||void 0===m?void 0:m.message_by_init)||void 0===_?void 0:_.messages)||void 0===y||y.forEach(e=>e.messages&&T.push(...e.messages));break;case o.m.IMCMD.GET_USER_MESSAGE:null===(C=null===(b=null===(x=null===(I=e.body)||void 0===I?void 0:I.get_user_message)||void 0===x?void 0:x.messages)||void 0===b?void 0:b.messages)||void 0===C||C.forEach(e=>e.messages&&T.push(...e.messages)),null===(E=null===(k=null===(S=null===(M=e.body)||void 0===M?void 0:M.get_user_message)||void 0===S?void 0:S.messages)||void 0===k?void 0:k.messages)||void 0===E||E.forEach(e=>e.ext_messages&&T.push(...e.ext_messages))}yield this.decryptMessages(T,i)}})}}},52886:function(e,t,n){"use strict";let i,r;n.d(t,{a:function(){return u},i:function(){return s},r:function(){return h},u:function(){return g},w:function(){return v}});let s=(e,t)=>t.some(t=>e instanceof t),o=new WeakMap,a=new WeakMap,d=new WeakMap,c=new WeakMap,u=new WeakMap,l={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return a.get(e);if("objectStoreNames"===t)return e.objectStoreNames||d.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return v(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function h(e){l=e(l)}function v(e){if(e instanceof IDBRequest)return function(e){let t=new Promise((t,n)=>{let i=()=>{e.removeEventListener("success",r),e.removeEventListener("error",s)},r=()=>{t(v(e.result)),i()},s=()=>{n(e.error),i()};e.addEventListener("success",r),e.addEventListener("error",s)});return t.then(t=>{t instanceof IDBCursor&&o.set(t,e)}).catch(()=>{}),u.set(t,e),t}(e);if(c.has(e))return c.get(e);let t=function(e){if("function"==typeof e){var t;return(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(r||(r=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(g(this),e),v(o.get(this))}:function(...e){return v(t.apply(g(this),e))}:function(e,...n){let i=t.call(g(this),e,...n);return d.set(i,e.sort?e.sort():[e]),v(i)}}return(e instanceof IDBTransaction&&!function(e){if(a.has(e))return;let t=new Promise((t,n)=>{let i=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",s),e.removeEventListener("abort",s)},r=()=>{t(),i()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",r),e.addEventListener("error",s),e.addEventListener("abort",s)});a.set(e,t)}(e),s(e,i||(i=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])))?new Proxy(e,l):e}(e);return t!==e&&(c.set(e,t),u.set(t,e)),t}let g=e=>u.get(e)},987232:function(e,t,n){"use strict";n.d(t,{Lj:function(){return i.Lj},X3:function(){return i.X3}});var i=n(876265);n(171479)},213257:function(e,t,n){var i=n(928686);!function(){"use strict";var t="input is invalid type",r="object"==typeof window,s=r?window:{};s.JS_SHA256_NO_WINDOW&&(r=!1);var o=!r&&"object"==typeof self,a=!s.JS_SHA256_NO_NODE_JS&&"object"==typeof i&&i.versions&&i.versions.node;a?s=window:o&&(s=self);var d=!s.JS_SHA256_NO_COMMON_JS&&e.exports,c="function"==typeof define&&define.amd,u=!s.JS_SHA256_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,l="0123456789abcdef".split(""),h=[-2147483648,8388608,32768,128],v=[24,16,8,0],g=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],f=["hex","array","digest","arrayBuffer"],p=[];(s.JS_SHA256_NO_NODE_JS||!Array.isArray)&&(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),u&&(s.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW||!ArrayBuffer.isView)&&(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var m=function(e,t){return function(n){return new b(t,!0).update(n)[e]()}},_=function(e){var t=m("hex",e);a&&(t=y(t,e)),t.create=function(){return new b(e)},t.update=function(e){return t.create().update(e)};for(var n=0;n<f.length;++n){var i=f[n];t[i]=m(i,e)}return t},y=function(e,i){var r,o=n(89855),a=n(687841).Buffer,d=i?"sha224":"sha256";return r=a.from&&!s.JS_SHA256_NO_BUFFER_FROM?a.from:function(e){return new a(e)},function(n){if("string"==typeof n)return o.createHash(d).update(n,"utf8").digest("hex");if(null==n)throw Error(t);n.constructor===ArrayBuffer&&(n=new Uint8Array(n));return Array.isArray(n)||ArrayBuffer.isView(n)||n.constructor===a?o.createHash(d).update(r(n)).digest("hex"):e(n)}},I=function(e,t){return function(n,i){return new C(n,t,!0).update(i)[e]()}},x=function(e){var t=I("hex",e);t.create=function(t){return new C(t,e)},t.update=function(e,n){return t.create(e).update(n)};for(var n=0;n<f.length;++n){var i=f[n];t[i]=I(i,e)}return t};function b(e,t){t?(p[0]=p[16]=p[1]=p[2]=p[3]=p[4]=p[5]=p[6]=p[7]=p[8]=p[9]=p[10]=p[11]=p[12]=p[13]=p[14]=p[15]=0,this.blocks=p):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}function C(e,n,i){var r,s=typeof e;if("string"===s){var o,a=[],d=e.length,c=0;for(r=0;r<d;++r)(o=e.charCodeAt(r))<128?a[c++]=o:(o<2048?a[c++]=192|o>>>6:(o<55296||o>=57344?a[c++]=224|o>>>12:(o=65536+((1023&o)<<10|1023&e.charCodeAt(++r)),a[c++]=240|o>>>18,a[c++]=128|o>>>12&63),a[c++]=128|o>>>6&63),a[c++]=128|63&o);e=a}else if("object"===s){if(null===e)throw Error(t);if(u&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!Array.isArray(e)&&(!u||!ArrayBuffer.isView(e)))throw Error(t)}else throw Error(t);e.length>64&&(e=new b(n,!0).update(e).array());var l=[],h=[];for(r=0;r<64;++r){var v=e[r]||0;l[r]=92^v,h[r]=54^v}b.call(this,n,i),this.update(h),this.oKeyPad=l,this.inner=!0,this.sharedMemory=i}b.prototype.update=function(e){if(!this.finalized){var n,i=typeof e;if("string"!==i){if("object"===i){if(null===e)throw Error(t);if(u&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!Array.isArray(e)&&(!u||!ArrayBuffer.isView(e)))throw Error(t)}else throw Error(t);n=!0}for(var r,s,o=0,a=e.length,d=this.blocks;o<a;){if(this.hashed&&(this.hashed=!1,d[0]=this.block,this.block=d[16]=d[1]=d[2]=d[3]=d[4]=d[5]=d[6]=d[7]=d[8]=d[9]=d[10]=d[11]=d[12]=d[13]=d[14]=d[15]=0),n)for(s=this.start;o<a&&s<64;++o)d[s>>>2]|=e[o]<<v[3&s++];else for(s=this.start;o<a&&s<64;++o)(r=e.charCodeAt(o))<128?d[s>>>2]|=r<<v[3&s++]:(r<2048?d[s>>>2]|=(192|r>>>6)<<v[3&s++]:(r<55296||r>=57344?d[s>>>2]|=(224|r>>>12)<<v[3&s++]:(r=65536+((1023&r)<<10|1023&e.charCodeAt(++o)),d[s>>>2]|=(240|r>>>18)<<v[3&s++],d[s>>>2]|=(128|r>>>12&63)<<v[3&s++]),d[s>>>2]|=(128|r>>>6&63)<<v[3&s++]),d[s>>>2]|=(128|63&r)<<v[3&s++]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=d[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},b.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=h[3&t],this.block=e[16],t>=56&&(!this.hashed&&this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},b.prototype.hash=function(){var e,t,n,i,r,s,o,a,d,c,u,l=this.h0,h=this.h1,v=this.h2,f=this.h3,p=this.h4,m=this.h5,_=this.h6,y=this.h7,I=this.blocks;for(e=16;e<64;++e)t=((r=I[e-15])>>>7|r<<25)^(r>>>18|r<<14)^r>>>3,n=((r=I[e-2])>>>17|r<<15)^(r>>>19|r<<13)^r>>>10,I[e]=I[e-16]+t+I[e-7]+n<<0;for(e=0,u=h&v;e<64;e+=4)this.first?(this.is224?(a=300032,y=(r=I[0]-1413257819)-150054599<<0,f=r+24177077<<0):(a=704751109,y=(r=I[0]-210244248)-1521486534<<0,f=r+143694565<<0),this.first=!1):(t=(l>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10),n=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7),i=(a=l&h)^l&v^u,r=y+n+(o=p&m^~p&_)+g[e]+I[e],s=t+i,y=f+r<<0,f=r+s<<0),t=(f>>>2|f<<30)^(f>>>13|f<<19)^(f>>>22|f<<10),n=(y>>>6|y<<26)^(y>>>11|y<<21)^(y>>>25|y<<7),i=(d=f&l)^f&h^a,r=_+n+(o=y&p^~y&m)+g[e+1]+I[e+1],s=t+i,_=v+r<<0,t=((v=r+s<<0)>>>2|v<<30)^(v>>>13|v<<19)^(v>>>22|v<<10),n=(_>>>6|_<<26)^(_>>>11|_<<21)^(_>>>25|_<<7),i=(c=v&f)^v&l^d,r=m+n+(o=_&y^~_&p)+g[e+2]+I[e+2],s=t+i,m=h+r<<0,t=((h=r+s<<0)>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),n=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7),i=(u=h&v)^h&f^c,r=p+n+(o=m&_^~m&y)+g[e+3]+I[e+3],s=t+i,p=l+r<<0,l=r+s<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+l<<0,this.h1=this.h1+h<<0,this.h2=this.h2+v<<0,this.h3=this.h3+f<<0,this.h4=this.h4+p<<0,this.h5=this.h5+m<<0,this.h6=this.h6+_<<0,this.h7=this.h7+y<<0},b.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,i=this.h3,r=this.h4,s=this.h5,o=this.h6,a=this.h7,d=l[e>>>28&15]+l[e>>>24&15]+l[e>>>20&15]+l[e>>>16&15]+l[e>>>12&15]+l[e>>>8&15]+l[e>>>4&15]+l[15&e]+l[t>>>28&15]+l[t>>>24&15]+l[t>>>20&15]+l[t>>>16&15]+l[t>>>12&15]+l[t>>>8&15]+l[t>>>4&15]+l[15&t]+l[n>>>28&15]+l[n>>>24&15]+l[n>>>20&15]+l[n>>>16&15]+l[n>>>12&15]+l[n>>>8&15]+l[n>>>4&15]+l[15&n]+l[i>>>28&15]+l[i>>>24&15]+l[i>>>20&15]+l[i>>>16&15]+l[i>>>12&15]+l[i>>>8&15]+l[i>>>4&15]+l[15&i]+l[r>>>28&15]+l[r>>>24&15]+l[r>>>20&15]+l[r>>>16&15]+l[r>>>12&15]+l[r>>>8&15]+l[r>>>4&15]+l[15&r]+l[s>>>28&15]+l[s>>>24&15]+l[s>>>20&15]+l[s>>>16&15]+l[s>>>12&15]+l[s>>>8&15]+l[s>>>4&15]+l[15&s]+l[o>>>28&15]+l[o>>>24&15]+l[o>>>20&15]+l[o>>>16&15]+l[o>>>12&15]+l[o>>>8&15]+l[o>>>4&15]+l[15&o];return!this.is224&&(d+=l[a>>>28&15]+l[a>>>24&15]+l[a>>>20&15]+l[a>>>16&15]+l[a>>>12&15]+l[a>>>8&15]+l[a>>>4&15]+l[15&a]),d},b.prototype.toString=b.prototype.hex,b.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,i=this.h3,r=this.h4,s=this.h5,o=this.h6,a=this.h7,d=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,n>>>24&255,n>>>16&255,n>>>8&255,255&n,i>>>24&255,i>>>16&255,i>>>8&255,255&i,r>>>24&255,r>>>16&255,r>>>8&255,255&r,s>>>24&255,s>>>16&255,s>>>8&255,255&s,o>>>24&255,o>>>16&255,o>>>8&255,255&o];return!this.is224&&d.push(a>>>24&255,a>>>16&255,a>>>8&255,255&a),d},b.prototype.array=b.prototype.digest,b.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),!this.is224&&t.setUint32(28,this.h7),e},C.prototype=new b,C.prototype.finalize=function(){if(b.prototype.finalize.call(this),this.inner){this.inner=!1;var e=this.array();b.call(this,this.is224,this.sharedMemory),this.update(this.oKeyPad),this.update(e),b.prototype.finalize.call(this)}};var M=_();M.sha256=M,M.sha224=_(!0),M.sha256.hmac=x(),M.sha224.hmac=x(!0),d?e.exports=M:(s.sha256=M.sha256,s.sha224=M.sha224,c&&define(function(){return M}))}()},985101:function(e,t,n){var i=null;e.exports=function(e){"use strict";var t,r,s,o,a={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"	"},d=function(e){throw{name:"SyntaxError",message:e,at:t,text:s}},c=function(e){return e&&e!==r&&d("Expected '"+e+"' instead of '"+r+"'"),r=s.charAt(t),t+=1,r},u=function(){var e=!1,t,s="";for("-"===r&&(s="-",c("-"));r>="0"&&r<="9";)s+=r,c();if("."===r)for(e=!0,s+=".";c()&&r>="0"&&r<="9";)s+=r;if("e"===r||"E"===r)for(e=!0,s+=r,c(),("-"===r||"+"===r)&&(s+=r,c());r>="0"&&r<="9";)s+=r,c();if(isFinite(t=+s))return e||Number(s).toString()===s?t:(null==i&&(i=n(193533)),i.fromString(s));d("Bad number")},l=function(){var e,t,n,i="";if('"'===r)for(;c();){if('"'===r)return c(),i;if("\\"===r){if(c(),"u"===r){for(t=0,n=0;t<4&&isFinite(e=parseInt(c(),16));t+=1){;n=16*n+e}i+=String.fromCharCode(n)}else if("string"==typeof a[r])i+=a[r];else break}else i+=r}d("Bad string")},h=function(){for(;r&&r<=" ";)c()},v=function(){switch(r){case"t":return c("t"),c("r"),c("u"),c("e"),!0;case"f":return c("f"),c("a"),c("l"),c("s"),c("e"),!1;case"n":return c("n"),c("u"),c("l"),c("l"),null}d("Unexpected '"+r+"'")},g=function(){var e=[];if("["===r){if(c("["),h(),"]"===r)return c("]"),e;for(;r;){if(e.push(o()),h(),"]"===r)return c("]"),e;c(","),h()}}d("Bad array")},f=function(){var e,t={};if("{"===r){if(c("{"),h(),"}"===r)return c("}"),t;for(;r;){if(e=l(),h(),c(":"),Object.hasOwnProperty.call(t,e)&&d('Duplicate key "'+e+'"'),t[e]=o(),h(),"}"===r)return c("}"),t;c(","),h()}}d("Bad object")};return o=function(){switch(h(),r){case"{":return f();case"[":return g();case'"':return l();case"-":return u();default:return r>="0"&&r<="9"?u():v()}},function(e,n){var i;return s=e+"",t=0,r=" ",i=o(),h(),r&&d("Syntax error"),"function"==typeof n?function e(t,i){var r,s=t[i];return s&&"object"==typeof s&&Object.keys(s).forEach(function(t){void 0!==(r=e(s,t))?s[t]=r:delete s[t]}),n.call(t,i,s)}({"":i},""):i}}}}]);